<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Legend of General Starã€€ç¾¤é›„å°†æ˜Ÿä¼</title>
    <style>
        :root {
            --bg-primary: #000; --bg-secondary: #111; --bg-tertiary: #222; --bg-card: #333; --bg-hover: #444;
            --border-primary: #666; --border-secondary: #555;
            --text-primary: #fff; --text-secondary: #ccc; --text-muted: #888;
            --accent-red: #ff6666; --accent-green: #66ff66; --accent-blue: #6666ff; --accent-yellow: #ffff66;
            --gradient-primary: linear-gradient(145deg, #333, #555);
            --gradient-button: linear-gradient(145deg, #444, #666);
            --gradient-hover: linear-gradient(145deg, #555, #777);
            --shadow-glow: 0 0 10px rgba(255, 102, 102, 0.5);
            --transition-smooth: all 0.3s ease;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg-primary); color: var(--text-primary); font: 12px Arial, sans-serif; overflow: hidden; }
        .container { width: 100vw; height: 100vh; display: flex; flex-direction: column; }
        #title-image { display: block; margin: 0 auto; width: 100%; height: 100%; object-fit: contain; border-radius: 0; border: none; box-shadow: var(--shadow-glow); }
        .header { height: 60px; background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; border-bottom: 2px solid var(--border-primary); }
        .title { font: bold 32px Arial; color: var(--accent-red); text-shadow: 2px 2px 4px #000; }
        .main-content { flex: 1; display: flex; flex-direction: column; }
        .control-panel { width: 320px; height: var(--bottom-height, 180px); background: var(--bg-tertiary); border-top: 2px solid var(--border-primary); padding: 8px 10px; display: flex; flex-direction: column; gap: 8px; }
        .log-area { flex: 1; height: var(--bottom-height, 180px); background: var(--bg-secondary); border-top: 2px solid var(--border-primary); border-left: 1px solid var(--border-secondary); padding: 10px; overflow-y: auto; line-height: 1.4; display: flex; }
        .daimyo-portrait { width: 140px; height: 140px; background: var(--bg-tertiary); border: 2px solid var(--border-primary); border-radius: 8px; margin-right: 15px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .daimyo-portrait img { width: 130px; height: 130px; border-radius: 5px; object-fit: cover; }
        .daimyo-portrait.empty { color: var(--text-muted); font-size: 12px; text-align: center; }
        .log-content { flex: 1; overflow-y: auto; }
        .bottom-section { display: flex; height: var(--bottom-height, 180px); position: relative; }
        .resize-handle { 
            position: absolute; 
            top: -3px; 
            left: 0; 
            right: 0; 
            height: 6px; 
            background: var(--border-primary); 
            cursor: ns-resize; 
            z-index: 1000; 
            opacity: 0.5; 
            transition: opacity 0.2s; 
        }
        .resize-handle:hover { opacity: 1; background: var(--accent-red); }
        .button-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .turn-display { position: absolute; top: 10px; left: 10px; background: var(--bg-tertiary); border: 1px solid var(--border-primary); border-radius: 5px; padding: 8px 12px; font-weight: bold; z-index: 100; }
        .map-area { position: relative; }
        
        .daimyo-selection, .map-area { padding: 20px; }
        .map-area { flex: 1; overflow: auto; }
        .daimyo-selection { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; z-index: 10; }
        .daimyo-card { background: var(--gradient-primary); border: 2px solid var(--border-primary); border-radius: 12px; padding: 12px 20px; text-align: center; cursor: pointer; transition: var(--transition-smooth); display: flex; justify-content: center; align-items: center; min-width: 120px; }
        .daimyo-card:hover { border-color: var(--accent-red); transform: scale(1.05); box-shadow: 0 4px 15px rgba(255, 102, 102, 0.4); }
        .daimyo-name { font: bold 16px Arial; color: var(--accent-red); }
        .daimyo-desc { display: none; }
        .map-grid { display: grid; grid-template-columns: repeat(8, 1fr); grid-template-rows: repeat(3, 1fr); gap: 2px; height: 100%; max-width: 100%; margin: 0 auto; }
        .territory { border: 2px solid var(--border-primary); border-radius: 5px; padding: 1px; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 11px; line-height: 1.1; transition: var(--transition-smooth); aspect-ratio: 1; min-height: 55px; }
        .territory:hover { border-color: var(--accent-red); box-shadow: var(--shadow-glow); }
        .territory.empty { background: var(--bg-card); color: var(--text-muted); }
        .territory.player {  }
        .territory.enemy {  }
        .territory-name { font-weight: bold; margin-bottom: 5px; color: var(--accent-red); }
        .territory-owner { font-size: 10px; margin-bottom: 3px; }
        .territory-stats { font-size: 9px; line-height: 1.1; }
        
        .btn { background: var(--gradient-button); border: 1px solid var(--text-muted); color: var(--text-primary); padding: 6px 8px; border-radius: 5px; cursor: pointer; transition: var(--transition-smooth); font-size: 11px; }
        .btn:hover { background: var(--gradient-hover); border-color: var(--accent-red); }
        .btn:disabled { background: var(--bg-card); border-color: var(--border-secondary); color: var(--text-muted); cursor: not-allowed; }
        .btn.primary { background: linear-gradient(145deg, #ff4444, var(--accent-red)); border-color: #ff8888; }
        .btn.primary:hover { background: linear-gradient(145deg, var(--accent-red), #ff8888); }
        .status-display { background: var(--bg-tertiary); border: 1px solid var(--border-primary); border-radius: 5px; padding: 8px; display: flex; gap: 15px; justify-content: space-around; }
        
        .modal { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--bg-card); border: 2px solid var(--border-primary); border-radius: 10px; padding: 20px; max-width: 600px; max-height: 80vh; overflow-y: auto; }
        .modal-title { font: bold 18px Arial; color: var(--accent-red); margin-bottom: 15px; text-align: center; }
        .action-buttons { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        .log-entry { margin-bottom: 5px; padding: 2px 5px; border-left: 3px solid var(--border-primary); }
        .log-entry.battle { border-left-color: var(--accent-red); }
        .log-entry.diplomacy { border-left-color: var(--accent-green); }
        .log-entry.strategy { border-left-color: var(--accent-blue); }
        .hidden { display: none !important; }
        
        .generals-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--border-primary); padding-bottom: 10px; }
        .tab-btn { background: var(--bg-card); border: 1px solid var(--border-primary); padding: 8px 16px; border-radius: 5px 5px 0 0; }
        .tab-btn.active { background: var(--border-secondary); border-color: var(--accent-red); color: var(--accent-red); }
        .tab-content { display: none; min-height: 300px; }
        .tab-content.active { display: block; }
        .tab-content h3 { color: var(--accent-red); margin-bottom: 15px; font-size: 16px; }
        .role-settings { display: grid; gap: 15px; }
        .role-group { display: flex; align-items: center; gap: 10px; }
        .role-group label { min-width: 100px; font-weight: bold; }
        .role-group select, .formation-position select, .assignment-controls select, .recruit-controls select { background: var(--bg-card); border: 1px solid var(--border-primary); color: var(--text-primary); padding: 5px 10px; border-radius: 3px; }
        .role-group select { min-width: 200px; }
        .dismiss-btn { background: linear-gradient(145deg, #cc4444, #aa3333); border: 1px solid #ff6666; color: #fff; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 10px; margin-left: 8px; }
        .dismiss-btn:hover { background: linear-gradient(145deg, #aa3333, #cc4444); }
        .assignment-controls select, .recruit-controls select { background: var(--bg-tertiary); border-color: var(--border-secondary); padding: 3px 8px; min-width: 150px; }
        .formation-position select { width: 100%; background: var(--bg-tertiary); border-color: var(--border-secondary); padding: 5px; }
        .formation-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .formation-position { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 5px; padding: 10px; }
        .formation-position label { display: block; font-weight: bold; color: var(--accent-red); margin-bottom: 5px; }
        .position-info { color: var(--text-secondary); font-style: italic; }
        .army-stats, .current-roles-display, .current-army-display, .recruit-info { background: var(--bg-tertiary); border: 1px solid var(--border-primary); border-radius: 5px; padding: 15px; margin-bottom: 20px; }
        .army-stats h4, .current-roles-display h4, .current-army-display h4, .recruit-info h4 { color: var(--accent-red); margin-bottom: 10px; font-size: 14px; }
        .territory-assignment, .general-card, .recruit-general-card { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 5px; padding: 10px; margin-bottom: 10px; }
        .territory-assignment { display: flex; justify-content: space-between; align-items: center; }
        .territory-info { flex: 1; }
        .territory-name-assign, .general-name, .recruit-general-name { font-weight: bold; color: var(--accent-red); }
        .territory-stats-assign { color: var(--text-secondary); }
        .assignment-controls, .recruit-controls { display: flex; gap: 10px; align-items: center; }
        .general-card { padding: 15px; }
        .general-name { font-size: 16px; margin-bottom: 8px; }
        .general-stats-detail { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 8px; }
        .stat-item, .recruit-stat-item { display: flex; justify-content: space-between; }
        .general-skill, .recruit-general-skill { color: var(--accent-green); margin-bottom: 5px; }
        .general-loyalty { color: var(--accent-yellow); }
        .assignment-status { font-size: 11px; color: var(--text-secondary); margin-top: 5px; }
        
        .role-item, .formation-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid var(--border-secondary); }
        .role-item:last-child, .formation-item:last-child { border-bottom: none; }
        .role-label, .formation-label { font-weight: bold; color: var(--text-secondary); }
        .role-value, .formation-value { color: var(--accent-green); }
        .role-value.empty, .formation-value.empty { color: var(--text-muted); font-style: italic; }
        
        .power-display { display: grid; gap: 8px; }
        .power-item { display: flex; justify-content: space-between; align-items: center; padding: 5px 10px; background: var(--bg-card); border-radius: 3px; }
        .power-value { font: bold 16px Arial; color: var(--accent-green); }
        .total-power { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-hover); border: 2px solid var(--accent-red); border-radius: 5px; margin-top: 10px; }
        .total-value { font: bold 20px Arial; color: var(--accent-red); }
        
        .formation-display { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .available-generals-list { max-height: 400px; overflow-y: auto; }
        .recruit-general-card { display: flex; justify-content: space-between; align-items: center; }
        .recruit-general-info { flex: 1; }
        .recruit-general-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 11px; margin-bottom: 5px; }
        .recruit-cost { color: var(--accent-yellow); font-weight: bold; }
        .recruit-controls { display: flex; flex-direction: column; align-items: center; gap: 10px; min-width: 120px; }
        .recruit-chance { font-size: 11px; color: var(--text-secondary); text-align: center; }
        .recruit-chance.high { color: var(--accent-green); }
        .recruit-chance.medium { color: var(--accent-yellow); }
        .recruit-chance.low { color: var(--accent-red); }
        
        .recruit-btn { background: linear-gradient(145deg, #006600, #008800); border: 1px solid #00aa00; color: var(--text-primary); padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 11px; transition: var(--transition-smooth); }
        .recruit-btn:hover { background: linear-gradient(145deg, #008800, #00aa00); }
        .recruit-btn:disabled { background: var(--bg-card); border-color: var(--border-secondary); color: var(--text-muted); cursor: not-allowed; }
        
        .battle-participants { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; padding: 15px; background: var(--bg-tertiary); border-radius: 8px; }
        .attacker-info, .defender-info { padding: 15px; border: 1px solid var(--border-primary); border-radius: 5px; }
        .attacker-info { background: #003300; border-color: var(--accent-green); }
        .defender-info { background: #330000; border-color: var(--accent-red); }
        .participant-stats { margin-top: 10px; }
        .participant-stats div { display: flex; justify-content: space-between; margin-bottom: 5px; padding: 2px 5px; background: rgba(255, 255, 255, 0.1); border-radius: 3px; }
        
        .battle-log-content { background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 8px; padding: 15px; margin-bottom: 20px; max-height: 300px; overflow-y: auto; }
        .battle-event { margin-bottom: 8px; padding: 8px; border-left: 3px solid var(--border-primary); background: var(--bg-tertiary); border-radius: 3px; font-size: 13px; line-height: 1.4; }
        .battle-event.attack { border-left-color: var(--accent-red); background: #331111; }
        .battle-event.defense { border-left-color: var(--accent-blue); background: #111133; }
        .battle-event.damage { border-left-color: var(--accent-yellow); background: #333311; }
        .battle-event.victory { border-left-color: var(--accent-green); background: #113311; }
        .battle-event.skill { border-left-color: #ff66ff; background: #331133; }
        .battle-event.general-activity { border-left-color: #66ccff; background: #113333; }
        
        .battle-result { background: var(--bg-tertiary); border: 2px solid var(--accent-red); border-radius: 8px; padding: 15px; text-align: center; }
        .result-summary { font: bold 16px Arial; margin-bottom: 15px; }
        .result-details { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .result-item { padding: 8px; background: var(--bg-card); border-radius: 5px; display: flex; justify-content: space-between; }
        .power-display { color: var(--accent-green); font-weight: bold; }
        .damage-display { color: var(--accent-red); font-weight: bold; }
        .success-display { color: var(--accent-yellow); font-weight: bold; }
        
        #generals-reset-btn { background: linear-gradient(145deg, #994400, #bb6600); border: 1px solid #dd8800; }
        #generals-reset-btn:hover { background: linear-gradient(145deg, #bb6600, #dd8800); }
        
        .turn-log { background: rgba(0, 0, 0, 0.9); position: fixed; inset: 0; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px; }
        .turn-log-content { background: var(--bg-tertiary); border: 2px solid var(--border-primary); border-radius: 10px; padding: 30px; max-width: 80%; max-height: 80%; overflow-y: auto; }
        .turn-log-title { font: bold 24px Arial; color: var(--accent-red); text-align: center; margin-bottom: 20px; }
        .turn-events { font-size: 14px; line-height: 1.6; margin-bottom: 20px; }
        .turn-log-container { display: flex; gap: 20px; margin-bottom: 20px; }
        .action-log-section, .personnel-log-section { flex: 1; background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 8px; padding: 15px; max-height: 400px; overflow-y: auto; }
        .log-section-title { color: var(--accent-red); font: bold 16px Arial; margin-bottom: 15px; text-align: center; border-bottom: 1px solid var(--border-primary); padding-bottom: 8px; }
        .personnel-log-section .log-section-title { color: var(--accent-green); }
        .no-events { text-align: center; color: var(--text-muted); font-style: italic; padding: 20px; }
        .event-entry { margin-bottom: 10px; padding: 8px; border-radius: 5px; background: var(--bg-card); }
        
        @media (max-width: 768px) {
            .map-grid { grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(6, 1fr); }
            .bottom-section { flex-direction: column; height: auto; }
            .control-panel { width: 100%; height: auto; }
            .log-area { height: 100px; border-left: none; border-top: 1px solid var(--border-secondary); }
            .daimyo-selection { grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 15px; }
            .daimyo-card { padding: 10px; }
            .daimyo-name { font-size: 14px; margin-bottom: 6px; }
            .daimyo-desc { font-size: 11px; }
            .turn-log-container { flex-direction: column; gap: 15px; }
            .action-log-section, .personnel-log-section { max-height: 300px; }
        }
        
        /* é™£å½¢é¸æŠã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .formation-card { 
            background: var(--gradient-button); 
            border: 3px solid var(--border-primary); 
            border-radius: 12px; 
            padding: 18px; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.2s ease; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            min-height: 140px;
            position: relative;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
            user-select: none;
        }
        .formation-card:hover { 
            border-color: var(--accent-yellow); 
            transform: translateY(-5px) scale(1.03); 
            box-shadow: 0 12px 25px rgba(255, 255, 102, 0.5);
            background: var(--gradient-hover);
        }
        .formation-card:active {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 6px 15px rgba(255, 255, 102, 0.7);
            transition: all 0.1s ease;
        }
        .formation-card.selected { 
            border-color: var(--accent-green); 
            background: linear-gradient(145deg, #1a4d1a, #2e6b2e); 
            box-shadow: 0 8px 20px rgba(102, 255, 102, 0.7);
            transform: translateY(-3px) scale(1.02);
        }
        .formation-card.selected:hover {
            transform: translateY(-6px) scale(1.04);
            box-shadow: 0 15px 30px rgba(102, 255, 102, 0.8);
        }
        .formation-card::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.15), transparent);
            border-radius: 15px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .formation-card:hover::before {
            opacity: 1;
        }
        .formation-card::after {
            content: 'é¸æŠ';
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: var(--accent-yellow);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .formation-card:hover::after {
            opacity: 1;
        }
        .formation-card.selected::after {
            content: 'âœ“é¸æŠæ¸ˆã¿';
            background: var(--accent-green);
            color: #000;
            opacity: 1;
        }
        .formation-name { 
            font: bold 16px Arial; 
            color: var(--accent-yellow); 
            margin-bottom: 12px; 
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }
        .formation-desc { 
            font-size: 12px; 
            line-height: 1.5; 
            color: var(--text-secondary); 
            margin-bottom: 12px; 
        }
        .formation-bonus { 
            font-size: 12px; 
            color: var(--accent-green); 
            font-weight: bold; 
            background: rgba(0, 0, 0, 0.4);
            padding: 6px 10px;
            border-radius: 6px;
            margin-top: auto;
            border: 1px solid rgba(102, 255, 102, 0.3);
        }
        
        @media (max-width: 480px) {
            .daimyo-selection { grid-template-columns: 1fr; gap: 8px; padding: 10px; }
            .daimyo-card { padding: 8px; }
            .daimyo-name { font-size: 13px; margin-bottom: 5px; }
            .daimyo-desc { font-size: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header hidden" id="game-header"></div>
        <div id="daimyo-selection-screen" class="main-content" style="overflow-y: auto;">
            <div class="header">
                <div class="title">The Legend of General Starã€€ç¾¤é›„å°†æ˜Ÿä¼</div>
                <audio id="bgm" autoplay loop muted>
                    <source src="syoseiden.mp3" type="audio/mpeg">
                </audio>
            </div>
            <div style="position: relative; width: 100%; height: calc(100vh - 60px); overflow: hidden;">
                <img id="title-image" src="Snapshot_77.PNG" alt="ã‚²ãƒ¼ãƒ ã‚¿ã‚¤ãƒˆãƒ«ç”»åƒ">
                <div class="daimyo-selection">
                <div class="daimyo-card" data-daimyo="oda"><div class="daimyo-name">ç¹”ç”°ä¿¡é•·</div><div class="daimyo-desc">çµŒæ¸ˆåŠ›ã¨é‰„ç ²éšŠã‚’é§†ä½¿ã—ã€æ—§ä½“åˆ¶ã‚’ç ´å£Šã™ã‚‹é­”ç‹ã€‚çŸ­æœŸæ±ºæˆ¦å‹ã§åºç›¤ã®å‹¢ã„ã¯åœ§å€’çš„ã€‚</div></div>
                <div class="daimyo-card" data-daimyo="hashiba"><div class="daimyo-name">ç¾½æŸ´ç§€å‰</div><div class="daimyo-desc">äººå¿ƒæŒæ¡è¡“ã«é•·ã‘ã€å·§ã¿ãªå¤–äº¤ã§å‹¢åŠ›ã‚’æ‹¡å¤§ã€‚é‡‘ã¨äººã®åŠ›ã§å¤©ä¸‹ã‚’æ´ã‚€ã€‚</div></div>
                <div class="daimyo-card" data-daimyo="tokugawa"><div class="daimyo-name">å¾³å·å®¶åº·</div><div class="daimyo-desc">å¿è€ã¨å …å®Ÿãªé ˜å›½çµŒå–¶ãŒæŒã¡å‘³ã€‚å„ªç§€ãªå®¶è‡£å›£ã¨å…±ã«ã€æ©ŸãŒç†Ÿã™ã®ã‚’å¾…ã¤å¤§å™¨æ™©æˆå‹ã€‚</div></div>
                </div>
            </div>
        </div>
        
        <div id="scout-modal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-title">åµå¯Ÿå ±å‘Š</div>
                <div id="scout-body">
                    <div id="scout-target-info" style="margin-bottom: 20px;"></div>
                    <div id="scout-generals-info"></div>
                </div>
                <div class="action-buttons"><button class="btn primary" id="scout-close-btn">é–‰ã˜ã‚‹</button></div>
            </div>
        </div>
        <div id="recruit-general-modal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-title">æ­¦å°†ç™»ç”¨</div>
                <div id="recruit-general-body">
                    <div class="recruit-info">
                        <h4>ç™»ç”¨æ¡ä»¶</h4>
                        <p>ãƒ»ç™»ç”¨ã«ã¯ä¸€å¾‹é‡‘100ãŒå¿…è¦ã§ã™</p>
                        <p>ãƒ»æˆåŠŸç‡ã¯äººäº‹ç·ç›£ã®é­…åŠ›ã«ä¾å­˜ã—ã¾ã™</p>
                        <p>ãƒ»å¤±æ•—ã—ã¦ã‚‚é‡‘ã¯æ¶ˆè²»ã•ã‚Œã¾ã™</p>
                    </div>
                    <div class="available-generals-list" id="available-generals-list"></div>
                </div>
                <div class="action-buttons"><button class="btn" id="recruit-general-cancel-btn">é–‰ã˜ã‚‹</button></div>
            </div>
        </div>
        <div id="battle-log-modal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-title">å‡ºå…µè¨˜éŒ²</div>
                <div id="battle-log-body">
                    <div class="battle-participants">
                        <div class="attacker-info">
                            <h4 style="color: #66ff66;">ã€æ”»æ’ƒå´ã€‘</h4>
                            <div id="attacker-details"></div>
                        </div>
                        <div class="defender-info">
                            <h4 style="color: #ff6666;">ã€é˜²å¾¡å´ã€‘</h4>
                            <div id="defender-details"></div>
                        </div>
                    </div>
                    <div class="battle-log-content">
                        <h4 style="color: #ffff66; text-align: center; margin: 20px 0;">æˆ¦é—˜çµŒé</h4>
                        <div id="battle-events-log"></div>
                    </div>
                    <div class="battle-result">
                        <h4 style="color: #ff6666; text-align: center; margin: 20px 0;">æˆ¦æœ</h4>
                        <div id="battle-final-result"></div>
                    </div>
                </div>
                <div class="action-buttons"><button class="btn primary" id="battle-log-close-btn">é–‰ã˜ã‚‹</button></div>
            </div>
        </div>
        
        <!-- é™£å½¢é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="formation-modal" class="modal">
            <div class="modal-content" style="max-width: 1000px;">
                <div class="modal-title">é™£å½¢é¸æŠ</div>
                
                <!-- åµå¯Ÿè²»ç”¨é€šçŸ¥ -->
                <div style="background: #2c4a2c; border: 2px solid #66ff66; border-radius: 8px; padding: 12px; margin-bottom: 15px;">
                    <h4 style="color: #66ff66; margin-bottom: 8px;">ğŸ’° åµå¯Ÿå®Œäº†</h4>
                    <p style="color: #ccffcc; font-size: 12px; margin-bottom: 5px;">é‡‘10ã‚’æ¶ˆè²»ã—ã¦æ•µæƒ…åµå¯Ÿã‚’å®Ÿæ–½ã—ã¾ã—ãŸ</p>
                    <p style="color: #aaffaa; font-size: 11px;">â€»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ã‚‚åµå¯Ÿè²»ç”¨ã¯è¿”é‡‘ã•ã‚Œã¾ã›ã‚“</p>
                </div>
                
                <!-- è»å¸«åŠ©è¨€ã‚¨ãƒªã‚¢ -->
                <div id="strategist-advice" style="background: #1a2b3a; border: 2px solid #66ccff; border-radius: 8px; padding: 15px; margin-bottom: 20px; display: none;">
                    <h4 style="color: #66ccff; margin-bottom: 10px;">è»å¸«ã®åŠ©è¨€</h4>
                    <div id="advice-text" style="color: #ccffff; line-height: 1.5;"></div>
                </div>
                
                <!-- é™£å½¢é¸æŠã‚°ãƒªãƒƒãƒ‰ -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div class="formation-card" data-formation="gyorin">
                        <div class="formation-name">é­šé±—ã®é™£</div>
                        <div class="formation-desc">å®ˆå‚™é‡è¦–ã€‚ä¸­å¤®é›†ä¸­ã§é˜²å¾¡ãƒ»åæ’ƒã«å¼·ã„</div>
                        <div class="formation-bonus">æ”»æ’ƒ+5 é˜²å¾¡+15</div>
                    </div>
                    <div class="formation-card" data-formation="kakuyoku">
                        <div class="formation-name">é¶´ç¿¼ã®é™£</div>
                        <div class="formation-desc">åŒ…å›²å‹ã€‚ä¸¡ç¿¼å±•é–‹ã§ãƒãƒ©ãƒ³ã‚¹ãŒå–ã‚ŒãŸä¸‡èƒ½å‹</div>
                        <div class="formation-bonus">æ”»æ’ƒ+10 é˜²å¾¡+10</div>
                    </div>
                    <div class="formation-card" data-formation="hoshi">
                        <div class="formation-name">é‹’çŸ¢ã®é™£</div>
                        <div class="formation-desc">çªç ´å‹ã€‚ä¸€ç‚¹é›†ä¸­çªç ´ã§æ”»æ’ƒåŠ›ç‰¹åŒ–</div>
                        <div class="formation-bonus">æ”»æ’ƒ+20 é˜²å¾¡+0</div>
                    </div>
                    <div class="formation-card" data-formation="choda">
                        <div class="formation-name">é•·è›‡ã®é™£</div>
                        <div class="formation-desc">ç¸¦é•·ã€‚é€²è»ãƒ»çªæ’ƒå‘ãã€‚æ©Ÿå‹•æ€§é‡è¦–</div>
                        <div class="formation-bonus">æ”»æ’ƒ+15 é˜²å¾¡+5</div>
                    </div>
                    <div class="formation-card" data-formation="ganko">
                        <div class="formation-name">é›è¡Œã®é™£</div>
                        <div class="formation-desc">å¥‡è¥²å‘ãã€‚æ–œã‚å±•é–‹ã§æŸ”è»ŸãªéŠæ’ƒæˆ¦ã«å¼·ã„</div>
                        <div class="formation-bonus">æ”»æ’ƒ+12 é˜²å¾¡+8</div>
                    </div>
                    <div class="formation-card" data-formation="houen">
                        <div class="formation-name">æ–¹å††ã®é™£</div>
                        <div class="formation-desc">å…¨æ–¹ä½é˜²å¾¡å‹ã€‚ç± åŸãƒ»å®ˆå‚™æˆ¦ã«å¼·ã„</div>
                        <div class="formation-bonus">æ”»æ’ƒ+0 é˜²å¾¡+20</div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn" id="formation-cancel-btn" style="color: #ffaaaa;">ã‚­ãƒ£ãƒ³ã‚»ãƒ« (è¿”é‡‘ãªã—)</button>
                    <button class="btn primary" id="formation-confirm-btn" disabled>æ±ºå®š</button>
                </div>
            </div>
        </div>
        
        <div id="game-screen" class="main-content hidden">
            <div class="turn-display"><span>ã‚¿ãƒ¼ãƒ³:</span> <span id="current-turn">1</span></div>
            <div class="map-area"><div class="map-grid" id="map-grid"></div></div>
            <div class="bottom-section">
                <div class="resize-handle" id="resize-handle"></div>
                <div class="control-panel">
                    <div class="status-display">
                        <div><strong>é‡‘:</strong> <span id="player-gold">1000</span></div>
                        <div><strong>ç±³:</strong> <span id="player-rice">500</span></div>
                    </div>
                    <div class="button-grid">
                        <button class="btn primary" id="next-turn-btn">ã‚¿ãƒ¼ãƒ³æ›´æ–°</button>
                        <button class="btn" id="trade-btn">ç±³å£²è²·</button>
                        <button class="btn" id="recruit-btn">å…µé›‡ç”¨</button>
                        <button class="btn" id="recruit-general-btn">æ­¦å°†ç™»ç”¨</button>
                        <button class="btn" id="generals-btn">æ­¦å°†è¨­å®š</button>
                        <button class="btn" id="attack-btn" disabled>å‡ºå…µ</button>
                        <button class="btn" id="strategy-btn" disabled>è¬€ç•¥</button>
                        <button class="btn" id="diplomacy-btn" disabled>å¤–äº¤</button>
                        <button class="btn" id="scout-btn" disabled>åµå¯Ÿ</button>
                    </div>
                </div>
                <div class="log-area" id="log-area">
                    <div class="daimyo-portrait empty" id="daimyo-portrait">
                        å¤§åã‚’<br>é¸æŠã—ã¦ãã ã•ã„
                    </div>
                    <div class="log-content" id="log-content">
                        <div class="log-entry">ã‚²ãƒ¼ãƒ é–‹å§‹ã€‚å¤©ä¸‹çµ±ä¸€ã‚’ç›®æŒ‡ã›ï¼</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="turn-log-screen" class="turn-log hidden">
            <div class="turn-log-content">
                <div class="turn-log-title">æˆ¦æ³å ±å‘Š</div>
                <div class="turn-log-container">
                    <div class="action-log-section">
                        <h3 class="log-section-title">è¡Œå‹•ãƒ­ã‚°</h3>
                        <div class="turn-events" id="action-events"></div>
                    </div>
                    <div class="personnel-log-section">
                        <h3 class="log-section-title">äººäº‹ãƒ­ã‚°</h3>
                        <div class="turn-events" id="personnel-events"></div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;"><button class="btn primary" id="confirm-turn-btn">ç¢ºèª</button></div>
            </div>
        </div>
        <div id="action-modal" class="modal">
            <div class="modal-content">
                <div class="modal-title" id="modal-title">è¡Œå‹•é¸æŠ</div>
                <div id="modal-body"></div>
                <div class="action-buttons">
                    <button class="btn" id="modal-cancel-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button class="btn primary" id="modal-confirm-btn">å®Ÿè¡Œ</button>
                </div>
            </div>
        </div>
        
        <div id="generals-modal" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-title">æ­¦å°†è¨­å®š</div>
                <div id="generals-body">
                    <div class="generals-tabs">
                        <button class="btn tab-btn active" data-tab="assignment">åŸä¸»é…ç½®</button>
                        <button class="btn tab-btn" data-tab="roles">å½¹è·è¨­å®š</button>
                        <button class="btn tab-btn" data-tab="army">è»å›£ç·¨æˆ</button>
                        <button class="btn tab-btn" data-tab="reward">ä¸‹è³œ</button>
                        <button class="btn tab-btn" data-tab="list">æ­¦å°†ä¸€è¦§</button>
                    </div>
                    <div id="tab-assignment" class="tab-content active">
                        <h3>åŸä¸»é…ç½®</h3>
                        <div id="territory-assignment-list"></div>
                    </div>
                    <div id="tab-roles" class="tab-content">
                        <h3>å½¹è·è¨­å®š</h3>
                        <div class="current-roles-display">
                            <h4>ç¾åœ¨ã®å½¹è·è¨­å®š</h4>
                            <div id="current-roles-list"></div>
                        </div>
                        <div class="role-settings">
                            <div style="color: #ff6666; margin-bottom: 15px; font-weight: bold; border-bottom: 1px solid #666; padding-bottom: 8px;">é‡è¦å½¹è·</div>
                            <div class="role-group"><label>å‚è¬€:</label><select id="strategist-select"><option value="">æœªè¨­å®š</option></select><button class="dismiss-btn" data-role="strategist">è§£ä»»</button></div>
                            <div class="role-group"><label>å¤–äº¤æ‹…å½“:</label><select id="diplomat-select"><option value="">æœªè¨­å®š</option></select><button class="dismiss-btn" data-role="diplomat">è§£ä»»</button></div>
                            <div class="role-group"><label>äººäº‹ç·ç›£:</label><select id="administrator-select"><option value="">æœªè¨­å®š</option></select><button class="dismiss-btn" data-role="administrator">è§£ä»»</button></div>
                            
                            <div style="color: #66ff66; margin: 20px 0 15px 0; font-weight: bold; border-bottom: 1px solid #666; padding-bottom: 8px;">å¥‰è¡Œè·</div>
                            <div class="role-group"><label>æ¤œåœ°å¥‰è¡Œ:</label><select id="kenchi-commissioner-select"><option value="">æœªè¨­å®š</option></select><button class="dismiss-btn" data-role="kenchiCommissioner">è§£ä»»</button><span style="color: #ccc; font-size: 10px; margin-left: 10px;">è¾²æ¥­å‘ä¸Š(æ”¿æ²»)</span></div>
                            <div class="role-group"><label>ç±³å¥‰è¡Œ:</label><select id="rice-commissioner-select"><option value="">æœªè¨­å®š</option></select><button class="dismiss-btn" data-role="riceCommissioner">è§£ä»»</button><span style="color: #ccc; font-size: 10px; margin-left: 10px;">ç±³å¢—ç”£(æ”¿æ²»)</span></div>
                            <div class="role-group"><label>ç”ºå¥‰è¡Œ:</label><select id="town-commissioner-select"><option value="">æœªè¨­å®š</option></select><button class="dismiss-btn" data-role="townCommissioner">è§£ä»»</button><span style="color: #ccc; font-size: 10px; margin-left: 10px;">å•†æ¥­ç™ºå±•(æ”¿æ²»)</span></div>
                            <div class="role-group"><label>é‡‘å¥‰è¡Œ:</label><select id="gold-commissioner-select"><option value="">æœªè¨­å®š</option></select><button class="dismiss-btn" data-role="goldCommissioner">è§£ä»»</button><span style="color: #ccc; font-size: 10px; margin-left: 10px;">åå…¥å¢—åŠ (æ”¿æ²»)</span></div>
                            <div class="role-group"><label>æ™®è«‹å¥‰è¡Œ:</label><select id="construction-commissioner-select"><option value="">æœªè¨­å®š</option></select><button class="dismiss-btn" data-role="constructionCommissioner">è§£ä»»</button><span style="color: #ccc; font-size: 10px; margin-left: 10px;">åŸå£å¼·åŒ–(çµ±ç‡)</span></div>
                            <div class="role-group"><label>å…µå¥‰è¡Œ:</label><select id="military-commissioner-select"><option value="">æœªè¨­å®š</option></select><button class="dismiss-btn" data-role="militaryCommissioner">è§£ä»»</button><span style="color: #ccc; font-size: 10px; margin-left: 10px;">å…µåŠ›å¢—å¼·(æˆ¦é—˜)</span></div>
                        </div>
                    </div>
                    <div id="tab-army" class="tab-content">
                        <h3>è»å›£ç·¨æˆ</h3>
                        <div class="current-army-display">
                            <h4>ç¾åœ¨ã®ç·¨æˆ</h4>
                            <div id="current-army-formation"></div>
                        </div>
                        <div class="army-formation">
                            <div class="formation-grid">
                                <div class="formation-position"><label>å¤§å°†:</label><div class="position-info"><span id="general-name">[å¤§åå›ºå®š]</span></div></div>
                                <div class="formation-position"><label>è»å¸«:</label><select id="army-strategist"><option value="">æœªè¨­å®š</option></select><button class="dismiss-btn" data-role="armyStrategist">è§£ä»»</button></div>
                                <div class="formation-position"><label>å‰è¡›:</label><select id="vanguard"><option value="">æœªè¨­å®š</option></select><button class="dismiss-btn" data-role="vanguard">è§£ä»»</button></div>
                                <div class="formation-position"><label>å³ç¿¼:</label><select id="right-wing"><option value="">æœªè¨­å®š</option></select><button class="dismiss-btn" data-role="rightWing">è§£ä»»</button></div>
                                <div class="formation-position"><label>å·¦ç¿¼:</label><select id="left-wing"><option value="">æœªè¨­å®š</option></select><button class="dismiss-btn" data-role="leftWing">è§£ä»»</button></div>
                                <div class="formation-position"><label>å¾Œè©°:</label><select id="reserve"><option value="">æœªè¨­å®š</option></select><button class="dismiss-btn" data-role="reserve">è§£ä»»</button></div>
                            </div>
                            <div class="army-stats">
                                <h4>è»å›£æˆ¦åŠ›</h4>
                                <div class="power-display">
                                    <div class="power-item"><span>æ”»æ’ƒåŠ›:</span><span id="army-attack" class="power-value">0</span></div>
                                    <div class="power-item"><span>é˜²å¾¡åŠ›:</span><span id="army-defense" class="power-value">0</span></div>
                                    <div class="power-item"><span>çŸ¥è¬€åŠ›:</span><span id="army-intelligence" class="power-value">0</span></div>
                                    <div class="total-power"><span>ç·åˆæˆ¦åŠ›:</span><span id="total-army-power" class="total-value">0</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="tab-reward" class="tab-content">
                        <h3>ä¸‹è³œ</h3>
                        <div class="recruit-info">
                            <h4>ä¸‹è³œã«ã¤ã„ã¦</h4>
                            <p>ãƒ»é‡‘100ã‚’ä½¿ç”¨ã—ã¦æ­¦å°†ã®å¿ èª åº¦ã‚’25ä¸Šæ˜‡ã•ã›ã¾ã™</p>
                            <p>ãƒ»å¿ èª åº¦ã¯æœ€å¤§100ã¾ã§ä¸Šæ˜‡ã—ã¾ã™</p>
                            <p>ãƒ»å¿ èª åº¦ãŒé«˜ã„æ­¦å°†ã»ã©è£åˆ‡ã‚Šã«ãããªã‚Šã¾ã™</p>
                        </div>
                        <div id="reward-generals-list"></div>
                    </div>
                    <div id="tab-list" class="tab-content">
                        <h3>é…ä¸‹æ­¦å°†ä¸€è¦§</h3>
                        <div id="generals-list"></div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn" id="generals-cancel-btn">é–‰ã˜ã‚‹</button>
                    <button class="btn" id="generals-reset-btn">å†ç·¨æˆ</button>
                    <button class="btn primary" id="generals-save-btn">è¨­å®šä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†
        class GameState {
            constructor() {
                this.turn = 1;
                this.playerDaimyo = null;
                this.selectedTerritory = null;
                this.attackUsed = false; // å‡ºå…µä½¿ç”¨ãƒ•ãƒ©ã‚°
                this.diplomacyUsed = 0; // å¤–äº¤ä½¿ç”¨å›æ•°ï¼ˆæ”¿æ²»ä¾å­˜ï¼š96ä»¥ä¸Š=3å›ã€90-95=2å›ã€ãã®ä»–=1å›ï¼‰
                this.strategyUsed = false; // è¬€ç•¥ä½¿ç”¨ãƒ•ãƒ©ã‚°
                this.rumorDefenseActive = false; // è™šå ±é˜²å¾¡ç™ºå‹•ãƒ•ãƒ©ã‚°
                this.rumorActivationRate = 0; // è™šå ±ç™ºå‹•ç‡
                this.territories = [];
                this.generals = [];
                this.daimyos = [];
                this.turnEvents = [];
                this.personnelEvents = []; // äººäº‹ãƒ­ã‚°ç”¨
                this.gameLog = [];
                this.diplomacyTreaties = {}; // å¤–äº¤å”å®šç®¡ç† {daimyoId: [ç›¸æ‰‹ã®daimyoIdé…åˆ—]}
                this.playerRoles = {
                    strategist: null,
                    diplomat: null,
                    administrator: null,
                    kenchiCommissioner: null, // æ¤œåœ°å¥‰è¡Œ
                    riceCommissioner: null, // ç±³å¥‰è¡Œ
                    townCommissioner: null, // ç”ºå¥‰è¡Œ
                    goldCommissioner: null, // é‡‘å¥‰è¡Œ
                    constructionCommissioner: null, // æ™®è«‹å¥‰è¡Œ
                    militaryCommissioner: null, // å…µå¥‰è¡Œ
                    armyStrategist: null,
                    vanguard: null,
                    rightWing: null,
                    leftWing: null,
                    reserve: null
                };
                this.aiRoles = {}; // AIå¤§åã®å½¹è·è¨­å®š
                this.availableGenerals = []; // ç™»ç”¨å¯èƒ½ãªæ­¦å°†
                this.yamashiroControl = {}; // å±±åŸæ”¯é…ã‚¿ãƒ¼ãƒ³æ•°ç®¡ç† {daimyoId: turnCount}
                this.tenkaninStatus = {}; // å¤©ä¸‹äººèªå®šçŠ¶æ³ {daimyoId: boolean}
                
                // é™£å½¢ã‚·ã‚¹ãƒ†ãƒ 
                this.formations = {
                    'gyorin': {
                        name: 'é­šé±—ã®é™£',
                        description: 'å®ˆå‚™é‡è¦–ã€‚ä¸­å¤®é›†ä¸­ã§é˜²å¾¡ãƒ»åæ’ƒã«å¼·ã„',
                        attackBonus: 5,
                        defenseBonus: 15,
                        advantages: ['ganko', 'choda'], // æœ‰åˆ©ãªé™£å½¢
                        disadvantages: ['kakuyoku', 'hoshi'] // ä¸åˆ©ãªé™£å½¢
                    },
                    'kakuyoku': {
                        name: 'é¶´ç¿¼ã®é™£',
                        description: 'åŒ…å›²å‹ã€‚ä¸¡ç¿¼å±•é–‹ã§ãƒãƒ©ãƒ³ã‚¹ãŒå–ã‚ŒãŸä¸‡èƒ½å‹',
                        attackBonus: 10,
                        defenseBonus: 10,
                        advantages: ['hoshi', 'gyorin'],
                        disadvantages: ['ganko', 'choda']
                    },
                    'hoshi': {
                        name: 'é‹’çŸ¢ã®é™£',
                        description: 'çªç ´å‹ã€‚ä¸€ç‚¹é›†ä¸­çªç ´ã§æ”»æ’ƒåŠ›ç‰¹åŒ–',
                        attackBonus: 20,
                        defenseBonus: 0,
                        advantages: ['gyorin', 'houen'],
                        disadvantages: ['kakuyoku', 'ganko']
                    },
                    'choda': {
                        name: 'é•·è›‡ã®é™£',
                        description: 'ç¸¦é•·ã€‚é€²è»ãƒ»çªæ’ƒå‘ãã€‚æ©Ÿå‹•æ€§é‡è¦–',
                        attackBonus: 15,
                        defenseBonus: 5,
                        advantages: ['kakuyoku', 'houen'],
                        disadvantages: ['gyorin', 'ganko']
                    },
                    'ganko': {
                        name: 'é›è¡Œã®é™£',
                        description: 'å¥‡è¥²å‘ãã€‚æ–œã‚å±•é–‹ã§æŸ”è»ŸãªéŠæ’ƒæˆ¦ã«å¼·ã„',
                        attackBonus: 12,
                        defenseBonus: 8,
                        advantages: ['kakuyoku', 'choda'],
                        disadvantages: ['gyorin', 'hoshi']
                    },
                    'houen': {
                        name: 'æ–¹å††ã®é™£',
                        description: 'å…¨æ–¹ä½é˜²å¾¡å‹ã€‚ç± åŸãƒ»å®ˆå‚™æˆ¦ã«å¼·ã„',
                        attackBonus: 0,
                        defenseBonus: 20,
                        advantages: ['ganko', 'hoshi'],
                        disadvantages: ['choda', 'gyorin']
                    }
                };
                this.selectedFormation = null; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒé¸æŠã—ãŸé™£å½¢
                this.currentBattle = null; // ç¾åœ¨ã®æˆ¦é—˜æƒ…å ±
                
                this.init();
            }
            
            init() {
                this.initializeDaimyos();
                this.initializeGenerals();
                this.initializeAvailableGenerals();
                this.initializeTerritories();
                this.setupAIGenerals();
            }
            
            initializeDaimyos() {
                this.daimyos = [
                    {
                        id: 'oda',
                        name: 'ç¹”ç”°ä¿¡é•·',
                        stats: { battle: 85, command: 88, politics: 95, intelligence: 90, charm: 93 },
                        skill: 'é©æ–°è€…',
                        startTerritory: 'owari',
                        preferredUnit: 'arquebus', // é‰„ç ²
                        gold: 1500,
                        rice: 800,
                        color: '#E63946' // é®®ã‚„ã‹ãªèµ¤
                    },
                    {
                        id: 'takeda',
                        name: 'æ­¦ç”°ä¿¡ç„',
                        stats: { battle: 90, command: 95, politics: 91, intelligence: 93, charm: 94 },
                        skill: 'é¢¨æ—ç«å±±',
                        startTerritory: 'kai',
                        preferredUnit: 'cavalry', // é¨é¦¬
                        gold: 1200,
                        rice: 700,
                        color: '#A8DADC' // ãƒ©ã‚¤ãƒˆãƒ–ãƒ«ãƒ¼/ã‚·ã‚¢ãƒ³
                    },
                    {
                        id: 'uesugi',
                        name: 'ä¸Šæ‰è¬™ä¿¡',
                        stats: { battle: 100, command: 96, politics: 78, intelligence: 82, charm: 95 },
                        skill: 'è»ç¥',
                        startTerritory: 'shinano',
                        preferredUnit: 'infantry', // æ­©å…µ
                        gold: 1000,
                        rice: 600,
                        color: '#457B9D' // ã‚¹ãƒãƒ¼ãƒ«ãƒ–ãƒ«ãƒ¼
                    },
                    {
                        id: 'tokugawa',
                        name: 'å¾³å·å®¶åº·',
                        stats: { battle: 85, command: 90, politics: 92, intelligence: 88, charm: 85 },
                        skill: 'å¿è€',
                        startTerritory: 'mikawa',
                        preferredUnit: 'infantry', // æ­©å…µ
                        gold: 1300,
                        rice: 750,
                        color: '#2A9D8F' // ãƒ†ã‚£ãƒ¼ãƒ«ã‚°ãƒªãƒ¼ãƒ³
                    },
                    {
                        id: 'hojo',
                        name: 'åŒ—æ¡æ°åº·',
                        stats: { battle: 86, command: 90, politics: 91, intelligence: 88, charm: 90 },
                        skill: 'é–¢æ±åˆ¶è¦‡',
                        startTerritory: 'kaga',
                        preferredUnit: 'infantry', // æ­©å…µ
                        gold: 1200,
                        rice: 700,
                        color: '#F4A261' // ã‚ªãƒ¬ãƒ³ã‚¸
                    },
                    {
                        id: 'mori',
                        name: 'æ¯›åˆ©å…ƒå°±',
                        stats: { battle: 78, command: 84, politics: 90, intelligence: 99, charm: 89 },
                        skill: 'è¬€å°†',
                        startTerritory: 'aki',
                        preferredUnit: 'arquebus', // é‰„ç ²
                        gold: 1000,
                        rice: 600,
                        color: '#1D3557' // ãƒ€ãƒ¼ã‚¯ãƒ–ãƒ«ãƒ¼
                    },
                    {
                        id: 'otomo',
                        name: 'å¤§å‹å®—éºŸ',
                        stats: { battle: 75, command: 80, politics: 85, intelligence: 78, charm: 80 },
                        skill: 'å—è›®è²¿æ˜“',
                        startTerritory: 'suruga',
                        preferredUnit: 'arquebus', // é‰„ç ²
                        gold: 1400,
                        rice: 700,
                        color: '#E76F51' // ã‚³ãƒ¼ãƒ©ãƒ«
                    },
                    {
                        id: 'shimazu',
                        name: 'å³¶æ´¥ç¾©ä¹…',
                        stats: { battle: 78, command: 88, politics: 93, intelligence: 82, charm: 91 },
                        skill: 'è–©æ‘©éš¼äºº',
                        startTerritory: 'bungo',
                        preferredUnit: 'cavalry', // é¨é¦¬
                        gold: 900,
                        rice: 500,
                        color: '#8D6A00' // ãƒ€ãƒ¼ã‚¯ã‚´ãƒ¼ãƒ«ãƒ‰/ãƒ–ãƒ©ã‚¦ãƒ³
                    },
                    {
                        id: 'date',
                        name: 'ä¼Šé”æ”¿å®—',
                        stats: { battle: 90, command: 88, politics: 82, intelligence: 85, charm: 92 },
                        skill: 'ç‹¬çœ¼ç«œ',
                        startTerritory: 'mutsu',
                        preferredUnit: 'cavalry', // é¨é¦¬
                        gold: 1000,
                        rice: 550,
                        color: '#6A0572' // ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ‘ãƒ¼ãƒ—ãƒ«
                    },
                    {
                        id: 'sanada',
                        name: 'çœŸç”°æ˜Œå¹¸',
                        stats: { battle: 78, command: 86, politics: 80, intelligence: 96, charm: 89 },
                        skill: 'è¡¨è£æ¯”èˆˆ',
                        startTerritory: 'echigo',
                        preferredUnit: 'infantry', // æ­©å…µ
                        gold: 800,
                        rice: 450,
                        color: '#7F5539' // ãƒ€ãƒ¼ã‚¯ãƒ–ãƒ©ã‚¦ãƒ³
                    },
                    {
                        id: 'hashiba',
                        name: 'ç¾½æŸ´ç§€å‰',
                        stats: { battle: 85, command: 90, politics: 95, intelligence: 88, charm: 98 },
                        skill: 'å¤©ä¸‹äºº',
                        startTerritory: 'harima',
                        preferredUnit: 'arquebus', // é‰„ç ²
                        gold: 1600,
                        rice: 900,
                        color: '#F7B267' // ãƒ©ã‚¤ãƒˆã‚ªãƒ¬ãƒ³ã‚¸
                    },
                    {
                        id: 'ryuzoji',
                        name: 'é¾é€ å¯ºéš†ä¿¡',
                        stats: { battle: 85, command: 88, politics: 82, intelligence: 85, charm: 80 },
                        skill: 'è‚¥å‰ã®ç†Š',
                        startTerritory: 'hizen',
                        preferredUnit: 'arquebus', // é‰„ç ²
                        gold: 1100,
                        rice: 600,
                        color: '#4CAF50' // ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆã‚°ãƒªãƒ¼ãƒ³
                    }
                ];
            }
            
            initializeAvailableGenerals() {
                // åˆæœŸã¯æµªäººãªã—
                this.availableGenerals = [];
                
                // é€šå¸¸æµªäººãƒ—ãƒ¼ãƒ«
                this.normalRonin = [
                    { id: 'ishida_mitsunari', name: 'çŸ³ç”°ä¸‰æˆ', stats: { battle: 56, command: 68, politics: 92, intelligence: 78, charm: 78 }, skill: 'è¡Œæ”¿ã®é¬¼', recruitCost: 100, baseCharm: 60 },
                    { id: 'kato_kiyomasa', name: 'åŠ è—¤æ¸…æ­£', stats: { battle: 86, command: 76, politics: 75, intelligence: 63, charm: 82 }, skill: 'ç¯‰åŸåäºº', recruitCost: 100, baseCharm: 70 },
                    { id: 'fukushima_masanori', name: 'ç¦å³¶æ­£å‰‡', stats: { battle: 87, command: 78, politics: 60, intelligence: 62, charm: 68 }, skill: 'çŒ›å°†', recruitCost: 100, baseCharm: 75 },
                    { id: 'yamanaka_shikanosuke', name: 'å±±ä¸­é¹¿ä¹‹ä»‹', stats: { battle: 84, command: 85, politics: 71, intelligence: 89, charm: 79 }, skill: 'ä¸ƒé›£å…«è‹¦', recruitCost: 100, baseCharm: 75 },
                    { id: 'akai_naomasa', name: 'èµ¤äº•ç›´æ­£', stats: { battle: 82, command: 81, politics: 68, intelligence: 75, charm: 80 }, skill: 'ä¸¹æ³¢ã®èµ¤é¬¼', recruitCost: 100, baseCharm: 70 },
                    { id: 'matsunaga_hisahide', name: 'æ¾æ°¸ä¹…ç§€', stats: { battle: 77, command: 79, politics: 82, intelligence: 90, charm: 75 }, skill: 'æ¢Ÿé›„', recruitCost: 100, baseCharm: 65 },
                    { id: 'gamo_ujisato', name: 'è’²ç”Ÿæ°éƒ·', stats: { battle: 81, command: 85, politics: 84, intelligence: 86, charm: 83 }, skill: 'ä¼šæ´¥ã®éº’éºŸå…', recruitCost: 100, baseCharm: 80 },
                    { id: 'saiga_magoichi', name: 'é›‘è³€å­«ä¸€', stats: { battle: 89, command: 80, politics: 70, intelligence: 78, charm: 81 }, skill: 'é‰„ç ²å¤§å°†', recruitCost: 100, baseCharm: 75 },
                    { id: 'shima_sakon', name: 'å³¶å·¦è¿‘', stats: { battle: 87, command: 88, politics: 72, intelligence: 79, charm: 88 }, skill: 'é¬¼å·¦è¿‘', recruitCost: 100, baseCharm: 70 },
                    { id: 'otani_yoshitsugu', name: 'å¤§è°·å‰ç¶™', stats: { battle: 85, command: 89, politics: 78, intelligence: 82, charm: 86 }, skill: 'ç™½é ­å·¾', recruitCost: 100, baseCharm: 75 },
                    { id: 'goto_matabei', name: 'å¾Œè—¤åˆå…µè¡›', stats: { battle: 88, command: 79, politics: 58, intelligence: 66, charm: 77 }, skill: 'é»’æ¯è¡£è¡†', recruitCost: 100, baseCharm: 65 },
                    { id: 'watanabe_kanbei', name: 'æ¸¡è¾ºå‹˜å…µè¡›', stats: { battle: 85, command: 74, politics: 49, intelligence: 52, charm: 78 }, skill: 'æ¸¡è¾ºã®æ§', recruitCost: 100, baseCharm: 70 },
                    { id: 'kimura_shigenari', name: 'æœ¨æ‘é‡æˆ', stats: { battle: 85, command: 78, politics: 65, intelligence: 72, charm: 88 }, skill: 'è‹¥æ­¦è€…', recruitCost: 100, baseCharm: 75 },
                    { id: 'sue_harutaka', name: 'é™¶æ™´è³¢', stats: { battle: 80, command: 76, politics: 72, intelligence: 78, charm: 66 }, skill: 'è¬€åã®å°†', recruitCost: 100, baseCharm: 70 },
                    { id: 'ota_sukemasa', name: 'å¤ªç”°è³‡æ­£', stats: { battle: 77, command: 74, politics: 68, intelligence: 80, charm: 64 }, skill: 'é–¢æ±ã®é©å°†', recruitCost: 100, baseCharm: 65 },
                    { id: 'tsugaru_tamenobu', name: 'æ´¥è»½ç‚ºä¿¡', stats: { battle: 74, command: 72, politics: 84, intelligence: 82, charm: 72 }, skill: 'å¥¥å·ã®æ¢Ÿé›„', recruitCost: 100, baseCharm: 75 },
                    { id: 'akaike_nagato', name: 'èµ¤æ± é•·ä»»', stats: { battle: 84, command: 76, politics: 60, intelligence: 70, charm: 66 }, skill: 'è¶Šå¾Œæ­¦å£«', recruitCost: 100, baseCharm: 70 },
                    { id: 'kuroda_nagamasa', name: 'é»’ç”°é•·æ”¿', stats: { battle: 81, command: 83, politics: 78, intelligence: 72, charm: 84 }, skill: 'å¦‚æ°´ã®å­', recruitCost: 100, baseCharm: 80 },
                    { id: 'konishi_yukinaga', name: 'å°è¥¿è¡Œé•·', stats: { battle: 68, command: 70, politics: 84, intelligence: 72, charm: 70 }, skill: 'å—è›®å•†äºº', recruitCost: 100, baseCharm: 75 },
                    { id: 'kanamori_nagachika', name: 'é‡‘æ£®é•·è¿‘', stats: { battle: 60, command: 62, politics: 78, intelligence: 76, charm: 70 }, skill: 'é£›é¨¨å®ˆ', recruitCost: 100, baseCharm: 70 },
                    { id: 'kani_yoshinaga', name: 'å¯å…å‰é•·', stats: { battle: 84, command: 74, politics: 52, intelligence: 60, charm: 72 }, skill: 'ç¬¹ã®æ‰è”µ', recruitCost: 100, baseCharm: 65 },
                    { id: 'inaba_ittetsu', name: 'ç¨²è‘‰ä¸€é‰„', stats: { battle: 78, command: 72, politics: 66, intelligence: 64, charm: 66 }, skill: 'ç¾æ¿ƒä¸‰äººè¡†', recruitCost: 100, baseCharm: 70 },
                    { id: 'ando_morinari', name: 'å®‰è—¤å®ˆå°±', stats: { battle: 70, command: 74, politics: 74, intelligence: 68, charm: 74 }, skill: 'ç¾æ¿ƒä¸‰äººè¡†', recruitCost: 100, baseCharm: 70 },
                    { id: 'ujiie_bokuzen', name: 'æ°å®¶åœå…¨', stats: { battle: 77, command: 75, politics: 68, intelligence: 63, charm: 66 }, skill: 'ç¾æ¿ƒä¸‰äººè¡†', recruitCost: 100, baseCharm: 70 },
                    { id: 'kuki_yoshitaka', name: 'ä¹é¬¼å˜‰éš†', stats: { battle: 74, command: 80, politics: 66, intelligence: 68, charm: 72 }, skill: 'æ°´è»å¤§å°†', recruitCost: 100, baseCharm: 75 },
                    { id: 'todo_takatora', name: 'è—¤å ‚é«˜è™', stats: { battle: 78, command: 87, politics: 82, intelligence: 79, charm: 80 }, skill: 'ç¯‰åŸã®åæ‰‹', recruitCost: 100, baseCharm: 80 }
                ];
                
                // ãƒ¬ã‚¢æµªäººãƒ—ãƒ¼ãƒ«
                this.rareRonin = [
                    { id: 'shirai_tanenao', name: 'ç™½äº•èƒ¤æ²»', stats: { battle: 75, command: 92, politics: 85, intelligence: 98, charm: 88 }, skill: 'è‡¼äº•ã®å¥‡ç­–', recruitCost: 100, baseCharm: 75 },
                    { id: 'maeda_keiji', name: 'å‰ç”°æ…¶æ¬¡', stats: { battle: 90, command: 80, politics: 60, intelligence: 75, charm: 95 }, skill: 'å‚¾å¥‡è€…', recruitCost: 100, baseCharm: 85 },
                    { id: 'miyamoto_musashi', name: 'å®®æœ¬æ­¦è”µ', stats: { battle: 94, command: 70, politics: 30, intelligence: 69, charm: 75 }, skill: 'äºŒåˆ€æµ', recruitCost: 100, baseCharm: 90 },
                    { id: 'yagyu_jubei', name: 'æŸ³ç”Ÿåå…µè¡›', stats: { battle: 93, command: 65, politics: 60, intelligence: 68, charm: 80 }, skill: 'éš»çœ¼ã®å‰£å£«', recruitCost: 100, baseCharm: 80 },
                    { id: 'asakura_soteki', name: 'æœå€‰å®—æ»´', stats: { battle: 90, command: 92, politics: 69, intelligence: 77, charm: 88 }, skill: 'ä¸€ä¹—è°·ã®é¬¼', recruitCost: 100, baseCharm: 75 },
                    { id: 'taigen_sessai', name: 'å¤ªåŸé›ªæ–', stats: { battle: 70, command: 88, politics: 96, intelligence: 91, charm: 87 }, skill: 'ä»Šå·è»å¸«', recruitCost: 100, baseCharm: 80 }
                ];
            }
            
            initializeGenerals() {
                this.generals = [
                    // ç¹”ç”°å®¶
                    { id: 'akechi', name: 'æ˜æ™ºå…‰ç§€', lord: 'oda', stats: { battle: 78, command: 89, politics: 87, intelligence: 91, charm: 80 }, skill: 'è¬€å', loyalty: 70 },
                    { id: 'shibata', name: 'æŸ´ç”°å‹å®¶', lord: 'oda', stats: { battle: 90, command: 85, politics: 69, intelligence: 66, charm: 74 }, skill: 'é¬¼æŸ´ç”°', loyalty: 90 },
                    { id: 'niwa', name: 'ä¸¹ç¾½é•·ç§€', lord: 'oda', stats: { battle: 79, command: 80, politics: 84, intelligence: 77, charm: 84 }, skill: 'ç±³äº”éƒå·¦', loyalty: 95 },
                    { id: 'takigawa', name: 'æ»å·ä¸€ç›Š', lord: 'oda', stats: { battle: 86, command: 75, politics: 76, intelligence: 78, charm: 76 }, skill: 'é–¢æ±ç®¡é ˜', loyalty: 88 },
                    { id: 'sassa', name: 'ä½ã€…æˆæ”¿', lord: 'oda', stats: { battle: 85, command: 77, politics: 60, intelligence: 68, charm: 68 }, skill: 'é»’æ¯è¡£è¡†', loyalty: 90 },
                    { id: 'maeda_toshiie', name: 'å‰ç”°åˆ©å®¶', lord: 'oda', stats: { battle: 84, command: 76, politics: 88, intelligence: 72, charm: 88 }, skill: 'æ§ã®åˆå·¦', loyalty: 92 },
                    { id: 'mori_ranmaru', name: 'æ£®è˜­ä¸¸', lord: 'oda', stats: { battle: 76, command: 72, politics: 66, intelligence: 70, charm: 84 }, skill: 'å°å§“é ­', loyalty: 99 },
                    { id: 'ikeda', name: 'æ± ç”°æ’èˆˆ', lord: 'oda', stats: { battle: 72, command: 78, politics: 70, intelligence: 65, charm: 74 }, skill: 'ä¹³å…„å¼Ÿ', loyalty: 95 },
                    { id: 'hosokawa_fujitaka', name: 'ç´°å·è—¤å­', lord: 'oda', stats: { battle: 70, command: 76, politics: 88, intelligence: 87, charm: 78 }, skill: 'å¹½æ–', loyalty: 80 },
                    { id: 'oda_nobutada', name: 'ç¹”ç”°ä¿¡å¿ ', lord: 'oda', stats: { battle: 82, command: 84, politics: 74, intelligence: 76, charm: 87 }, skill: 'å«¡ç”·', loyalty: 99 },
                    { id: 'murai_sadakatsu', name: 'æ‘äº•è²å‹', lord: 'oda', stats: { battle: 50, command: 56, politics: 86, intelligence: 78, charm: 64 }, skill: 'äº¬éƒ½æ‰€å¸ä»£', loyalty: 95 },
                    
                    // æ­¦ç”°å®¶
                    { id: 'takeda_nobushige', name: 'æ­¦ç”°ä¿¡ç¹', lord: 'takeda', stats: { battle: 84, command: 88, politics: 78, intelligence: 79, charm: 92 }, skill: 'å‰¯å°†', loyalty: 99 },
                    { id: 'takeda_katsuyori', name: 'æ­¦ç”°å‹é ¼', lord: 'takeda', stats: { battle: 86, command: 82, politics: 60, intelligence: 68, charm: 72 }, skill: 'è«è¨ªå‹é ¼', loyalty: 95 },
                    { id: 'takeda_nobukado', name: 'æ­¦ç”°ä¿¡å»‰', lord: 'takeda', stats: { battle: 60, command: 68, politics: 74, intelligence: 72, charm: 66 }, skill: 'å½±æ­¦è€…', loyalty: 95 },
                    { id: 'yamagata', name: 'å±±çœŒæ˜Œæ™¯', lord: 'takeda', stats: { battle: 93, command: 90, politics: 69, intelligence: 70, charm: 84 }, skill: 'èµ¤å‚™ãˆ', loyalty: 90 },
                    { id: 'baba', name: 'é¦¬å ´ä¿¡æ˜¥', lord: 'takeda', stats: { battle: 90, command: 92, politics: 74, intelligence: 76, charm: 82 }, skill: 'ä¸æ­»èº«', loyalty: 92 },
                    { id: 'naito', name: 'å†…è—¤æ˜Œè±Š', lord: 'takeda', stats: { battle: 88, command: 85, politics: 58, intelligence: 68, charm: 79 }, skill: 'æ­¦ç”°å››å¤©ç‹', loyalty: 90 },
                    { id: 'kosaka', name: 'é«˜å‚æ˜Œä¿¡', lord: 'takeda', stats: { battle: 84, command: 93, politics: 70, intelligence: 82, charm: 84 }, skill: 'é€ƒã’å¼¾æ­£', loyalty: 95 },
                    { id: 'oyamada', name: 'å°å±±ç”°ä¿¡èŒ‚', lord: 'takeda', stats: { battle: 78, command: 74, politics: 64, intelligence: 68, charm: 66 }, skill: 'éƒ¡å†…é ˜ä¸»', loyalty: 65 },
                    { id: 'amari', name: 'ç”˜åˆ©è™æ³°', lord: 'takeda', stats: { battle: 82, command: 80, politics: 55, intelligence: 65, charm: 70 }, skill: 'æ­¦ç”°é‡è‡£', loyalty: 88 },
                    { id: 'yamamoto_kansuke', name: 'å±±æœ¬å‹˜åŠ©', lord: 'takeda', stats: { battle: 81, command: 76, politics: 72, intelligence: 94, charm: 69 }, skill: 'å•„æœ¨é³¥æˆ¦æ³•', loyalty: 95 },
                    { id: 'hara_toratane', name: 'åŸè™èƒ¤', lord: 'takeda', stats: { battle: 89, command: 84, politics: 50, intelligence: 60, charm: 68 }, skill: 'æ­¦ç”°å®¿è€', loyalty: 92 },
                    { id: 'iitomi_toramasa', name: 'é£¯å¯Œè™æ˜Œ', lord: 'takeda', stats: { battle: 86, command: 80, politics: 52, intelligence: 60, charm: 80 }, skill: 'èµ¤å‚™ãˆã®ç¥–', loyalty: 90 },
                    { id: 'sanada_yukitaka', name: 'çœŸç”°å¹¸éš†', lord: 'takeda', stats: { battle: 72, command: 78, politics: 68, intelligence: 92, charm: 76 }, skill: 'æ”»ã‚å¼¾æ­£', loyalty: 88 },
                    { id: 'nagasaka_chokansai', name: 'é•·å‚é‡£é–‘æ–', lord: 'takeda', stats: { battle: 69, command: 78, politics: 83, intelligence: 79, charm: 68 }, skill: 'æ­¦ç”°è»å­¦', loyalty: 90 },
                    { id: 'itagaki_nobukata', name: 'æ¿å£ä¿¡æ–¹', lord: 'takeda', stats: { battle: 74, command: 82, politics: 80, intelligence: 72, charm: 75 }, skill: 'ç”²å·æ³•åº¦', loyalty: 95 },
                    { id: 'anayama_baisetsu', name: 'ç©´å±±æ¢…é›ª', lord: 'takeda', stats: { battle: 61, command: 70, politics: 80, intelligence: 76, charm: 67 }, skill: 'æ²³å†…å®ˆ', loyalty: 75 },
                    { id: 'akiyama_torashige', name: 'ç§‹å±±è™ç¹', lord: 'takeda', stats: { battle: 79, command: 76, politics: 68, intelligence: 71, charm: 72 }, skill: 'å²©æ‘åŸä¸»', loyalty: 88 },
                    { id: 'nishina_morinobu', name: 'ä»ç§‘ç››ä¿¡', lord: 'takeda', stats: { battle: 78, command: 77, politics: 50, intelligence: 62, charm: 72 }, skill: 'é«˜é åŸä¸»', loyalty: 99 },
                    { id: 'tsuchiya_masatsune', name: 'åœŸå±‹æ˜Œæ’', lord: 'takeda', stats: { battle: 80, command: 76, politics: 45, intelligence: 58, charm: 64 }, skill: 'ç‰‡æ‰‹åƒäººæ–¬', loyalty: 92 },
                    
                    // ä¸Šæ‰å®¶
                    { id: 'naoe', name: 'ç›´æ±Ÿå…¼ç¶š', lord: 'uesugi', stats: { battle: 78, command: 85, politics: 94, intelligence: 91, charm: 90 }, skill: 'æ„›ã®å­—', loyalty: 95 },
                    { id: 'naoe_kagetsuna', name: 'ç›´æ±Ÿæ™¯ç¶±', lord: 'uesugi', stats: { battle: 70, command: 76, politics: 84, intelligence: 82, charm: 75 }, skill: 'ä¸Šæ‰åŸ·æ”¿', loyalty: 95 },
                    { id: 'kakizaki', name: 'æŸ¿å´æ™¯å®¶', lord: 'uesugi', stats: { battle: 86, command: 82, politics: 68, intelligence: 70, charm: 72 }, skill: 'å…ˆé™£', loyalty: 88 },
                    { id: 'uesugi_kagekatsu', name: 'ä¸Šæ‰æ™¯å‹', lord: 'uesugi', stats: { battle: 76, command: 82, politics: 85, intelligence: 84, charm: 95 }, skill: 'ç„¡è¨€', loyalty: 99 },
                    { id: 'nagano_narimasa', name: 'é•·é‡æ¥­æ­£', lord: 'uesugi', stats: { battle: 84, command: 96, politics: 78, intelligence: 80, charm: 85 }, skill: 'ä¸Šé‡ã®é»„æ–‘', loyalty: 88 },
                    { id: 'irobe', name: 'è‰²éƒ¨å‹é•·', lord: 'uesugi', stats: { battle: 74, command: 78, politics: 70, intelligence: 72, charm: 68 }, skill: 'è‰²éƒ¨å‹¢', loyalty: 90 },
                    { id: 'honjo', name: 'æœ¬åº„ç¹é•·', lord: 'uesugi', stats: { battle: 80, command: 76, politics: 66, intelligence: 70, charm: 70 }, skill: 'æœ¬åº„å‹¢', loyalty: 85 },
                    { id: 'saito_tomonobu', name: 'æ–è—¤æœä¿¡', lord: 'uesugi', stats: { battle: 77, command: 76, politics: 68, intelligence: 74, charm: 69 }, skill: 'ä¸‹è¶Šå®ˆè­·', loyalty: 88 },
                    { id: 'shibata_shigeie', name: 'æ–°ç™ºç”°é‡å®¶', lord: 'uesugi', stats: { battle: 82, command: 74, politics: 60, intelligence: 66, charm: 65 }, skill: 'æ–°ç™ºç”°å‹¢', loyalty: 70 },
                    { id: 'murakami', name: 'æ‘ä¸Šç¾©æ¸…', lord: 'uesugi', stats: { battle: 88, command: 84, politics: 64, intelligence: 70, charm: 74 }, skill: 'ä¿¡æ¿ƒæ­¦å£«', loyalty: 85 },
                    { id: 'usami_sadamitsu', name: 'å®‡ä½è¦‹å®šæº€', lord: 'uesugi', stats: { battle: 65, command: 70, politics: 88, intelligence: 92, charm: 76 }, skill: 'ä¸Šæ‰é‡è‡£', loyalty: 92 },
                    { id: 'onijima_yatarou', name: 'é¬¼å°å³¶å¼¥å¤ªéƒ', lord: 'uesugi', stats: { battle: 94, command: 75, politics: 40, intelligence: 50, charm: 60 }, skill: 'é¬¼å°å³¶', loyalty: 95 },
                    
                    // å¾³å·å®¶
                    { id: 'honda_tadakatsu', name: 'æœ¬å¤šå¿ å‹', lord: 'tokugawa', stats: { battle: 97, command: 85, politics: 55, intelligence: 60, charm: 88 }, skill: 'ç„¡å‚·', loyalty: 95 },
                    { id: 'sakai', name: 'é…’äº•å¿ æ¬¡', lord: 'tokugawa', stats: { battle: 76, command: 79, politics: 81, intelligence: 75, charm: 74 }, skill: 'å®¿è€', loyalty: 95 },
                    { id: 'ishikawa', name: 'çŸ³å·æ•°æ­£', lord: 'tokugawa', stats: { battle: 65, command: 72, politics: 84, intelligence: 86, charm: 65 }, skill: 'èª¿æ•´', loyalty: 75 },
                    { id: 'sakakibara', name: 'æ¦ŠåŸåº·æ”¿', lord: 'tokugawa', stats: { battle: 82, command: 84, politics: 77, intelligence: 72, charm: 76 }, skill: 'å¾³å·å››å¤©ç‹', loyalty: 95 },
                    { id: 'ii_naomasa', name: 'äº•ä¼Šç›´æ”¿', lord: 'tokugawa', stats: { battle: 84, command: 83, politics: 78, intelligence: 70, charm: 87 }, skill: 'èµ¤é¬¼', loyalty: 95 },
                    { id: 'matsudaira_nobutsuna', name: 'æ¾å¹³ä¿¡ç¶±', lord: 'tokugawa', stats: { battle: 66, command: 74, politics: 88, intelligence: 90, charm: 89 }, skill: 'çŸ¥æµä¼Šè±†', loyalty: 90 },
                    { id: 'okubo', name: 'å¤§ä¹…ä¿å¿ ä¸–', lord: 'tokugawa', stats: { battle: 78, command: 76, politics: 70, intelligence: 68, charm: 68 }, skill: 'ä¸‰æ²³æ­¦å£«', loyalty: 95 },
                    { id: 'hiraiwa', name: 'å¹³å²©è¦ªå‰', lord: 'tokugawa', stats: { battle: 70, command: 72, politics: 66, intelligence: 65, charm: 64 }, skill: 'å¾³å·è­œä»£', loyalty: 95 },
                    { id: 'torii', name: 'é³¥å±…å…ƒå¿ ', lord: 'tokugawa', stats: { battle: 80, command: 78, politics: 60, intelligence: 62, charm: 86 }, skill: 'ä¼è¦‹åŸ', loyalty: 99 },
                    { id: 'hattori', name: 'æœéƒ¨åŠè”µ', lord: 'tokugawa', stats: { battle: 84, command: 70, politics: 55, intelligence: 83, charm: 60 }, skill: 'å¿è€…é ­', loyalty: 90 },
                    
                    // åŒ—æ¡å®¶
                    { id: 'hojo_ujiteru', name: 'åŒ—æ¡æ°ç…§', lord: 'hojo', stats: { battle: 79, command: 80, politics: 72, intelligence: 74, charm: 76 }, skill: 'æ»å±±åŸä¸»', loyalty: 95 },
                    { id: 'hojo_ujikuni', name: 'åŒ—æ¡æ°é‚¦', lord: 'hojo', stats: { battle: 78, command: 79, politics: 68, intelligence: 70, charm: 72 }, skill: 'é‰¢å½¢åŸä¸»', loyalty: 95 },
                    { id: 'toyama_tsunakage', name: 'é å±±ç¶±æ™¯', lord: 'hojo', stats: { battle: 76, command: 78, politics: 65, intelligence: 68, charm: 66 }, skill: 'ä¸Šé‡è¡†', loyalty: 88 },
                    { id: 'hojo_ujimasa', name: 'åŒ—æ¡æ°æ”¿', lord: 'hojo', stats: { battle: 72, command: 78, politics: 74, intelligence: 76, charm: 84 }, skill: 'ç¶™æ‰¿è€…', loyalty: 95 },
                    { id: 'matsuda', name: 'æ¾ç”°æ†²ç§€', lord: 'hojo', stats: { battle: 66, command: 72, politics: 80, intelligence: 78, charm: 64 }, skill: 'å†…æ”¿', loyalty: 88 },
                    { id: 'hojo_ujinao', name: 'åŒ—æ¡æ°ç›´', lord: 'hojo', stats: { battle: 70, command: 74, politics: 76, intelligence: 74, charm: 80 }, skill: 'è‹¥æ®¿', loyalty: 95 },
                    { id: 'daidoji', name: 'å¤§é“å¯ºæ”¿ç¹', lord: 'hojo', stats: { battle: 82, command: 84, politics: 68, intelligence: 72, charm: 78 }, skill: 'é–¢æ±ã®é¬¼', loyalty: 90 },
                    { id: 'narita', name: 'æˆç”°æ°é•·', lord: 'hojo', stats: { battle: 80, command: 78, politics: 66, intelligence: 70, charm: 68 }, skill: 'å¿åŸä¸»', loyalty: 85 },
                    { id: 'ota_ujisuke', name: 'å¤ªç”°æ°è³‡', lord: 'hojo', stats: { battle: 68, command: 72, politics: 78, intelligence: 80, charm: 66 }, skill: 'æ±Ÿæˆ¸åŸä¸»', loyalty: 88 },
                    { id: 'shimizu', name: 'æ¸…æ°´åº·è‹±', lord: 'hojo', stats: { battle: 64, command: 68, politics: 74, intelligence: 76, charm: 62 }, skill: 'åŒ—æ¡é‡è‡£', loyalty: 90 },
                    { id: 'hojo_tsunashige', name: 'åŒ—æ¡ç¶±æˆ', lord: 'hojo', stats: { battle: 91, command: 88, politics: 60, intelligence: 65, charm: 78 }, skill: 'åœ°é»„å…«å¹¡', loyalty: 95 },
                    { id: 'fuma_kotaro', name: 'é¢¨é­”å°å¤ªéƒ', lord: 'hojo', stats: { battle: 82, command: 70, politics: 50, intelligence: 85, charm: 60 }, skill: 'é¢¨é­”å¿è¡“', loyalty: 88 },
                    { id: 'itabeoka_sessai', name: 'æ¿éƒ¨å²¡æ±Ÿé›ªæ–', lord: 'hojo', stats: { battle: 58, command: 66, politics: 86, intelligence: 74, charm: 72 }, skill: 'å¤–äº¤åƒ§', loyalty: 90 },
                    { id: 'hojo_genan', name: 'åŒ—æ¡ç„åºµ', lord: 'hojo', stats: { battle: 52, command: 64, politics: 85, intelligence: 81, charm: 87 }, skill: 'ååŒ»', loyalty: 92 },
                    
                    // æ¯›åˆ©å®¶
                    { id: 'mori_takamoto', name: 'æ¯›åˆ©éš†å…ƒ', lord: 'mori', stats: { battle: 72, command: 78, politics: 82, intelligence: 80, charm: 83 }, skill: 'å«¡ç”·', loyalty: 99 },
                    { id: 'mori_terumoto', name: 'æ¯›åˆ©è¼å…ƒ', lord: 'mori', stats: { battle: 66, command: 74, politics: 85, intelligence: 76, charm: 82 }, skill: 'ä¸­å›½å¤§å', loyalty: 98 },
                    { id: 'kobayakawa', name: 'å°æ—©å·éš†æ™¯', lord: 'mori', stats: { battle: 78, command: 86, politics: 90, intelligence: 92, charm: 91 }, skill: 'ä¸¡å·', loyalty: 90 },
                    { id: 'kikkawa', name: 'å‰å·å…ƒæ˜¥', lord: 'mori', stats: { battle: 91, command: 88, politics: 70, intelligence: 74, charm: 81 }, skill: 'å‹‡çŒ›', loyalty: 92 },
                    { id: 'ankokuji', name: 'å®‰å›½å¯ºæµç“Š', lord: 'mori', stats: { battle: 50, command: 62, politics: 88, intelligence: 90, charm: 70 }, skill: 'å¤–äº¤åƒ§', loyalty: 85 },
                    { id: 'fukuhara', name: 'ç¦åŸè²ä¿Š', lord: 'mori', stats: { battle: 72, command: 76, politics: 70, intelligence: 74, charm: 66 }, skill: 'æ¯›åˆ©é‡è‡£', loyalty: 90 },
                    { id: 'kuchiba', name: 'å£ç¾½é€šè‰¯', lord: 'mori', stats: { battle: 74, command: 78, politics: 66, intelligence: 70, charm: 65 }, skill: 'çŸ³è¦‹å®ˆè­·', loyalty: 88 },
                    { id: 'katsura', name: 'æ¡‚å…ƒæ¾„', lord: 'mori', stats: { battle: 76, command: 74, politics: 68, intelligence: 72, charm: 64 }, skill: 'æ¡‚å‹¢', loyalty: 85 },
                    { id: 'sugi', name: 'æ¤™æœéš†åº·', lord: 'mori', stats: { battle: 70, command: 68, politics: 60, intelligence: 65, charm: 62 }, skill: 'å±±é™°é“', loyalty: 88 },
                    { id: 'shimizu_muneharu', name: 'æ¸…æ°´å®—æ²»', lord: 'mori', stats: { battle: 80, command: 82, politics: 62, intelligence: 68, charm: 85 }, skill: 'å¿ ç¾©ã®å£«', loyalty: 99 },
                    { id: 'fukuhara_hirotoshi', name: 'ç¦åŸåºƒä¿Š', lord: 'mori', stats: { battle: 68, command: 72, politics: 70, intelligence: 72, charm: 66 }, skill: 'æ¯›åˆ©å®¶è€', loyalty: 88 },
                    { id: 'shishido_takaiie', name: 'å®æˆ¸éš†å®¶', lord: 'mori', stats: { battle: 74, command: 73, politics: 64, intelligence: 68, charm: 63 }, skill: 'å®æˆ¸å‹¢', loyalty: 86 },
                    { id: 'kodama_narahide', name: 'å…ç‰å°±è‹±', lord: 'mori', stats: { battle: 70, command: 70, politics: 58, intelligence: 66, charm: 60 }, skill: 'å‚™å¾Œè¡†', loyalty: 84 },
                    { id: 'amano_takashige', name: 'å¤©é‡éš†é‡', lord: 'mori', stats: { battle: 72, command: 74, politics: 64, intelligence: 68, charm: 62 }, skill: 'éŠ€å±±è¡†', loyalty: 87 },
                    
                    // å¤§å‹å®¶
                    { id: 'tachibana_dosetsu', name: 'ç«‹èŠ±é“é›ª', lord: 'otomo', stats: { battle: 88, command: 98, politics: 80, intelligence: 85, charm: 88 }, skill: 'é›·ç¥', loyalty: 90 },
                    { id: 'takahashi', name: 'é«˜æ©‹ç´¹é‹', lord: 'otomo', stats: { battle: 85, command: 90, politics: 78, intelligence: 80, charm: 85 }, skill: 'å¿ è‡£', loyalty: 95 },
                    { id: 'yoshihiro_akizuki', name: 'å‰å¼˜é‘‘ç†', lord: 'otomo', stats: { battle: 74, command: 72, politics: 68, intelligence: 70, charm: 66 }, skill: 'å¤§å‹é‡è‡£', loyalty: 88 },
                    { id: 'usuki', name: 'è‡¼æµé‘‘é€Ÿ', lord: 'otomo', stats: { battle: 66, command: 70, politics: 72, intelligence: 68, charm: 64 }, skill: 'è±Šå¾Œå‹¢', loyalty: 90 },
                    { id: 'takita', name: 'ç”°åŒ—é‘‘é‡', lord: 'otomo', stats: { battle: 72, command: 70, politics: 58, intelligence: 62, charm: 62 }, skill: 'è‚¥å¾Œè¡†', loyalty: 85 },
                    { id: 'tsunokuma', name: 'è§’éšˆçŸ³å®—', lord: 'otomo', stats: { battle: 45, command: 58, politics: 86, intelligence: 79, charm: 84 }, skill: 'è±Šå¾Œä¸‰è€', loyalty: 88 },
                    { id: 'kai_soun', name: 'ç”²æ–å®—é‹', lord: 'otomo', stats: { battle: 65, command: 72, politics: 76, intelligence: 85, charm: 76 }, skill: 'ç«‹èŠ±é“é›ªé¤Šå­', loyalty: 92 },

                    { id: 'tachibana_muneshige', name: 'ç«‹èŠ±å®—èŒ‚', lord: 'otomo', stats: { battle: 95, command: 92, politics: 82, intelligence: 85, charm: 88 }, skill: 'è¥¿å›½ç„¡åŒ', loyalty: 90 },
                    
                    // å³¶æ´¥å®¶
                    { id: 'shimazu_yoshihiro', name: 'å³¶æ´¥ç¾©å¼˜', lord: 'shimazu', stats: { battle: 89, command: 95, politics: 75, intelligence: 80, charm: 92 }, skill: 'é¬¼å³¶æ´¥', loyalty: 95 },
                    { id: 'shimazu_iehisa', name: 'å³¶æ´¥å®¶ä¹…', lord: 'shimazu', stats: { battle: 92, command: 89, politics: 68, intelligence: 76, charm: 80 }, skill: 'æ™ºå°†', loyalty: 95 },
                    { id: 'shimazu_toyohisa', name: 'å³¶æ´¥è±Šä¹…', lord: 'shimazu', stats: { battle: 81, command: 78, politics: 56, intelligence: 62, charm: 79 }, skill: 'è‹¥æ­¦è€…', loyalty: 95 },
                    { id: 'niiro', name: 'æ–°ç´å¿ å…ƒ', lord: 'shimazu', stats: { battle: 82, command: 78, politics: 60, intelligence: 64, charm: 68 }, skill: 'è–©æ‘©å‹¢', loyalty: 90 },
                    { id: 'ijuin', name: 'ä¼Šé›†é™¢å¿ æ£Ÿ', lord: 'shimazu', stats: { battle: 76, command: 74, politics: 65, intelligence: 68, charm: 66 }, skill: 'å³¶æ´¥é‡è‡£', loyalty: 85 },
                    { id: 'kabayama', name: 'æ¨ºå±±ä¹…é«˜', lord: 'shimazu', stats: { battle: 70, command: 72, politics: 72, intelligence: 70, charm: 64 }, skill: 'æ¨ºå±±å‹¢', loyalty: 88 },
                    { id: 'ei', name: 'é ´å¨ƒä¹…è™', lord: 'shimazu', stats: { battle: 74, command: 70, politics: 58, intelligence: 60, charm: 62 }, skill: 'è–©æ‘©æ­¦å£«', loyalty: 90 },
                    { id: 'shimazu_toshihisa', name: 'å³¶æ´¥æ­³ä¹…', lord: 'shimazu', stats: { battle: 86, command: 84, politics: 66, intelligence: 80, charm: 74 }, skill: 'è–©æ‘©ã®å‰¯å°†', loyalty: 95 },
                    
                    // ä¼Šé”å®¶
                    { id: 'katakura', name: 'ç‰‡å€‰æ™¯ç¶±', lord: 'date', stats: { battle: 84, command: 88, politics: 75, intelligence: 82, charm: 85 }, skill: 'è»å¸«', loyalty: 95 },
                    { id: 'date_shigezane', name: 'ä¼Šé”æˆå®Ÿ', lord: 'date', stats: { battle: 90, command: 85, politics: 60, intelligence: 70, charm: 78 }, skill: 'å‹‡å°†', loyalty: 90 },
                    { id: 'shigeta', name: 'ç•™å®ˆæ”¿æ™¯', lord: 'date', stats: { battle: 68, command: 72, politics: 76, intelligence: 78, charm: 70 }, skill: 'ä¼Šé”é‡è‡£', loyalty: 88 },
                    { id: 'harada', name: 'åŸç”°å®—æ™‚', lord: 'date', stats: { battle: 78, command: 74, politics: 55, intelligence: 66, charm: 68 }, skill: 'æ§å¥‰è¡Œ', loyalty: 85 },
                    { id: 'shiroishi', name: 'ç™½çŸ³å®—å®Ÿ', lord: 'date', stats: { battle: 72, command: 70, politics: 58, intelligence: 64, charm: 60 }, skill: 'ç™½çŸ³å‹¢', loyalty: 88 },
                    { id: 'oniniwa', name: 'é¬¼åº­ç¶±å…ƒ', lord: 'date', stats: { battle: 82, command: 80, politics: 62, intelligence: 68, charm: 72 }, skill: 'é¬¼åº­å‹¢', loyalty: 90 },
                    { id: 'endo', name: 'é è—¤åŸºä¿¡', lord: 'date', stats: { battle: 60, command: 68, politics: 88, intelligence: 71, charm: 74 }, skill: 'å±±å½¢åŸä¸»', loyalty: 85 },
                    
                    // çœŸç”°å®¶
                    { id: 'sanada_nobuyuki', name: 'çœŸç”°ä¿¡ä¹‹', lord: 'sanada', stats: { battle: 70, command: 78, politics: 89, intelligence: 77, charm: 89 }, skill: 'å…„å¼Ÿã®çµ†', loyalty: 95 },
                    { id: 'sanada_yukimura', name: 'çœŸç”°å¹¸æ‘', lord: 'sanada', stats: { battle: 91, command: 98, politics: 70, intelligence: 88, charm: 91 }, skill: 'æ—¥æœ¬ä¸€ã®å…µ', loyalty: 99 },
                    { id: 'sarutobi_sasuke', name: 'çŒ¿é£›ä½åŠ©', lord: 'sanada', stats: { battle: 84, command: 74, politics: 50, intelligence: 82, charm: 70 }, skill: 'å¿è¡“ã®æ¥µæ„', loyalty: 90 },
                    { id: 'kirigakure_saizo', name: 'éœ§éš æ‰è”µ', lord: 'sanada', stats: { battle: 82, command: 72, politics: 48, intelligence: 80, charm: 68 }, skill: 'éœ§éš ã‚Œ', loyalty: 85 },
                    { id: 'anayama_kosuke', name: 'ç©´å±±å°åŠ©', lord: 'sanada', stats: { battle: 78, command: 70, politics: 46, intelligence: 68, charm: 64 }, skill: 'åå‹‡å£«', loyalty: 88 },
                    { id: 'unno_rokuro', name: 'æµ·é‡å…­éƒ', lord: 'sanada', stats: { battle: 80, command: 72, politics: 52, intelligence: 66, charm: 65 }, skill: 'åå‹‡å£«', loyalty: 90 },
                    { id: 'nezu_jinpachi', name: 'æ ¹æ´¥ç”šå…«', lord: 'sanada', stats: { battle: 76, command: 68, politics: 44, intelligence: 64, charm: 62 }, skill: 'åå‹‡å£«', loyalty: 92 },
                    { id: 'yuri_kamanosuke', name: 'ç”±åˆ©éŒä¹‹åŠ©', lord: 'sanada', stats: { battle: 78, command: 70, politics: 48, intelligence: 66, charm: 63 }, skill: 'åå‹‡å£«', loyalty: 87 },
                    { id: 'kakei_juzo', name: 'ç­§åè”µ', lord: 'sanada', stats: { battle: 75, command: 70, politics: 60, intelligence: 68, charm: 66 }, skill: 'åå‹‡å£«', loyalty: 89 },
                    { id: 'mochizuki_rokuro', name: 'æœ›æœˆå…­éƒ', lord: 'sanada', stats: { battle: 72, command: 66, politics: 54, intelligence: 64, charm: 60 }, skill: 'åå‹‡å£«', loyalty: 85 },
                    { id: 'miyoshi_isa', name: 'ä¸‰å¥½ä¼Šä¸‰', lord: 'sanada', stats: { battle: 74, command: 68, politics: 50, intelligence: 65, charm: 62 }, skill: 'åå‹‡å£«', loyalty: 88 },
                    { id: 'miyoshi_seikai', name: 'ä¸‰å¥½æ¸…æµ·', lord: 'sanada', stats: { battle: 76, command: 70, politics: 46, intelligence: 60, charm: 61 }, skill: 'åå‹‡å£«', loyalty: 90 },
                    
                    // ç¾½æŸ´å®¶
                    { id: 'takenaka_hanbei_h', name: 'ç«¹ä¸­åŠå…µè¡›', lord: 'hashiba', stats: { battle: 68, command: 78, politics: 77, intelligence: 100, charm: 75 }, skill: 'åé¢åŸ‹ä¼ã®è¨ˆ', loyalty: 95 },
                    { id: 'kuroda_kanbei_h', name: 'é»’ç”°å®˜å…µè¡›', lord: 'hashiba', stats: { battle: 80, command: 82, politics: 87, intelligence: 96, charm: 84 }, skill: 'è»å¸«ã®æ‰', loyalty: 90 },
                    { id: 'hachisuka_masakatsu_h', name: 'èœ‚é ˆè³€æ­£å‹', lord: 'hashiba', stats: { battle: 80, command: 78, politics: 70, intelligence: 74, charm: 76 }, skill: 'èœ‚é ˆè³€å°å…­', loyalty: 95 },
                    { id: 'hashiba_hidenaga', name: 'ç¾½æŸ´ç§€é•·', lord: 'hashiba', stats: { battle: 75, command: 85, politics: 90, intelligence: 88, charm: 89 }, skill: 'å¤§å’Œå¤§ç´è¨€', loyalty: 99 },
                    { id: 'asano_nagamasa', name: 'æµ…é‡é•·æ”¿', lord: 'hashiba', stats: { battle: 66, command: 70, politics: 82, intelligence: 79, charm: 78 }, skill: 'äº”å¥‰è¡Œ', loyalty: 92 },
                    { id: 'mashita_nagamori', name: 'å¢—ç”°é•·ç››', lord: 'hashiba', stats: { battle: 60, command: 68, politics: 84, intelligence: 77, charm: 70 }, skill: 'äº”å¥‰è¡Œ', loyalty: 88 },
                    { id: 'natsuka_masaie', name: 'é•·æŸæ­£å®¶', lord: 'hashiba', stats: { battle: 58, command: 66, politics: 86, intelligence: 78, charm: 68 }, skill: 'äº”å¥‰è¡Œ', loyalty: 85 },
                    { id: 'maeno_nagayasu', name: 'å‰é‡é•·åº·', lord: 'hashiba', stats: { battle: 74, command: 72, politics: 70, intelligence: 68, charm: 66 }, skill: 'è±Šè‡£å®¶è‡£', loyalty: 90 },
                    
                    // é¾é€ å¯ºå®¶
                    { id: 'nabeshima_naoshige_r', name: 'é‹å³¶ç›´èŒ‚', lord: 'ryuzoji', stats: { battle: 82, command: 88, politics: 86, intelligence: 88, charm: 84 }, skill: 'åŒ–ã‘çŒ«é¨’å‹•', loyalty: 85 },
                    { id: 'ryuzoji_masaie', name: 'é¾é€ å¯ºæ”¿å®¶', lord: 'ryuzoji', stats: { battle: 62, command: 68, politics: 74, intelligence: 72, charm: 66 }, skill: 'é¾é€ å¯ºä¸€æ—', loyalty: 95 },
                    { id: 'goto_sumiharu', name: 'å¾Œè—¤å®¶ä¿¡', lord: 'ryuzoji', stats: { battle: 78, command: 74, politics: 60, intelligence: 68, charm: 64 }, skill: 'è‚¥å‰å‹¢', loyalty: 90 },
                    { id: 'egami_shigemune', name: 'æ±Ÿä¸Šå®¶ç¨®', lord: 'ryuzoji', stats: { battle: 74, command: 70, politics: 58, intelligence: 66, charm: 62 }, skill: 'è‚¥å‰å‹¢', loyalty: 88 },
                    { id: 'chiba_tsunemura', name: 'åƒè‘‰èƒ¤é€£', lord: 'ryuzoji', stats: { battle: 76, command: 72, politics: 64, intelligence: 70, charm: 66 }, skill: 'è‚¥å‰å‹¢', loyalty: 85 },
                    { id: 'takagi_taneshige', name: 'é«˜æœ¨èƒ¤ç¹', lord: 'ryuzoji', stats: { battle: 78, command: 80, politics: 78, intelligence: 78, charm: 76 }, skill: 'è‚¥å‰å‹¢', loyalty: 88 },
                    { id: 'hyakutake_masukane', name: 'ç™¾æ­¦è³¢å…¼', lord: 'ryuzoji', stats: { battle: 78, command: 75, politics: 60, intelligence: 66, charm: 64 }, skill: 'è‚¥å‰æ­¦å£«', loyalty: 85 },
                    { id: 'narimatsu_nobukatsu', name: 'æˆæ¾ä¿¡å‹', lord: 'ryuzoji', stats: { battle: 80, command: 73, politics: 45, intelligence: 55, charm: 61 }, skill: 'é¾é€ å¯ºå®¶è‡£', loyalty: 90 },
                    { id: 'enjoji_nobutane', name: 'å††åŸå¯ºä¿¡èƒ¤', lord: 'ryuzoji', stats: { battle: 74, command: 70, politics: 50, intelligence: 64, charm: 58 }, skill: 'è‚¥å‰è±ªæ—', loyalty: 87 }
                ];
            }
            
            initializeTerritories() {
                const territoryNames = [
                    'mutsu', 'dewa', 'kai', 'shinano', 'echigo', 'kaga', 'noto', 'etchu',
                    'kozuke', 'shimotsuke', 'musashi', 'sagami', 'izu', 'mikawa', 'suruga', 'hizen',
                    'owari', 'mino', 'omi', 'yamashiro', 'yamato', 'harima', 'aki', 'bungo',
                ];
                
                const displayNames = [
                    'é™¸å¥¥', 'å‡ºç¾½', 'ç”²æ–', 'è¶Šå¾Œ', 'ä¿¡æ¿ƒ', 'ç›¸æ¨¡', 'èƒ½ç™»', 'è¶Šä¸­',
                    'ä¸Šé‡', 'ä¸‹é‡', 'æ­¦è”µ', 'ä¼Šå‹¢', 'ä¼Šè±†', 'ä¸‰æ²³', 'è±Šå‰', 'è‚¥å‰',
                    'å°¾å¼µ', 'ç¾æ¿ƒ', 'è¿‘æ±Ÿ', 'å±±åŸ', 'å¤§å’Œ', 'æ’­ç£¨', 'å®‰èŠ¸', 'è–©æ‘©'
                ];
                
                // åœ°åŸŸç‰¹æ€§ï¼šæœ‰åˆ©ãªå…µç§‘ã‚’è¨­å®šï¼ˆå„å…µç§‘8å€‹ãšã¤å‡ç­‰é…åˆ†ï¼‰
                const regionalAdvantages = [
                    'cavalry', 'cavalry', 'cavalry', 'cavalry', 'cavalry', 'cavalry', 'cavalry', 'cavalry',
                    'infantry', 'infantry', 'infantry', 'infantry', 'infantry', 'infantry', 'infantry', 'infantry',
                    'arquebus', 'arquebus', 'arquebus', 'arquebus', 'arquebus', 'arquebus', 'arquebus', 'arquebus'
                ];
                
                this.territories = territoryNames.map((id, index) => ({
                    id: id,
                    name: displayNames[index],
                    owner: null,
                    agriculture: 50,
                    commerce: 50,
                    troops: 0,
                    walls: 50,
                    gold: 0,
                    rice: 0,
                    unitType: 'infantry', // åˆæœŸã¯æ­©å…µ
                    advantageType: regionalAdvantages[index], // åœ°åŸŸç‰¹æ€§
                    agriculturalOfficer: null,
                    commercialOfficer: null,
                    diplomacyOfficer: null,
                    generalGarrison: null,
                    adjacentTerritories: []
                }));
                
                // éš£æ¥é–¢ä¿‚ã‚’è¨­å®šï¼ˆç°¡ç•¥åŒ–ï¼‰
                this.setAdjacencies();
                
                // å¤§åã®åˆæœŸé…ç½®ã¨å€‹åˆ¥è¨­å®š
                this.daimyos.forEach(daimyo => {
                    const territory = this.territories.find(t => t.id === daimyo.startTerritory);
                    if (territory) {
                        territory.owner = daimyo.id;
                        
                        // å²å®Ÿã«åŸºã¥ãå€‹åˆ¥è¨­å®š
                        switch(daimyo.id) {
                            case 'oda': // ç¹”ç”°ä¿¡é•· - å°¾å¼µ
                                territory.troops = 1200;
                                territory.walls = 500;
                                territory.agriculture = 65;
                                territory.commerce = 85; // å•†æ¥­ã®ä¸­å¿ƒåœ°
                                daimyo.gold = 1800; // å•†æ¥­ã§è£•ç¦
                                daimyo.rice = 600;
                                break;
                                
                            case 'takeda': // æ­¦ç”°ä¿¡ç„ - ç”²æ–
                                territory.troops = 1500; // æœ€å¼·é¨é¦¬è»å›£
                                territory.walls = 500;
                                territory.agriculture = 55; // å±±å›½ã§è¾²æ¥­ã¯å³ã—ã„
                                territory.commerce = 60;
                                daimyo.gold = 1000;
                                daimyo.rice = 500;
                                break;
                                
                            case 'uesugi': // ä¸Šæ‰è¬™ä¿¡ - ä¿¡æ¿ƒ
                                territory.troops = 1400; // è»ç¥ã®ç²¾å…µ
                                territory.walls = 500;
                                territory.agriculture = 65; // å±±å›½
                                territory.commerce = 55;
                                daimyo.gold = 1000;
                                daimyo.rice = 600;
                                break;
                                
                            case 'tokugawa': // å¾³å·å®¶åº· - ä¸‰æ²³
                                territory.troops = 1100;
                                territory.walls = 500; // è³ªå®Ÿå‰›å¥ãªå®ˆã‚Š
                                territory.agriculture = 75;
                                territory.commerce = 70;
                                daimyo.gold = 1300;
                                daimyo.rice = 750;
                                break;
                                
                            case 'hojo': // åŒ—æ¡æ°åº· - ä¼Šå‹¢ï¼ˆæ—§åŠ è³€ï¼‰
                                territory.troops = 1000;
                                territory.walls = 1000; // å°ç”°åŸåŸã®å …å›ºãªå®ˆã‚Š
                                territory.agriculture = 70;
                                territory.commerce = 75;
                                daimyo.gold = 1200;
                                daimyo.rice = 700;
                                break;
                                
                            case 'mori': // æ¯›åˆ©å…ƒå°± - å®‰èŠ¸
                                territory.troops = 1100;
                                territory.walls = 500;
                                territory.agriculture = 70;
                                territory.commerce = 75;
                                daimyo.gold = 1100;
                                daimyo.rice = 650;
                                break;
                                
                            case 'otomo': // å¤§å‹å®—éºŸ - è±Šå¾Œ
                                territory.troops = 900;
                                territory.walls = 500;
                                territory.agriculture = 65;
                                territory.commerce = 80; // å—è›®è²¿æ˜“
                                daimyo.gold = 2000; // è²¿æ˜“ã§å¤§ã„ã«æ½¤ã†
                                daimyo.rice = 600;
                                break;
                                
                            case 'shimazu': // å³¶æ´¥ç¾©ä¹… - è–©æ‘©
                                territory.troops = 1000; // å°‘æ•°ç²¾é‹­
                                territory.walls = 500; // ä¹å·ã®è¦å®³
                                territory.agriculture = 60; // è¾ºå¢ƒã®åœ°
                                territory.commerce = 50;
                                daimyo.gold = 700;
                                daimyo.rice = 400;
                                break;
                                
                            case 'date': // ä¼Šé”æ”¿å®— - é™¸å¥¥
                                territory.troops = 1200;
                                territory.walls = 500;
                                territory.agriculture = 75;
                                territory.commerce = 65;
                                daimyo.gold = 1000;
                                daimyo.rice = 650;
                                break;
                                
                            case 'sanada': // çœŸç”°æ˜Œå¹¸ - è¶Šå¾Œ
                                territory.troops = 600; // å°é ˜ä¸»ã§å…µæ•°å°‘ãªã„
                                territory.walls = 500; // å±±åŸã§å®ˆã‚Šã¯å …ã„
                                territory.agriculture = 75; // ç±³ã©ã“ã‚
                                territory.commerce = 55;
                                daimyo.gold = 800; // è³‡é‡‘ã«ä¹ã—ã„
                                daimyo.rice = 450; // ç±³ã¯å°‘ãªã„
                                break;
                                
                            case 'hashiba': // ç¾½æŸ´ç§€å‰ - æ’­ç£¨
                                territory.troops = 1100;
                                territory.walls = 500;
                                territory.agriculture = 70;
                                territory.commerce = 85; // å•†æ‰ã«é•·ã‘ã‚‹
                                daimyo.gold = 1700; // æˆã‚Šä¸ŠãŒã‚Šã®å¯Œ
                                daimyo.rice = 800;
                                break;
                                
                            case 'ryuzoji': // é¾é€ å¯ºéš†ä¿¡ - è‚¥å‰
                                territory.troops = 900; // è‚¥å‰ã®ç†Š
                                territory.walls = 500;
                                territory.agriculture = 70;
                                territory.commerce = 65;
                                daimyo.gold = 900;
                                daimyo.rice = 550;
                                break;
                                
                            default: // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
                                territory.troops = 1000;
                                territory.walls = 500;
                                territory.agriculture = 70;
                                territory.commerce = 70;
                                break;
                        }
                        
                        // å¤§åã®å¾—æ„å…µç§‘ã‚’è¨­å®š
                        territory.unitType = daimyo.preferredUnit || 'infantry';
                    }
                });
            }
            
            setupAIGenerals() {
                try {
                    // å„AIå¤§åã®æ­¦å°†ã‚’è‡ªå‹•é…ç½®
                    this.daimyos.forEach(daimyo => {
                        if (daimyo.id !== this.playerDaimyo) {
                            this.assignAIGenerals(daimyo.id);
                        }
                    });
                } catch (error) {
                    console.warn('AIæ­¦å°†è¨­å®šä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ:', error);
                }
            }
            
            assignAIGenerals(daimyoId) {
                try {
                    // ã“ã®AIå¤§åã®æ­¦å°†ã‚’å–å¾—
                    const aiGenerals = this.generals.filter(g => g.lord === daimyoId);
                    if (aiGenerals.length === 0) return;
                    
                    // AIå¤§åã®å½¹è·è¨­å®šã‚’åˆæœŸåŒ–
                    if (!this.aiRoles[daimyoId]) {
                        this.aiRoles[daimyoId] = {
                            strategist: null,
                            diplomat: null,
                            administrator: null,
                            kenchiCommissioner: null,
                            riceCommissioner: null,
                            townCommissioner: null,
                            goldCommissioner: null,
                            constructionCommissioner: null,
                            militaryCommissioner: null,
                            armyStrategist: null,
                            vanguard: null,
                            rightWing: null,
                            leftWing: null,
                            reserve: null
                        };
                    }
                    
                    const availableGenerals = [...aiGenerals]; // ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆ
                    
                    // ã€ç¬¬1å„ªå…ˆã€‘è»å›£ç·¨æˆã‚’æœ€å„ªå…ˆã§é…ç½®ï¼ˆæ–°ã—ã„å„ªå…ˆé †ä½ï¼‰
                    // 1. çŸ¥è¬€æœ€é«˜ã‚’è»å¸«ã«
                    if (availableGenerals.length > 0) {
                        const bestStrategist = availableGenerals.reduce((best, current) => 
                            (current.stats?.intelligence || 0) > (best.stats?.intelligence || 0) ? current : best
                        );
                        this.aiRoles[daimyoId]['armyStrategist'] = bestStrategist.id;
                        const index = availableGenerals.indexOf(bestStrategist);
                        if (index > -1) availableGenerals.splice(index, 1);
                    }
                    
                    // 2. æˆ¦é—˜æœ€é«˜ã‚’å‰è¡›ã«
                    if (availableGenerals.length > 0) {
                        const bestVanguard = availableGenerals.reduce((best, current) => 
                            (current.stats?.battle || 0) > (best.stats?.battle || 0) ? current : best
                        );
                        this.aiRoles[daimyoId]['vanguard'] = bestVanguard.id;
                        const index = availableGenerals.indexOf(bestVanguard);
                        if (index > -1) availableGenerals.splice(index, 1);
                    }
                    
                    // 3. çµ±ç‡æœ€é«˜ã‚’å¾Œè©°ã«
                    if (availableGenerals.length > 0) {
                        const bestReserve = availableGenerals.reduce((best, current) => 
                            (current.stats?.command || 0) > (best.stats?.command || 0) ? current : best
                        );
                        this.aiRoles[daimyoId]['reserve'] = bestReserve.id;
                        const index = availableGenerals.indexOf(bestReserve);
                        if (index > -1) availableGenerals.splice(index, 1);
                    }
                    
                    // 4. æ®‹ã‚Šã®ä¸­ã§æˆ¦é—˜æœ€é«˜ã‚’å³ç¿¼ã«
                    if (availableGenerals.length > 0) {
                        const bestRightWing = availableGenerals.reduce((best, current) => 
                            (current.stats?.battle || 0) > (best.stats?.battle || 0) ? current : best
                        );
                        this.aiRoles[daimyoId]['rightWing'] = bestRightWing.id;
                        const index = availableGenerals.indexOf(bestRightWing);
                        if (index > -1) availableGenerals.splice(index, 1);
                    }
                    
                    // 5. æ®‹ã‚Šã®ä¸­ã§æˆ¦é—˜æœ€é«˜ã‚’å·¦ç¿¼ã«
                    if (availableGenerals.length > 0) {
                        const bestLeftWing = availableGenerals.reduce((best, current) => 
                            (current.stats?.battle || 0) > (best.stats?.battle || 0) ? current : best
                        );
                        this.aiRoles[daimyoId]['leftWing'] = bestLeftWing.id;
                        const index = availableGenerals.indexOf(bestLeftWing);
                        if (index > -1) availableGenerals.splice(index, 1);
                    }
                    
                    // ã€ç¬¬2å„ªå…ˆã€‘é‡è¦å½¹è·ã‚’é…ç½®
                    const importantRoles = ['strategist', 'diplomat', 'administrator'];
                    importantRoles.forEach(role => {
                        if (availableGenerals.length === 0) return;
                        
                        let bestGeneral = null;
                        let bestScore = -1;
                        
                        availableGenerals.forEach(general => {
                            const score = this.calculateGeneralScore(general, role);
                            if (score > bestScore) {
                                bestScore = score;
                                bestGeneral = general;
                            }
                        });
                        
                        if (bestGeneral) {
                            this.aiRoles[daimyoId][role] = bestGeneral.id;
                            // é…ç½®ã—ãŸæ­¦å°†ã‚’åˆ©ç”¨å¯èƒ½ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
                            const index = availableGenerals.indexOf(bestGeneral);
                            if (index > -1) {
                                availableGenerals.splice(index, 1);
                            }
                        }
                    });
                    
                    // ã€ç¬¬3å„ªå…ˆã€‘å¥‰è¡Œè·ã‚’é…ç½®ï¼ˆæ®‹ã£ãŸæ­¦å°†ã§ï¼‰
                    const commissionerRoles = ['kenchiCommissioner', 'riceCommissioner', 'townCommissioner', 'goldCommissioner', 'constructionCommissioner', 'militaryCommissioner'];
                    commissionerRoles.forEach(role => {
                        if (availableGenerals.length === 0) return;
                        
                        let bestGeneral = null;
                        let bestScore = -1;
                        
                        availableGenerals.forEach(general => {
                            const score = this.calculateGeneralScore(general, role);
                            if (score > bestScore) {
                                bestScore = score;
                                bestGeneral = general;
                            }
                        });
                        
                        if (bestGeneral) {
                            this.aiRoles[daimyoId][role] = bestGeneral.id;
                            // é…ç½®ã—ãŸæ­¦å°†ã‚’åˆ©ç”¨å¯èƒ½ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
                            const index = availableGenerals.indexOf(bestGeneral);
                            if (index > -1) {
                                availableGenerals.splice(index, 1);
                            }
                        }
                    });
                    
                    // æ®‹ã£ãŸæ­¦å°†ã‚’é ˜åœŸæ‹…å½“ã«é…ç½®
                    this.assignAITerritoryGenerals(daimyoId, availableGenerals);
                    
                } catch (error) {
                    console.warn(`AIå¤§å${daimyoId}ã®æ­¦å°†é…ç½®ä¸­ã«ã‚¨ãƒ©ãƒ¼:`, error);
                }
            }
            
            calculateGeneralScore(general, role) {
                try {
                    if (!general || !general.stats) return 0;
                    
                    // å½¹è·ã«å¿œã˜ã¦é©æ€§ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
                    switch (role) {
                        case 'strategist':
                        case 'armyStrategist':
                            return general.stats.intelligence + general.stats.command;
                        case 'diplomat':
                            return general.stats.politics + general.stats.charm;
                        case 'administrator':
                            return general.stats.politics + general.stats.intelligence;
                        case 'kenchiCommissioner':
                        case 'riceCommissioner':
                        case 'townCommissioner':
                        case 'goldCommissioner':
                            return general.stats.politics * 2; // å¥‰è¡Œè·ã¯æ”¿æ²»é‡è¦–
                        case 'constructionCommissioner':
                            return general.stats.command + general.stats.politics; // æ™®è«‹å¥‰è¡Œã¯çµ±ç‡+æ”¿æ²»
                        case 'militaryCommissioner':
                            return general.stats.battle + general.stats.command; // å…µå¥‰è¡Œã¯æˆ¦é—˜+çµ±ç‡
                        case 'vanguard':
                            return general.stats.battle + general.stats.command;
                        case 'rightWing':
                        case 'leftWing':
                            return general.stats.battle;
                        case 'reserve':
                            return general.stats.command;
                        default:
                            return general.stats.battle + general.stats.command + general.stats.politics;
                    }
                } catch (error) {
                    console.warn('æ­¦å°†ã‚¹ã‚³ã‚¢è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                    return 0;
                }
            }
            
            assignAITerritoryGenerals(daimyoId, availableGenerals) {
                try {
                    // ã“ã®å¤§åã®é ˜åœŸã‚’å–å¾—
                    const territories = this.territories.filter(t => t.owner === daimyoId);
                    
                    territories.forEach((territory, index) => {
                        if (availableGenerals.length > index) {
                            territory.generalGarrison = availableGenerals[index].id;
                        }
                    });
                } catch (error) {
                    console.warn(`AIå¤§å${daimyoId}ã®é ˜åœŸæ­¦å°†é…ç½®ä¸­ã«ã‚¨ãƒ©ãƒ¼:`, error);
                }
            }
            
            setAdjacencies() {
                // éš£æ¥é–¢ä¿‚ã®è¨­å®šï¼ˆ8x3ã®ã‚°ãƒªãƒƒãƒ‰ãƒ™ãƒ¼ã‚¹ã€8æ–¹å‘ï¼‰
                const adjacencyMap = {
                    0: [1, 8, 9],
                    1: [0, 2, 8, 9, 10],
                    2: [1, 3, 9, 10, 11],
                    3: [2, 4, 10, 11, 12],
                    4: [3, 5, 11, 12, 13],
                    5: [4, 6, 12, 13, 14],
                    6: [5, 7, 13, 14, 15],
                    7: [6, 14, 15],
                    8: [0, 1, 9, 16, 17],
                    9: [0, 1, 2, 8, 10, 16, 17, 18],
                    10: [1, 2, 3, 9, 11, 17, 18, 19],
                    11: [2, 3, 4, 10, 12, 18, 19, 20],
                    12: [3, 4, 5, 11, 13, 19, 20, 21],
                    13: [4, 5, 6, 12, 14, 20, 21, 22],
                    14: [5, 6, 7, 13, 15, 21, 22, 23],
                    15: [6, 7, 14, 22, 23],
                    16: [8, 9, 17],
                    17: [8, 9, 10, 16, 18],
                    18: [9, 10, 11, 17, 19],
                    19: [10, 11, 12, 18, 20],
                    20: [11, 12, 13, 19, 21],
                    21: [12, 13, 14, 20, 22],
                    22: [13, 14, 15, 21, 23],
                    23: [14, 15, 22]
                };
                
                Object.entries(adjacencyMap).forEach(([index, adjacents]) => {
                    const territory = this.territories[parseInt(index)];
                    territory.adjacentTerritories = adjacents.map(i => this.territories[i].id);
                });
            }
            
            getPlayerTerritories() {
                return this.territories.filter(t => t.owner === this.playerDaimyo);
            }
            
            getPlayerDaimyoData() {
                return this.daimyos.find(d => d.id === this.playerDaimyo);
            }
            
            getMaxDiplomacyCount() {
                // å¤–äº¤æ‹…å½“ã®æ”¿æ²»åŠ›ã§å¤–äº¤å›æ•°ã‚’æ±ºå®š
                if (!this.playerRoles.diplomat) return 1; // å¤–äº¤æ‹…å½“æœªè¨­å®šæ™‚ã¯1å›
                
                // å¤–äº¤æ‹…å½“ã‚’æ­¦å°†ã‹ã‚‰æ¢ã™
                let diplomat = this.generals.find(g => g.id === this.playerRoles.diplomat);
                
                // æ­¦å°†ã«è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å¤§åã‹ã‚‚ã—ã‚Œãªã„
                if (!diplomat && this.playerRoles.diplomat === this.playerDaimyo) {
                    diplomat = this.getPlayerDaimyoData();
                }
                
                if (!diplomat) return 1;
                
                const politics = diplomat.stats.politics || 50;
                if (politics >= 96) return 3;
                if (politics >= 90) return 2;
                return 1;
            }
            
            canUseDiplomacy() {
                return this.diplomacyUsed < this.getMaxDiplomacyCount();
            }
            
            addLog(message, type = 'normal') {
                this.gameLog.push({ message, type, turn: this.turn });
                this.updateLogDisplay();
            }
            
            addPersonnelLog(message) {
                try {
                    if (!this.personnelEvents) {
                        this.personnelEvents = [];
                    }
                    this.personnelEvents.push({
                        type: 'personnel',
                        message: message || '',
                        turn: this.turn || 1
                    });
                } catch (error) {
                    console.warn('äººäº‹ãƒ­ã‚°è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            updateLogDisplay() {
                const logContent = document.getElementById('log-content');
                const latestLogs = this.gameLog.slice(-5);
                logContent.innerHTML = latestLogs.map(log => 
                    `<div class="log-entry ${log.type}">${log.message}</div>`
                ).join('');
                logContent.scrollTop = logContent.scrollHeight;
            }
        }
        
        // UIç®¡ç†
        class UIManager {
            constructor(gameState) {
                this.gameState = gameState;
                this.setupEventListeners();
            }
            
            setupEventListeners() {
                // å¤§åé¸æŠ
                document.querySelectorAll('.daimyo-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        const daimyoId = e.currentTarget.dataset.daimyo;
                        this.selectDaimyo(daimyoId);
                    });
                });
                
                // ã‚²ãƒ¼ãƒ å†…ãƒœã‚¿ãƒ³
                document.getElementById('next-turn-btn').addEventListener('click', () => this.nextTurn());
                document.getElementById('attack-btn').addEventListener('click', () => this.showAttackModal());
                document.getElementById('strategy-btn').addEventListener('click', () => this.showStrategyModal());
                document.getElementById('diplomacy-btn').addEventListener('click', () => this.showDiplomacyModal());
                document.getElementById('scout-btn').addEventListener('click', () => this.showScoutModal());
                document.getElementById('trade-btn').addEventListener('click', () => this.showTradeModal());
                document.getElementById('recruit-btn').addEventListener('click', () => this.showRecruitModal());
                document.getElementById('recruit-general-btn').addEventListener('click', () => this.showRecruitGeneralModal());
                document.getElementById('generals-btn').addEventListener('click', () => this.showGeneralsModal());
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«
                document.getElementById('modal-cancel-btn').addEventListener('click', () => this.hideModal());
                document.getElementById('modal-confirm-btn').addEventListener('click', () => this.executeModalAction());
                document.getElementById('confirm-turn-btn').addEventListener('click', () => this.hideTurnLog());
                document.getElementById('generals-cancel-btn').addEventListener('click', () => this.hideGeneralsModal());
                document.getElementById('generals-save-btn').addEventListener('click', () => this.saveGeneralsSettings());
                document.getElementById('generals-reset-btn').addEventListener('click', () => this.resetCurrentTab());
                document.getElementById('recruit-general-cancel-btn').addEventListener('click', () => this.hideRecruitGeneralModal());
                document.getElementById('battle-log-close-btn').addEventListener('click', () => this.hideBattleLogModal());
                document.getElementById('scout-close-btn').addEventListener('click', () => this.hideScoutModal());
                
                // æ­¦å°†è¨­å®šã‚¿ãƒ–
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.switchTab(e.target.dataset.tab));
                });
                
                // é ˜åœŸã‚¯ãƒªãƒƒã‚¯
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('territory')) {
                        this.selectTerritory(e.target.dataset.territoryId);
                    }
                });
                
                // ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«
                const resizeHandle = document.getElementById('resize-handle');
                let isResizing = false;
                let startY = 0;
                let startHeight = 180;
                
                resizeHandle.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    startY = e.clientY;
                    startHeight = parseInt(document.documentElement.style.getPropertyValue('--bottom-height') || '180');
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                    e.preventDefault();
                });
                
                const handleMouseMove = (e) => {
                    if (!isResizing) return;
                    const deltaY = startY - e.clientY;
                    const newHeight = Math.max(120, Math.min(400, startHeight + deltaY));
                    document.documentElement.style.setProperty('--bottom-height', `${newHeight}px`);
                };
                
                const handleMouseUp = () => {
                    isResizing = false;
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                };
            }
            
            selectDaimyo(daimyoId) {
                try {
                    this.gameState.playerDaimyo = daimyoId;
                    this.gameState.attackUsed = false; // ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã¯è¡Œå‹•å¯èƒ½ã«è¨­å®š
                    this.gameState.diplomacyUsed = 0;
                    this.gameState.strategyUsed = false;
                    
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠå¾Œã«AIæ­¦å°†ã‚’å†é…ç½®ï¼ˆå®‰å…¨ã«å®Ÿè¡Œï¼‰
                    if (this.gameState.setupAIGenerals) {
                        this.gameState.setupAIGenerals();
                    }
                    
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ­¦å°†ã‚’è‡ªå‹•é…ç½®
                    this.setupInitialPlayerGenerals();
                    
                    document.getElementById('daimyo-selection-screen').classList.add('hidden');
                    document.getElementById('game-screen').classList.remove('hidden');
                    this.updateDaimyoPortrait(daimyoId);
                    this.initializeGameUI();
                    
                    const playerDaimyo = this.gameState.getPlayerDaimyoData();
                    const daimyoName = playerDaimyo ? playerDaimyo.name : 'é¸æŠã•ã‚ŒãŸå¤§å';
                    
                    // å¤§åã”ã¨ã®å€‹æ€§çš„ãªé–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    let startMessage = '';
                    switch(this.gameState.playerDaimyo) {
                        case 'oda':
                            startMessage = `${daimyoName}ã¨ã—ã¦é©æ–°çš„ãªå¤©ä¸‹çµ±ä¸€ãŒå§‹ã¾ã‚‹ï¼å•†æ¥­ã®åŠ›ã¨é‰„ç ²ã§æ–°æ™‚ä»£ã‚’åˆ‡ã‚Šé–‹ã‘ï¼`;
                            break;
                        case 'takeda':
                            startMessage = `${daimyoName}ã¨ã—ã¦ç”²æ–ã®è™ãŒè¦‡é“ã‚’æ­©ã‚€ï¼é¢¨æ—ç«å±±ã®æ——ã®ã‚‚ã¨ã€ç„¡æ•µã®é¨é¦¬çªæ’ƒã§å¤©ä¸‹ã‚’é§†ã‘ã‚ï¼`;
                            break;
                        case 'uesugi':
                            startMessage = `${daimyoName}ã¨ã—ã¦è»ç¥ã®æˆ¦ã„ãŒå§‹ã¾ã‚‹ï¼ä¿¡æ¿ƒã®å±±å›½ã‹ã‚‰ç¾©ã‚’èƒŒè² ã„ã€ç„¡åŒã®æ­¦ã¨ç¥å¨ã§æ•µã®å®ˆå‚™ã‚’ç²‰ç •ã›ã‚ˆï¼`;
                            break;
                        case 'tokugawa':
                            startMessage = `${daimyoName}ã¨ã—ã¦å¿è€ã®é“ãŒå§‹ã¾ã‚‹ï¼ä¸‰æ²³æ­¦å£«ã®å¿ ç¾©ã¨å …å®Ÿãªçµ±æ²»ã§å¤ªå¹³ã®ä¸–ã‚’ç¯‰ã‘ï¼`;
                            break;
                        case 'hojo':
                            startMessage = `${daimyoName}ã¨ã—ã¦é–¢æ±ã®è¦‡è€…ãŒç«‹ã¤ï¼å°ç”°åŸåŸã®é‰„å£ã®å®ˆã‚Šã‚’èª‡ã‚Šã€é–¢æ±åˆ¶è¦‡ã‹ã‚‰å¤©ä¸‹ã¸ï¼`;
                            break;
                        case 'mori':
                            startMessage = `${daimyoName}ã¨ã—ã¦ä¸­å›½åœ°æ–¹ã®è¬€å°†ãŒå‹•ãï¼ä¸‰æœ¬ã®çŸ¢ã®æ•™ãˆã¨å·§ã¿ãªç­–ç•¥ã§å¤©ä¸‹ã‚’æ‰‹ä¸­ã«ï¼`;
                            break;
                        case 'otomo':
                            startMessage = `${daimyoName}ã¨ã—ã¦å—è›®ã®çŸ¥è­˜ã§æ–°æ™‚ä»£ã‚’ï¼è±Šå¾Œã®åœ°ã‹ã‚‰è¥¿æ´‹ã®æŠ€è¡“ã¨å¯Œã§å¤©ä¸‹çµ±ä¸€ã‚’ï¼`;
                            break;
                        case 'shimazu':
                            startMessage = `${daimyoName}ã¨ã—ã¦è–©æ‘©éš¼äººã®é­‚ãŒç‡ƒãˆã‚‹ï¼ä¹å·ã®æœ€æœã¦ã‹ã‚‰å°‘æ•°ç²¾é‹­ã§å¤©ä¸‹ã«æŒ‘ã‚ï¼`;
                            break;
                        case 'date':
                            startMessage = `${daimyoName}ã¨ã—ã¦ç‹¬çœ¼ç«œãŒç¿”ã‘ã‚‹ï¼å¥¥å·ã®è¦‡è€…ã¨ã—ã¦ä¼Šé”ã®å¨é¢¨ã§å¤©ä¸‹ã‚’éœ‡æ’¼ã•ã›ã‚ˆï¼`;
                            break;
                        case 'sanada':
                            startMessage = `${daimyoName}ã¨ã—ã¦è¡¨è£æ¯”èˆˆã®æ™ºè¬€æˆ¦é–‹å§‹ï¼è¶Šå¾Œã®ç±³ã©ã“ã‚ã‚’æ‹ ç‚¹ã«çŸ¥ç•¥ã§å¤§å‹¢åŠ›ã‚’ç¿»å¼„ã—ã€å¤©ä¸‹ã®å¤¢ã‚’æ´ã‚ï¼`;
                            break;
                        case 'hashiba':
                            startMessage = `${daimyoName}ã¨ã—ã¦æˆã‚Šä¸ŠãŒã‚Šã®é‡æœ›ãŒå§‹ã¾ã‚‹ï¼äººãŸã‚‰ã—ã®æ‰ã¨å•†æ‰ã§ã€ç™¾å§“ã‹ã‚‰å¤©ä¸‹äººã¸ã®é“ã‚’æ­©ã‚ï¼`;
                            break;
                        case 'ryuzoji':
                            startMessage = `${daimyoName}ã¨ã—ã¦è‚¥å‰ã®ç†ŠãŒå’†å“®ã™ã‚‹ï¼ä¹å·çµ±ä¸€ã‹ã‚‰å¤©ä¸‹ã¸ã€æ­¦åŠ›ã§é“ã‚’åˆ‡ã‚Šé–‹ã‘ï¼`;
                            break;
                        default:
                            startMessage = `${daimyoName}ã¨ã—ã¦å¤©ä¸‹çµ±ä¸€ã®æˆ¦ã„ãŒå§‹ã¾ã£ãŸï¼`;
                            break;
                    }
                    
                    this.gameState.addLog(startMessage);
                    
                    // é…ç½®ã•ã‚ŒãŸæ­¦å°†ã‚’ãƒ­ã‚°ã«è¡¨ç¤º
                    this.showInitialGeneralStatus();
                    
                } catch (error) {
                    console.error('å¤§åé¸æŠä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ:', error);
                    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã‚²ãƒ¼ãƒ ã¯é–‹å§‹ã™ã‚‹
                    this.gameState.attackUsed = false; // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚è¡Œå‹•å¯èƒ½ã«
                    this.gameState.diplomacyUsed = 0;
                    this.gameState.strategyUsed = false;
                    document.getElementById('daimyo-selection-screen').classList.add('hidden');
                    document.getElementById('game-screen').classList.remove('hidden');
                    this.initializeGameUI();
                    this.gameState.addLog('ã‚²ãƒ¼ãƒ ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ');
                }
            }
            
            updateDaimyoPortrait(daimyoId) {
                const portraitElement = document.getElementById('daimyo-portrait');
                if (daimyoId && portraitElement) {
                    portraitElement.className = 'daimyo-portrait';
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«åã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆå®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«åã«åˆã‚ã›ã‚‹ï¼‰
                    let filename = daimyoId;
                    if (daimyoId === 'oda') {
                        filename = 'oda '; // ã‚¹ãƒšãƒ¼ã‚¹ä»˜ããƒ•ã‚¡ã‚¤ãƒ«åã«å¯¾å¿œ
                    }
                    
                    portraitElement.innerHTML = `<img src="daimyo/${filename}.webp" alt="${daimyoId}">`;
                }
            }
            
            setupInitialPlayerGenerals() {
                try {
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é…ä¸‹æ­¦å°†ã‚’å–å¾—
                    const playerGenerals = this.gameState.generals.filter(g => 
                        g && g.lord === this.gameState.playerDaimyo
                    );
                    
                    if (playerGenerals.length === 0) {
                        return; // æ­¦å°†ãŒã„ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
                    }
                    
                    // æ­¦å°†ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦é…ç½®ç”¨ãƒªã‚¹ãƒˆã‚’ä½œæˆ
                    const availableGenerals = [...playerGenerals];
                    
                    // ã€ç¬¬1å„ªå…ˆã€‘è»å›£ç·¨æˆã‚’æœ€å„ªå…ˆã§é…ç½®
                    const militaryRoles = ['armyStrategist', 'vanguard', 'rightWing', 'leftWing', 'reserve'];
                    militaryRoles.forEach(roleKey => {
                        if (availableGenerals.length === 0) return;
                        
                        let bestGeneral = null;
                        let bestScore = -1;
                        
                        availableGenerals.forEach(general => {
                            try {
                                const score = this.gameState.calculateGeneralScore(general, roleKey);
                                if (score > bestScore) {
                                    bestScore = score;
                                    bestGeneral = general;
                                }
                            } catch (error) {
                                // æ­¦å°†é©æ€§è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ç¶™ç¶š
                            }
                        });
                        
                        if (bestGeneral) {
                            this.gameState.playerRoles[roleKey] = bestGeneral.id;
                            // é…ç½®ã—ãŸæ­¦å°†ã‚’åˆ©ç”¨å¯èƒ½ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
                            const index = availableGenerals.indexOf(bestGeneral);
                            if (index > -1) {
                                availableGenerals.splice(index, 1);
                            }
                        }
                    });
                    
                    // ã€ç¬¬2å„ªå…ˆã€‘é‡è¦å½¹è·ã‚’é…ç½®
                    const importantRoles = ['strategist', 'diplomat', 'administrator'];
                    importantRoles.forEach(roleKey => {
                        if (availableGenerals.length === 0) return;
                        
                        let bestGeneral = null;
                        let bestScore = -1;
                        
                        availableGenerals.forEach(general => {
                            try {
                                const score = this.gameState.calculateGeneralScore(general, roleKey);
                                if (score > bestScore) {
                                    bestScore = score;
                                    bestGeneral = general;
                                }
                            } catch (error) {
                                // æ­¦å°†é©æ€§è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ç¶™ç¶š
                            }
                        });
                        
                        if (bestGeneral) {
                            this.gameState.playerRoles[roleKey] = bestGeneral.id;
                            // é…ç½®ã—ãŸæ­¦å°†ã‚’åˆ©ç”¨å¯èƒ½ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
                            const index = availableGenerals.indexOf(bestGeneral);
                            if (index > -1) {
                                availableGenerals.splice(index, 1);
                            }
                        }
                    });
                    
                    // ã€ç¬¬3å„ªå…ˆã€‘å¥‰è¡Œè·ã‚’é…ç½®ï¼ˆæ®‹ã£ãŸæ­¦å°†ã§ï¼‰
                    const commissionerRoles = ['kenchiCommissioner', 'riceCommissioner', 'townCommissioner', 'goldCommissioner', 'constructionCommissioner', 'militaryCommissioner'];
                    commissionerRoles.forEach(roleKey => {
                        if (availableGenerals.length === 0) return;
                        
                        let bestGeneral = null;
                        let bestScore = -1;
                        
                        availableGenerals.forEach(general => {
                            try {
                                const score = this.gameState.calculateGeneralScore(general, roleKey);
                                if (score > bestScore) {
                                    bestScore = score;
                                    bestGeneral = general;
                                }
                            } catch (error) {
                                // æ­¦å°†é©æ€§è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ç¶™ç¶š
                            }
                        });
                        
                        if (bestGeneral) {
                            this.gameState.playerRoles[roleKey] = bestGeneral.id;
                            // é…ç½®ã—ãŸæ­¦å°†ã‚’åˆ©ç”¨å¯èƒ½ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
                            const index = availableGenerals.indexOf(bestGeneral);
                            if (index > -1) {
                                availableGenerals.splice(index, 1);
                            }
                        }
                    });
                    
                    // æ®‹ã£ãŸæ­¦å°†ã‚’é ˜åœŸæ‹…å½“ã«é…ç½®
                    this.assignGeneralsToTerritories(availableGenerals);
                    
                } catch (error) {
                    // åˆæœŸæ­¦å°†é…ç½®ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ç¶™ç¶š
                }
            }
            
            assignGeneralsToTerritories(remainingGenerals) {
                try {
                    const playerTerritories = this.gameState.getPlayerTerritories();
                    
                    remainingGenerals.forEach((general, index) => {
                        if (index < playerTerritories.length && general && playerTerritories[index]) {
                            playerTerritories[index].generalGarrison = general.id;
                        }
                    });
                } catch (error) {
                    // é ˜åœŸæ­¦å°†é…ç½®ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ç¶™ç¶š
                }
            }
            
            showInitialGeneralStatus() {
                try {
                    const playerGenerals = this.gameState.generals.filter(g => 
                        g && g.lord === this.gameState.playerDaimyo
                    );
                    
                    if (playerGenerals.length > 0) {
                        // å„ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®é…ç½®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                        const militaryRoles = ['armyStrategist', 'vanguard', 'rightWing', 'leftWing', 'reserve'];
                        const importantRoles = ['strategist', 'diplomat', 'administrator'];
                        const commissionerRoles = ['kenchiCommissioner', 'riceCommissioner', 'townCommissioner', 'goldCommissioner', 'constructionCommissioner', 'militaryCommissioner'];
                        
                        const assignedMilitary = militaryRoles.filter(role => this.gameState.playerRoles[role] !== null);
                        const assignedImportant = importantRoles.filter(role => this.gameState.playerRoles[role] !== null);
                        const assignedCommissioner = commissionerRoles.filter(role => this.gameState.playerRoles[role] !== null);
                        
                        // é ˜åœŸã«é…ç½®ã•ã‚ŒãŸæ­¦å°†ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                        const assignedTerritories = this.gameState.getPlayerTerritories().filter(t => t.generalGarrison !== null);
                        
                        this.gameState.addLog(`é…ä¸‹æ­¦å°†${playerGenerals.length}åãŒå‚é›†`, 'diplomacy');
                        
                        // å„ªå…ˆé †ä½ã«å¾“ã£ãŸé…ç½®çŠ¶æ³ã‚’è¡¨ç¤º
                        if (assignedMilitary.length > 0) {
                            this.gameState.addLog(`ã€è»å›£ç·¨æˆã€‘${assignedMilitary.length}åã‚’æœ€å„ªå…ˆé…ç½®`, 'diplomacy');
                        }
                        if (assignedImportant.length > 0) {
                            this.gameState.addLog(`ã€é‡è¦å½¹è·ã€‘${assignedImportant.length}åã‚’é…ç½®`, 'diplomacy');
                        }
                        if (assignedCommissioner.length > 0) {
                            this.gameState.addLog(`ã€å¥‰è¡Œè·ã€‘${assignedCommissioner.length}åã‚’é…ç½®`, 'diplomacy');
                        }
                        if (assignedTerritories.length > 0) {
                            this.gameState.addLog(`ã€é ˜åœŸæ‹…å½“ã€‘${assignedTerritories.length}åã‚’é…ç½®`, 'diplomacy');
                        }
                        
                        // ä¸»è¦ãªè»å›£ãƒ¡ãƒ³ãƒãƒ¼ã‚’å…·ä½“çš„ã«è¡¨ç¤º
                        try {
                            const militaryAssignments = [];
                            const roleNames = {
                                'armyStrategist': 'è»å¸«',
                                'vanguard': 'å‰è¡›',
                                'rightWing': 'å³ç¿¼',
                                'leftWing': 'å·¦ç¿¼',
                                'reserve': 'å¾Œè©°'
                            };
                            
                            militaryRoles.forEach(roleKey => {
                                const generalId = this.gameState.playerRoles[roleKey];
                                if (generalId) {
                                    const general = this.gameState.generals.find(g => g && g.id === generalId);
                                    if (general) {
                                        militaryAssignments.push(`${general.name}(${roleNames[roleKey]})`);
                                    }
                                }
                            });
                            
                            if (militaryAssignments.length > 0) {
                                const displayAssignments = militaryAssignments.slice(0, 3); // æœ€å¤§3åã¾ã§è¡¨ç¤º
                                let assignmentMessage = '';
                                if (militaryAssignments.length <= 3) {
                                    assignmentMessage = `è»å›£ä¸»åŠ›: ${displayAssignments.join('ã€')}`;
                                } else {
                                    assignmentMessage = `è»å›£ä¸»åŠ›: ${displayAssignments.join('ã€')}ã‚‰${militaryAssignments.length}å`;
                                }
                                this.gameState.addLog(assignmentMessage, 'diplomacy');
                            }
                        } catch (error) {
                            console.warn('è»å›£ãƒ¡ãƒ³ãƒãƒ¼è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                        }
                        

                    }
                } catch (error) {
                    // åˆæœŸé…ç½®ãƒ­ã‚°å‡ºåŠ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ç¶™ç¶š
                }
            }
            
            initializeGameUI() {
                try {
                    this.renderMap();
                    this.updateStatus();
                    // åˆæœŸè»å›£æˆ¦åŠ›ã‚’è¨ˆç®—
                    this.calculateArmyStats();
                    
                    // æ­¦å°†è¨­å®šã®åˆæœŸåŒ–çŠ¶æ…‹ã‚’ãƒ­ã‚°ã«è¡¨ç¤º
                    const assignedRoles = Object.values(this.gameState.playerRoles).filter(id => id !== null);
                    if (assignedRoles.length > 0) {
                        this.gameState.addLog(`æ­¦å°†é…ç½®å®Œäº†ï¼šå½¹è·${assignedRoles.length}åé…ç½®æ¸ˆã¿`);
                    }
                } catch (error) {
                    // åˆæœŸUIæ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ç¶™ç¶š
                }
            }
            
            renderMap() {
                const mapGrid = document.getElementById('map-grid');
                mapGrid.innerHTML = '';
                
                // å…µç§‘ã‚¢ã‚¤ã‚³ãƒ³
                const unitIcons = {
                    'infantry': 'âš”ï¸',
                    'cavalry': 'ğŸ',
                    'arquebus': 'ğŸ”«'
                };
                
                this.gameState.territories.forEach((territory, index) => {
                    const territoryDiv = document.createElement('div');
                    territoryDiv.className = 'territory';
                    territoryDiv.dataset.territoryId = territory.id;
                    
                    let className = 'territory';
                    let ownerColor = null;

                    if (!territory.owner) {
                        className += ' empty';
                    } else {
                        const ownerDaimyo = this.gameState.daimyos.find(d => d.id === territory.owner);
                        if (ownerDaimyo && ownerDaimyo.color) {
                            ownerColor = ownerDaimyo.color;
                        }
                        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é ˜åœŸã¨æ•µé ˜åœŸã®ã‚¯ãƒ©ã‚¹ã¯ç¶­æŒï¼ˆãƒœãƒ¼ãƒ€ãƒ¼è‰²ãªã©ã«å½±éŸ¿ã™ã‚‹ãŸã‚ï¼‰
                        if (territory.owner === this.gameState.playerDaimyo) {
                            className += ' player';
                        } else {
                            className += ' enemy';
                        }
                    }
                    
                    territoryDiv.className = className;
                    if (ownerColor) {
                        territoryDiv.style.backgroundColor = ownerColor;
                        // èƒŒæ™¯è‰²ã«å¿œã˜ã¦æ–‡å­—è‰²ã‚’è‡ªå‹•èª¿æ•´
                        const r = parseInt(ownerColor.slice(1, 3), 16);
                        const g = parseInt(ownerColor.slice(3, 5), 16);
                        const b = parseInt(ownerColor.slice(5, 7), 16);
                        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                        if (brightness < 125) { // æš—ã„è‰²ãªã‚‰ç™½æ–‡å­—
                            territoryDiv.style.color = 'white';
                            territoryDiv.querySelectorAll('.territory-name, .territory-owner, .territory-stats').forEach(el => el.style.color = 'white');
                        } else { // æ˜ã‚‹ã„è‰²ãªã‚‰é»’æ–‡å­—
                            territoryDiv.style.color = 'black';
                            territoryDiv.querySelectorAll('.territory-name, .territory-owner, .territory-stats').forEach(el => el.style.color = 'black');
                        }
                    }
                    
                    const ownerName = territory.owner ? 
                        this.gameState.daimyos.find(d => d.id === territory.owner)?.name || 'ä¸æ˜' : 
                        'ç©ºç™½åœ°';
                    
                    // å…µç§‘è¡¨ç¤ºã®æ”¹å–„
                    let unitDisplay = '';
                    let advantageDisplay = '';
                    
                    if (territory.owner) {
                        // æ”¯é…ã•ã‚Œã¦ã„ã‚‹é ˜åœŸï¼šç¾åœ¨ã®å…µç§‘ãƒãƒ¼ã‚¯
                        if (territory.troops > 0 && territory.unitType) {
                            unitDisplay = ` ${unitIcons[territory.unitType] || 'âš”ï¸'}`;
                        }
                        
                        // åœ°åŸŸç‰¹æ€§ã¨ä¸€è‡´ã—ã¦ã„ã‚‹å ´åˆã¯ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯ã€ãã†ã§ãªã‘ã‚Œã°åœ°åŸŸç‰¹æ€§ã®ã‚¢ã‚¤ã‚³ãƒ³
                        if (territory.unitType === territory.advantageType) {
                            advantageDisplay = ' <span style="color: #66ff66;">âœ“</span>';
                        } else {
                            advantageDisplay = ` <span style="color: #ffaa66; font-size: 10px;">${unitIcons[territory.advantageType] || 'âš”ï¸'}</span>`;
                        }
                    } else {
                        // ç©ºç™½åœ°ï¼šåœ°åŸŸç‰¹æ€§ã®ãƒãƒ¼ã‚¯ã‚’åå‰ã®æ¨ªã«è¡¨ç¤º
                        advantageDisplay = ` <span style="color: #ffaa66;">${unitIcons[territory.advantageType] || 'âš”ï¸'}</span>`;
                    }
                    
                    // åœ°åŸŸç‰¹æ€§ã®è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆ
                    const advantageText = territory.advantageType === 'infantry' ? 'æ­©å…µ' : 
                                        territory.advantageType === 'cavalry' ? 'é¨é¦¬' : 'é‰„ç ²';
                    
                    let statsContent = '';
                    if (territory.owner) {
                        // æ”¯é…æ¸ˆã¿é ˜åœŸ
                        statsContent = `è¾²:${territory.agriculture} å•†:${territory.commerce}<br>å…µ:${territory.troops}${unitDisplay} å£:${territory.walls}`;
                        
                        // åœ°åŸŸç‰¹æ€§ã¨ç¾åœ¨ã®å…µç§‘ãŒé•ã†å ´åˆã¯åœ°åŸŸç‰¹æ€§ã‚’è¡¨ç¤º
                        if (territory.unitType !== territory.advantageType) {
                            statsContent += `<br><span style="color: #ffaa66; font-size: 10px;">${unitIcons[territory.advantageType]}${advantageText}æœ‰åˆ©</span>`;
                        }
                    } else {
                        // ç©ºç™½åœ°
                        statsContent = `è¾²:${territory.agriculture} å•†:${territory.commerce}<br>${unitIcons[territory.advantageType] || 'âš”ï¸'} ${advantageText}æœ‰åˆ©`;
                    }
                    
                    territoryDiv.innerHTML = `
                        <div class="territory-name">${territory.name}${advantageDisplay}</div>
                        <div class="territory-owner">${ownerName}</div>
                        <div class="territory-stats">${statsContent}</div>
                    `;
                    
                    mapGrid.appendChild(territoryDiv);
                });
            }
            
            updateStatus() {
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                
                document.getElementById('current-turn').textContent = this.gameState.turn;
                document.getElementById('player-gold').textContent = playerDaimyo.gold;
                document.getElementById('player-rice').textContent = playerDaimyo.rice;
            }
            
            selectTerritory(territoryId) {
                const territory = this.gameState.territories.find(t => t.id === territoryId);
                this.gameState.selectedTerritory = territory;
                
                // é¸æŠçŠ¶æ…‹ã®è¡¨ç¤ºæ›´æ–°
                document.querySelectorAll('.territory').forEach(t => {
                    t.style.border = '2px solid #666';
                });
                
                const territoryElement = document.querySelector(`[data-territory-id="${territoryId}"]`);
                if (territoryElement) {
                    territoryElement.style.border = '3px solid #ff6666';
                }
                
                // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’æ›´æ–°
                this.updateActionButtons();
                
                // é¸æŠæƒ…å ±ã‚’ãƒ­ã‚°ã«è¡¨ç¤ºï¼ˆæ”¹å–„ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
                if (territory) {
                    const ownerName = territory.owner ? 
                        this.gameState.daimyos.find(d => d.id === territory.owner)?.name || 'ä¸æ˜' : 
                        'ç©ºç™½åœ°';
                    
                    let statusMessage = `${territory.name}ã‚’é¸æŠ (æ”¯é…è€…: ${ownerName})`;
                    
                    // æ”»æ’ƒå¯èƒ½æ€§ã‚’ãƒã‚§ãƒƒã‚¯
                    const isPlayerTerritory = territory.owner === this.gameState.playerDaimyo;
                    const playerTerritories = this.gameState.getPlayerTerritories();
                    const isAdjacent = this.isAdjacentToPlayerTerritory(territory);
                    
                    const canAttack = !this.gameState.attackUsed && !isPlayerTerritory && playerTerritories.length > 0 && isAdjacent;
                    const canStrategy = !this.gameState.strategyUsed && !isPlayerTerritory && playerTerritories.length > 0 && isAdjacent;
                    const canDiplomacy = this.gameState.canUseDiplomacy() && !isPlayerTerritory && playerTerritories.length > 0 && isAdjacent;
                    
                    if (isPlayerTerritory) {
                        statusMessage += ' - è‡ªé ˜åœŸã®ãŸã‚è¡Œå‹•ä¸å¯';
                    } else if (playerTerritories.length === 0) {
                        statusMessage += ' - è‡ªé ˜åœŸã‚’æŒã£ã¦ã„ã¾ã›ã‚“';
                    } else if (!isAdjacent) {
                        if (territory.id === 'yamashiro') {
                            statusMessage += ' - å±±åŸã¸ã®å‡ºå…µã«ã¯è¿‘æ±Ÿãƒ»å¤§å’ŒãŒå¿…è¦';
                        } else {
                            statusMessage += ' - éš£æ¥ã—ã¦ã„ãªã„ãŸã‚å‡ºå…µãƒ»è¬€ç•¥ä¸å¯';
                        }
                    } else {
                        const availableActions = [];
                        if (canAttack) availableActions.push('å‡ºå…µ');
                        if (canStrategy) availableActions.push('è¬€ç•¥');
                        if (canDiplomacy) availableActions.push('å¤–äº¤');
                        
                        if (availableActions.length > 0) {
                            statusMessage += ` - å®Ÿè¡Œå¯èƒ½: ${availableActions.join('ã€')}`;
                        } else {
                            statusMessage += ' - å…¨ã¦ã®è¡Œå‹•ã‚’ä½¿ç”¨æ¸ˆã¿';
                        }
                    }
                    
                    this.gameState.addLog(statusMessage);
                }
            }
            
            updateActionButtons() {
                const selectedTerritory = this.gameState.selectedTerritory;
                const isPlayerTerritory = selectedTerritory?.owner === this.gameState.playerDaimyo;
                
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒé ˜åœŸã‚’æŒã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const playerTerritories = this.gameState.getPlayerTerritories();
                const hasPlayerTerritories = playerTerritories.length > 0;
                
                // éš£æ¥ãƒã‚§ãƒƒã‚¯ï¼šé¸æŠã•ã‚ŒãŸé ˜åœŸãŒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é ˜åœŸã¨éš£æ¥ã—ã¦ã„ã‚‹ã‹
                const isAdjacent = this.isAdjacentToPlayerTerritory(selectedTerritory);
                
                // å„è¡Œå‹•ã‚’å€‹åˆ¥ã«ãƒã‚§ãƒƒã‚¯ï¼ˆéš£æ¥æ¡ä»¶ã‚’è¿½åŠ ï¼‰
                const canAttack = !this.gameState.attackUsed && selectedTerritory && !isPlayerTerritory && hasPlayerTerritories && isAdjacent;
                const canStrategy = !this.gameState.strategyUsed && hasPlayerTerritories; // è™šå ±ã¯å¯¾è±¡ä¸è¦ãªã®ã§æ¡ä»¶ç·©å’Œ
                const canDiplomacy = this.gameState.canUseDiplomacy() && selectedTerritory && !isPlayerTerritory && hasPlayerTerritories && isAdjacent;
                
                // åµå¯Ÿã¯æ•µé ˜åœŸã§ã‚ã‚Œã°è¡Œå‹•æ¸ˆã¿ã§ã‚‚å¯èƒ½ï¼ˆéš£æ¥ä¸è¦ï¼‰
                const canScout = selectedTerritory && !isPlayerTerritory;
                
                document.getElementById('attack-btn').disabled = !canAttack;
                document.getElementById('strategy-btn').disabled = !canStrategy;
                document.getElementById('diplomacy-btn').disabled = !canDiplomacy;
                document.getElementById('scout-btn').disabled = !canScout;
                
                // å¤–äº¤ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å‹•çš„ã«å¤‰æ›´
                const diplomacyBtn = document.getElementById('diplomacy-btn');
                if (diplomacyBtn) {
                    const usedCount = this.gameState.diplomacyUsed;
                    const maxCount = this.gameState.getMaxDiplomacyCount();
                    diplomacyBtn.textContent = `å¤–äº¤(${usedCount}/${maxCount})`;
                }
                
                // å…µé›‡ç”¨ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å‹•çš„ã«å¤‰æ›´
                const recruitBtn = document.getElementById('recruit-btn');
                if (recruitBtn) {
                    if (selectedTerritory && isPlayerTerritory) {
                        recruitBtn.textContent = `${selectedTerritory.name}ã«é›‡ç”¨`;
                        recruitBtn.style.backgroundColor = '#006600';
                        recruitBtn.style.borderColor = '#008800';
                    } else {
                        recruitBtn.textContent = 'å…µé›‡ç”¨';
                        recruitBtn.style.backgroundColor = '';
                        recruitBtn.style.borderColor = '';
                    }
                }
            }
            
            // æµªäººã®è‡ªå‹•å£«å®˜å‡¦ç†
            processRoninAutoRecruitment() {
                try {
                    // 3ã‚¿ãƒ¼ãƒ³çµŒéã—ãŸæµªäººã‚’ãƒã‚§ãƒƒã‚¯
                    const roninToRecruit = this.gameState.availableGenerals.filter(ronin => 
                        ronin.appearanceTurn && (this.gameState.turn - ronin.appearanceTurn) >= 3
                    );
                    
                    roninToRecruit.forEach(ronin => {
                        // 50%ã®ç¢ºç‡ã§å£«å®˜
                        if (Math.random() < 0.5) {
                            // ç”Ÿå­˜ã—ã¦ã„ã‚‹å¤§åã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ
                            const aliveDaimyos = this.gameState.daimyos.filter(d => d && d.id);
                            if (aliveDaimyos.length > 0) {
                                const randomDaimyo = aliveDaimyos[Math.floor(Math.random() * aliveDaimyos.length)];
                                
                                // æµªäººã‚’æ­¦å°†ã¨ã—ã¦è¿½åŠ 
                                const newGeneral = {
                                    ...ronin,
                                    lord: randomDaimyo.id,
                                    loyalty: Math.floor(Math.random() * 30) + 50, // 50-79ã®å¿ èª åº¦
                                    experience: 0,
                                    position: 'none'
                                };
                                delete newGeneral.appearanceTurn;
                                delete newGeneral.recruitCost;
                                delete newGeneral.baseCharm;
                                
                                this.gameState.generals.push(newGeneral);
                                
                                // ãƒ­ã‚°ã«è¨˜éŒ²
                                const daimyoName = randomDaimyo.name || 'ä¸æ˜';
                                this.gameState.addPersonnelLog(`${ronin.name}ãŒ${daimyoName}ã«è‡ªã‚‰å£«å®˜ã—ãŸ`);
                                
                                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒé–¢ä¿‚ã™ã‚‹å ´åˆã¯ãƒ¡ã‚¤ãƒ³ãƒ­ã‚°ã«ã‚‚
                                if (randomDaimyo.id === this.gameState.playerDaimyo) {
                                    this.gameState.addLog(`${ronin.name}ãŒä»•å®˜ã‚’ç”³ã—å‡ºã¦ããŸï¼`, 'diplomacy');
                                }
                            }
                        }
                        
                        // æµªäººãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
                        this.gameState.availableGenerals = this.gameState.availableGenerals.filter(r => r.id !== ronin.id);
                    });
                    
                } catch (error) {
                    console.warn('æµªäººè‡ªå‹•å£«å®˜å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            // é¸æŠã•ã‚ŒãŸé ˜åœŸãŒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é ˜åœŸã¨éš£æ¥ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            isAdjacentToPlayerTerritory(targetTerritory) {
                if (!targetTerritory) return false;
                
                const playerTerritories = this.gameState.getPlayerTerritories();
                if (playerTerritories.length === 0) return false;
                
                // å±±åŸã¸ã®å‡ºå…µã¯è¿‘æ±Ÿãƒ»å¤§å’Œã‹ã‚‰ã®ã¿å¯èƒ½
                if (targetTerritory.id === 'yamashiro') {
                    return playerTerritories.some(playerTerritory => 
                        playerTerritory.id === 'omi' || playerTerritory.id === 'yamato'
                    );
                }
                
                // ãã®ä»–ã®é ˜åœŸã¯é€šå¸¸ã®éš£æ¥ãƒã‚§ãƒƒã‚¯
                return playerTerritories.some(playerTerritory => 
                    playerTerritory.adjacentTerritories.includes(targetTerritory.id)
                );
            }
            
            // é™£å½¢é¸æŠã‚·ã‚¹ãƒ†ãƒ 
            showFormationSelection() {
                console.log('showFormationSelection called');
                const target = this.gameState.selectedTerritory;
                console.log('selected territory:', target);
                if (!target) {
                    console.log('No territory selected');
                    this.gameState.addLog('æ”»æ’ƒå¯¾è±¡ã®é ˜åœŸã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }
                
                // æ•µã®é™£å½¢ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«æ±ºå®š
                const formationKeys = Object.keys(this.gameState.formations);
                const enemyFormation = formationKeys[Math.floor(Math.random() * formationKeys.length)];
                console.log('Enemy formation selected:', enemyFormation);
                
                // è»å¸«ã®åŠ©è¨€ãƒã‚§ãƒƒã‚¯
                this.checkStrategistAdvice(enemyFormation);
                
                // é™£å½¢é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                document.getElementById('formation-modal').style.display = 'flex';
                
                // é™£å½¢ã‚«ãƒ¼ãƒ‰ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
                this.setupFormationSelection(target, enemyFormation);
            }
            
            checkStrategistAdvice(enemyFormation) {
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è»å¸«ã‚’å–å¾—ï¼ˆè»å›£ç·¨æˆã®è»å¸«ï¼‰
                const ourStrategist = this.gameState.playerRoles.armyStrategist ? 
                    this.gameState.generals.find(g => g.id === this.gameState.playerRoles.armyStrategist) : null;
                
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å¤§åã‚’å–å¾—
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                
                // æ•µã®è»å¸«ã‚’å–å¾—ï¼ˆç°¡æ˜“ç‰ˆï¼šæ•µå¤§åã®çŸ¥è¬€ã‚’ä½¿ç”¨ï¼‰
                const target = this.gameState.selectedTerritory;
                const enemyDaimyo = target.owner ? this.gameState.daimyos.find(d => d.id === target.owner) : null;
                const enemyIntelligence = enemyDaimyo ? enemyDaimyo.stats.intelligence : 70;
                
                const adviceElement = document.getElementById('strategist-advice');
                const adviceText = document.getElementById('advice-text');
                
                // è»å¸«ãŒã„ãªã„å ´åˆ
                if (!ourStrategist) {
                    adviceElement.style.display = 'none';
                    console.log('No strategist assigned');
                    return;
                }
                
                // å¤§åã®é­…åŠ›ã«ã‚ˆã‚‹åŠ©è¨€ç™ºå‹•ç‡ã‚’è¨ˆç®—
                const daimyoCharm = playerDaimyo ? playerDaimyo.stats.charm : 50;
                const adviceActivationRate = Math.max(0, Math.min(100, (daimyoCharm - 80) * 5));
                const roll = Math.random() * 100;
                
                console.log(`Advice activation check: charm=${daimyoCharm}, rate=${adviceActivationRate}%, roll=${roll.toFixed(1)}%`);
                
                // ç™ºå‹•ç‡ãƒã‚§ãƒƒã‚¯
                if (roll > adviceActivationRate) {
                    // åŠ©è¨€ç™ºå‹•å¤±æ•—
                    adviceText.innerHTML = `<strong style="color: #66ccff;">${ourStrategist.name}</strong>ï¼š<br>ã€Œæ®¿ã®å¨å³ãŒè¶³ã‚Šãšã€æ•µæƒ…ã‚’æŠŠæ¡ã§ãã¾ã›ã‚“ã§ã—ãŸ...ã€<br><span style="color: #888; font-size: 10px;">åŠ©è¨€ç™ºå‹•ç‡: ${adviceActivationRate}% (é­…åŠ›${daimyoCharm})</span>`;
                    adviceElement.style.display = 'block';
                    console.log('Advice activation failed due to insufficient charm');
                    return;
                }
                
                // åŠ©è¨€ç™ºå‹•æˆåŠŸ - çŸ¥è¬€ãƒã‚§ãƒƒã‚¯
                if (ourStrategist.stats.intelligence > enemyIntelligence) {
                    // è»å¸«ã®åŠ©è¨€ã‚’è¡¨ç¤º
                    const enemyFormationData = this.gameState.formations[enemyFormation];
                    const recommendedFormations = enemyFormationData.disadvantages; // æ•µã®å¼±ç‚¹ã¨ãªã‚‹é™£å½¢
                    
                    let advice = `<strong style="color: #66ccff;">${ourStrategist.name}</strong>ã®åŠ©è¨€ï¼š<br>`;
                    advice += `ã€Œæ•µã¯ã€${enemyFormationData.name}ã€ã‚’ä½¿ç”¨ã—ã¦ãã¾ã™ã€‚<br>`;
                    if (recommendedFormations.length > 0) {
                        const recommendedNames = recommendedFormations.map(f => this.gameState.formations[f].name);
                        advice += `æˆ‘ãŒè»ã«ã¯ã€${recommendedNames.join('ã€ã¾ãŸã¯ã€')}ã€ãŒæœ‰åŠ¹ã§ã—ã‚‡ã†ã€‚ã€<br>`;
                    } else {
                        advice += `ç‰¹ã«æœ‰åŠ¹ãªé™£å½¢ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€æ…é‡ã«é¸æŠã—ã¦ãã ã•ã„ã€‚ã€<br>`;
                    }
                    advice += `<span style="color: #888; font-size: 10px;">åŠ©è¨€ç™ºå‹•ç‡: ${adviceActivationRate}% (é­…åŠ›${daimyoCharm}) - æˆåŠŸ</span>`;
                    
                    adviceText.innerHTML = advice;
                    adviceElement.style.display = 'block';
                    
                    console.log('Strategist advice shown:', advice);
                } else {
                    // è»å¸«ã¯ã„ã‚‹ãŒçŸ¥è¬€ãŒè¶³ã‚Šãªã„å ´åˆ
                    adviceText.innerHTML = `<strong style="color: #66ccff;">${ourStrategist.name}</strong>ï¼š<br>ã€Œæ•µã®é™£å½¢ã‚’è¦‹ç ´ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“...ã€<br><span style="color: #888; font-size: 10px;">åŠ©è¨€ç™ºå‹•ç‡: ${adviceActivationRate}% (é­…åŠ›${daimyoCharm}) - çŸ¥è¬€ä¸è¶³</span>`;
                    adviceElement.style.display = 'block';
                    console.log('Strategist present but insufficient intelligence');
                }
            }
            
            setupFormationSelection(target, enemyFormation) {
                const formationCards = document.querySelectorAll('.formation-card');
                const confirmBtn = document.getElementById('formation-confirm-btn');
                const cancelBtn = document.getElementById('formation-cancel-btn');
                let selectedFormation = null;
                
                // æ—¢å­˜ã®é¸æŠçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
                formationCards.forEach(card => {
                    card.classList.remove('selected');
                    // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã™ã‚‹å‰ã«å¤ã„ã‚‚ã®ã‚’å‰Šé™¤
                    card.replaceWith(card.cloneNode(true));
                });
                
                // æ–°ã—ã„ã‚«ãƒ¼ãƒ‰è¦ç´ ã‚’å–å¾—
                const newFormationCards = document.querySelectorAll('.formation-card');
                
                // ã‚«ãƒ¼ãƒ‰é¸æŠå‡¦ç†
                newFormationCards.forEach(card => {
                    card.addEventListener('click', () => {
                        newFormationCards.forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected');
                        selectedFormation = card.dataset.formation;
                        confirmBtn.disabled = false;
                        console.log('Formation selected:', selectedFormation);
                    });
                });
                
                // æ±ºå®šãƒœã‚¿ãƒ³
                confirmBtn.onclick = () => {
                    if (selectedFormation) {
                        console.log('Formation confirmed:', selectedFormation);
                        this.gameState.selectedFormation = selectedFormation;
                        document.getElementById('formation-modal').style.display = 'none';
                        this.executeAttackWithFormation(target, selectedFormation, enemyFormation);
                    }
                };
                
                // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
                cancelBtn.onclick = () => {
                    console.log('Formation selection cancelled');
                    document.getElementById('formation-modal').style.display = 'none';
                };
                
                // åˆæœŸçŠ¶æ…‹ã§ã¯æ±ºå®šãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                confirmBtn.disabled = true;
            }
            
            executeAttackWithFormation(target, playerFormation, enemyFormation) {
                console.log('Executing attack with formations:', playerFormation, 'vs', enemyFormation);
                
                // é™£å½¢åŠ¹æœã‚’ä¿å­˜
                this.gameState.currentBattle = {
                    playerFormation: playerFormation,
                    enemyFormation: enemyFormation,
                    formationBonus: this.calculateFormationBonus(playerFormation, enemyFormation)
                };
                
                // é™£å½¢æƒ…å ±ã‚’ãƒ­ã‚°ã«è¿½åŠ 
                const playerFormationName = this.gameState.formations[playerFormation].name;
                const enemyFormationName = this.gameState.formations[enemyFormation].name;
                
                this.gameState.addLog(`é™£å½¢é¸æŠ: æˆ‘ãŒè»ã€Œ${playerFormationName}ã€vs æ•µè»ã€Œ${enemyFormationName}ã€`, 'battle');
                
                if (this.gameState.currentBattle.formationBonus.player > 1) {
                    this.gameState.addLog(`é™£å½¢ç›¸æ€§ï¼šæˆ‘ãŒè»æœ‰åˆ©ï¼æˆ¦åŠ›1.2å€ãƒœãƒ¼ãƒŠã‚¹`, 'battle');
                } else if (this.gameState.currentBattle.formationBonus.enemy > 1) {
                    this.gameState.addLog(`é™£å½¢ç›¸æ€§ï¼šæ•µè»æœ‰åˆ©ï¼æ•µã«1.2å€ãƒœãƒ¼ãƒŠã‚¹`, 'battle');
                } else {
                    this.gameState.addLog(`é™£å½¢ç›¸æ€§ï¼šäº’è§’`, 'battle');
                }
                
                // é€šå¸¸ã®æ”»æ’ƒå‡¦ç†ã‚’å®Ÿè¡Œ
                this.executeAttack();
            }
            
            calculateFormationBonus(playerFormation, enemyFormation) {
                const playerData = this.gameState.formations[playerFormation];
                const enemyData = this.gameState.formations[enemyFormation];
                
                let playerBonus = 1.0;
                let enemyBonus = 1.0;
                
                // ç›¸æ€§ãƒã‚§ãƒƒã‚¯
                if (playerData.advantages.includes(enemyFormation)) {
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æœ‰åˆ©
                    playerBonus = 1.2;
                } else if (playerData.disadvantages.includes(enemyFormation)) {
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸åˆ©ï¼ˆæ•µæœ‰åˆ©ï¼‰
                    enemyBonus = 1.2;
                }
                // åŒã˜é™£å½¢ã¾ãŸã¯ç›¸æ€§ãªã—ã®å ´åˆã¯1.0ã®ã¾ã¾
                
                console.log('Formation bonus calculated:', { player: playerBonus, enemy: enemyBonus });
                
                return {
                    player: playerBonus,
                    enemy: enemyBonus
                };
            }
            
            showAttackModal() {
                const target = this.gameState.selectedTerritory;
                if (!target) return;
                
                // å…µç§‘ã‚¢ã‚¤ã‚³ãƒ³ã¨åå‰
                const unitIcons = {
                    'infantry': 'âš”ï¸',
                    'cavalry': 'ğŸ',
                    'arquebus': 'ğŸ”«'
                };
                
                const unitNames = {
                    'infantry': 'æ­©å…µ',
                    'cavalry': 'é¨é¦¬',
                    'arquebus': 'é‰„ç ²'
                };
                
                // åœ°åŸŸç‰¹æ€§æƒ…å ±
                const advantageIcon = unitIcons[target.advantageType] || 'âš”ï¸';
                const advantageName = unitNames[target.advantageType] || 'ä¸æ˜';
                
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä¸»åŠ›å…µç§‘ã‚’åˆ¤å®šï¼ˆæœ€ã‚‚å…µæ•°ã®å¤šã„é ˜åœŸã®å…µç§‘ï¼‰
                const playerTerritories = this.gameState.getPlayerTerritories();
                let playerMainUnit = 'infantry';
                let maxTroops = 0;
                
                playerTerritories.forEach(territory => {
                    if (territory.troops > maxTroops) {
                        maxTroops = territory.troops;
                        playerMainUnit = territory.unitType;
                    }
                });
                
                const playerUnitIcon = unitIcons[playerMainUnit] || 'âš”ï¸';
                const playerUnitName = unitNames[playerMainUnit] || 'ä¸æ˜';
                
                // ç›¸æ€§åˆ¤å®š
                let compatibilityText = '';
                let compatibilityColor = '#ffaa66';
                
                if (playerMainUnit === target.advantageType) {
                    compatibilityText = 'ã€æœ‰åˆ©ã€‘ã“ã®åœ°åŸŸã§ã¯æˆ‘è»ã®å…µç§‘ãŒ+20%ãƒœãƒ¼ãƒŠã‚¹ï¼';
                    compatibilityColor = '#66ff66';
                } else {
                    compatibilityText = `ã€é€šå¸¸ã€‘æˆ‘è»${playerUnitIcon}${playerUnitName} vs åœ°åŸŸç‰¹æ€§${advantageIcon}${advantageName}`;
                    compatibilityColor = '#ffaa66';
                }
                
                // å±±åŸã¸ã®å‡ºå…µæ¡ä»¶ãƒã‚§ãƒƒã‚¯
                let attackCondition = '';
                if (target.id === 'yamashiro') {
                    const hasOmi = playerTerritories.some(t => t.id === 'omi');
                    const hasYamato = playerTerritories.some(t => t.id === 'yamato');
                    
                    if (hasOmi && hasYamato) {
                        attackCondition = '<div style="background: #003366; border: 1px solid #66ccff; border-radius: 5px; padding: 10px; margin-bottom: 15px;"><h4 style="color: #66ccff; margin-bottom: 8px;">ã€å±±åŸå‡ºå…µè·¯ã€‘</h4><p style="color: #66ccff;">è¿‘æ±Ÿãƒ»å¤§å’Œã®ä¸¡æ–¹ã‚’ç¢ºä¿ï¼ä¸‡å…¨ã®ä½“åˆ¶ã§å¤©ä¸‹ã®ä¸­å¿ƒåœ°ã‚’æ”»ç•¥</p></div>';
                    } else if (hasOmi) {
                        attackCondition = '<div style="background: #003366; border: 1px solid #66ccff; border-radius: 5px; padding: 10px; margin-bottom: 15px;"><h4 style="color: #66ccff; margin-bottom: 8px;">ã€å±±åŸå‡ºå…µè·¯ã€‘</h4><p style="color: #66ccff;">è¿‘æ±Ÿã‹ã‚‰å¤©ä¸‹ã®ä¸­å¿ƒåœ°ãƒ»å±±åŸã¸ã®é€²è»</p></div>';
                    } else if (hasYamato) {
                        attackCondition = '<div style="background: #003366; border: 1px solid #66ccff; border-radius: 5px; padding: 10px; margin-bottom: 15px;"><h4 style="color: #66ccff; margin-bottom: 8px;">ã€å±±åŸå‡ºå…µè·¯ã€‘</h4><p style="color: #66ccff;">å¤§å’Œã‹ã‚‰å¤©ä¸‹ã®ä¸­å¿ƒåœ°ãƒ»å±±åŸã¸ã®é€²è»</p></div>';
                    }
                }
                
                let battlePhase = '';
                if (target.troops > 0) {
                    battlePhase = '<p><strong style="color: #ffff66;">ç¬¬1æ®µéš:</strong> ã¾ãšå®ˆå‚™å…µã‚’æ’ƒç ´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™</p>';
                } else {
                    battlePhase = '<p><strong style="color: #ff6666;">ç¬¬2æ®µéš:</strong> å®ˆå‚™å…µã¯å…¨æ»…æ¸ˆã¿ã€‚åŸå£ã‚’ç ´å£Šã—ã¦æ”»ç•¥ï¼</p>';
                }
                
                document.getElementById('modal-title').textContent = `${target.name}ã¸ã®å‡ºå…µ`;
                document.getElementById('modal-body').innerHTML = `
                    ${attackCondition}
                    <div style="background: #333; border: 1px solid #666; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="color: #ff6666; margin-bottom: 10px;">ã€æ”»æ’ƒç›®æ¨™æƒ…å ±ã€‘</h4>
                        <p><strong>é ˜åœŸå:</strong> ${target.name}</p>
                        <p><strong>å®ˆå‚™å…µåŠ›:</strong> ${target.troops}</p>
                        <p><strong>åŸå£å¼·åº¦:</strong> ${target.walls}</p>
                        <p><strong>åœ°åŸŸç‰¹æ€§:</strong> ${advantageIcon} ${advantageName}æœ‰åˆ©åœ°åŸŸ</p>
                    </div>
                    
                    <div style="background: #222; border: 1px solid #666; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="color: #66ff66; margin-bottom: 10px;">ã€å…µç§‘ç›¸æ€§ã€‘</h4>
                        <p style="color: ${compatibilityColor};">${compatibilityText}</p>
                        ${playerMainUnit === target.advantageType ? 
                            '<p style="color: #66ff66; font-size: 12px;">â€»åœ°åŸŸç‰¹æ€§ãƒœãƒ¼ãƒŠã‚¹ã«ã‚ˆã‚Šæˆ¦é—˜åŠ›ãŒå¤§å¹…ã«å‘ä¸Šã—ã¾ã™</p>' : 
                            '<p style="color: #ccc; font-size: 12px;">â€»å…µç§‘å¤‰æ›´ã§åœ°åŸŸç‰¹æ€§ãƒœãƒ¼ãƒŠã‚¹(+20%)ã‚’å¾—ã‚‰ã‚Œã¾ã™</p>'
                        }
                    </div>
                    
                    ${battlePhase}
                    <p style="font-size: 11px; color: #ccc;">â€»å…µæ•°ãŒ0ã«ãªã£ã¦ã‹ã‚‰åŸå£ãŒæ”»æ’ƒå¯¾è±¡ã¨ãªã‚Šã¾ã™</p>
                    
                    <div style="background: #4a2c2c; border: 2px solid #ff6666; border-radius: 8px; padding: 12px; margin: 15px 0;">
                        <h4 style="color: #ff6666; margin-bottom: 8px;">ã€å‡ºå…µè²»ç”¨ã€‘</h4>
                        <p style="color: #ffcccc; margin-bottom: 5px;"><strong>é‡‘10ã‚’æ¶ˆè²»ã—ã¾ã™</strong></p>
                        <p style="color: #ffaaaa; font-size: 11px;">â€»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ã‚‚è¿”é‡‘ã•ã‚Œã¾ã›ã‚“</p>
                        <p style="color: #ffaaaa; font-size: 11px;">â€»è»å¸«ã®åŠ©è¨€ã‚’è¦‹ã‚‹ãŸã‚ã®åµå¯Ÿè²»ç”¨ã§ã™</p>
                    </div>
                    
                    <p><strong>å‡ºå…µã—ã¾ã™ã‹ï¼Ÿ</strong></p>
                `;
                document.getElementById('action-modal').style.display = 'flex';
                this.currentAction = 'attack';
            }
            
            showStrategyModal() {
                const target = this.gameState.selectedTerritory;
                if (!target) return;
                
                document.getElementById('modal-title').textContent = `è¬€ç•¥å·¥ä½œ`;
                document.getElementById('modal-body').innerHTML = `
                    <p>è¬€ç•¥ã®ç¨®é¡ã‚’é¸æŠã—ã¦ãã ã•ã„:</p>
                    <select id="strategy-type" style="width: 100%; padding: 8px; background: #333; border: 1px solid #666; color: #fff; border-radius: 5px;">
                        <option value="rumor">è™šå ±é˜²å¾¡</option>
                        <option value="fire">ç«æ”»ã‚</option>
                        <option value="water">æ°´æ”»ã‚</option>
                        <option value="defection">èª¿ç•¥</option>
                    </select>
                `;
                
                document.getElementById('action-modal').style.display = 'flex';
                this.currentAction = 'strategy';
            }
            
            showDiplomacyModal() {
                const target = this.gameState.selectedTerritory;
                if (!target) return;
                
                document.getElementById('modal-title').textContent = `${target.name}ã¨ã®å¤–äº¤`;
                document.getElementById('modal-body').innerHTML = `
                    <p>å¤–äº¤äº¤æ¸‰ã‚’è¡Œã„ã¾ã™ã€‚</p>
                    <p>åœæˆ¦å”å®šã‚’ææ¡ˆã—ã¾ã™ã‹ï¼Ÿ</p>
                `;
                document.getElementById('action-modal').style.display = 'flex';
                this.currentAction = 'diplomacy';
            }
            
            showTradeModal() {
                document.getElementById('modal-title').textContent = 'ç±³å£²è²·';
                document.getElementById('modal-body').innerHTML = `
                    <div style="background: #333; border: 1px solid #666; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="color: #ffff66; margin-bottom: 10px;">ã€ç¾åœ¨ã®ç›¸å ´ã€‘</h4>
                        <p style="text-align: center; font-size: 16px;">é‡‘100 â‡” ç±³50</p>
                    </div>
                    
                    <div style="background: #222; border: 1px solid #666; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="color: #66ff66; margin-bottom: 15px;">ã€å–å¼•è¨­å®šã€‘</h4>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #fff;">å–å¼•ç¨®åˆ¥:</label>
                            <select id="trade-type" style="width: 100%; background: #333; border: 1px solid #666; color: #fff; padding: 8px; border-radius: 5px;">
                                <option value="buy">ç±³ã‚’è²·ã† (é‡‘â†’ç±³)</option>
                                <option value="sell">ç±³ã‚’å£²ã‚‹ (ç±³â†’é‡‘)</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #fff;">å–å¼•æ•°é‡:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <button class="btn" onclick="uiManager.adjustTradeAmount(-100)" style="padding: 8px 12px;">-100</button>
                                <input type="number" id="trade-amount" min="0" max="5000" value="100" 
                                       style="flex: 1; background: #333; border: 1px solid #666; color: #fff; padding: 8px; border-radius: 5px; text-align: center;">
                                <button class="btn" onclick="uiManager.adjustTradeAmount(100)" style="padding: 8px 12px;">+100</button>
                            </div>
                            <div style="text-align: center; margin-top: 8px; color: #ccc; font-size: 12px;">
                                â€»ç›´æ¥å…¥åŠ›ã‚‚å¯èƒ½ã§ã™
                            </div>
                        </div>
                        
                        <div id="trade-preview" style="background: #444; border: 1px solid #666; border-radius: 5px; padding: 10px; text-align: center; color: #ffff66;">
                            <!-- å–å¼•ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </div>
                    </div>
                `;
                
                // å–å¼•ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
                this.updateTradePreview();
                
                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                const amountInput = document.getElementById('trade-amount');
                const typeSelect = document.getElementById('trade-type');
                
                if (amountInput) {
                    amountInput.addEventListener('input', () => this.updateTradePreview());
                }
                if (typeSelect) {
                    typeSelect.addEventListener('change', () => this.updateTradePreview());
                }
                
                document.getElementById('action-modal').style.display = 'flex';
                this.currentAction = 'trade';
            }
            
            adjustTradeAmount(change) {
                const input = document.getElementById('trade-amount');
                if (input) {
                    const currentValue = parseInt(input.value) || 0;
                    const newValue = Math.max(0, Math.min(5000, currentValue + change));
                    input.value = newValue;
                    this.updateTradePreview();
                }
            }
            
            updateTradePreview() {
                const amount = parseInt(document.getElementById('trade-amount')?.value || '0');
                const type = document.getElementById('trade-type')?.value;
                const preview = document.getElementById('trade-preview');
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                
                if (!preview || !playerDaimyo) return;
                
                let previewText = '';
                let canAfford = false;
                
                if (type === 'buy') {
                    const cost = amount * 2;
                    canAfford = playerDaimyo.gold >= cost;
                    previewText = `é‡‘${cost}ã§ç±³${amount}ã‚’è³¼å…¥`;
                    if (!canAfford) {
                        previewText += ` <span style="color: #ff6666;">(è³‡é‡‘ä¸è¶³)</span>`;
                    }
                } else {
                    const income = amount * 2;
                    canAfford = playerDaimyo.rice >= amount;
                    previewText = `ç±³${amount}ã‚’å£²ã£ã¦é‡‘${income}ã‚’ç²å¾—`;
                    if (!canAfford) {
                        previewText += ` <span style="color: #ff6666;">(ç±³ä¸è¶³)</span>`;
                    }
                }
                
                preview.innerHTML = previewText;
                preview.style.color = canAfford ? '#66ff66' : '#ff6666';
            }
            
            showRecruitModal() {
                const playerTerritories = this.gameState.getPlayerTerritories();
                if (playerTerritories.length === 0) {
                    this.gameState.addLog('å…µã‚’é›‡ç”¨ã™ã‚‹ã«ã¯é ˜åœŸãŒå¿…è¦ã§ã™');
                    return;
                }
                
                const selectedTerritory = this.gameState.selectedTerritory;
                const isSelectedPlayerTerritory = selectedTerritory?.owner === this.gameState.playerDaimyo;
                
                let defaultTerritoryId = '';
                if (isSelectedPlayerTerritory) {
                    defaultTerritoryId = selectedTerritory.id;
                }
                
                const unitTypeNames = {
                    'infantry': 'æ­©å…µ',
                    'cavalry': 'é¨é¦¬', 
                    'arquebus': 'é‰„ç ²'
                };
                
                document.getElementById('modal-title').textContent = 'å…µå£«é›‡ç”¨';
                document.getElementById('modal-body').innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <label>é…ç½®å…ˆ:</label>
                        <select id="recruit-territory" style="width: 100%; background: #333; border: 1px solid #666; color: #fff; padding: 8px; border-radius: 5px; margin-top: 5px;">
                            ${playerTerritories.map(t => 
                                `<option value="${t.id}" ${t.id === defaultTerritoryId ? 'selected' : ''}>${t.name} (${unitTypeNames[t.unitType]})</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label>é›‡ç”¨å…µæ•°:</label>
                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                            <button class="btn" onclick="uiManager.adjustRecruitAmount(-100)" style="padding: 8px 12px;">-100</button>
                            <input type="number" id="recruit-amount" min="0" max="2000" value="100" 
                                   style="flex: 1; background: #333; border: 1px solid #666; color: #fff; padding: 8px; border-radius: 5px; text-align: center;">
                            <button class="btn" onclick="uiManager.adjustRecruitAmount(100)" style="padding: 8px 12px;">+100</button>
                        </div>
                        <div style="text-align: center; margin-top: 8px; color: #ccc; font-size: 12px;">
                            è²»ç”¨: é‡‘1 = å…µå£«1äºº
                        </div>
                    </div>
                    
                    <div style="background: #333; border: 1px solid #666; border-radius: 5px; padding: 10px; margin-bottom: 15px;">
                        <h4 style="color: #ffff66; margin-bottom: 8px;">å…µç§‘å¤‰æ›´ (è²»ç”¨: é‡‘100)</h4>
                        <div id="unit-type-controls">
                `;
                
                playerTerritories.forEach(territory => {
                    const currentUnit = unitTypeNames[territory.unitType];
                    const advantageUnit = unitTypeNames[territory.advantageType];
                    const isAdvantaged = territory.unitType === territory.advantageType;
                    
                    document.getElementById('modal-body').innerHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 8px; background: #222; border-radius: 3px;">
                            <div>
                                <strong style="color: #ff6666;">${territory.name}</strong>
                                <span style="color: #ccc; margin-left: 10px;">${currentUnit} ${isAdvantaged ? 'âœ“' : ''}</span>
                            </div>
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <select id="unit-select-${territory.id}" data-territory="${territory.id}" style="background: #333; border: 1px solid #555; color: #fff; padding: 3px;">
                                    <option value="infantry" ${territory.unitType === 'infantry' ? 'selected' : ''}>æ­©å…µ</option>
                                    <option value="cavalry" ${territory.unitType === 'cavalry' ? 'selected' : ''}>é¨é¦¬</option>
                                    <option value="arquebus" ${territory.unitType === 'arquebus' ? 'selected' : ''}>é‰„ç ²</option>
                                </select>
                                <button class="btn" style="padding: 3px 8px; font-size: 11px;" 
                                        onclick="uiManager.changeUnitType('${territory.id}')" id="change-btn-${territory.id}">
                                    å¤‰æ›´
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('modal-body').innerHTML += '</div></div>';
                
                document.getElementById('action-modal').style.display = 'flex';
                this.currentAction = 'recruit';
            }
            
            adjustRecruitAmount(change) {
                const input = document.getElementById('recruit-amount');
                if (input) {
                    const currentValue = parseInt(input.value) || 0;
                    const newValue = Math.max(0, Math.min(2000, currentValue + change));
                    input.value = newValue;
                }
            }
            
            changeUnitType(territoryId) {
                const territory = this.gameState.territories.find(t => t.id === territoryId);
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                const newUnitType = document.getElementById(`unit-select-${territoryId}`).value;
                
                if (!territory || !playerDaimyo) return;
                
                if (territory.unitType === newUnitType) {
                    this.gameState.addLog('æ—¢ã«åŒã˜å…µç§‘ã§ã™');
                    return;
                }
                
                if (playerDaimyo.gold < 100) {
                    this.gameState.addLog('å…µç§‘å¤‰æ›´ã«ã¯é‡‘100ãŒå¿…è¦ã§ã™');
                    return;
                }
                
                const unitTypeNames = {
                    'infantry': 'æ­©å…µ',
                    'cavalry': 'é¨é¦¬', 
                    'arquebus': 'é‰„ç ²'
                };
                
                const oldUnit = unitTypeNames[territory.unitType];
                const newUnit = unitTypeNames[newUnitType];
                
                // è²»ç”¨ã‚’æ”¯æ‰•ã„ã€å…µç§‘ã‚’å¤‰æ›´
                playerDaimyo.gold -= 100;
                territory.unitType = newUnitType;
                
                this.gameState.addLog(`${territory.name}ã®å…µç§‘ã‚’${oldUnit}ã‹ã‚‰${newUnit}ã«å¤‰æ›´`, 'strategy');
                this.gameState.addPersonnelLog(`${territory.name}ã®è»åˆ¶ã‚’${newUnit}ã«æ”¹ç·¨ï¼ˆè²»ç”¨: é‡‘100ï¼‰`);
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’æ›´æ–°
                this.showRecruitModal();
                this.updateStatus();
            }
            
            hideModal() {
                document.getElementById('action-modal').style.display = 'none';
                this.currentAction = null;
            }
            
            executeModalAction() {
                switch (this.currentAction) {
                    case 'attack':
                        // å‡ºå…µã«ã¯é‡‘10ãŒå¿…è¦
                        const playerDaimyo = this.gameState.getPlayerDaimyoData();
                        if (!playerDaimyo || playerDaimyo.gold < 10) {
                            this.gameState.addLog('å‡ºå…µã«ã¯é‡‘10ãŒå¿…è¦ã§ã™');
                            this.hideModal();
                            return;
                        }
                        
                        // é‡‘10ã‚’æ¶ˆè²»ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ã‚‚è¿”é‡‘ã•ã‚Œãªã„ï¼‰
                        playerDaimyo.gold -= 10;
                        this.gameState.addLog('å‡ºå…µæº–å‚™ã®ãŸã‚é‡‘10ã‚’æ¶ˆè²»ã—ã¾ã—ãŸ', 'battle');
                        this.updateStatus(); // é‡‘ã®è¡¨ç¤ºã‚’æ›´æ–°
                        
                        this.hideModal();
                        // æ”»æ’ƒç¢ºèªå¾Œã«é™£å½¢é¸æŠã‚’è¡¨ç¤º
                        this.showFormationSelection();
                        return; // hideModal()ã¯æ—¢ã«å‘¼ã‚“ã ã®ã§return
                    case 'strategy':
                        this.executeStrategy();
                        break;
                    case 'diplomacy':
                        this.executeDiplomacy();
                        break;
                    case 'trade':
                        this.executeTrade();
                        break;
                    case 'recruit':
                        this.executeRecruit();
                        break;
                }
                this.hideModal();
            }
            
            executeAttack() {
                const target = this.gameState.selectedTerritory;
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                
                if (!target || !playerDaimyo) {
                    this.gameState.addLog('æ”»æ’ƒå¯¾è±¡ã¾ãŸã¯å¤§åãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™', 'battle');
                    return;
                }
                
                // å¤–äº¤å”å®šãƒã‚§ãƒƒã‚¯ï¼šç›¸äº’ä¸å¯ä¾µæ¡ç´„ãŒã‚ã‚‹å ´åˆã¯æ”»æ’ƒã‚’ç¦æ­¢
                if (target.owner && this.gameState.diplomacyTreaties[this.gameState.playerDaimyo] && 
                    this.gameState.diplomacyTreaties[this.gameState.playerDaimyo].includes(target.owner)) {
                    const targetDaimyoName = this.gameState.daimyos.find(d => d.id === target.owner)?.name || 'ç›¸æ‰‹';
                    this.gameState.addLog(`${targetDaimyoName}ã¨ã¯å¤–äº¤å”å®šã‚’çµã‚“ã§ãŠã‚Šæ”»æ’ƒã§ãã¾ã›ã‚“`, 'diplomacy');
                    return; // æ”»æ’ƒã‚’ä¸­æ­¢
                }
                
                // é˜²å¾¡å´ã®å¤§åãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                let defenderDaimyo = null;
                if (target.owner) {
                    defenderDaimyo = this.gameState.daimyos.find(d => d && d.id === target.owner);
                }
                
                // æˆ¦é—˜ãƒ­ã‚°ç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–
                const battleLog = {
                    events: [],
                    generalActivities: [], // æ­¦å°†ã®æ´»èºãƒ­ã‚°
                    skillActivations: [], // ç‰¹æŠ€ç™ºå‹•ãƒ­ã‚°
                    attacker: {
                        name: playerDaimyo.name || 'ä¸æ˜',
                        basePower: playerDaimyo.stats?.battle || 50,
                        totalPower: 0,
                        generals: []
                    },
                    defender: {
                        name: defenderDaimyo ? defenderDaimyo.name : 'ç©ºç™½åœ°',
                        troops: target.troops || 0,
                        walls: target.walls || 0,
                        basePower: defenderDaimyo ? (defenderDaimyo.stats?.battle || 50) : 30,
                        generals: []
                    },
                    result: {
                        victory: false,
                        troopDamage: 0,
                        wallDamage: 0,
                        conquered: false,
                        skillBonuses: 0,
                        defenderSkillBonuses: 0
                    }
                };
                
                // è»å›£æˆ¦åŠ›ã‚’è¨ˆç®—
                let attackPower = playerDaimyo.stats?.battle || 50;
                let defensePower = Math.floor((playerDaimyo.stats?.command || 50) / 3);
                let skillBonus = 0; // ç‰¹æŠ€ã«ã‚ˆã‚‹è¿½åŠ ãƒœãƒ¼ãƒŠã‚¹
                
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é ˜åœŸã®å…µç§‘ãƒœãƒ¼ãƒŠã‚¹ã‚’è¨ˆç®—
                const playerTerritories = this.gameState.getPlayerTerritories();
                let totalUnitBonus = 0;
                let unitBonusCount = 0;
                
                playerTerritories.forEach(territory => {
                    if (territory.troops > 0 && territory.unitType === territory.advantageType) {
                        // åœ°åŸŸç‰¹æ€§ã¨ä¸€è‡´ã™ã‚‹å…µç§‘ã¯+20%ãƒœãƒ¼ãƒŠã‚¹
                        const territoryBonus = Math.floor(territory.troops * 0.2);
                        totalUnitBonus += territoryBonus;
                        unitBonusCount++;
                    }
                });
                
                if (totalUnitBonus > 0) {
                    attackPower += Math.floor(totalUnitBonus / 10); // å…µç§‘ãƒœãƒ¼ãƒŠã‚¹ã‚’æˆ¦é—˜åŠ›ã«åæ˜ 
                    battleLog.events.push({
                        type: 'attack',
                        message: `${unitBonusCount}é ˜åœŸã®å…µç§‘ç‰¹æ€§ãŒç™ºå‹•ï¼æˆ¦é—˜åŠ›+${Math.floor(totalUnitBonus / 10)}`
                    });
                }
                
                // ä¸‰ã™ãã¿ã‚·ã‚¹ãƒ†ãƒ ï¼ˆæ­©å…µï¼œé¨é¦¬ï¼œé‰„ç ²ï¼œæ­©å…µï¼‰
                try {
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä¸»åŠ›å…µç§‘ã‚’å®‰å…¨ã«å–å¾—
                    let playerMainUnit = 'infantry'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                    let maxTroops = 0;
                    
                    playerTerritories.forEach(territory => {
                        if (territory && territory.troops > maxTroops) {
                            maxTroops = territory.troops;
                            playerMainUnit = territory.unitType || 'infantry';
                        }
                    });
                    
                    // æ•µã®å…µç§‘ã‚’å–å¾—
                    const enemyUnit = target.unitType || 'infantry';
                    
                    // ç›¸æ€§ãƒã‚§ãƒƒã‚¯
                    const isAdvantage = (
                        (playerMainUnit === 'cavalry' && enemyUnit === 'infantry') ||
                        (playerMainUnit === 'arquebus' && enemyUnit === 'cavalry') ||
                        (playerMainUnit === 'infantry' && enemyUnit === 'arquebus')
                    );
                    
                    if (isAdvantage) {
                        const unitBonus = Math.floor(attackPower * 0.2); // 1.2å€ç›¸å½“
                        attackPower += unitBonus;
                        
                        const unitNames = { 'infantry': 'æ­©å…µ', 'cavalry': 'é¨é¦¬', 'arquebus': 'é‰„ç ²' };
                        battleLog.events.push({
                            type: 'attack',
                            message: `å…µç§‘ç›¸æ€§æœ‰åˆ©ï¼${unitNames[playerMainUnit]}ãŒ${unitNames[enemyUnit]}ã‚’åœ§å€’ï¼æˆ¦é—˜åŠ›+${unitBonus}`
                        });
                    }
                } catch (error) {
                    // ä¸‰ã™ãã¿å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚æˆ¦é—˜ã¯ç¶™ç¶š
                }
                
                // å¥‡è¥²æ”»æ’ƒåˆ¤å®šï¼ˆæ”»æ’ƒå´ã®ã¿ï¼‰
                let surpriseAttackBonus = 1.0;
                let surpriseAttackActivated = false;
                let surpriseAttackLeader = null;
                
                try {
                    // é˜²å¾¡å´ã®åŸä¸»çµ±ç‡åŠ›ã‚’å–å¾—
                    let defenderCommandValue = 0;
                    
                    // é˜²å¾¡å´å¤§åã®çµ±ç‡
                    if (defenderDaimyo && defenderDaimyo.stats && defenderDaimyo.stats.command) {
                        defenderCommandValue = defenderDaimyo.stats.command;
                    }
                    
                    // åŸä¸»æ­¦å°†ã®çµ±ç‡ã‚’ãƒã‚§ãƒƒã‚¯
                    if (target.generalGarrison) {
                        const castleCommander = this.gameState.generals.find(g => g && g.id === target.generalGarrison);
                        if (castleCommander && castleCommander.stats && castleCommander.stats.command) {
                            defenderCommandValue = Math.max(defenderCommandValue, castleCommander.stats.command);
                        }
                    }
                    
                    // æ”»æ’ƒå´æ­¦å°†ã®ä¸­ã§åŸä¸»ã®çµ±ç‡ã‚’ä¸Šå›ã‚‹æ­¦å°†ã‚’ãƒã‚§ãƒƒã‚¯
                    const eligibleGenerals = [];
                    
                    // æ”»æ’ƒå´å¤§åã‚‚ãƒã‚§ãƒƒã‚¯
                    if (playerDaimyo && playerDaimyo.stats && playerDaimyo.stats.command > defenderCommandValue) {
                        eligibleGenerals.push({
                            name: playerDaimyo.name,
                            command: playerDaimyo.stats.command,
                            isLord: true
                        });
                    }
                    
                    // æ”»æ’ƒå´ã®è»å›£æ­¦å°†ã‚’ãƒã‚§ãƒƒã‚¯
                    const attackPositions = ['armyStrategist', 'vanguard', 'rightWing', 'leftWing', 'reserve'];
                    attackPositions.forEach(roleKey => {
                        try {
                            const generalId = this.gameState.playerRoles[roleKey];
                            if (generalId) {
                                const general = this.gameState.generals.find(g => g && g.id === generalId);
                                if (general && general.stats && general.stats.command > defenderCommandValue) {
                                    eligibleGenerals.push({
                                        name: general.name,
                                        command: general.stats.command,
                                        role: roleKey,
                                        isLord: false
                                    });
                                }
                            }
                        } catch (error) {
                            console.warn('å¥‡è¥²æ”»æ’ƒæ­¦å°†ãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                        }
                    });
                    
                    // å¥‡è¥²æ”»æ’ƒç™ºå‹•åˆ¤å®š
                    if (eligibleGenerals.length > 0) {
                        // çµ±ç‡å·®ãŒå¤§ãã„ã»ã©æˆåŠŸç‡ãŒé«˜ããªã‚‹ï¼ˆåŸºæœ¬20%ã€çµ±ç‡å·®10ã«ã¤ã+10%ã€æœ€å¤§70%ï¼‰
                        const bestGeneral = eligibleGenerals.reduce((best, current) => 
                            current.command > best.command ? current : best
                        );
                        
                        const commandDifference = bestGeneral.command - defenderCommandValue;
                        const baseChance = 20;
                        const bonusChance = Math.floor(commandDifference / 10) * 10;
                        const surpriseChance = Math.min(70, baseChance + bonusChance);
                        
                        if (Math.random() * 100 <= surpriseChance) {
                            surpriseAttackActivated = true;
                            surpriseAttackLeader = bestGeneral;
                            surpriseAttackBonus = 1.5;
                            
                            // å¥‡è¥²æ”»æ’ƒãƒ­ã‚°
                            const roleNames = {
                                'armyStrategist': 'è»å¸«', 'vanguard': 'å‰è¡›', 
                                'rightWing': 'å³ç¿¼', 'leftWing': 'å·¦ç¿¼', 'reserve': 'å¾Œè©°'
                            };
                            
                            let surpriseMessage = '';
                            if (bestGeneral.isLord) {
                                surpriseMessage = `${bestGeneral.name}ãŒè¦‹äº‹ãªçµ±ç‡ã§å¥‡è¥²æ”»æ’ƒã‚’æˆåŠŸã•ã›ãŸï¼`;
                            } else {
                                const roleName = roleNames[bestGeneral.role] || 'æ­¦å°†';
                                surpriseMessage = `${bestGeneral.name}(${roleName})ãŒçµ¶å¦™ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å¥‡è¥²æ”»æ’ƒã‚’æŒ‡æ®ï¼`;
                            }
                            
                            battleLog.events.push({
                                type: 'attack',
                                message: `ã€å¥‡è¥²æ”»æ’ƒç™ºå‹•ã€‘${surpriseMessage}`
                            });
                            
                            battleLog.events.push({
                                type: 'victory',
                                message: `çµ±ç‡å·®${commandDifference}ã«ã‚ˆã‚Šå¥‡è¥²ãŒæˆåŠŸï¼æ”»æ’ƒåŠ›ãŒ1.5å€ã«å¢—å¼·ã•ã‚ŒãŸï¼`
                            });
                        }
                    }
                } catch (error) {
                    console.warn('å¥‡è¥²æ”»æ’ƒåˆ¤å®šä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ:', error);
                }
                const positions = {
                    'armyStrategist': { command: 1, intelligence: 1, description: 'è»å›£ã‚’æŒ‡æ®' },
                    'vanguard': { battle: 1, command: 1, description: 'å…ˆé ­ã§æ•µè»ã«çªæ’ƒ' },
                    'rightWing': { battle: 1, description: 'å³ç¿¼ã‹ã‚‰å´é¢æ”»æ’ƒ' },
                    'leftWing': { battle: 1, description: 'å·¦ç¿¼ã‹ã‚‰å´é¢æ”»æ’ƒ' },
                    'reserve': { command: 1, description: 'å¾Œæ–¹ã‹ã‚‰å…¨è»ã‚’æ”¯æ´' }
                };
                
                Object.entries(positions).forEach(([roleKey, stats]) => {
                    try {
                        const generalId = this.gameState.playerRoles[roleKey];
                        if (generalId) {
                            const general = this.gameState.generals.find(g => g && g.id === generalId);
                            if (general && general.stats) {
                                // æ­¦å°†ã®åŸºæœ¬æƒ…å ±ã‚’è¨˜éŒ²
                                battleLog.attacker.generals.push({
                                    name: general.name || 'ç„¡åæ­¦å°†',
                                    role: roleKey,
                                    battle: general.stats.battle || 0,
                                    command: general.stats.command || 0,
                                    skill: general.skill || 'ç‰¹æŠ€ãªã—'
                                });
                                
                                // åŸºæœ¬æˆ¦åŠ›è¿½åŠ 
                                let contribution = 0;
                                if (stats.battle && general.stats.battle) {
                                    attackPower += general.stats.battle;
                                    contribution += general.stats.battle;
                                }
                                if (stats.command && general.stats.command) {
                                    const commandBonus = Math.floor(general.stats.command / 3);
                                    defensePower += commandBonus;
                                    contribution += commandBonus;
                                }
                                
                                // æ­¦å°†ã®æ´»èºã‚’è¨˜éŒ²
                                const roleNames = {
                                    'armyStrategist': 'å‚è¬€', 'vanguard': 'å‰è¡›', 
                                    'rightWing': 'å³ç¿¼', 'leftWing': 'å·¦ç¿¼', 'reserve': 'å¾Œè©°'
                                };
                                
                                battleLog.generalActivities.push({
                                    name: general.name || 'ç„¡åæ­¦å°†',
                                    role: roleNames[roleKey] || roleKey,
                                    action: stats.description || 'æˆ¦é—˜ã«å‚åŠ ',
                                    contribution: Math.max(1, contribution),
                                    side: 'attacker'
                                });
                                
                                // ç‰¹æŠ€ç™ºå‹•ãƒã‚§ãƒƒã‚¯
                                try {
                                    const skillActivation = this.checkSkillActivation(general, roleKey, target);
                                    if (skillActivation && skillActivation.activated) {
                                        skillBonus += skillActivation.bonus || 0;
                                        skillActivation.side = 'attacker';
                                        battleLog.skillActivations.push(skillActivation);
                                    }
                                } catch (skillError) {
                                    console.warn('æ”»æ’ƒå´ç‰¹æŠ€ãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼:', skillError);
                                }
                            }
                        }
                    } catch (error) {
                        console.warn('æ”»æ’ƒå´æ­¦å°†å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                    }
                });
                
                // æ”»æ’ƒå´å¤§åã®ç‰¹æŠ€ã‚‚ãƒã‚§ãƒƒã‚¯
                try {
                    const daimyoName = playerDaimyo?.name || 'å¤§å';
                    let daimyoContribution = Math.floor((playerDaimyo?.stats?.battle || 50) / 2);
                    
                    if (playerDaimyo && playerDaimyo.skill && playerDaimyo.skill !== 'ç‰¹æŠ€ãªã—') {
                        const daimyoSkillActivation = this.checkSkillActivation(playerDaimyo, 'general', target);
                        if (daimyoSkillActivation && daimyoSkillActivation.activated) {
                            skillBonus += daimyoSkillActivation.bonus || 0;
                            daimyoSkillActivation.side = 'attacker';
                            battleLog.skillActivations.push(daimyoSkillActivation);
                            daimyoContribution += daimyoSkillActivation.bonus || 0;
                        }
                    }
                    
                    const daimyoAlreadyRecorded = battleLog.generalActivities.some(activity => 
                        activity && activity.name === daimyoName
                    );
                    
                    if (!daimyoAlreadyRecorded) {
                        battleLog.generalActivities.push({
                            name: daimyoName,
                            role: 'å¤§å°†',
                            action: 'è»å›£ã‚’ç·æŒ‡æ®',
                            contribution: Math.max(10, daimyoContribution),
                            side: 'attacker'
                        });
                    }
                } catch (error) {
                    console.warn('æ”»æ’ƒå´å¤§åç‰¹æŠ€ãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                    if (!battleLog.generalActivities.some(activity => activity && activity.name && activity.name.includes('å¤§å'))) {
                        battleLog.generalActivities.push({
                            name: playerDaimyo?.name || 'å¤§å',
                            role: 'å¤§å°†',
                            action: 'æˆ¦å ´ã‚’æŒ‡æ®',
                            contribution: 10,
                            side: 'attacker'
                        });
                    }
                }
                
                // é˜²å¾¡å´ã®æ­¦å°†ç·¨æˆã¨æˆ¦åŠ›è¨ˆç®—
                let defenderAttackPower = battleLog.defender.basePower;
                let defenderDefensePower = Math.floor(battleLog.defender.basePower / 3);
                let defenderSkillBonus = 0;
                let defenderGeneralsList = []; // é‰„å£ãƒã‚§ãƒƒã‚¯ç”¨
                
                if (defenderDaimyo && defenderDaimyo.id) {
                    try {
                        // é˜²å¾¡å´AIæ­¦å°†ã®ç·¨æˆã‚’å–å¾—
                        const defenderRoles = this.gameState.aiRoles[defenderDaimyo.id];
                        if (defenderRoles) {
                            const defenderGenerals = this.gameState.generals.filter(g => g && g.lord === defenderDaimyo.id);
                            
                            Object.entries(positions).forEach(([roleKey, stats]) => {
                                try {
                                    const generalId = defenderRoles[roleKey];
                                    if (generalId) {
                                        const general = defenderGenerals.find(g => g && g.id === generalId);
                                        if (general && general.stats) {
                                            // é˜²å¾¡å´æ­¦å°†ã®åŸºæœ¬æƒ…å ±ã‚’è¨˜éŒ²
                                            battleLog.defender.generals.push({
                                                name: general.name || 'ç„¡åæ­¦å°†',
                                                role: roleKey,
                                                battle: general.stats.battle || 0,
                                                command: general.stats.command || 0,
                                                skill: general.skill || 'ç‰¹æŠ€ãªã—'
                                            });
                                            
                                            defenderGeneralsList.push(general); // é‰„å£ãƒã‚§ãƒƒã‚¯ç”¨ã«è¿½åŠ 
                                            
                                            // é˜²å¾¡å´æˆ¦åŠ›è¿½åŠ 
                                            let contribution = 0;
                                            if (stats.battle && general.stats.battle) {
                                                defenderAttackPower += Math.floor(general.stats.battle * 0.8); // é˜²å¾¡å´ã¯è‹¥å¹²å¼±ä½“åŒ–
                                                contribution += general.stats.battle;
                                            }
                                            if (stats.command && general.stats.command) {
                                                const commandBonus = Math.floor(general.stats.command / 3);
                                                defenderDefensePower += commandBonus;
                                                contribution += commandBonus;
                                            }
                                            
                                            // é˜²å¾¡å´æ­¦å°†ã®æ´»èºã‚’è¨˜éŒ²
                                            const roleNames = {
                                                'armyStrategist': 'å‚è¬€', 'vanguard': 'å‰è¡›', 
                                                'rightWing': 'å³ç¿¼', 'leftWing': 'å·¦ç¿¼', 'reserve': 'å¾Œè©°'
                                            };
                                            
                                            const defenseActions = {
                                                'armyStrategist': 'å®ˆå‚™éšŠã‚’çµ±ç‡',
                                                'vanguard': 'åŸé–€ã‚’æ­»å®ˆ',
                                                'rightWing': 'å³ç¿¼ã‹ã‚‰è¿æ’ƒ',
                                                'leftWing': 'å·¦ç¿¼ã‹ã‚‰è¿æ’ƒ',
                                                'reserve': 'å¾Œæ–¹ã‹ã‚‰æ´è­·'
                                            };
                                            
                                            battleLog.generalActivities.push({
                                                name: general.name || 'ç„¡åæ­¦å°†',
                                                role: roleNames[roleKey] || roleKey,
                                                action: defenseActions[roleKey] || 'é˜²å¾¡ã«å‚åŠ ',
                                                contribution: Math.max(1, contribution),
                                                side: 'defender'
                                            });
                                            
                                            // é˜²å¾¡å´æ­¦å°†ã®ç‰¹æŠ€ç™ºå‹•ãƒã‚§ãƒƒã‚¯
                                            try {
                                                const skillActivation = this.checkSkillActivation(general, roleKey, target);
                                                if (skillActivation && skillActivation.activated) {
                                                    defenderSkillBonus += skillActivation.bonus || 0;
                                                    skillActivation.side = 'defender';
                                                    battleLog.skillActivations.push(skillActivation);
                                                    
                                                    // åé¢åŸ‹ä¼ã®è¨ˆã¯æˆ¦é—˜åºç›¤ã®ã‚¤ãƒ™ãƒ³ãƒˆã¨ã—ã¦è¡¨ç¤º
                                                    if (skillActivation.skill === 'åé¢åŸ‹ä¼ã®è¨ˆ') {
                                                        battleLog.events.unshift({
                                                            type: 'defense',
                                                            message: `ã€æˆ¦é—˜é–‹å§‹å‰ã€‘${skillActivation.name}ã®${skillActivation.skill}ãŒç™ºå‹•ï¼${skillActivation.description}`
                                                        });
                                                        // è¡Œå‹•ãƒ­ã‚°ã«ã‚‚è¿½åŠ 
                                                        this.gameState.addLog(`${skillActivation.name}ã®${skillActivation.skill}ãŒç™ºå‹•ï¼${skillActivation.description}`, 'battle');
                                                    }
                                                }
                                            } catch (skillError) {
                                                console.warn('é˜²å¾¡å´ç‰¹æŠ€ãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼:', skillError);
                                            }
                                        }
                                    }
                                } catch (error) {
                                    console.warn('é˜²å¾¡å´æ­¦å°†å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                                }
                            });
                        }
                        
                        // åŸä¸»æ­¦å°†ã‚‚é‰„å£ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã«è¿½åŠ 
                        if (target.generalGarrison) {
                            const castleCommander = this.gameState.generals.find(g => g && g.id === target.generalGarrison);
                            if (castleCommander) {
                                defenderGeneralsList.push(castleCommander);
                            }
                        }
                        
                        // é˜²å¾¡å´å¤§åã‚‚é‰„å£ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã«è¿½åŠ 
                        if (defenderDaimyo) {
                            defenderGeneralsList.push(defenderDaimyo);
                        }
                        
                        // é‰„å£é˜²å¾¡ãƒã‚§ãƒƒã‚¯
                        const ironwallResult = this.checkIronwallDefense(defenderGeneralsList, battleLog);
                        
                        // é˜²å¾¡å´å¤§åã®ç‰¹æŠ€ã‚‚ãƒã‚§ãƒƒã‚¯
                        try {
                            const defenderDaimyoName = defenderDaimyo?.name || 'å®ˆå‚™éšŠé•·';
                            let defenderDaimyoContribution = Math.floor((defenderDaimyo?.stats?.battle || 50) / 2);
                            
                            if (defenderDaimyo && defenderDaimyo.skill && defenderDaimyo.skill !== 'ç‰¹æŠ€ãªã—') {
                                const defenderDaimyoSkillActivation = this.checkSkillActivation(defenderDaimyo, 'general', target);
                                if (defenderDaimyoSkillActivation && defenderDaimyoSkillActivation.activated) {
                                    defenderSkillBonus += defenderDaimyoSkillActivation.bonus || 0;
                                    defenderDaimyoSkillActivation.side = 'defender';
                                    battleLog.skillActivations.push(defenderDaimyoSkillActivation);
                                    defenderDaimyoContribution += defenderDaimyoSkillActivation.bonus || 0;
                                    
                                    // åé¢åŸ‹ä¼ã®è¨ˆã¯æˆ¦é—˜åºç›¤ã®ã‚¤ãƒ™ãƒ³ãƒˆã¨ã—ã¦è¡¨ç¤º
                                    if (defenderDaimyoSkillActivation.skill === 'åé¢åŸ‹ä¼ã®è¨ˆ') {
                                        battleLog.events.unshift({
                                            type: 'defense',
                                            message: `ã€æˆ¦é—˜é–‹å§‹å‰ã€‘${defenderDaimyoSkillActivation.name}ã®${defenderDaimyoSkillActivation.skill}ãŒç™ºå‹•ï¼${defenderDaimyoSkillActivation.description}`
                                        });
                                        // è¡Œå‹•ãƒ­ã‚°ã«ã‚‚è¿½åŠ 
                                        this.gameState.addLog(`${defenderDaimyoSkillActivation.name}ã®${defenderDaimyoSkillActivation.skill}ãŒç™ºå‹•ï¼${defenderDaimyoSkillActivation.description}`, 'battle');
                                    }
                                }
                            }
                            
                            const defenderDaimyoAlreadyRecorded = battleLog.generalActivities.some(activity => 
                                activity && activity.name === defenderDaimyoName && activity.side === 'defender'
                            );
                            
                            if (!defenderDaimyoAlreadyRecorded) {
                                battleLog.generalActivities.push({
                                    name: defenderDaimyoName,
                                    role: 'ç·å¤§å°†',
                                    action: 'å…¨è»ã®å®ˆå‚™ã‚’æŒ‡æ®',
                                    contribution: Math.max(10, defenderDaimyoContribution),
                                    side: 'defender'
                                });
                            }
                        } catch (error) {
                            console.warn('é˜²å¾¡å´å¤§åç‰¹æŠ€ãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                        }
                        
                    } catch (error) {
                        console.warn('é˜²å¾¡å´ç·¨æˆå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                    }
                }
                
                // æœ€çµ‚æˆ¦åŠ›ã«ç‰¹æŠ€ãƒœãƒ¼ãƒŠã‚¹ã‚’è¿½åŠ 
                attackPower += skillBonus;
                defenderAttackPower += defenderSkillBonus;
                
                // æˆ¦è¡“çš„é§†ã‘å¼•ãï¼šå‰è¡›ãƒ»å‚è¬€ãƒ»å¾Œè©°ã®èƒ½åŠ›æ¯”è¼ƒ
                let tacticalDamageToDefender = 0;
                let tacticalDamageToAttacker = 0;
                let tacticalDefenseBonus = 0;
                
                try {
                    // å‰è¡›ã®å…ˆåˆ¶æ”»æ’ƒï¼ˆæˆ¦é—˜æ¯”è¼ƒï¼‰
                    const attackerVanguard = this.gameState.playerRoles.vanguard ? 
                        this.gameState.generals.find(g => g && g.id === this.gameState.playerRoles.vanguard) : null;
                    const defenderVanguard = (defenderDaimyo && this.gameState.aiRoles[defenderDaimyo.id] && this.gameState.aiRoles[defenderDaimyo.id].vanguard) ?
                        this.gameState.generals.find(g => g && g.id === this.gameState.aiRoles[defenderDaimyo.id].vanguard) : null;
                    
                    const attackerBattle = attackerVanguard ? (attackerVanguard.stats?.battle || 0) : 0;
                    const defenderBattle = defenderVanguard ? (defenderVanguard.stats?.battle || 0) : 0;
                    
                    if (attackerBattle > 0 && defenderBattle > 0) {
                        if (attackerBattle > defenderBattle) {
                            tacticalDamageToDefender += 25;
                            battleLog.events.push({
                                type: 'attack',
                                message: `ã€å…ˆåˆ¶æ”»æ’ƒç™ºå‹•ã€‘${attackerVanguard.name}(æˆ¦é—˜${attackerBattle})ãŒ${defenderVanguard.name}(æˆ¦é—˜${defenderBattle})ã‚’åœ§å€’ã™ã‚‹é›»å…‰çŸ³ç«ã®å…ˆåˆ¶æ”»æ’ƒã§æ•µå‰è¡›ã‚’ç²‰ç •ï¼25ã®æå®³ï¼`
                            });
                        } else if (defenderBattle > attackerBattle) {
                            tacticalDamageToAttacker += 25;
                            battleLog.events.push({
                                type: 'defense',
                                message: `ã€å…ˆåˆ¶æ”»æ’ƒç™ºå‹•ã€‘${defenderVanguard.name}(æˆ¦é—˜${defenderBattle})ãŒ${attackerVanguard.name}(æˆ¦é—˜${attackerBattle})ã‚’ä¸Šå›ã‚‹æ­¦å‹‡ã§é€†è¥²ã®å…ˆåˆ¶æ”»æ’ƒï¼æ”»æ’ƒè»å‰è¡›ã«25ã®æå®³ï¼`
                            });
                        }
                    } else if (attackerBattle > 0 && defenderBattle === 0) {
                        tacticalDamageToDefender += 25;
                        battleLog.events.push({
                            type: 'attack',
                            message: `ã€å…ˆåˆ¶æ”»æ’ƒç™ºå‹•ã€‘${attackerVanguard.name}ãŒå‰è¡›ãªãæ•µè»ã«é›»æ’ƒçš„ãªå…ˆåˆ¶æ”»æ’ƒã‚’æ•¢è¡Œã—25ã®æå®³ï¼`
                        });
                    } else if (defenderBattle > 0 && attackerBattle === 0) {
                        tacticalDamageToAttacker += 25;
                        battleLog.events.push({
                            type: 'defense',
                            message: `ã€å…ˆåˆ¶æ”»æ’ƒç™ºå‹•ã€‘${defenderVanguard.name}ãŒå‰è¡›ãªãæ”»æ’ƒè»ã«å®¹èµ¦ãªã„è¿æ’ƒã‚’è¡Œã„25ã®æå®³ï¼`
                        });
                    }
                    
                    // å‚è¬€ã®é™½å‹•æ”»æ’ƒï¼ˆçŸ¥è¬€æ¯”è¼ƒï¼‰
                    const attackerStrategist = this.gameState.playerRoles.armyStrategist ? 
                        this.gameState.generals.find(g => g && g.id === this.gameState.playerRoles.armyStrategist) : null;
                    const defenderStrategist = (defenderDaimyo && this.gameState.aiRoles[defenderDaimyo.id] && this.gameState.aiRoles[defenderDaimyo.id].armyStrategist) ?
                        this.gameState.generals.find(g => g && g.id === this.gameState.aiRoles[defenderDaimyo.id].armyStrategist) : null;
                    
                    const attackerIntelligence = attackerStrategist ? (attackerStrategist.stats?.intelligence || 0) : 0;
                    const defenderIntelligence = defenderStrategist ? (defenderStrategist.stats?.intelligence || 0) : 0;
                    
                    if (attackerIntelligence > 0 && defenderIntelligence > 0) {
                        if (attackerIntelligence > defenderIntelligence) {
                            tacticalDamageToDefender += 25;
                            battleLog.events.push({
                                type: 'attack',
                                message: `ã€é™½å‹•æ”»æ’ƒç™ºå‹•ã€‘${attackerStrategist.name}(çŸ¥è¬€${attackerIntelligence})ãŒ${defenderStrategist.name}(çŸ¥è¬€${defenderIntelligence})ã‚’ä¸Šå›ã‚‹æˆ¦è¡“ã§æ•µè»ã‚’ç¿»å¼„ï¼é™½å‹•ã«ã‚ˆã‚Šæ•µã«25ã®æå®³ï¼`
                            });
                        } else if (defenderIntelligence > attackerIntelligence) {
                            tacticalDamageToAttacker += 25;
                            battleLog.events.push({
                                type: 'defense',
                                message: `ã€é™½å‹•æ”»æ’ƒç™ºå‹•ã€‘${defenderStrategist.name}(çŸ¥è¬€${defenderIntelligence})ãŒ${attackerStrategist.name}(çŸ¥è¬€${attackerIntelligence})ã‚’å‡ºã—æŠœãå·§å¦™ãªç­–ã§æ”»æ’ƒè»ã‚’æ··ä¹±ã•ã›25ã®æå®³ï¼`
                            });
                        }
                    } else if (attackerIntelligence > 0 && defenderIntelligence === 0) {
                        tacticalDamageToDefender += 25;
                        battleLog.events.push({
                            type: 'attack',
                            message: `ã€é™½å‹•æ”»æ’ƒç™ºå‹•ã€‘${attackerStrategist.name}ãŒç„¡é˜²å‚™ãªæ•µè»ã«å®Œç’§ãªé™½å‹•æˆ¦è¡“ã‚’ä»•æ›ã‘25ã®æå®³ï¼`
                        });
                    } else if (defenderIntelligence > 0 && attackerIntelligence === 0) {
                        tacticalDamageToAttacker += 25;
                        battleLog.events.push({
                            type: 'defense',
                            message: `ã€é™½å‹•æ”»æ’ƒç™ºå‹•ã€‘${defenderStrategist.name}ãŒç­–ç•¥ãªãæ”»æ’ƒè»ã«ç½ ã‚’ä»•æ›ã‘25ã®æå®³ï¼`
                        });
                    }
                    
                    // å¾Œè©°ã®åæ’ƒè»½æ¸›ï¼ˆçµ±ç‡æ¯”è¼ƒï¼‰
                    const attackerReserve = this.gameState.playerRoles.reserve ? 
                        this.gameState.generals.find(g => g && g.id === this.gameState.playerRoles.reserve) : null;
                    const defenderReserve = (defenderDaimyo && this.gameState.aiRoles[defenderDaimyo.id] && this.gameState.aiRoles[defenderDaimyo.id].reserve) ?
                        this.gameState.generals.find(g => g && g.id === this.gameState.aiRoles[defenderDaimyo.id].reserve) : null;
                    
                    const attackerCommand = attackerReserve ? (attackerReserve.stats?.command || 0) : 0;
                    const defenderCommand = defenderReserve ? (defenderReserve.stats?.command || 0) : 0;
                    
                    if (attackerCommand > 0 && defenderCommand > 0) {
                        if (attackerCommand > defenderCommand) {
                            tacticalDefenseBonus += 25;
                            battleLog.events.push({
                                type: 'attack',
                                message: `ã€å¾Œæ–¹æ”¯æ´ç™ºå‹•ã€‘${attackerReserve.name}(çµ±ç‡${attackerCommand})ãŒ${defenderReserve.name}(çµ±ç‡${defenderCommand})ã‚’åœ§å€’ã™ã‚‹å®Œç’§ãªå¾Œæ–¹æ”¯æ´ã§æ•µã®åæ’ƒã‚’25è»½æ¸›ï¼`
                            });
                        } else if (defenderCommand > attackerCommand) {
                            // é˜²å¾¡å´ã®åæ’ƒè»½æ¸›ã¯æ”»æ’ƒå´ã¸ã®ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—åŠ ã¨ã—ã¦å®Ÿè£…
                            tacticalDamageToAttacker += 25;
                            battleLog.events.push({
                                type: 'defense',
                                message: `ã€å¾Œæ–¹æ”¯æ´ç™ºå‹•ã€‘${defenderReserve.name}(çµ±ç‡${defenderCommand})ãŒ${attackerReserve.name}(çµ±ç‡${attackerCommand})ã‚’ä¸Šå›ã‚‹çµ±ç‡ã§å®Œç’§ãªåæ’ƒæ…‹å‹¢ã‚’æ§‹ç¯‰ã—æ”»æ’ƒè»ã«25ã®è¿½åŠ æå®³ï¼`
                            });
                        }
                    } else if (attackerCommand > 0 && defenderCommand === 0) {
                        tacticalDefenseBonus += 25;
                        battleLog.events.push({
                            type: 'attack',
                            message: `ã€å¾Œæ–¹æ”¯æ´ç™ºå‹•ã€‘${attackerReserve.name}ãŒå¾Œæ–¹æ”¯æ´ãªãæ•µè»ã«å¯¾ã—å®Œç’§ãªçµ±ç‡ã§åæ’ƒã‚’25è»½æ¸›ï¼`
                        });
                    } else if (defenderCommand > 0 && attackerCommand === 0) {
                        tacticalDamageToAttacker += 25;
                        battleLog.events.push({
                            type: 'defense',
                            message: `ã€å¾Œæ–¹æ”¯æ´ç™ºå‹•ã€‘${defenderReserve.name}ãŒå¾Œæ–¹æ”¯æ´ãªãæ”»æ’ƒè»ã«å®¹èµ¦ãªã„åæ’ƒã‚’ä»•æ›ã‘25ã®æå®³ï¼`
                        });
                    }
                } catch (error) {
                    console.warn('æˆ¦è¡“çš„é§†ã‘å¼•ãå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                }
                
                // ä¼Šé”æ”¿å®—ã®é¨é¦¬é‰„ç ²éšŠãƒã‚§ãƒƒã‚¯
                let dateCavalryDamage = 0;
                let dateCavalryActivated = false;
                
                if (playerDaimyo.skill === 'ç‹¬çœ¼ç«œ' && Math.random() * 100 <= 60) {
                    // æ•µã®å…µç§‘ã‚’ãƒã‚§ãƒƒã‚¯
                    const enemyUnit = target.unitType || 'infantry';
                    if (enemyUnit === 'infantry' || enemyUnit === 'cavalry') {
                        dateCavalryActivated = true;
                        dateCavalryDamage = 100;
                        
                        const unitNames = { 'infantry': 'æ­©å…µ', 'cavalry': 'é¨é¦¬' };
                        battleLog.events.push({
                            type: 'attack',
                            message: `ã€é¨é¦¬é‰„ç ²éšŠçªæ’ƒã€‘ç‹¬çœ¼ç«œæ”¿å®—ã®é¨é¦¬é‰„ç ²éšŠãŒ${unitNames[enemyUnit]}éšŠã«è¥²ã„ã‹ã‹ã‚‹ï¼é˜²å¾¡ç„¡è¦–ã§100ã®çµ¶å¯¾ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`
                        });
                    }
                }
                
                // ä¸­å¤®çªç ´ãƒã‚§ãƒƒã‚¯ï¼ˆç‰¹æŠ€ã¨ã¯åˆ¥æ ï¼‰
                let centralBreakthroughDamage = 0;
                let centralBreakthroughActivator = null;
                let centralBreakthroughAttempted = false;
                
                // ä¸­å¤®çªç ´ã‚’æŒã¤æ­¦å°†ã‚’ãƒã‚§ãƒƒã‚¯
                const centralBreakthroughSkills = {
                    'ç„¡å‚·': 70,
                    'é¬¼å³¶æ´¥': 60,
                    'æ—¥æœ¬ä¸€ã®å…µ': 80,
                    'å‚¾å¥‡è€…': 50,
                    'è¥¿å›½ç„¡åŒ': 50,
                    'äºŒåˆ€æµ': 75
                };
                
                // æ”»æ’ƒå´å¤§åã‚’ãƒã‚§ãƒƒã‚¯
                if (playerDaimyo && playerDaimyo.skill && centralBreakthroughSkills[playerDaimyo.skill]) {
                    centralBreakthroughAttempted = true;
                    battleLog.events.push({
                        type: 'attack',
                        message: `${playerDaimyo.name}ã¯ä¸­å¤®çªç ´ã®æ§‹ãˆã‚’è¦‹ã›ã‚‹`
                    });
                    
                    const successRate = centralBreakthroughSkills[playerDaimyo.skill];
                    if (Math.random() * 100 <= successRate) {
                        centralBreakthroughActivator = {
                            name: playerDaimyo.name,
                            skill: playerDaimyo.skill
                        };
                        centralBreakthroughDamage = 100;
                        
                        battleLog.events.push({
                            type: 'victory',
                            message: `ã€ä¸­å¤®çªç ´ç™ºå‹•ã€‘${playerDaimyo.name}ãŒæ•µé™£ä¸­å¤®ã‚’çœŸæ­£é¢ã‹ã‚‰çªç ´ï¼é˜²å¾¡ç„¡è¦–ã§100ã®çµ¶å¯¾ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`
                        });
                    }
                }
                
                // æ”»æ’ƒå´æ­¦å°†ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆå¤§åãŒç™ºå‹•ã—ãªã‹ã£ãŸå ´åˆã®ã¿ï¼‰
                if (!centralBreakthroughActivator) {
                    const attackPositions = ['armyStrategist', 'vanguard', 'rightWing', 'leftWing', 'reserve'];
                    for (const roleKey of attackPositions) {
                        const generalId = this.gameState.playerRoles[roleKey];
                        if (generalId) {
                            const general = this.gameState.generals.find(g => g && g.id === generalId);
                            if (general && general.skill && centralBreakthroughSkills[general.skill]) {
                                centralBreakthroughAttempted = true;
                                battleLog.events.push({
                                    type: 'attack',
                                    message: `${general.name}ã¯ä¸­å¤®çªç ´ã®æ§‹ãˆã‚’è¦‹ã›ã‚‹`
                                });
                                
                                const successRate = centralBreakthroughSkills[general.skill];
                                if (Math.random() * 100 <= successRate) {
                                    centralBreakthroughActivator = {
                                        name: general.name,
                                        skill: general.skill
                                    };
                                    centralBreakthroughDamage = 100;
                                    
                                    battleLog.events.push({
                                        type: 'victory',
                                        message: `ã€ä¸­å¤®çªç ´ç™ºå‹•ã€‘${general.name}ãŒæ•µé™£ä¸­å¤®ã‚’ä¸€æ°—ã«çªç ´ï¼é˜²å¾¡ç„¡è¦–ã§100ã®çµ¶å¯¾ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`
                                    });
                                    break;
                                }
                            }
                        }
                    }
                }
                
                // å£«æ°—åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ 
                const moralePositions = {
                    'general': { rate: 40, charm: playerDaimyo.stats?.charm || 50 },
                    'armyStrategist': { rate: 10 },
                    'vanguard': { rate: 20 },
                    'rightWing': { rate: 10 },
                    'leftWing': { rate: 10 },
                    'reserve': { rate: 10 }
                };
                
                // æ”»æ’ƒå´å£«æ°—ä»£è¡¨é¸å‡º
                let attackerMoraleLeader = null;
                for (const [roleKey, config] of Object.entries(moralePositions)) {
                    if (Math.random() * 100 <= config.rate) {
                        if (roleKey === 'general') {
                            attackerMoraleLeader = { name: playerDaimyo.name, charm: config.charm };
                        } else {
                            const generalId = this.gameState.playerRoles[roleKey];
                            if (generalId) {
                                const general = this.gameState.generals.find(g => g && g.id === generalId);
                                if (general && general.stats) {
                                    attackerMoraleLeader = { name: general.name, charm: general.stats.charm || 50 };
                                }
                            }
                        }
                        break;
                    }
                }
                
                // é˜²å¾¡å´å£«æ°—ä»£è¡¨é¸å‡º
                let defenderMoraleLeader = null;
                if (defenderDaimyo && this.gameState.aiRoles[defenderDaimyo.id]) {
                    const defRoles = this.gameState.aiRoles[defenderDaimyo.id];
                    for (const [roleKey, config] of Object.entries(moralePositions)) {
                        if (Math.random() * 100 <= config.rate) {
                            if (roleKey === 'general') {
                                defenderMoraleLeader = { name: defenderDaimyo.name, charm: defenderDaimyo.stats?.charm || 50 };
                            } else {
                                const generalId = defRoles[roleKey];
                                if (generalId) {
                                    const general = this.gameState.generals.find(g => g && g.id === generalId);
                                    if (general && general.stats) {
                                        defenderMoraleLeader = { name: general.name, charm: general.stats.charm || 50 };
                                    }
                                }
                            }
                            break;
                        }
                    }
                }
                
                // å£«æ°—å¯¾æ±ºã¨æˆ¦åŠ›è£œæ­£
                let moraleBonus = 1.0;
                if (attackerMoraleLeader && defenderMoraleLeader) {
                    if (attackerMoraleLeader.charm > defenderMoraleLeader.charm) {
                        moraleBonus = 1.2;
                        battleLog.events.unshift({
                            type: 'attack',
                            message: `ã€å£«æ°—å‹åˆ©ã€‘${attackerMoraleLeader.name}(é­…åŠ›${attackerMoraleLeader.charm})ãŒ${defenderMoraleLeader.name}(é­…åŠ›${defenderMoraleLeader.charm})ã‚’åœ§å€’ï¼æ”»æ’ƒåŠ›1.2å€`
                        });
                    } else if (defenderMoraleLeader.charm > attackerMoraleLeader.charm) {
                        battleLog.events.unshift({
                            type: 'defense',
                            message: `ã€å£«æ°—å‹åˆ©ã€‘${defenderMoraleLeader.name}(é­…åŠ›${defenderMoraleLeader.charm})ãŒ${attackerMoraleLeader.name}(é­…åŠ›${attackerMoraleLeader.charm})ã‚’åœ§å€’ï¼å®ˆå‚™å´æœ‰åˆ©`
                        });
                    }
                } else if (attackerMoraleLeader) {
                    moraleBonus = 1.2;
                    battleLog.events.unshift({
                        type: 'attack',
                        message: `ã€å£«æ°—å‹åˆ©ã€‘${attackerMoraleLeader.name}ã®é¼“èˆã«ã‚ˆã‚Šæ”»æ’ƒåŠ›1.2å€`
                    });
                }
                
                attackPower = Math.floor(attackPower * moraleBonus);
                
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å¾å¤·å¤§å°†è»åŠ¹æœï¼šå£«æ°—1.2å€
                if (this.gameState.tenkaninStatus[this.gameState.playerDaimyo]) {
                    attackPower = Math.floor(attackPower * 1.2);
                    battleLog.events.push({
                        type: 'attack',
                        message: `ã€å¾å¤·å¤§å°†è»ã€‘${playerDaimyo.name}ã®è»ãŒå¹•åºœã®å¨å…‰ã«ã‚ˆã‚Šå£«æ°—1.2å€ã§é€²è»ï¼`
                    });
                }
                
                // å¥‡è¥²æ”»æ’ƒãƒœãƒ¼ãƒŠã‚¹ã‚’é©ç”¨ï¼ˆæ”»æ’ƒåŠ›ã«1.5å€ï¼‰
                if (surpriseAttackActivated) {
                    attackPower = Math.floor(attackPower * surpriseAttackBonus);
                    battleLog.events.push({
                        type: 'attack',
                        message: `å¥‡è¥²æ”»æ’ƒã«ã‚ˆã‚Šæœ€çµ‚æ”»æ’ƒåŠ›: ${Math.floor(attackPower / surpriseAttackBonus)} â†’ ${attackPower}`
                    });
                }
                
                battleLog.result.skillBonuses = skillBonus;
                battleLog.result.defenderSkillBonuses = defenderSkillBonus;
                battleLog.result.surpriseAttack = surpriseAttackActivated;
                battleLog.result.surpriseAttackLeader = surpriseAttackLeader;
                battleLog.result.centralBreakthrough = centralBreakthroughDamage > 0;
                battleLog.result.centralBreakthroughActivator = centralBreakthroughActivator;
                battleLog.result.centralBreakthroughAttempted = centralBreakthroughAttempted;
                battleLog.attacker.totalPower = attackPower; // å£«æ°—è£œæ­£å¾Œã®å€¤
                
                // æ­¦å°†ãŒé…ç½®ã•ã‚Œã¦ã„ãªã„å ´åˆã®ç¢ºèªã¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                if (!battleLog.generalActivities || battleLog.generalActivities.length === 0) {
                    // å¤§åã®ã¿ã§æˆ¦é—˜ã‚’å®Ÿè¡Œã™ã‚‹å ´åˆ
                    battleLog.generalActivities = [{
                        name: playerDaimyo.name || 'å¤§å',
                        role: 'å¤§å°†',
                        action: 'å˜ç‹¬ã§æˆ¦å ´ã‚’æŒ‡æ®',
                        contribution: playerDaimyo.stats?.battle || 50
                    }];
                }
                
                // é˜²å¾¡å´ã®æˆ¦åŠ›ã‚’è¨ˆç®—
                if (target.owner) {
                    if (defenderDaimyo) {
                        battleLog.defender.basePower = defenderDaimyo.stats?.battle || 50;
                    }
                } else {
                    battleLog.defender.basePower = 30; // ç©ºç™½åœ°ã®åŸºæœ¬é˜²å¾¡åŠ›
                }
                
                // æˆ¦é—˜è¨ˆç®—ï¼ˆæ”»æ’ƒåŠ›ã‚’å°‘ã—å¼·åŒ–ï¼‰
                let finalAttackPower = attackPower + Math.random() * 25 + 10; // +10å›ºå®šãƒœãƒ¼ãƒŠã‚¹ã€ãƒ©ãƒ³ãƒ€ãƒ å¹…æ‹¡å¤§
                
                // é™£å½¢ãƒœãƒ¼ãƒŠã‚¹ã®é©ç”¨
                if (this.gameState.currentBattle && this.gameState.currentBattle.formationBonus) {
                    const playerFormationData = this.gameState.formations[this.gameState.currentBattle.playerFormation];
                    const formationBonus = this.gameState.currentBattle.formationBonus;
                    
                    // é™£å½¢å›ºæœ‰ãƒœãƒ¼ãƒŠã‚¹ï¼ˆæ”»æ’ƒåŠ›ãƒ»é˜²å¾¡åŠ›ï¼‰
                    finalAttackPower += playerFormationData.attackBonus;
                    
                    // é™£å½¢ç›¸æ€§ãƒœãƒ¼ãƒŠã‚¹ï¼ˆ1.2å€ï¼‰
                    if (formationBonus.player > 1) {
                        finalAttackPower = Math.floor(finalAttackPower * formationBonus.player);
                        battleLog.events.push({
                            type: 'attack',
                            message: `ã€é™£å½¢åŠ¹æœã€‘${playerFormationData.name}ã®å›ºæœ‰åŠ¹æœ(æ”»æ’ƒ+${playerFormationData.attackBonus})ã¨ç›¸æ€§ãƒœãƒ¼ãƒŠã‚¹(${formationBonus.player}å€)ãŒç™ºå‹•ï¼`
                        });
                    } else {
                        battleLog.events.push({
                            type: 'attack',
                            message: `ã€é™£å½¢åŠ¹æœã€‘${playerFormationData.name}ã®å›ºæœ‰åŠ¹æœã«ã‚ˆã‚Šæ”»æ’ƒåŠ›+${playerFormationData.attackBonus}`
                        });
                    }
                }
                
                // é‰„å£åŠ¹æœã®é©ç”¨
                if (typeof ironwallResult !== 'undefined' && ironwallResult.activated) {
                    finalAttackPower = Math.floor(finalAttackPower * ironwallResult.multiplier);
                    battleLog.events.push({
                        type: 'defense',
                        message: `é‰„å£åŠ¹æœã«ã‚ˆã‚Šæ”»æ’ƒåŠ›ãŒåŠæ¸›ï¼${ironwallResult.activator}ã®å®Œç’§ãªå®ˆå‚™é™£å½¢ãŒæ”»æ’ƒã‚’å°ã˜ãŸï¼`
                    });
                }
                
                // æ­¦ç”°ä¿¡ç„ã®é¢¨æ—ç«å±±åŠ¹æœï¼šé¨é¦¬å…µç§‘æ™‚ã®é¨é¦¬çªæ’ƒ
                if (playerDaimyo.skill === 'é¢¨æ—ç«å±±') {
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä¸»åŠ›å…µç§‘ã‚’åˆ¤å®š
                    let playerMainUnit = 'infantry';
                    let maxTroops = 0;
                    
                    playerTerritories.forEach(territory => {
                        if (territory && territory.troops > maxTroops) {
                            maxTroops = territory.troops;
                            playerMainUnit = territory.unitType || 'infantry';
                        }
                    });
                    
                    if (playerMainUnit === 'cavalry') {
                        const chargeMultiplier = Math.random() * 0.4 + 1.1; // 1.1-1.5å€
                        finalAttackPower = Math.floor(finalAttackPower * chargeMultiplier);
                        
                        battleLog.events.push({
                            type: 'attack',
                            message: `ã€é¨é¦¬çªæ’ƒç™ºå‹•ã€‘æ­¦ç”°ä¿¡ç„ã®é¢¨æ—ç«å±±ã«ã‚ˆã‚Šé¨é¦¬éšŠãŒç–¾é¢¨è¿…é›·ã®çªæ’ƒï¼æˆ¦åŠ›ãŒ${(chargeMultiplier * 100).toFixed(0)}%ã«å¢—å¼·ï¼`
                        });
                    }
                }
                const baseDefensePower = defenderAttackPower + defenderSkillBonus;
                let troopDefensePower = Math.floor((target.troops || 0) / 10) + baseDefensePower + Math.random() * 10;
                
                // æ•µã®é™£å½¢ãƒœãƒ¼ãƒŠã‚¹ã®é©ç”¨
                if (this.gameState.currentBattle && this.gameState.currentBattle.formationBonus) {
                    const enemyFormationData = this.gameState.formations[this.gameState.currentBattle.enemyFormation];
                    const formationBonus = this.gameState.currentBattle.formationBonus;
                    
                    // æ•µé™£å½¢å›ºæœ‰ãƒœãƒ¼ãƒŠã‚¹ï¼ˆé˜²å¾¡åŠ›ï¼‰
                    troopDefensePower += enemyFormationData.defenseBonus;
                    
                    // æ•µã®é™£å½¢ç›¸æ€§ãƒœãƒ¼ãƒŠã‚¹ï¼ˆ1.2å€ï¼‰
                    if (formationBonus.enemy > 1) {
                        troopDefensePower = Math.floor(troopDefensePower * formationBonus.enemy);
                        battleLog.events.push({
                            type: 'defense',
                            message: `ã€æ•µé™£å½¢åŠ¹æœã€‘${enemyFormationData.name}ã®å›ºæœ‰åŠ¹æœ(é˜²å¾¡+${enemyFormationData.defenseBonus})ã¨ç›¸æ€§ãƒœãƒ¼ãƒŠã‚¹(${formationBonus.enemy}å€)ãŒç™ºå‹•ï¼`
                        });
                    } else {
                        battleLog.events.push({
                            type: 'defense',
                            message: `ã€æ•µé™£å½¢åŠ¹æœã€‘${enemyFormationData.name}ã®å›ºæœ‰åŠ¹æœã«ã‚ˆã‚Šé˜²å¾¡åŠ›+${enemyFormationData.defenseBonus}`
                        });
                    }
                }
                
                // ä¸Šæ‰è¬™ä¿¡ã®è»ç¥åŠ¹æœï¼šæ•µå®ˆå‚™åŠ›åŠæ¸›
                if (playerDaimyo.skill === 'è»ç¥') {
                    troopDefensePower = Math.floor(troopDefensePower / 2);
                    battleLog.events.push({
                        type: 'attack',
                        message: `ã€è»ç¥åŠ¹æœã€‘ä¸Šæ‰è¬™ä¿¡ã®ç¥å¨ã«ã‚ˆã‚Šæ•µã®å®ˆå‚™åŠ›ãŒåŠæ¸›ï¼`
                    });
                }
                
                // å¼·è¥²æ”»æ’ƒåˆ¤å®šç”¨ã®æˆ¦é—˜å€¤ã‚’å–å¾—
                const getAttackerBattleValue = () => {
                    let maxBattle = playerDaimyo.stats?.battle || 50;
                    
                    // æ”»æ’ƒå´æ­¦å°†ã®æœ€é«˜æˆ¦é—˜å€¤ã‚’å–å¾—
                    const attackPositions = ['armyStrategist', 'vanguard', 'rightWing', 'leftWing', 'reserve'];
                    attackPositions.forEach(roleKey => {
                        const generalId = this.gameState.playerRoles[roleKey];
                        if (generalId) {
                            const general = this.gameState.generals.find(g => g && g.id === generalId);
                            if (general && general.stats && general.stats.battle) {
                                maxBattle = Math.max(maxBattle, general.stats.battle);
                            }
                        }
                    });
                    return maxBattle;
                };
                
                const getDefenderBattleValue = () => {
                    let maxBattle = defenderDaimyo ? (defenderDaimyo.stats?.battle || 50) : 30;
                    
                    // é˜²å¾¡å´æ­¦å°†ã®æˆ¦é—˜å€¤ã‚’ãƒã‚§ãƒƒã‚¯
                    if (target.generalGarrison) {
                        const castleCommander = this.gameState.generals.find(g => g && g.id === target.generalGarrison);
                        if (castleCommander && castleCommander.stats && castleCommander.stats.battle) {
                            maxBattle = Math.max(maxBattle, castleCommander.stats.battle);
                        }
                    }
                    
                    // é˜²å¾¡å´AIæ­¦å°†ã®æˆ¦é—˜å€¤ã‚‚ãƒã‚§ãƒƒã‚¯
                    if (defenderDaimyo && defenderDaimyo.id && this.gameState.aiRoles && this.gameState.aiRoles[defenderDaimyo.id]) {
                        const defenderRoles = this.gameState.aiRoles[defenderDaimyo.id];
                        const defenderPositions = ['armyStrategist', 'vanguard', 'rightWing', 'leftWing', 'reserve'];
                        defenderPositions.forEach(roleKey => {
                            const generalId = defenderRoles[roleKey];
                            if (generalId) {
                                const general = this.gameState.generals.find(g => g && g.id === generalId);
                                if (general && general.stats && general.stats.battle) {
                                    maxBattle = Math.max(maxBattle, general.stats.battle);
                                }
                            }
                        });
                    }
                    return maxBattle;
                };
                
                // å¼·è¥²åˆ¤å®šé–¢æ•°
                const checkAssaultAttack = (side, phase) => {
                    let assaultResults = [];
                    
                    if (side === 'attacker') {
                        // æ”»æ’ƒå´ã®å¼·è¥²åˆ¤å®šï¼šå¤§åã¨å„æ­¦å°†ã‚’ãƒã‚§ãƒƒã‚¯
                        const attackers = [];
                        
                        // å¤§åã‚’ãƒã‚§ãƒƒã‚¯
                        if (playerDaimyo && playerDaimyo.stats && playerDaimyo.stats.battle >= 80) {
                            attackers.push({
                                name: playerDaimyo.name,
                                battleValue: playerDaimyo.stats.battle,
                                isLord: true
                            });
                        }
                        
                        // è»å›£æ­¦å°†ã‚’ãƒã‚§ãƒƒã‚¯
                        const attackPositions = ['armyStrategist', 'vanguard', 'rightWing', 'leftWing', 'reserve'];
                        attackPositions.forEach(roleKey => {
                            const generalId = this.gameState.playerRoles[roleKey];
                            if (generalId) {
                                const general = this.gameState.generals.find(g => g && g.id === generalId);
                                if (general && general.stats && general.stats.battle >= 80) {
                                    attackers.push({
                                        name: general.name,
                                        battleValue: general.stats.battle,
                                        role: roleKey,
                                        isLord: false
                                    });
                                }
                            }
                        });
                        
                        // å„æ”»æ’ƒè€…ã«ã¤ã„ã¦å¼·è¥²åˆ¤å®š
                        attackers.forEach(attacker => {
                            const baseChance = Math.min(30, (attacker.battleValue - 80) * 2 + 15);
                            if (Math.random() * 100 <= baseChance) {
                                const assaultPower = Math.floor(attacker.battleValue / 4) + Math.random() * 10;
                                
                                // è»ç¥æŒã¡ã®å ´åˆã€å¼·è¥²å¨åŠ›ã‚’1.5å€ã«
                                let finalAssaultPower = assaultPower;
                                let hasGunsin = false;
                                
                                // æ”»æ’ƒå´ã«è»ç¥æŒã¡ãŒã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                                if (attacker.isLord && playerDaimyo && playerDaimyo.skill === 'è»ç¥') {
                                    hasGunsin = true;
                                } else if (!attacker.isLord && attacker.role) {
                                    const generalId = this.gameState.playerRoles[attacker.role];
                                    if (generalId) {
                                        const general = this.gameState.generals.find(g => g && g.id === generalId);
                                        if (general && general.skill === 'è»ç¥') {
                                            hasGunsin = true;
                                        }
                                    }
                                }
                                
                                if (hasGunsin) {
                                    finalAssaultPower = Math.floor(assaultPower * 1.5);
                                }
                                
                                assaultResults.push({
                                    name: attacker.name,
                                    power: finalAssaultPower,
                                    role: attacker.role,
                                    isLord: attacker.isLord,
                                    hasGunsin: hasGunsin
                                });
                            }
                        });
                        
                    } else {
                        // é˜²å¾¡å´ã®å¼·è¥²åˆ¤å®š
                        const defenders = [];
                        
                        // é˜²å¾¡å´å¤§åã‚’ãƒã‚§ãƒƒã‚¯
                        if (defenderDaimyo && defenderDaimyo.stats && defenderDaimyo.stats.battle >= 80) {
                            defenders.push({
                                name: defenderDaimyo.name,
                                battleValue: defenderDaimyo.stats.battle,
                                isLord: true
                            });
                        }
                        
                        // åŸä¸»æ­¦å°†ã‚’ãƒã‚§ãƒƒã‚¯
                        if (target.generalGarrison) {
                            const castleCommander = this.gameState.generals.find(g => g && g.id === target.generalGarrison);
                            if (castleCommander && castleCommander.stats && castleCommander.stats.battle >= 80) {
                                defenders.push({
                                    name: castleCommander.name,
                                    battleValue: castleCommander.stats.battle,
                                    role: 'castle_commander',
                                    isLord: false
                                });
                            }
                        }
                        
                        // é˜²å¾¡å´AIæ­¦å°†ã‚’ãƒã‚§ãƒƒã‚¯
                        if (defenderDaimyo && defenderDaimyo.id && this.gameState.aiRoles && this.gameState.aiRoles[defenderDaimyo.id]) {
                            const defenderRoles = this.gameState.aiRoles[defenderDaimyo.id];
                            const defenderPositions = ['armyStrategist', 'vanguard', 'rightWing', 'leftWing', 'reserve'];
                            defenderPositions.forEach(roleKey => {
                                const generalId = defenderRoles[roleKey];
                                if (generalId) {
                                    const general = this.gameState.generals.find(g => g && g.id === generalId);
                                    if (general && general.stats && general.stats.battle >= 80) {
                                        defenders.push({
                                            name: general.name,
                                            battleValue: general.stats.battle,
                                            role: roleKey,
                                            isLord: false
                                        });
                                    }
                                }
                            });
                        }
                        
                        // å„é˜²å¾¡è€…ã«ã¤ã„ã¦å¼·è¥²åˆ¤å®š
                        defenders.forEach(defender => {
                            const baseChance = Math.min(30, (defender.battleValue - 80) * 2 + 15);
                            if (Math.random() * 100 <= baseChance) {
                                const assaultPower = Math.floor(defender.battleValue / 4) + Math.random() * 10;
                                assaultResults.push({
                                    name: defender.name,
                                    power: assaultPower,
                                    role: defender.role,
                                    isLord: defender.isLord
                                });
                            }
                        });
                    }
                    
                    // å¼·è¥²çµæœã‚’ãƒ­ã‚°ã«è¨˜éŒ²
                    if (assaultResults.length > 0) {
                        const sideText = side === 'attacker' ? 'æ”»æ’ƒè»' : 'å®ˆå‚™è»';
                        const phaseText = phase === 'troops' ? 'å…µå£«æˆ¦' : 'æ”»åŸæˆ¦';
                        
                        assaultResults.forEach(result => {
                            const roleNames = {
                                'armyStrategist': 'è»å¸«', 'vanguard': 'å‰è¡›', 
                                'rightWing': 'å³ç¿¼', 'leftWing': 'å·¦ç¿¼', 'reserve': 'å¾Œè©°',
                                'castle_commander': 'åŸä¸»'
                            };
                            
                            let assaultMessage = '';
                            if (result.isLord) {
                                assaultMessage = `ã€å¼·è¥²ç™ºå‹•ã€‘${result.name}ãŒ${phaseText}ã§å¼·è¥²æ”»æ’ƒã‚’æ•¢è¡Œï¼`;
                            } else {
                                const roleName = roleNames[result.role] || 'æ­¦å°†';
                                assaultMessage = `ã€å¼·è¥²ç™ºå‹•ã€‘${result.name}(${roleName})ãŒ${phaseText}ã§å¼·è¥²æ”»æ’ƒã‚’æ•¢è¡Œï¼`;
                            }
                            
                            if (result.hasGunsin) {
                                assaultMessage += ` è»ç¥ã®åŠ è­·ã«ã‚ˆã‚Šå¨åŠ›1.5å€å¢—å¼·ï¼ è¿½åŠ å¨åŠ›+${Math.floor(result.power)}`;
                            } else {
                                assaultMessage += ` è¿½åŠ å¨åŠ›+${Math.floor(result.power)}`;
                            }
                            
                            battleLog.events.push({
                                type: side === 'attacker' ? 'attack' : 'defense',
                                message: assaultMessage
                            });
                        });
                    }
                    
                    return assaultResults.reduce((total, result) => total + result.power, 0);
                };
                
                const attackerBattleValue = getAttackerBattleValue();
                const defenderBattleValue = getDefenderBattleValue();
                
                // æ•µã‹ã‚‰ã®åæ’ƒåŠ›è¨ˆç®—
                const defenderCounterAttack = baseDefensePower + Math.floor((target.troops || 0) / 8) + Math.random() * 15;
                let playerDefensePower = defensePower + Math.random() * 10;
                
                // ç¹”ç”°ä¿¡é•·ã®é©æ–°è€…åŠ¹æœï¼šå®ˆå‚™æ™‚ã®é‰„ç ²åæ’ƒ
                if (target.owner === this.gameState.playerDaimyo && playerDaimyo.skill === 'é©æ–°è€…') {
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã“ã®é ˜åœŸã®å…µç§‘ã‚’ãƒã‚§ãƒƒã‚¯
                    if (target.unitType === 'arquebus') {
                        const counterMultiplier = Math.random() * 0.1 + 1.3; // 1.3-1.4å€
                        playerDefensePower = Math.floor(playerDefensePower * counterMultiplier);
                        
                        battleLog.events.push({
                            type: 'defense',
                            message: `ã€é‰„ç ²åæ’ƒç™ºå‹•ã€‘ç¹”ç”°ä¿¡é•·ã®é©æ–°çš„æˆ¦è¡“ã«ã‚ˆã‚Šé‰„ç ²éšŠãŒè¿æ’ƒï¼åæ’ƒåŠ›${(counterMultiplier * 100).toFixed(0)}%å¢—å¼·ï¼`
                        });
                    }
                }
                
                battleLog.events.push({
                    type: 'attack',
                    message: `${playerDaimyo.name}ã®è»å›£ãŒ${target.name}ã¸ã®ç·æ”»æ’ƒã‚’é–‹å§‹ï¼`
                });
                
                battleLog.events.push({
                    type: 'attack',
                    message: `æ”»æ’ƒè»æˆ¦åŠ›: ${Math.floor(finalAttackPower)} (åŸºæœ¬æˆ¦åŠ›${playerDaimyo.stats?.battle || 50} + è»å›£è£œæ­£${Math.floor(attackPower - (playerDaimyo.stats?.battle || 50) - skillBonus)} + ç‰¹æŠ€åŠ¹æœ${skillBonus} + å£«æ°—è£œæ­£)`
                });
                
                // é˜²å¾¡å´ã®æˆ¦åŠ›è¡¨ç¤º
                const defenderGeneralsCount = battleLog.defender.generals ? battleLog.defender.generals.length : 0;
                if (defenderGeneralsCount > 0) {
                    battleLog.events.push({
                        type: 'defense',
                        message: `${battleLog.defender.name}ã®è»å›£${defenderGeneralsCount}åãŒè¿æ’ƒæ…‹å‹¢ï¼é˜²å¾¡æˆ¦åŠ›: ${Math.floor(baseDefensePower)} (ç‰¹æŠ€åŠ¹æœ+${defenderSkillBonus} + å£«æ°—è£œæ­£)`
                    });
                } else {
                    battleLog.events.push({
                        type: 'defense',
                        message: `${battleLog.defender.name}ãŒè¿æ’ƒæ…‹å‹¢ã‚’æ•´ãˆã‚‹ï¼åŸºæœ¬é˜²å¾¡åŠ›: ${Math.floor(baseDefensePower)} (å£«æ°—è£œæ­£è¾¼ã¿)`
                    });
                }
                
                // æ­¦å°†ã®å‚æˆ¦ã‚’æˆ¦é—˜ã‚¤ãƒ™ãƒ³ãƒˆã«è¿½åŠ ï¼ˆå…·ä½“çš„ãªæ­¦å°†åã§ï¼‰
                try {
                    const attackerGeneralsCount = battleLog.attacker.generals ? battleLog.attacker.generals.length : 0;
                    if (attackerGeneralsCount > 0 && battleLog.attacker.generals) {
                        const attackerNames = battleLog.attacker.generals
                            .filter(g => g && g.name)
                            .map(g => g.name)
                            .slice(0, 4); // æœ€å¤§4åã¾ã§è¡¨ç¤º
                        
                        if (attackerNames.length > 0) {
                            let participationMessage = '';
                            if (attackerNames.length <= 2) {
                                participationMessage = `${attackerNames.join('ã€')}ãŒæˆ¦ç·šã«å‚åŠ ï¼`;
                            } else if (attackerNames.length <= 4) {
                                participationMessage = `${attackerNames.join('ã€')}ã‚‰ãŒæˆ¦ç·šã«å‚åŠ ï¼`;
                            } else {
                                participationMessage = `${attackerNames.slice(0, 3).join('ã€')}ã‚‰${attackerGeneralsCount}åãŒæˆ¦ç·šã«å‚åŠ ï¼`;
                            }
                            
                            battleLog.events.push({
                                type: 'attack',
                                message: participationMessage
                            });
                        }
                    }
                } catch (error) {
                    console.warn('æ”»æ’ƒå´æ­¦å°†å‚æˆ¦ãƒ­ã‚°ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º
                    const attackerGeneralsCount = battleLog.attacker.generals ? battleLog.attacker.generals.length : 0;
                    if (attackerGeneralsCount > 0) {
                        battleLog.events.push({
                            type: 'attack',
                            message: `æ”»æ’ƒè»é…ä¸‹æ­¦å°†${attackerGeneralsCount}åãŒæˆ¦ç·šã«å‚åŠ ï¼`
                        });
                    }
                }
                
                try {
                    const defenderGeneralsCount = battleLog.defender.generals ? battleLog.defender.generals.length : 0;
                    if (defenderGeneralsCount > 0 && battleLog.defender.generals) {
                        const defenderNames = battleLog.defender.generals
                            .filter(g => g && g.name)
                            .map(g => g.name)
                            .slice(0, 4); // æœ€å¤§4åã¾ã§è¡¨ç¤º
                        
                        if (defenderNames.length > 0) {
                            let defenseMessage = '';
                            if (defenderNames.length <= 2) {
                                defenseMessage = `${defenderNames.join('ã€')}ãŒé˜²è¡›ç·šã‚’æ§‹ç¯‰ï¼`;
                            } else if (defenderNames.length <= 4) {
                                defenseMessage = `${defenderNames.join('ã€')}ã‚‰ãŒé˜²è¡›ç·šã‚’æ§‹ç¯‰ï¼`;
                            } else {
                                defenseMessage = `${defenderNames.slice(0, 3).join('ã€')}ã‚‰${defenderGeneralsCount}åãŒé˜²è¡›ç·šã‚’æ§‹ç¯‰ï¼`;
                            }
                            
                            battleLog.events.push({
                                type: 'defense',
                                message: defenseMessage
                            });
                        }
                    }
                } catch (error) {
                    console.warn('é˜²å¾¡å´æ­¦å°†å‚æˆ¦ãƒ­ã‚°ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º
                    const defenderGeneralsCount = battleLog.defender.generals ? battleLog.defender.generals.length : 0;
                    if (defenderGeneralsCount > 0) {
                        battleLog.events.push({
                            type: 'defense',
                            message: `å®ˆå‚™è»é…ä¸‹æ­¦å°†${defenderGeneralsCount}åãŒé˜²è¡›ç·šã‚’æ§‹ç¯‰ï¼`
                        });
                    }
                }
                
                // ç‰¹æŠ€ç™ºå‹•ã‚’æˆ¦é—˜ã‚¤ãƒ™ãƒ³ãƒˆã«è¿½åŠ 
                if (battleLog.skillActivations && battleLog.skillActivations.length > 0) {
                    const attackerSkills = battleLog.skillActivations.filter(s => s && s.activated && s.side === 'attacker');
                    const defenderSkills = battleLog.skillActivations.filter(s => s && s.activated && s.side === 'defender');
                    
                    if (attackerSkills.length > 0) {
                        battleLog.events.push({
                            type: 'victory',
                            message: `æ”»æ’ƒè»ã®ç‰¹æŠ€ãŒ${attackerSkills.length}å€‹ç™ºå‹•ï¼æˆ¦æ³ã«å¤§ããªå½±éŸ¿ã‚’ä¸ãˆãŸ`
                        });
                    }
                    
                    if (defenderSkills.length > 0) {
                        battleLog.events.push({
                            type: 'defense',
                            message: `å®ˆå‚™è»ã®ç‰¹æŠ€ãŒ${defenderSkills.length}å€‹ç™ºå‹•ï¼å®ˆã‚Šã‚’å›ºã‚ãŸ`
                        });
                    }
                }
                
                // åŒæ–¹å‘æˆ¦é—˜ã®é–‹å§‹
                battleLog.events.push({
                    type: 'attack',
                    message: `æ¿€ã—ã„æˆ¦é—˜ãŒé–‹å§‹ã•ã‚ŒãŸï¼ä¸¡è»ãŒæ¿€çªã™ã‚‹ï¼`
                });
                
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è»ã®æå®³è¨ˆç®—ï¼ˆæ•µã‹ã‚‰ã®åæ’ƒ + æˆ¦è¡“çš„ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼‰
                let playerCasualties = 0;
                
                // æˆ¦è¡“çš„ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å…ˆã«é©ç”¨
                if (tacticalDamageToAttacker > 0) {
                    playerCasualties += tacticalDamageToAttacker;
                    battleLog.events.push({
                        type: 'damage',
                        message: `æˆ¦è¡“çš„æ”»æ’ƒã«ã‚ˆã‚Šæ”»æ’ƒè»ã«${tacticalDamageToAttacker}ã®æå®³ãŒç™ºç”Ÿ`
                    });
                }
                
                // é€šå¸¸ã®åæ’ƒãƒ€ãƒ¡ãƒ¼ã‚¸ï¼ˆå¾Œè©°ã«ã‚ˆã‚‹è»½æ¸›ã‚’é©ç”¨ï¼‰
                let effectiveCounterAttack = Math.max(0, defenderCounterAttack - tacticalDefenseBonus);
                if (tacticalDefenseBonus > 0) {
                    battleLog.events.push({
                        type: 'attack',
                        message: `å¾Œæ–¹æ”¯æ´ã«ã‚ˆã‚Šæ•µã®åæ’ƒåŠ›${defenderCounterAttack}â†’${effectiveCounterAttack}ã«è»½æ¸›ï¼`
                    });
                }
                
                if (effectiveCounterAttack > playerDefensePower) {
                    const additionalCasualties = Math.floor((effectiveCounterAttack - playerDefensePower) * (Math.random() * 0.4 + 0.2));
                    playerCasualties += additionalCasualties;
                    
                    if (defenderGeneralsCount > 0) {
                        battleLog.events.push({
                            type: 'defense',
                            message: `${battleLog.defender.name}ã®åæ’ƒï¼é…ä¸‹æ­¦å°†ãŒå¥®æˆ¦ã—æ”»æ’ƒè»ã«${playerCasualties}ã®æå®³ã‚’ä¸ãˆãŸ`
                        });
                    } else {
                        battleLog.events.push({
                            type: 'defense',
                            message: `${battleLog.defender.name}ã®åæ’ƒã«ã‚ˆã‚Šæ”»æ’ƒè»ã«${playerCasualties}ã®æå®³ãŒç™ºç”Ÿ`
                        });
                    }
                    
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é ˜åœŸã‹ã‚‰å…µåŠ›ã‚’æ¸›ã‚‰ã™
                    const playerTerritories = this.gameState.getPlayerTerritories();
                    if (playerTerritories.length > 0) {
                        // æœ€ã‚‚å…µåŠ›ã®å¤šã„é ˜åœŸã‹ã‚‰æå®³ã‚’å·®ã—å¼•ã
                        const strongestTerritory = playerTerritories.reduce((strongest, current) => 
                            (current.troops || 0) > (strongest.troops || 0) ? current : strongest
                        );
                        
                        const originalTroops = strongestTerritory.troops || 0;
                        strongestTerritory.troops = Math.max(0, originalTroops - playerCasualties);
                        
                        if (strongestTerritory.troops < originalTroops) {
                            battleLog.events.push({
                                type: 'damage',
                                message: `${strongestTerritory.name}ã®å®ˆå‚™å…µãŒ${originalTroops}â†’${strongestTerritory.troops}ã«æ¸›å°‘`
                            });
                        }
                    }
                } else {
                    battleLog.events.push({
                        type: 'attack',
                        message: `æ”»æ’ƒè»ã®é˜²å¾¡ãŒå …ãã€æ•µã®åæ’ƒã‚’æœ€å°é™ã«æŠ‘ãˆãŸ`
                    });
                    // å°è¦æ¨¡ãªæå®³ã¯ç™ºç”Ÿ
                    playerCasualties = Math.floor(Math.random() * 5);
                    if (playerCasualties > 0) {
                        battleLog.events.push({
                            type: 'damage',
                            message: `ãã‚Œã§ã‚‚å°è¦æ¨¡ãªæå®³${playerCasualties}ãŒç™ºç”Ÿ`
                        });
                        
                        const playerTerritories = this.gameState.getPlayerTerritories();
                        if (playerTerritories.length > 0) {
                            const randomTerritory = playerTerritories[Math.floor(Math.random() * playerTerritories.length)];
                            randomTerritory.troops = Math.max(0, (randomTerritory.troops || 0) - playerCasualties);
                        }
                    }
                }
                
                // è¨˜éŒ²ç”¨ã«æå®³ã‚’ä¿å­˜
                battleLog.result.playerCasualties = playerCasualties;
                
                if (target.troops > 0) {
                    // ç¬¬1æ®µéš: å…µæ•°ã¸ã®æ”»æ’ƒ
                    battleLog.events.push({
                        type: 'defense',
                        message: `${target.name}ã®å®ˆå‚™å…µ${target.troops}ãŒè¿æ’ƒæ…‹å‹¢ã‚’æ•´ãˆã‚‹ï¼é˜²å¾¡åŠ›: ${Math.floor(troopDefensePower)}`
                    });
                    
                    // é¨é¦¬é‰„ç ²éšŠã«ã‚ˆã‚‹é˜²å¾¡ç„¡è¦–ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å…ˆã«é©ç”¨
                    if (dateCavalryDamage > 0) {
                        const previousTroops = target.troops;
                        target.troops = Math.max(0, target.troops - dateCavalryDamage);
                        
                        battleLog.result.troopDamage += dateCavalryDamage;
                        battleLog.events.push({
                            type: 'victory',
                            message: `é¨é¦¬é‰„ç ²éšŠã®çªæ’ƒã«ã‚ˆã‚Šå®ˆå‚™å…µã«${dateCavalryDamage}ã®é˜²å¾¡ç„¡è¦–ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`
                        });
                        
                        battleLog.events.push({
                            type: 'damage',
                            message: `${target.name}ã®å®ˆå‚™å…µ: ${previousTroops} â†’ ${target.troops}`
                        });
                        
                        if (target.troops === 0) {
                            battleLog.events.push({
                                type: 'victory',
                                message: `é¨é¦¬é‰„ç ²éšŠã®çŒ›æ”»ã«ã‚ˆã‚Šå®ˆå‚™å…µãŒå£Šæ»…ï¼åŸã¸ã®ç·æ”»æ’ƒã‚’é–‹å§‹ã™ã‚‹`
                            });
                        }
                    }
                    
                    // æˆ¦è¡“çš„ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å…ˆã«é©ç”¨
                    if (tacticalDamageToDefender > 0) {
                        const previousTroops = target.troops;
                        target.troops = Math.max(0, target.troops - tacticalDamageToDefender);
                        
                        battleLog.result.troopDamage += tacticalDamageToDefender;
                        battleLog.events.push({
                            type: 'victory',
                            message: `æˆ¦è¡“çš„æ”»æ’ƒã«ã‚ˆã‚Šå®ˆå‚™å…µã«${tacticalDamageToDefender}ã®ç›´æ¥æå®³ï¼`
                        });
                        
                        battleLog.events.push({
                            type: 'damage',
                            message: `${target.name}ã®å®ˆå‚™å…µ: ${previousTroops} â†’ ${target.troops}`
                        });
                        
                        if (target.troops === 0) {
                            battleLog.events.push({
                                type: 'victory',
                                message: `æˆ¦è¡“çš„æ”»æ’ƒã«ã‚ˆã‚Šå®ˆå‚™å…µãŒå£Šæ»…ï¼åŸã¸ã®ç·æ”»æ’ƒã‚’é–‹å§‹ã™ã‚‹`
                            });
                        }
                    }
                    
                    // ä¸­å¤®çªç ´ã«ã‚ˆã‚‹é˜²å¾¡ç„¡è¦–ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å…ˆã«é©ç”¨
                    if (centralBreakthroughDamage > 0) {
                        const previousTroops = target.troops;
                        target.troops = Math.max(0, target.troops - centralBreakthroughDamage);
                        
                        battleLog.result.troopDamage = centralBreakthroughDamage;
                        battleLog.events.push({
                            type: 'victory',
                            message: `ä¸­å¤®çªç ´ã«ã‚ˆã‚Šé˜²å¾¡ç„¡è¦–ã§å®ˆå‚™å…µã«${centralBreakthroughDamage}ã®çµ¶å¯¾ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`
                        });
                        
                        battleLog.events.push({
                            type: 'damage',
                            message: `${target.name}ã®å®ˆå‚™å…µ: ${previousTroops} â†’ ${target.troops}`
                        });
                        
                        if (target.troops === 0) {
                            battleLog.events.push({
                                type: 'victory',
                                message: `ä¸­å¤®çªç ´ã«ã‚ˆã‚Šå®ˆå‚™å…µãŒç¬æ™‚ã«å…¨æ»…ï¼åŸã¸ã®ç·æ”»æ’ƒã‚’é–‹å§‹ã™ã‚‹`
                            });
                        }
                    }
                    
                    // é€šå¸¸ã®æˆ¦é—˜åˆ¤å®šï¼ˆä¸­å¤®çªç ´ã§å…µãŒã¾ã æ®‹ã£ã¦ã„ã‚‹å ´åˆï¼‰
                    if (target.troops > 0) {
                        // æˆ¦é—˜é–‹å§‹æ™‚ã®å¼·è¥²åˆ¤å®š
                        let attackerAssaultBonus = 0;
                        let defenderAssaultBonus = 0;
                        
                        // æ”»æ’ƒå´å¼·è¥²åˆ¤å®šï¼ˆæœ€å¤§3å›ã¾ã§ï¼‰
                        for (let i = 0; i < 3; i++) {
                            const assault = checkAssaultAttack('attacker', 'troops');
                            if (assault > 0) {
                                attackerAssaultBonus += assault;
                            } else {
                                break; // å¤±æ•—ã—ãŸã‚‰çµ‚äº†
                            }
                        }
                        
                        // é˜²å¾¡å´å¼·è¥²åˆ¤å®šï¼ˆæœ€å¤§3å›ã¾ã§ï¼‰
                        for (let i = 0; i < 3; i++) {
                            const assault = checkAssaultAttack('defender', 'troops');
                            if (assault > 0) {
                                defenderAssaultBonus += assault;
                            } else {
                                break; // å¤±æ•—ã—ãŸã‚‰çµ‚äº†
                            }
                        }
                        
                        // å¼·è¥²ãƒœãƒ¼ãƒŠã‚¹ã‚’æˆ¦é—˜åŠ›ã«é©ç”¨ï¼ˆæ”»æ’ƒåŠ›å¼·åŒ–ï¼‰
                        const adjustedAttackPower = finalAttackPower + attackerAssaultBonus + 8; // +8è¿½åŠ ãƒœãƒ¼ãƒŠã‚¹
                        const adjustedDefensePower = troopDefensePower + defenderAssaultBonus;
                        
                        if (adjustedAttackPower > adjustedDefensePower) {
                            const damage = Math.floor((adjustedAttackPower - adjustedDefensePower) * (Math.random() * 0.5 + 0.5));
                            const previousTroops = target.troops;
                            target.troops = Math.max(0, target.troops - damage);
                            
                            battleLog.result.troopDamage += damage; // ä¸­å¤®çªç ´ãƒ€ãƒ¡ãƒ¼ã‚¸ã«è¿½åŠ 
                            battleLog.events.push({
                                type: 'damage',
                                message: `é€šå¸¸æ”»æ’ƒãŒæˆåŠŸï¼å®ˆå‚™å…µã«ã•ã‚‰ã«${damage}ã®æå®³ã‚’ä¸ãˆãŸ`
                            });
                            
                            battleLog.events.push({
                                type: 'damage',
                                message: `${target.name}ã®å®ˆå‚™å…µ: ${previousTroops} â†’ ${target.troops}`
                            });
                            
                            if (target.troops === 0) {
                                battleLog.events.push({
                                    type: 'victory',
                                    message: `${target.name}ã®å®ˆå‚™å…µãŒå®Œå…¨ã«å…¨æ»…ï¼åŸã¸ã®ç·æ”»æ’ƒã‚’é–‹å§‹ã™ã‚‹`
                                });
                            }
                        } else {
                            battleLog.events.push({
                                type: 'defense',
                                message: `å®ˆå‚™å…µã®å¥®æˆ¦ã«ã‚ˆã‚Šé€šå¸¸æ”»æ’ƒã‚’é˜²å¾¡ã•ã‚ŒãŸ`
                            });
                        }
                    }
                } else {
                    // å…µæ•°ãŒæ—¢ã«0ã®å ´åˆã€æˆ¦è¡“çš„ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’åŸå£ã«é©ç”¨
                    if (tacticalDamageToDefender > 0) {
                        const previousWalls = target.walls;
                        target.walls = Math.max(0, target.walls - tacticalDamageToDefender);
                        
                        battleLog.result.wallDamage = tacticalDamageToDefender;
                        battleLog.events.push({
                            type: 'victory',
                            message: `æˆ¦è¡“çš„æ”»æ’ƒã«ã‚ˆã‚ŠåŸå£ã«${tacticalDamageToDefender}ã®ç›´æ¥æå®³ï¼`
                        });
                        
                        battleLog.events.push({
                            type: 'damage',
                            message: `${target.name}ã®åŸå£: ${previousWalls} â†’ ${target.walls}`
                        });
                    }
                    
                    // ä¸­å¤®çªç ´ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’åŸå£ã«é©ç”¨
                    if (centralBreakthroughDamage > 0) {
                        const previousWalls = target.walls;
                        target.walls = Math.max(0, target.walls - centralBreakthroughDamage);
                        
                        battleLog.result.wallDamage += centralBreakthroughDamage;
                        battleLog.events.push({
                            type: 'victory',
                            message: `ä¸­å¤®çªç ´ã«ã‚ˆã‚Šé˜²å¾¡ç„¡è¦–ã§åŸå£ã«${centralBreakthroughDamage}ã®çµ¶å¯¾ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`
                        });
                        
                        battleLog.events.push({
                            type: 'damage',
                            message: `${target.name}ã®åŸå£: ${previousWalls} â†’ ${target.walls}`
                        });
                    }
                } 
                
                if (target.troops === 0) {
                    // ç¬¬2æ®µéš: åŸå£ã¸ã®æ”»æ’ƒï¼ˆå…µæ•°ãŒ0ã®å ´åˆã®ã¿ï¼‰
                    let wallDefensePower = Math.floor(target.walls / 5) + Math.random() * 10;
                    
                    // æ”»åŸæˆ¦ã§ã®å®ˆå‚™æ­¦å°†èƒ½åŠ›ã‚’è¿½åŠ 
                    let siegeDefenderBonus = 0;
                    
                    // åŸä¸»æ­¦å°†ã®çµ±ç‡åŠ›ã‚’æ”»åŸæˆ¦å®ˆå‚™åŠ›ã«è¿½åŠ 
                    if (target.generalGarrison) {
                        const castleCommander = this.gameState.generals.find(g => g && g.id === target.generalGarrison);
                        if (castleCommander && castleCommander.stats && castleCommander.stats.command) {
                            siegeDefenderBonus += Math.floor(castleCommander.stats.command / 5);
                            battleLog.events.push({
                                type: 'defense',
                                message: `åŸä¸»${castleCommander.name}(çµ±ç‡${castleCommander.stats.command})ãŒåŸå£é˜²å¾¡ã‚’æŒ‡æ®ï¼å®ˆå‚™åŠ›+${Math.floor(castleCommander.stats.command / 5)}`
                            });
                        }
                    }
                    
                    // é˜²å¾¡å´å¤§åã®çµ±ç‡åŠ›ã‚‚æ”»åŸæˆ¦å®ˆå‚™åŠ›ã«è¿½åŠ 
                    if (defenderDaimyo && defenderDaimyo.stats && defenderDaimyo.stats.command) {
                        const daimyoDefenseBonus = Math.floor(defenderDaimyo.stats.command / 8);
                        siegeDefenderBonus += daimyoDefenseBonus;
                        battleLog.events.push({
                            type: 'defense',
                            message: `${defenderDaimyo.name}(çµ±ç‡${defenderDaimyo.stats.command})ã®æŒ‡æ®ã«ã‚ˆã‚ŠåŸå£å®ˆå‚™åŠ›+${daimyoDefenseBonus}`
                        });
                    }
                    
                    // é˜²å¾¡å´è»å›£æ­¦å°†ã®çµ±ç‡åŠ›ã‚‚æ”»åŸæˆ¦å®ˆå‚™åŠ›ã«è¿½åŠ 
                    if (defenderDaimyo && defenderDaimyo.id && this.gameState.aiRoles && this.gameState.aiRoles[defenderDaimyo.id]) {
                        const defenderRoles = this.gameState.aiRoles[defenderDaimyo.id];
                        const defenderPositions = ['armyStrategist', 'vanguard', 'rightWing', 'leftWing', 'reserve'];
                        
                        defenderPositions.forEach(roleKey => {
                            const generalId = defenderRoles[roleKey];
                            if (generalId) {
                                const general = this.gameState.generals.find(g => g && g.id === generalId);
                                if (general && general.stats && general.stats.command) {
                                    const roleDefenseBonus = Math.floor(general.stats.command / 10);
                                    if (roleDefenseBonus > 0) {
                                        siegeDefenderBonus += roleDefenseBonus;
                                        
                                        const roleNames = {
                                            'armyStrategist': 'è»å¸«', 'vanguard': 'å‰è¡›', 
                                            'rightWing': 'å³ç¿¼', 'leftWing': 'å·¦ç¿¼', 'reserve': 'å¾Œè©°'
                                        };
                                        const roleName = roleNames[roleKey] || roleKey;
                                        
                                        battleLog.events.push({
                                            type: 'defense',
                                            message: `${general.name}(${roleName})ã®çµ±ç‡ã«ã‚ˆã‚ŠåŸå£å®ˆå‚™åŠ›+${roleDefenseBonus}`
                                        });
                                    }
                                }
                            }
                        });
                    }
                    
                    // å®ˆå‚™æ­¦å°†ãƒœãƒ¼ãƒŠã‚¹ã‚’é©ç”¨
                    wallDefensePower += siegeDefenderBonus;
                    
                    // ä¸Šæ‰è¬™ä¿¡ã®è»ç¥åŠ¹æœï¼šåŸå£å®ˆå‚™åŠ›ã‚‚åŠæ¸›
                    if (playerDaimyo.skill === 'è»ç¥') {
                        wallDefensePower = Math.floor(wallDefensePower / 2);
                        battleLog.events.push({
                            type: 'attack',
                            message: `ã€è»ç¥åŠ¹æœã€‘åŸå£ã¸ã®æ”»æ’ƒã§ã‚‚æ•µã®å®ˆå‚™åŠ›ãŒåŠæ¸›ï¼`
                        });
                    }
                    
                    battleLog.events.push({
                        type: 'attack',
                        message: `åŸå£ã¸ã®æ”»åŸæˆ¦é–‹å§‹ï¼åŸå£å¼·åº¦: ${target.walls}, é˜²å¾¡åŠ›: ${Math.floor(wallDefensePower)}`
                    });
                    
                    // ä¸­å¤®çªç ´ã«ã‚ˆã‚‹é˜²å¾¡ç„¡è¦–ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å…ˆã«é©ç”¨ï¼ˆå…µãŒã„ãªã„å ´åˆï¼‰
                    if (centralBreakthroughDamage > 0 && battleLog.result.troopDamage === 0) {
                        const previousWalls = target.walls;
                        target.walls = Math.max(0, target.walls - centralBreakthroughDamage);
                        
                        battleLog.result.wallDamage = centralBreakthroughDamage;
                        battleLog.events.push({
                            type: 'victory',
                            message: `ä¸­å¤®çªç ´ã«ã‚ˆã‚Šé˜²å¾¡ç„¡è¦–ã§åŸå£ã«${centralBreakthroughDamage}ã®çµ¶å¯¾ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`
                        });
                        
                        battleLog.events.push({
                            type: 'damage',
                            message: `${target.name}ã®åŸå£: ${previousWalls} â†’ ${target.walls}`
                        });
                        
                        if (target.walls <= 0) {
                            // ä¸­å¤®çªç ´ã§åŸå£ç ´å£Šå®Œäº†ã®å ´åˆã¯å¾Œã®å‡¦ç†ã¸
                        }
                    }
                    
                    // é€šå¸¸ã®æ”»åŸæˆ¦ï¼ˆåŸå£ãŒã¾ã æ®‹ã£ã¦ã„ã‚‹å ´åˆï¼‰
                    if (target.walls > 0) {
                        // æ”»åŸæˆ¦ã§ã®å¼·è¥²åˆ¤å®š
                        let siegeAttackerAssaultBonus = 0;
                        let siegeDefenderAssaultBonus = 0;
                        
                        // æ”»æ’ƒå´å¼·è¥²åˆ¤å®šï¼ˆæ”»åŸæˆ¦ï¼‰
                        for (let i = 0; i < 3; i++) { // æœ€å¤§3å›ã¾ã§åˆ¤å®š
                            const assault = checkAssaultAttack('attacker', 'siege');
                            if (assault > 0) {
                                siegeAttackerAssaultBonus += assault;
                            } else {
                                break; // å¤±æ•—ã—ãŸã‚‰çµ‚äº†
                            }
                        }
                        
                        // é˜²å¾¡å´å¼·è¥²åˆ¤å®šï¼ˆæ”»åŸæˆ¦ï¼‰
                        for (let i = 0; i < 3; i++) { // æœ€å¤§3å›ã¾ã§åˆ¤å®š
                            const assault = checkAssaultAttack('defender', 'siege');
                            if (assault > 0) {
                                siegeDefenderAssaultBonus += assault;
                            } else {
                                break; // å¤±æ•—ã—ãŸã‚‰çµ‚äº†
                            }
                        }
                        
                        // å¼·è¥²ãƒœãƒ¼ãƒŠã‚¹ã‚’é©ç”¨ã—ãŸæ”»åŸæˆ¦ï¼ˆæ”»æ’ƒåŠ›å¼·åŒ–ï¼‰
                        const adjustedSiegeAttack = finalAttackPower + siegeAttackerAssaultBonus + 12; // +12è¿½åŠ ãƒœãƒ¼ãƒŠã‚¹
                        const adjustedWallDefense = wallDefensePower + siegeDefenderAssaultBonus;
                        
                        if (adjustedSiegeAttack > adjustedWallDefense) {
                            const wallDamage = Math.floor((adjustedSiegeAttack - adjustedWallDefense) * (Math.random() * 0.4 + 0.3));
                            const previousWalls = target.walls;
                            target.walls = Math.max(0, target.walls - wallDamage);
                            
                            battleLog.result.wallDamage += wallDamage; // ä¸­å¤®çªç ´ãƒ€ãƒ¡ãƒ¼ã‚¸ã«è¿½åŠ 
                            battleLog.events.push({
                                type: 'damage',
                                message: `æ”»åŸå…µå™¨ãŒåŸå£ã«ã•ã‚‰ã«${wallDamage}ã®æå‚·ã‚’ä¸ãˆãŸ`
                            });
                            
                            battleLog.events.push({
                                type: 'damage',
                                message: `${target.name}ã®åŸå£: ${previousWalls} â†’ ${target.walls}`
                            });
                        } else {
                            battleLog.events.push({
                                type: 'defense',
                                message: `åŸå£ãŒå …å›ºã™ãã¦é€šå¸¸ã®æ”»åŸå…µå™¨ã§ã¯ç ´å£Šã§ããªã‹ã£ãŸ`
                            });
                        }
                    }
                    
                    // åŸå£ãŒå®Œå…¨ã«ç ´å£Šã•ã‚ŒãŸå ´åˆã®å‡¦ç†
                    if (target.walls <= 0) {
                        // åŸå£ç ´å£Šã§é ˜åœŸé™¥è½
                        const previousOwner = target.owner ? 
                            this.gameState.daimyos.find(d => d.id === target.owner)?.name || 'ä¸æ˜å‹¢åŠ›' : 
                            'ç©ºç™½åœ°';
                        
                        target.owner = this.gameState.playerDaimyo;
                        target.troops = Math.floor(attackPower / 5); // æ–°ãŸãªå®ˆå‚™å…µé…ç½®
                        target.walls = 100; // å¥ªå–ç›´å¾Œã¯100ã‚¹ã‚¿ãƒ¼ãƒˆ
                        
                        // æ–°é ˜åœŸã«å¤§åã®å¾—æ„å…µç§‘ã‚’è¨­å®š
                        const playerDaimyo = this.gameState.getPlayerDaimyoData();
                        if (playerDaimyo && playerDaimyo.preferredUnit) {
                            target.unitType = playerDaimyo.preferredUnit;
                        } else {
                            target.unitType = 'infantry'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ­©å…µ
                        }
                        
                        battleLog.result.conquered = true;
                        battleLog.result.victory = true;
                        
                        battleLog.events.push({
                            type: 'victory',
                            message: `åŸå£ãŒå®Œå…¨ã«å´©å£Šï¼${target.name}ãŒé™¥è½ã—ãŸï¼`
                        });
                        
                        if (previousOwner !== 'ç©ºç™½åœ°') {
                            battleLog.events.push({
                                type: 'victory',
                                message: `${previousOwner}ã®æ”¯é…ã‹ã‚‰${target.name}ã‚’å¥ªå–ï¼æ–°ãŸãªå®ˆå‚™å…µ${target.troops}ã‚’é…ç½®`
                            });
                        } else {
                            battleLog.events.push({
                                type: 'victory',
                                message: `${target.name}ã‚’æ–°é ˜åœŸã¨ã—ã¦ç¢ºä¿ï¼æ–°ãŸãªå®ˆå‚™å…µ${target.troops}ã‚’é…ç½®`
                            });
                        }
                        
                        // ä¸€èˆ¬ãƒ­ã‚°ã«ã‚‚è¿½åŠ ï¼ˆæ­¦å°†ã®æ´»èºã‚’ç°¡æ½”ã«è¡¨ç¤ºï¼‰
                        let conquestLog = `${target.name}æ”»ç•¥æˆåŠŸï¼`;
                        if (surpriseAttackActivated && surpriseAttackLeader) {
                            conquestLog += ` ${surpriseAttackLeader.name}ã®å¥‡è¥²æ”»æ’ƒãŒæ±ºå®šæ‰“ã«ï¼`;
                        }
                        if (centralBreakthroughDamage > 0 && centralBreakthroughActivator) {
                            conquestLog += ` ${centralBreakthroughActivator.name}ã®ä¸­å¤®çªç ´ã§æ•µé™£ã‚’ç²‰ç •ï¼`;
                        }
                        if (playerCasualties > 0) {
                            conquestLog += ` (æˆ‘è»æå®³: ${playerCasualties})`;
                        }
                        this.gameState.addLog(conquestLog, 'battle');
                        
                        // æ´»èºã—ãŸæ­¦å°†ã‚’å…·ä½“çš„ã«ãƒ­ã‚°è¡¨ç¤º
                        try {
                            if (battleLog.generalActivities && battleLog.generalActivities.length > 0) {
                                const attackerActivities = battleLog.generalActivities.filter(activity => 
                                    activity && activity.name && (!activity.side || activity.side === 'attacker')
                                );
                                
                                if (attackerActivities.length > 0) {
                                    const topContributors = attackerActivities
                                        .sort((a, b) => (b.contribution || 0) - (a.contribution || 0))
                                        .slice(0, 3); // ä¸Šä½3åã¾ã§
                                    
                                    const contributorNames = topContributors
                                        .filter(g => g && g.name)
                                        .map(g => g.name);
                                    
                                    if (contributorNames.length > 0) {
                                        let contributionMessage = '';
                                        if (contributorNames.length === 1) {
                                            contributionMessage = `${contributorNames[0]}ãŒå¥®æˆ¦`;
                                        } else if (contributorNames.length === 2) {
                                            contributionMessage = `${contributorNames.join('ã€')}ãŒå¥®æˆ¦`;
                                        } else {
                                            contributionMessage = `${contributorNames.join('ã€')}ã‚‰ãŒå¥®æˆ¦`;
                                        }
                                        this.gameState.addLog(contributionMessage, 'battle');
                                    }
                                }
                            }
                        } catch (error) {
                            console.warn('æ­¦å°†æ´»èºãƒ­ã‚°ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º
                            if (battleLog.generalActivities && battleLog.generalActivities.length > 0) {
                                const attackerCount = battleLog.generalActivities.filter(activity => 
                                    activity && (!activity.side || activity.side === 'attacker')
                                ).length;
                                if (attackerCount > 0) {
                                    this.gameState.addLog(`é…ä¸‹æ­¦å°†${attackerCount}åãŒå¥®æˆ¦`, 'battle');
                                }
                            }
                        }
                        
                        // ç‰¹æŠ€ç™ºå‹•ã‚’å…·ä½“çš„ã«ãƒ­ã‚°è¡¨ç¤º
                        try {
                            const activatedSkills = battleLog.skillActivations.filter(s => s && s.activated && s.name && s.skill);
                            if (activatedSkills.length > 0) {
                                const attackerSkills = activatedSkills.filter(s => s.side === 'attacker' || !s.side);
                                const defenderSkills = activatedSkills.filter(s => s.side === 'defender');
                                
                                if (attackerSkills.length === 1 && defenderSkills.length === 0) {
                                    this.gameState.addLog(`${attackerSkills[0].name}ã®ã€Œ${attackerSkills[0].skill}ã€ãŒç™ºå‹•`, 'battle');
                                } else if (defenderSkills.length === 1 && attackerSkills.length === 0) {
                                    this.gameState.addLog(`æ•µ${defenderSkills[0].name}ã®ã€Œ${defenderSkills[0].skill}ã€ãŒç™ºå‹•`, 'battle');
                                } else if (attackerSkills.length > 0 && defenderSkills.length > 0) {
                                    this.gameState.addLog(`ä¸¡è»ç‰¹æŠ€${attackerSkills.length + defenderSkills.length}å€‹ãŒç™ºå‹•ã—æ¿€æˆ¦ã«`, 'battle');
                                } else if (attackerSkills.length > 0) {
                                    if (attackerSkills.length === 1) {
                                        this.gameState.addLog(`${attackerSkills[0].name}ã®ã€Œ${attackerSkills[0].skill}ã€ãŒç™ºå‹•`, 'battle');
                                    } else {
                                        this.gameState.addLog(`ç‰¹æŠ€${attackerSkills.length}å€‹ãŒç™ºå‹•ã—æˆ¦æ³ãŒæœ‰åˆ©ã«`, 'battle');
                                    }
                                } else if (defenderSkills.length > 0) {
                                    if (defenderSkills.length === 1) {
                                        this.gameState.addLog(`æ•µ${defenderSkills[0].name}ã®ã€Œ${defenderSkills[0].skill}ã€ãŒç™ºå‹•`, 'battle');
                                    } else {
                                        this.gameState.addLog(`æ•µç‰¹æŠ€${defenderSkills.length}å€‹ãŒç™ºå‹•ã—å®ˆã‚Šã‚’å›ºã‚ã‚‹`, 'battle');
                                    }
                                }
                            }
                        } catch (error) {
                            console.warn('ç‰¹æŠ€ãƒ­ã‚°ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º
                            try {
                                const activatedSkills = battleLog.skillActivations.filter(s => s && s.activated);
                                if (activatedSkills.length > 0) {
                                    const attackerSkillCount = activatedSkills.filter(s => s.side === 'attacker' || !s.side).length;
                                    const defenderSkillCount = activatedSkills.filter(s => s.side === 'defender').length;
                                    
                                    if (attackerSkillCount > 0 && defenderSkillCount > 0) {
                                        this.gameState.addLog(`ä¸¡è»ç‰¹æŠ€${attackerSkillCount + defenderSkillCount}å€‹ãŒç™ºå‹•ã—æ¿€æˆ¦ã«`, 'battle');
                                    } else if (attackerSkillCount > 0) {
                                        this.gameState.addLog(`ç‰¹æŠ€${attackerSkillCount}å€‹ãŒç™ºå‹•ã—æˆ¦æ³ãŒæœ‰åˆ©ã«`, 'battle');
                                    }
                                }
                            } catch (fallbackError) {
                                console.warn('ç‰¹æŠ€ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼:', fallbackError);
                            }
                        }
                        
                        // ä¸­å¤®çªç ´ã‚’ã‚¿ãƒ¼ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã«è¿½åŠ 
                        if (centralBreakthroughActivator) {
                            this.gameState.turnEvents.push({
                                type: 'battle',
                                message: `${centralBreakthroughActivator.name}ã®ä¸­å¤®çªç ´ã«ã‚ˆã‚Š${target.name}ã‚’é›»æ’ƒæ”»ç•¥ï¼`
                            });
                        }
                    } else {
                        battleLog.events.push({
                            type: 'defense',
                            message: `åŸå£ã«æå‚·ã‚’ä¸ãˆãŸãŒã€ã¾ã å …å›ºãªå®ˆã‚Šã‚’ä¿ã£ã¦ã„ã‚‹`
                        });
                    }
                }
                
                // æˆ¦é—˜ãƒ­ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                this.displayBattleLog(battleLog);
                
                // æˆ¦é—˜çµæœã®çµ±åˆãƒ­ã‚°è¡¨ç¤ºï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
                if (!battleLog.result.conquered && (battleLog.result.troopDamage > 0 || battleLog.result.wallDamage > 0)) {
                    // éƒ¨åˆ†çš„æˆåŠŸã®å ´åˆã¯ã“ã“ã§ã¾ã¨ã‚ã¦ãƒ­ã‚°è¡¨ç¤º
                    let partialSuccessLog = `${target.name}ã«æå®³ã‚’ä¸ãˆãŸ`;
                    if (surpriseAttackActivated && surpriseAttackLeader) {
                        partialSuccessLog += ` (${surpriseAttackLeader.name}ã®å¥‡è¥²ãŒåŠ¹æœçš„)`;
                    }
                    if (centralBreakthroughDamage > 0 && centralBreakthroughActivator) {
                        partialSuccessLog += ` (${centralBreakthroughActivator.name}ã®ä¸­å¤®çªç ´ã§å¤§æ‰“æ’ƒ)`;
                    }
                    if (playerCasualties > 0) {
                        partialSuccessLog += ` (æˆ‘è»æå®³: ${playerCasualties})`;
                    }
                    this.gameState.addLog(partialSuccessLog, 'battle');
                    
                    // ä¸­å¤®çªç ´ã‚’ã‚¿ãƒ¼ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã«è¿½åŠ ï¼ˆéƒ¨åˆ†çš„æˆåŠŸæ™‚ï¼‰
                    if (centralBreakthroughActivator) {
                        this.gameState.turnEvents.push({
                            type: 'battle',
                            message: `${centralBreakthroughActivator.name}ã®ä¸­å¤®çªç ´ã«ã‚ˆã‚Š${target.name}ã«å¤§æ‰“æ’ƒï¼`
                        });
                    }
                    
                    // æ­¦å°†æ´»èºãƒ­ã‚°ï¼ˆéƒ¨åˆ†çš„æˆåŠŸæ™‚ï¼‰
                    try {
                        if (battleLog.generalActivities && battleLog.generalActivities.length > 0) {
                            const attackerActivities = battleLog.generalActivities.filter(activity => 
                                activity && activity.name && (!activity.side || activity.side === 'attacker')
                            );
                            
                            if (attackerActivities.length > 0) {
                                const topContributors = attackerActivities
                                    .sort((a, b) => (b.contribution || 0) - (a.contribution || 0))
                                    .slice(0, 2); // ä¸Šä½2åã¾ã§
                                
                                const contributorNames = topContributors
                                    .filter(g => g && g.name)
                                    .map(g => g.name);
                                
                                if (contributorNames.length > 0) {
                                    let contributionMessage = '';
                                    if (contributorNames.length === 1) {
                                        contributionMessage = `${contributorNames[0]}ãŒæ´»èº`;
                                    } else {
                                        contributionMessage = `${contributorNames.join('ã€')}ãŒæ´»èº`;
                                    }
                                    this.gameState.addLog(contributionMessage, 'battle');
                                }
                            }
                        }
                    } catch (error) {
                        console.warn('éƒ¨åˆ†çš„æˆåŠŸæ™‚ã®æ­¦å°†ãƒ­ã‚°ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                    }
                    
                    // ç‰¹æŠ€ç™ºå‹•ã®ç°¡æ½”ãªãƒ­ã‚°ï¼ˆéƒ¨åˆ†çš„æˆåŠŸæ™‚ï¼‰
                    try {
                        const activatedSkills = battleLog.skillActivations.filter(s => s && s.activated);
                        if (activatedSkills.length > 0) {
                            const attackerSkills = activatedSkills.filter(s => s.side === 'attacker' || !s.side);
                            const defenderSkills = activatedSkills.filter(s => s.side === 'defender');
                            
                            if (attackerSkills.length > 0 && defenderSkills.length > 0) {
                                this.gameState.addLog(`ä¸¡è»ç‰¹æŠ€${attackerSkills.length + defenderSkills.length}å€‹ãŒç™ºå‹•ã—æ¿€æˆ¦ã«`, 'battle');
                            } else if (attackerSkills.length === 1 && defenderSkills.length === 0) {
                                if (attackerSkills[0].name && attackerSkills[0].skill) {
                                    this.gameState.addLog(`${attackerSkills[0].name}ã®ã€Œ${attackerSkills[0].skill}ã€ãŒç™ºå‹•`, 'battle');
                                } else {
                                    this.gameState.addLog(`ç‰¹æŠ€${attackerSkills.length}å€‹ãŒç™ºå‹•`, 'battle');
                                }
                            } else if (attackerSkills.length > 1) {
                                this.gameState.addLog(`ç‰¹æŠ€${attackerSkills.length}å€‹ãŒç™ºå‹•`, 'battle');
                            } else if (defenderSkills.length === 1) {
                                if (defenderSkills[0].name && defenderSkills[0].skill) {
                                    this.gameState.addLog(`æ•µ${defenderSkills[0].name}ã®ã€Œ${defenderSkills[0].skill}ã€ãŒç™ºå‹•ã—å®ˆã‚Šã‚’å›ºã‚ã‚‹`, 'battle');
                                } else {
                                    this.gameState.addLog(`æ•µç‰¹æŠ€${defenderSkills.length}å€‹ãŒç™ºå‹•ã—å®ˆã‚Šã‚’å›ºã‚ã‚‹`, 'battle');
                                }
                            } else if (defenderSkills.length > 1) {
                                this.gameState.addLog(`æ•µç‰¹æŠ€${defenderSkills.length}å€‹ãŒç™ºå‹•ã—å®ˆã‚Šã‚’å›ºã‚ã‚‹`, 'battle');
                            }
                        }
                    } catch (error) {
                        console.warn('éƒ¨åˆ†çš„æˆåŠŸæ™‚ã®ç‰¹æŠ€ãƒ­ã‚°ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                    }
                }
                
                this.gameState.attackUsed = true;
                
                // æˆ¦é—˜çµ‚äº†å¾Œã«é™£å½¢æƒ…å ±ã‚’ã‚¯ãƒªã‚¢
                this.gameState.currentBattle = null;
                this.gameState.selectedFormation = null;
                
                this.updateActionButtons();
                this.renderMap();
                this.updateStatus();
            }
            
            // é‰„å£é˜²å¾¡ãƒã‚§ãƒƒã‚¯ï¼ˆéš ã‚Œç‰¹æŠ€ï¼‰
            checkIronwallDefense(defenderGenerals, battleLog) {
                try {
                    const ironwallRates = {
                        'ç«‹èŠ±é“é›ª': 80,
                        'é•·é‡æ¥­æ­£': 70,
                        'åŒ—æ¡ç¶±æˆ': 65,
                        'é‹å³¶ç›´èŒ‚': 65,
                        'çœŸç”°å¹¸æ‘': 60,
                        'å±±ä¸­é¹¿ä¹‹ä»‹': 55,
                        'é«˜æ©‹ç´¹é‹': 45,
                        'é«˜å‚æ˜Œä¿¡': 45
                    };
                    
                    // é‰„å£æŒã¡ã®æ­¦å°†ã‚’ãƒã‚§ãƒƒã‚¯
                    const ironwallGenerals = defenderGenerals.filter(general => 
                        general && general.name && ironwallRates[general.name]
                    );
                    
                    if (ironwallGenerals.length === 0) {
                        return { activated: false, multiplier: 1.0 };
                    }
                    
                    let ironwallActivated = false;
                    let activatorName = '';
                    
                    // å„é‰„å£æ­¦å°†ã«ã¤ã„ã¦åˆ¤å®šï¼ˆæˆåŠŸç‡ã®é«˜ã„é †ï¼‰
                    ironwallGenerals.sort((a, b) => ironwallRates[b.name] - ironwallRates[a.name]);
                    
                    for (const general of ironwallGenerals) {
                        const rate = ironwallRates[general.name];
                        
                        // æº–å‚™ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆæˆåŠŸå¤±æ•—é–¢ä¿‚ãªãè¡¨ç¤ºï¼‰
                        battleLog.events.push({
                            type: 'defense',
                            message: `${general.name}ã¯é‰„å£ã®é™£ã‚’æ•·ã“ã†ã¨ã—ã¦ã„ã‚‹...`
                        });
                        
                        // ç™ºå‹•åˆ¤å®š
                        if (Math.random() * 100 <= rate) {
                            ironwallActivated = true;
                            activatorName = general.name;
                            
                            // æˆåŠŸæ™‚ã®æ´¾æ‰‹ãªã‚³ãƒ¡ãƒ³ãƒˆ
                            const ironwallMessages = {
                                'ç«‹èŠ±é“é›ª': `ã€é‰„å£ç™ºå‹•ã€‘é›·ç¥ç«‹èŠ±é“é›ªãŒå®Œç’§ãªé‰„å£é™£å½¢ã‚’æ§‹ç¯‰ï¼ç¥é›·ã®å¦‚ãå®ˆå‚™ã§æ•µã®æ”»æ’ƒã‚’å®Œå…¨ã«å°æ®ºï¼`,
                                'é•·é‡æ¥­æ­£': `ã€é‰„å£ç™ºå‹•ã€‘ä¸Šé‡ã®é»„æ–‘é•·é‡æ¥­æ­£ãŒç®•è¼ªåŸã®é‰„å£æˆ¦è¡“ã‚’å±•é–‹ï¼é–¢æ±éšä¸€ã®å®ˆå‚™ã§æ•µã®çŒ›æ”»ã‚’å®Œå…¨ã«å°ã˜è¾¼ã‚ã‚‹ï¼`,
                                'åŒ—æ¡ç¶±æˆ': `ã€é‰„å£ç™ºå‹•ã€‘åœ°é»„å…«å¹¡åŒ—æ¡ç¶±æˆãŒé‰„å£ã®é™£ã‚’æ•·ãï¼é»„é‡‘ã®é‡‡é…æ——ã®ã‚‚ã¨ã€æ•µè»ã®æ”»æ’ƒã‚’å®Œå…¨ã«ç²‰ç •ï¼`,
                                'é‹å³¶ç›´èŒ‚': `ã€é‰„å£ç™ºå‹•ã€‘è‚¥å‰ã®æ™ºå°†é‹å³¶ç›´èŒ‚ãŒåŒ–ã‘çŒ«ã®å¦‚ãç¥é€Ÿã®é‡‡é…ã§é‰„å£ã®å®ˆã‚Šã‚’å®Œæˆï¼æ•µè»ã®æ”»æ’ƒãŒéœ§æ•£ã—ãŸï¼`,
                                'çœŸç”°å¹¸æ‘': `ã€é‰„å£ç™ºå‹•ã€‘æ—¥æœ¬ä¸€ã®å…µçœŸç”°å¹¸æ‘ãŒçœŸç”°ä¸¸ã®è¦å¡ã§é‰„å£ã®é˜²å¾¡ï¼èµ¤å‚™ãˆã®ç²¾é‹­ãŒæ•µè»ã®æ”»æ’ƒã‚’å®Œå…¨ã«å°æ®ºï¼`,
                                'å±±ä¸­é¹¿ä¹‹ä»‹': `ã€é‰„å£ç™ºå‹•ã€‘å±±ä¸­é¹¿ä¹‹ä»‹ãŒä¸ƒé›£å…«è‹¦ã‚’ä¹—ã‚Šè¶ŠãˆãŸä¸å±ˆã®ç²¾ç¥ã§é‰„å£ã®å®ˆã‚Šã‚’æ§‹ç¯‰ï¼ä¸‰æ—¥æœˆã®åŠ è­·ã«ã‚ˆã‚Šæ”»æ’ƒã‚’ç„¡åŠ¹åŒ–ï¼`,
                                'é«˜æ©‹ç´¹é‹': `ã€é‰„å£ç™ºå‹•ã€‘å¿ è‡£é«˜æ©‹ç´¹é‹ãŒä¸»å›ã¸ã®å¿ ç¾©ã‚’è¾¼ã‚ã¦é‰„å£ã®å®ˆå‚™ã‚’å±•é–‹ï¼ãã®æ„å¿—ã¯å²©ã‚’ã‚‚ç •ãï¼`,
                                'é«˜å‚æ˜Œä¿¡': `ã€é‰„å£ç™ºå‹•ã€‘é€ƒã’å¼¾æ­£é«˜å‚æ˜Œä¿¡ãŒå·§å¦™ãªæˆ¦è¡“ã§æ”»æ’ƒã‚’å®Œå…¨ã«å°ã˜è¾¼ã‚ã‚‹ï¼ãã®å®ˆå‚™æˆ¦è¡“ã¯èŠ¸è¡“ã®åŸŸï¼`
                            };
                            
                            battleLog.events.push({
                                type: 'victory',
                                message: ironwallMessages[general.name] || `ã€é‰„å£ç™ºå‹•ã€‘${general.name}ã®é‰„å£ã®é™£ã«ã‚ˆã‚Šæ•µã®æ”»æ’ƒã‚’åŠæ¸›ï¼`
                            });
                            
                            break; // ä¸€äººãŒæˆåŠŸã—ãŸã‚‰çµ‚äº†
                        }
                    }
                    
                    return {
                        activated: ironwallActivated,
                        multiplier: ironwallActivated ? 0.5 : 1.0,
                        activator: activatorName
                    };
                } catch (error) {
                    console.warn('é‰„å£é˜²å¾¡ãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                    return { activated: false, multiplier: 1.0 };
                }
            }
            
            checkSkillActivation(general, roleKey, target) {
                try {
                    // å®‰å…¨ãªåˆæœŸå€¤è¨­å®š
                    const skillData = {
                        activated: false,
                        name: general?.name || 'ç„¡åæ­¦å°†',
                        skill: general?.skill || 'ç‰¹æŠ€ãªã—',
                        description: '',
                        bonus: 0
                    };
                    
                    // å…¥åŠ›å€¤ã®å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯
                    if (!general || !general.stats) {
                        return skillData;
                    }
                    
                    // ç‰¹æŠ€ãªã—ã®å ´åˆã¯ç™ºå‹•ã—ãªã„
                    if (!general.skill || general.skill === 'ç‰¹æŠ€ãªã—' || general.skill === '') {
                        return skillData;
                    }
                    
                    // ç™ºå‹•ç‡ã‚’ä½ã‚ã«è¨­å®šï¼ˆ5-25%ã®ç¯„å›²ï¼‰
                    // è»å¸«ç³»ç‰¹æŠ€ã¯çŸ¥è¬€ãƒ™ãƒ¼ã‚¹ã€ãã®ä»–ã¯æˆ¦é—˜ãƒ™ãƒ¼ã‚¹
                    let baseStat;
                    if (general.skill === 'åé¢åŸ‹ä¼ã®è¨ˆ' || general.skill === 'å¤©æ‰è»å¸«' || general.skill === 'è»å¸«ã®æ‰') {
                        baseStat = Math.max(0, Math.min(100, general.stats.intelligence || 50));
                    } else {
                        baseStat = Math.max(0, Math.min(100, general.stats.battle || 50));
                    }
                    const baseChance = Math.min(25, Math.max(5, baseStat / 4));
                    const roll = Math.random() * 100;
                    
                    // ç™ºå‹•åˆ¤å®š
                    if (roll > baseChance) {
                        return skillData; // ç™ºå‹•ã—ãªã„
                    }
                    
                    // ç‰¹æŠ€åˆ¥ã®åŠ¹æœ
                    skillData.activated = true;
                    
                    switch (general.skill) {
                        case 'é©æ–°è€…':
                            skillData.description = 'é‰„ç ²éšŠã‚’æŒ‡æ®ã—ã¦æ•µé™£ã‚’ç ´ç •ï¼å®ˆå‚™æ™‚ã¯é‰„ç ²å…µç§‘ã§åæ’ƒåŠ›1.3-1.4å€ï¼';
                            skillData.bonus = 15;
                            break;
                        case 'é¢¨æ—ç«å±±':
                            skillData.description = 'é¨é¦¬éšŠãŒç–¾é¢¨ã®ã”ã¨ãæ•µè»ã‚’çªç ´ï¼é¨é¦¬å…µç§‘æ™‚ã¯å¿…ãšé¨é¦¬çªæ’ƒç™ºå‹•ï¼';
                            skillData.bonus = 20;
                            break;
                        case 'è»ç¥':
                            skillData.description = 'ç¥ãŒã‹ã‚Šã®é‡‡é…ã§æˆ¦æ³ã‚’ä¸€å¤‰ï¼ã•ã‚‰ã«å…¨è»ã®å¼·è¥²å¨åŠ›ãŒ1.5å€ã€æ•µã®å®ˆå‚™åŠ›ã‚’åŠæ¸›ã•ã›ã‚‹ï¼';
                            skillData.bonus = 25;
                            break;
                        case 'å¿è€':
                            skillData.description = 'å …å®Ÿãªæˆ¦è¡“ã§æ•µã®æ”»æ’ƒã‚’ç„¡åŠ¹åŒ–ï¼';
                            skillData.bonus = 12;
                            break;
                        case 'é–¢æ±åˆ¶è¦‡':
                            skillData.description = 'åŸæ”»ã‚ã®çµŒé¨“ãŒå¨åŠ›ã‚’ç™ºæ®ï¼';
                            skillData.bonus = 18;
                            break;
                        case 'è¬€å°†':
                            skillData.description = 'å·§å¦™ãªç­–ç•¥ã§æ•µè»ã‚’æ··ä¹±ã•ã›ãŸï¼';
                            skillData.bonus = 16;
                            break;
                        case 'å—è›®è²¿æ˜“':
                            skillData.description = 'è¥¿æ´‹ã®æ­¦å™¨æŠ€è¡“ãŒæˆ¦å ´ã§è¼ãï¼';
                            skillData.bonus = 14;
                            break;
                        case 'è–©æ‘©éš¼äºº':
                            skillData.description = 'å¥‡è¥²æ”»æ’ƒã§æ•µã®è™šã‚’çªã„ãŸï¼';
                            skillData.bonus = 17;
                            break;
                        case 'ç‹¬çœ¼ç«œ':
                            skillData.description = 'é¨é¦¬é‰„ç ²éšŠã®çªæ’ƒæº–å‚™ï¼';
                            skillData.bonus = 10;
                            break;
                        case 'è¬€å':
                            skillData.description = 'è£åˆ‡ã‚Šã®ç­–ç•¥ã§æ•µå†…éƒ¨ã‚’åˆ†è£‚ï¼';
                            skillData.bonus = 13;
                            break;
                        case 'é¬¼æŸ´ç”°':
                            skillData.description = 'é¬¼ç¥ã®ã”ã¨ãæ­¦å‹‡ã§æ•µé™£ã‚’è¹‚èº™ï¼';
                            skillData.bonus = 22;
                            break;
                        case 'äººãŸã‚‰ã—':
                            skillData.description = 'äººå¿ƒæŒæ¡ã§æ•µå…µã‚’å‘³æ–¹ã«å¼•ãè¾¼ã‚€ï¼';
                            skillData.bonus = 15;
                            break;
                        case 'å½±æ­¦è€…':
                            skillData.description = 'å½±æ­¦è€…ã®è¡“ã§æ•µè»ã‚’æ’¹ä¹±ï¼';
                            skillData.bonus = 14;
                            break;
                        case 'èµ¤å‚™ãˆ':
                            skillData.description = 'èµ¤ã„è»è£…ã®ç²¾é‹­éšŠãŒæ•µã‚’åœ§å€’ï¼';
                            skillData.bonus = 20;
                            break;
                        case 'ä¸æ­»èº«':
                            skillData.description = 'ä¸æ­»èº«ã®æ­¦å‹‡ã§æ•µé™£ã‚’é§†ã‘æŠœã‘ã‚‹ï¼';
                            skillData.bonus = 18;
                            break;
                        case 'æ„›ã®å­—':
                            skillData.description = 'ç¾©æ„›ã®ç²¾ç¥ã§å…¨è»ã‚’é¼“èˆï¼';
                            skillData.bonus = 17;
                            break;
                        case 'å…ˆé™£':
                            skillData.description = 'å¸¸ã«å…ˆé™£ã‚’åˆ‡ã£ã¦æ•µè»ã«çªæ’ƒï¼';
                            skillData.bonus = 16;
                            break;
                        case 'ç„¡å‚·':
                            skillData.description = 'å®Œç’§ãªé˜²å¾¡ã§ä¸€åˆ‡ã®å‚·ã‚’è² ã‚ãšçªé€²ï¼';
                            skillData.bonus = 18;
                            break;
                        case 'å®¿è€':
                            skillData.description = 'è€ç·´ãªçµŒé¨“ã§æˆ¦æ³ã‚’è¦‹æ¥µã‚ã‚‹ï¼';
                            skillData.bonus = 15;
                            break;
                        case 'èª¿æ•´':
                            skillData.description = 'çµ¶å¦™ãªé€£æºã§è»å›£ã®åŠ›ã‚’æœ€å¤§åŒ–ï¼';
                            skillData.bonus = 14;
                            break;
                        case 'ç¶™æ‰¿è€…':
                            skillData.description = 'åé–€ã®èª‡ã‚Šã§å£«æ°—ã‚’é«˜ã‚ã‚‹ï¼';
                            skillData.bonus = 13;
                            break;
                        case 'å†…æ”¿':
                            skillData.description = 'å†…æ”¿ã®æ‰‹è…•ã§è£œçµ¦ã‚’å®Œç’§ã«ï¼';
                            skillData.bonus = 12;
                            break;
                        case 'ä¸¡å·':
                            skillData.description = 'ä¸¡å·ã®é€£æºã§æ•µè»ã‚’æŒŸæ’ƒï¼';
                            skillData.bonus = 19;
                            break;
                        case 'å‹‡çŒ›':
                            skillData.description = 'å‹‡çŒ›æœæ•¢ã«æ•µé™£ã‚’çªç ´ï¼';
                            skillData.bonus = 17;
                            break;
                        case 'é›·ç¥':
                            skillData.description = 'é›·é³´ã®ã‚ˆã†ãªè½Ÿãã§æ•µè»ã‚’éœ‡æ’¼ï¼';
                            skillData.bonus = 21;
                            break;
                        case 'å¿ è‡£':
                            skillData.description = 'å¿ ç¾©ã®å¿ƒã§ä¸»å›ã®ãŸã‚ã«å¥®æˆ¦ï¼';
                            skillData.bonus = 16;
                            break;
                        case 'é¬¼å³¶æ´¥':
                            skillData.description = 'é¬¼å³¶æ´¥ã®åã«æ¥ã˜ã¬çŒ›æ”»ï¼';
                            skillData.bonus = 23;
                            break;
                        case 'æ™ºå°†':
                            skillData.description = 'çŸ¥ç•¥ã‚’é§†ä½¿ã—ã¦æ•µã®éš™ã‚’çªãï¼';
                            skillData.bonus = 15;
                            break;
                        case 'è»å¸«':
                            skillData.description = 'è»å¸«ã¨ã—ã¦ã®ç­–ç•¥ãŒåŠŸã‚’å¥ã™ï¼';
                            skillData.bonus = 18;
                            break;
                        case 'å‹‡å°†':
                            skillData.description = 'å‹‡çŒ›ãªæ­¦å°†ã¨ã—ã¦å‰ç·šã‚’é§†ã‘ã‚‹ï¼';
                            skillData.bonus = 16;
                            break;
                        case 'äºŒåˆ€æµ':
                            skillData.description = 'äºŒåˆ€æµã®æ¥µæ„ã§æ•µã‚’åœ§å€’ï¼å·¦å³ã®åˆ€ãŒæ•µå°†ã‚’åˆ‡ã‚Šè£‚ãï¼';
                            skillData.bonus = 32;
                            break;
                        case 'éš»çœ¼ã®å‰£å£«':
                            skillData.description = 'éš»çœ¼ãªãŒã‚‰ç¥æŠ€ã®å‰£ã§æ•µã‚’åœ§å€’ï¼';
                            skillData.bonus = 24;
                            break;
                        case 'æ§ã®é”äºº':
                            skillData.description = 'æ§è¡“ã®é”äººã¨ã—ã¦æ•µè»ã‚’è²«ãï¼';
                            skillData.bonus = 18;
                            break;
                        case 'åé¢åŸ‹ä¼ã®è¨ˆ':
                            skillData.description = 'åŠå…µè¡›ã®ç­–ç•¥ã«ã‚ˆã‚Šæ”»æ’ƒè»ãŒæ··ä¹±ï¼æ•µã®åŠ›ã‚’é€†ã«åˆ©ç”¨ã™ã‚‹ï¼';
                            skillData.bonus = 15;
                            skillData.debuff = 0.6; // æ•µæ”»æ’ƒåŠ›ã‚’40%å‰Šæ¸›
                            break;
                        case 'è»å¸«ã®æ‰':
                            skillData.description = 'è»å¸«ã®æ‰èƒ½ã§å®Œç’§ãªä½œæˆ¦ã‚’ç«‹æ¡ˆï¼';
                            skillData.bonus = 22;
                            break;
                        case 'æ—¥æœ¬ä¸€ã®å…µ':
                            skillData.description = 'æ—¥æœ¬ä¸€ã®å…µã¨ã—ã¦æ­¦åã‚’è½Ÿã‹ã™ï¼';
                            skillData.bonus = 28;
                            break;
                        case 'å‚¾å¥‡è€…':
                            skillData.description = 'å‚¾å¥‡è€…ã®å¥‡æŠœãªæˆ¦æ³•ã§æ•µã‚’æ’¹ä¹±ï¼';
                            skillData.bonus = 20;
                            break;
                        case 'ç¯‰åŸåäºº':
                            skillData.description = 'ç¯‰åŸã®çŸ¥è­˜ã§æ”»åŸæˆ¦ã‚’æœ‰åˆ©ã«ï¼';
                            skillData.bonus = 17;
                            break;
                        case 'çŒ›å°†':
                            skillData.description = 'çŒ›å°†ã¨ã—ã¦æ•µé™£ã‚’ç¸¦æ¨ªç„¡å°½ã«é§†ã‘ã‚‹ï¼';
                            skillData.bonus = 19;
                            break;
                        case 'é»’æ¯è¡£è¡†':
                            skillData.description = 'é»’æ¯è¡£è¡†ã®ç²¾é‹­ã¨ã—ã¦æˆ¦å ´ã‚’åˆ¶åœ§ï¼';
                            skillData.bonus = 21;
                            break;
                        case 'ç±³äº”éƒå·¦':
                            skillData.description = 'ç¹”ç”°å®¶ç­†é ­å®¶è€ã¨ã—ã¦è»å‹¢ã‚’å®Œç’§ã«çµ±ç‡ï¼';
                            skillData.bonus = 18;
                            break;
                        case 'é–¢æ±ç®¡é ˜':
                            skillData.description = 'é–¢æ±ã®åœ°ã®åˆ©ã‚’æ´»ã‹ã—ãŸæˆ¦è¡“ã§æ•µã‚’æ’¹ä¹±ï¼';
                            skillData.bonus = 16;
                            break;
                        case 'æ§ã®åˆå·¦':
                            skillData.description = 'æ§è¡“ã®åæ‰‹ã¨ã—ã¦æ•µé™£ã‚’çªç ´ï¼';
                            skillData.bonus = 19;
                            break;
                        case 'å°å§“é ­':
                            skillData.description = 'ä¸»å›ã¸ã®å¿ ç¾©ã§å…¨è»ã®å£«æ°—ã‚’é«˜ã‚ã‚‹ï¼';
                            skillData.bonus = 15;
                            break;
                        case 'ä¹³å…„å¼Ÿ':
                            skillData.description = 'ä¿¡é•·ã¨ã®çµ†ã§çµæŸåŠ›ã‚’æœ€å¤§åŒ–ï¼';
                            skillData.bonus = 17;
                            break;
                        case 'å¹½æ–':
                            skillData.description = 'æ–‡æ­¦ä¸¡é“ã®æ•™é¤Šã§æˆ¦è¡“ã‚’æ´—ç·´ï¼';
                            skillData.bonus = 20;
                            break;
                        case 'èœ‚é ˆè³€å°å…­':
                            skillData.description = 'é‡æ­¦å£«ä¸ŠãŒã‚Šã®å¥‡ç­–ã§æ•µã‚’ç¿»å¼„ï¼';
                            skillData.bonus = 16;
                            break;
                        case 'æ­¦ç”°å››å¤©ç‹':
                            skillData.description = 'æ­¦ç”°å››å¤©ç‹ã®ä¸€è§’ã¨ã—ã¦é‰„å£ã®å®ˆã‚Šã‚’æŠ«éœ²ï¼';
                            skillData.bonus = 18;
                            break;
                        case 'é€ƒã’å¼¾æ­£':
                            skillData.description = 'å·§ã¿ãªé€€å´æˆ¦è¡“ã§æ•µã®åŒ…å›²ã‚’çªç ´ï¼';
                            skillData.bonus = 22;
                            break;
                        case 'è¡¨è£æ¯”èˆˆ':
                            skillData.description = 'ç‹¡çŒ¾ãªç­–ç•¥ã§æ•µè»å†…éƒ¨ã‚’åˆ†è£‚ã•ã›å¤§æ··ä¹±ã«é™¥ã‚Œã‚‹ï¼';
                            skillData.bonus = 32;
                            break;
                        case 'å…„å¼Ÿã®çµ†':
                            skillData.description = 'å…„å¼Ÿã®çµæŸã§è»å›£ã®é€£æºã‚’å¼·åŒ–ï¼';
                            skillData.bonus = 16;
                            break;
                        case 'éƒ¡å†…é ˜ä¸»':
                            skillData.description = 'åœ°å…ƒã®åœ°ç†ã‚’æ´»ã‹ã—ãŸæˆ¦è¡“ã§æœ‰åˆ©ã«å±•é–‹ï¼';
                            skillData.bonus = 14;
                            break;
                        case 'æ­¦ç”°é‡è‡£':
                            skillData.description = 'æ­¦ç”°å®¶é‡è‡£ã¨ã—ã¦ã®å¨å³ã§æ•µã‚’åœ§å€’ï¼';
                            skillData.bonus = 17;
                            break;
                        case 'ç„¡è¨€':
                            skillData.description = 'å¯¡é»™ãªãŒã‚‰åœ§å€’çš„ãªå­˜åœ¨æ„Ÿã§æ•µã‚’å¨åœ§ï¼';
                            skillData.bonus = 19;
                            break;
                        case 'è‰²éƒ¨å‹¢':
                            skillData.description = 'è‰²éƒ¨å‹¢ã®ç²¾é‹­ãŒæ•µé™£ã‚’è¹‚èº™ï¼';
                            skillData.bonus = 17;
                            break;
                        case 'æœ¬åº„å‹¢':
                            skillData.description = 'æœ¬åº„å‹¢ã®å‹‡çŒ›ã•ã§æ•µè»ã‚’éœ‡æ’¼ã•ã›ã‚‹ï¼';
                            skillData.bonus = 18;
                            break;
                        case 'ä¸‹è¶Šå®ˆè­·':
                            skillData.description = 'ä¸‹è¶Šã®çµ±æ²»çµŒé¨“ã§è»ç•¥ã‚’åŠ¹ç‡åŒ–ï¼';
                            skillData.bonus = 16;
                            break;
                        case 'æ–°ç™ºç”°å‹¢':
                            skillData.description = 'æ–°ç™ºç”°å‹¢ã®æ©Ÿå‹•åŠ›ã§æ•µã®å´é¢ã‚’çªãï¼';
                            skillData.bonus = 17;
                            break;
                        case 'ä¿¡æ¿ƒæ­¦å£«':
                            skillData.description = 'ä¿¡æ¿ƒæ­¦å£«ã®èª‡ã‚Šã§æ±ºæ­»ã®æ”»æ’ƒã‚’æ•¢è¡Œï¼';
                            skillData.bonus = 20;
                            break;
                        case 'å¾³å·å››å¤©ç‹':
                            skillData.description = 'å¾³å·å››å¤©ç‹ã¨ã—ã¦ä¸»å›ã‚’å®ˆã‚ŠæŠœãï¼';
                            skillData.bonus = 21;
                            break;
                        case 'èµ¤é¬¼':
                            skillData.description = 'èµ¤é¬¼ã®ç•°åé€šã‚Šé¬¼ç¥ã®ã”ã¨ãçªæ’ƒï¼';
                            skillData.bonus = 23;
                            break;
                        case 'çŸ¥æµä¼Šè±†':
                            skillData.description = 'çŸ¥æµä¼Šè±†ã®ç•°åã§å®Œç’§ãªä½œæˆ¦ã‚’ç«‹æ¡ˆï¼';
                            skillData.bonus = 24;
                            break;
                        case 'ä¸‰æ²³æ­¦å£«':
                            skillData.description = 'ä¸‰æ²³æ­¦å£«ã®å¿ ç¾©ã¨å‹‡çŒ›ã•ã§æ•µã‚’åœ§å€’ï¼';
                            skillData.bonus = 18;
                            break;
                        case 'å¾³å·è­œä»£':
                            skillData.description = 'å¾³å·è­œä»£ã®èª‡ã‚Šã§ä¸»å›ã®ãŸã‚ã«å¥®æˆ¦ï¼';
                            skillData.bonus = 17;
                            break;
                        case 'ä¼è¦‹åŸ':
                            skillData.description = 'ä¼è¦‹åŸã®æˆ¦ã„ã§ç¤ºã—ãŸå¿ ç¾©ã§å£«æ°—å‘ä¸Šï¼';
                            skillData.bonus = 22;
                            break;
                        case 'å¿è€…é ­':
                            skillData.description = 'å¿è¡“ã‚’é§†ä½¿ã—ã¦æ•µé™£ã«æ··ä¹±ã‚’å¼•ãèµ·ã“ã™ï¼';
                            skillData.bonus = 20;
                            break;
                        case 'è‹¥æ®¿':
                            skillData.description = 'è‹¥ãå½“ä¸»ã¨ã—ã¦å…¨è»ã‚’é¼“èˆï¼';
                            skillData.bonus = 15;
                            break;
                        case 'é–¢æ±ã®é¬¼':
                            skillData.description = 'é–¢æ±ã®é¬¼ã®ç•°åã§æ•µè»ã‚’ææ€–ã«é™¥ã‚Œã‚‹ï¼';
                            skillData.bonus = 21;
                            break;
                        case 'å¿åŸä¸»':
                            skillData.description = 'å¿åŸã®æµ®åŸæˆ¦è¡“ã§æ•µã®æ”»æ’ƒã‚’ç„¡åŠ¹åŒ–ï¼';
                            skillData.bonus = 19;
                            break;
                        case 'æ±Ÿæˆ¸åŸä¸»':
                            skillData.description = 'æ±Ÿæˆ¸åŸã®è¦å¡æˆ¦è¡“ã§é‰„å£ã®å®ˆã‚Šã‚’å±•é–‹ï¼';
                            skillData.bonus = 18;
                            break;
                        case 'åŒ—æ¡é‡è‡£':
                            skillData.description = 'åŒ—æ¡å®¶é‡è‡£ã¨ã—ã¦çµ±åˆ¶ã®å–ã‚ŒãŸæ”»æ’ƒï¼';
                            skillData.bonus = 16;
                            break;
                        case 'å¤–äº¤åƒ§':
                            skillData.description = 'å¤–äº¤åƒ§ã¨ã—ã¦æ•µè»ã«å‹•æºã‚’ä¸ãˆã‚‹ï¼';
                            skillData.bonus = 18;
                            break;
                        case 'æ¯›åˆ©é‡è‡£':
                            skillData.description = 'æ¯›åˆ©å®¶é‡è‡£ã¨ã—ã¦å¨å³ã‚ã‚‹æŒ‡æ®ï¼';
                            skillData.bonus = 17;
                            break;
                        case 'çŸ³è¦‹å®ˆè­·':
                            skillData.description = 'çŸ³è¦‹ã®å±±å²³æˆ¦è¡“ã§æ•µã‚’ç¿»å¼„ï¼';
                            skillData.bonus = 18;
                            break;
                        case 'æ¡‚å‹¢':
                            skillData.description = 'æ¡‚å‹¢ã®æ©Ÿå‹•åŠ›ã§æ•µã®éš™ã‚’çªãï¼';
                            skillData.bonus = 16;
                            break;
                        case 'å±±é™°é“':
                            skillData.description = 'å±±é™°é“ã®åœ°ã®åˆ©ã‚’æ´»ã‹ã—ãŸæˆ¦è¡“ï¼';
                            skillData.bonus = 17;
                            break;
                        case 'å¤§å‹é‡è‡£':
                            skillData.description = 'å¤§å‹å®¶é‡è‡£ã¨ã—ã¦ä¹å·æ­¦å£«ã®æ„åœ°ã‚’è¦‹ã›ã‚‹ï¼';
                            skillData.bonus = 17;
                            break;
                        case 'è±Šå¾Œå‹¢':
                            skillData.description = 'è±Šå¾Œå‹¢ã®çµæŸã§æ•µè»ã‚’åœ§å€’ï¼';
                            skillData.bonus = 18;
                            break;
                        case 'è‚¥å¾Œè¡†':
                            skillData.description = 'è‚¥å¾Œè¡†ã®é‡æ€§çš„ãªæˆ¦ã„ã§æ•µã‚’è¹‚èº™ï¼';
                            skillData.bonus = 19;
                            break;
                        case 'è±Šå¾Œä¸‰è€':
                            skillData.description = 'è±Šå¾Œä¸‰è€ã¨ã—ã¦è€ç·´ãªæˆ¦è¡“ã‚’é§†ä½¿ï¼';
                            skillData.bonus = 20;
                            break;
                        case 'è¥¿å›½ç„¡åŒ':
                            skillData.description = 'è¥¿å›½ç„¡åŒã®æ­¦å‹‡ã§æ•µé™£ã‚’è¹‚èº™ï¼';
                            skillData.bonus = 25;
                            break;
                        case 'æˆ¸æ¬¡å‹¢':
                            skillData.description = 'æˆ¸æ¬¡å‹¢ã®ç²¾å¼·ã•ã§æ•µé™£ã‚’çªç ´ï¼';
                            skillData.bonus = 19;
                            break;
                        case 'è‹¥æ­¦è€…':
                            skillData.description = 'è‹¥æ­¦è€…ã‚‰ã—ã„å‹‡çŒ›ãªçªæ’ƒã§æ•µã‚’åœ§å€’ï¼';
                            skillData.bonus = 20;
                            break;
                        case 'è–©æ‘©å‹¢':
                            skillData.description = 'è–©æ‘©å‹¢ã®çŒ›æ”»ã§æ•µè»ã‚’è¹‚èº™ï¼';
                            skillData.bonus = 19;
                            break;
                        case 'å³¶æ´¥é‡è‡£':
                            skillData.description = 'å³¶æ´¥å®¶é‡è‡£ã¨ã—ã¦è–©æ‘©æ­¦å£«ã‚’çµ±ç‡ï¼';
                            skillData.bonus = 18;
                            break;
                        case 'æ¨ºå±±å‹¢':
                            skillData.description = 'æ¨ºå±±å‹¢ã®å‹‡çŒ›ã•ã§æ•µé™£ã‚’é§†ã‘æŠœã‘ã‚‹ï¼';
                            skillData.bonus = 17;
                            break;
                        case 'ä¼Šé”é‡è‡£':
                            skillData.description = 'ä¼Šé”å®¶é‡è‡£ã¨ã—ã¦å¥¥å·æ­¦å£«ã‚’æŒ‡æ®ï¼';
                            skillData.bonus = 17;
                            break;
                        case 'æ§å¥‰è¡Œ':
                            skillData.description = 'æ§å¥‰è¡Œã¨ã—ã¦æ§è¡¾æˆ¦è¡“ã§æ•µã‚’è¿æ’ƒï¼';
                            skillData.bonus = 18;
                            break;
                        case 'ç™½çŸ³å‹¢':
                            skillData.description = 'ç™½çŸ³å‹¢ã®æ©Ÿå‹•åŠ›ã§æ•µã®å´é¢ã‚’çªãï¼';
                            skillData.bonus = 16;
                            break;
                        case 'é¬¼åº­å‹¢':
                            skillData.description = 'é¬¼åº­å‹¢ã®é¬¼ç¥ã®ã‚ˆã†ãªçªæ’ƒï¼';
                            skillData.bonus = 19;
                            break;
                        case 'å±±å½¢åŸä¸»':
                            skillData.description = 'å±±å½¢ã®åœ°ã®åˆ©ã‚’æ´»ã‹ã—ãŸæˆ¦è¡“ï¼';
                            skillData.bonus = 16;
                            break;
                        case 'å•„æœ¨é³¥æˆ¦æ³•':
                            skillData.description = 'å•„æœ¨é³¥æˆ¦æ³•ã§æ•µè»ã‚’åˆ†æ–­ã—å„å€‹æ’ƒç ´ï¼';
                            skillData.bonus = 30;
                            break;
                        case 'æ­¦ç”°å®¿è€':
                            skillData.description = 'æ­¦ç”°å®¶ã®å®¿è€ã¨ã—ã¦é‡åšãªæŒ‡æ®ï¼';
                            skillData.bonus = 20;
                            break;
                        case 'èµ¤å‚™ãˆã®ç¥–':
                            skillData.description = 'èµ¤å‚™ãˆã®å‰µå§‹è€…ã¨ã—ã¦éƒ¨éšŠã‚’é¼“èˆï¼';
                            skillData.bonus = 25;
                            break;
                        case 'å¿è¡“ã®æ¥µæ„':
                            skillData.description = 'å¿è¡“ã®æ¥µæ„ã§æ•µé™£ã«æ½œå…¥ã—æ··ä¹±ã‚’å¼•ãèµ·ã“ã™ï¼';
                            skillData.bonus = 28;
                            break;
                        case 'éœ§éš ã‚Œ':
                            skillData.description = 'éœ§ã«ç´›ã‚Œã¦ç¥å‡ºé¬¼æ²¡ã®æ”»æ’ƒã‚’ä»•æ›ã‘ã‚‹ï¼';
                            skillData.bonus = 26;
                            break;
                        case 'åå‹‡å£«':
                            skillData.description = 'çœŸç”°åå‹‡å£«ã®ä¸€å“¡ã¨ã—ã¦ç‰¹æ®Šä»»å‹™ã‚’é‚è¡Œï¼';
                            skillData.bonus = 22;
                            break;
                        case 'ä¸Šæ‰é‡è‡£':
                            skillData.description = 'ä¸Šæ‰å®¶é‡è‡£ã¨ã—ã¦è»å‹¢ã‚’çµ±ç‡ï¼';
                            skillData.bonus = 18;
                            break;
                        case 'é¬¼å°å³¶':
                            skillData.description = 'é¬¼å°å³¶ã®ç•°åã§æ•µè»ã‚’éœ‡æ’¼ã•ã›ã‚‹ï¼';
                            skillData.bonus = 24;
                            break;
                        case 'æ”»ã‚å¼¾æ­£':
                            skillData.description = 'æ”»ã‚å¼¾æ­£ã®ç•°åã§æ•µåŸã‚’æ”»ç•¥ï¼';
                            skillData.bonus = 26;
                            break;
                        case 'å‰¯å°†':
                            skillData.description = 'ä¿¡ç„å…¬ã®å‰¯å°†ã¨ã—ã¦å…¨è»ã‚’å®Œç’§ã«çµ±ç‡ï¼';
                            skillData.bonus = 24;
                            break;
                        case 'è«è¨ªå‹é ¼':
                            skillData.description = 'è«è¨ªã®è¡€ã‚’å¼•ãè‹¥ãå½“ä¸»ã¨ã—ã¦å¥®æˆ¦ï¼';
                            skillData.bonus = 20;
                            break;
                        case 'åœ°é»„å…«å¹¡':
                            skillData.description = 'åœ°é»„å…«å¹¡ã®æ——å°ã§æ•µè»ã‚’åœ§å€’ï¼';
                            skillData.bonus = 25;
                            break;
                        case 'å¿ ç¾©ã®å£«':
                            skillData.description = 'å¿ ç¾©ã®å¿ƒã§ä¸»å›ã®ãŸã‚ã«å‘½ã‚’æ§ã’ã‚‹ï¼';
                            skillData.bonus = 20;
                            break;
                        case 'è‹¥ãå‹‡å°†':
                            skillData.description = 'è‹¥ãå‹‡å°†ã¨ã—ã¦æœæ•¢ã«æ•µé™£ã«çªæ’ƒï¼';
                            skillData.bonus = 19;
                            break;
                        case 'æ¸¡è¾ºã®æ§':
                            skillData.description = 'æ¸¡è¾ºä¸€å…šä¼çµ±ã®æ§è¡“ã§æ•µé™£ã‚’çªç ´ï¼';
                            skillData.bonus = 20;
                            break;

                        case 'å¤§å’Œå¤§ç´è¨€':
                            skillData.description = 'å¤§å’Œå¤§ç´è¨€ã¨ã—ã¦å®Œç’§ãªè»æ”¿ã‚’å±•é–‹ï¼';
                            skillData.bonus = 22;
                            break;
                        case 'äº”å¥‰è¡Œ':
                            skillData.description = 'äº”å¥‰è¡Œã®è¡Œæ”¿æ‰‹è…•ã§è»ã®çµ„ç¹”åŠ›ã‚’å¼·åŒ–ï¼';
                            skillData.bonus = 18;
                            break;
                        case 'è±Šè‡£å®¶è‡£':
                            skillData.description = 'è±Šè‡£å®¶è‡£ã¨ã—ã¦ä¸»å›ã¸ã®å¿ ç¾©ã‚’ç¤ºã™ï¼';
                            skillData.bonus = 16;
                            break;
                        case 'è‚¥å‰ã®ç†Š':
                            skillData.description = 'è‚¥å‰ã®ç†Šã®ç•°åã§ä¹å·ã‚’éœ‡æ’¼ã•ã›ã‚‹ï¼';
                            skillData.bonus = 28;
                            break;
                        case 'é¾é€ å¯ºä¸€æ—':
                            skillData.description = 'é¾é€ å¯ºä¸€æ—ã®çµæŸã§æ•µè»ã‚’åœ§å€’ï¼';
                            skillData.bonus = 20;
                            break;
                        case 'è‚¥å‰å‹¢':
                            skillData.description = 'è‚¥å‰æ­¦å£«ã®æ„åœ°ã§å‹‡çŒ›ã«æˆ¦ã†ï¼';
                            skillData.bonus = 18;
                            break;
                        case 'ä¸ƒé›£å…«è‹¦':
                            skillData.description = 'ä¸ƒé›£å…«è‹¦ã‚’ä¹—ã‚Šè¶ŠãˆãŸä¸å±ˆã®ç²¾ç¥ã§æ•µã‚’åœ§å€’ï¼';
                            skillData.bonus = 25;
                            break;
                        case 'ä»Šå·è»å¸«':
                            skillData.description = 'ä»Šå·å®¶è»å¸«ã¨ã—ã¦åŸ¹ã£ãŸå®Œç’§ãªæˆ¦è¡“ã‚’å±•é–‹ï¼';
                            skillData.bonus = 28;
                            break;
                        case 'åŒ–ã‘çŒ«é¨’å‹•':
                            skillData.description = 'è‚¥å‰ã®æ™ºè¬€ã§æ•µè»ã‚’å¹»æƒ‘ã™ã‚‹ï¼';
                            skillData.bonus = 22;
                            break;
                        case 'ä¸€ä¹—è°·ã®é¬¼':
                            skillData.description = 'ä¸€ä¹—è°·ã®é¬¼ç¥ã¨ã—ã¦æ•µè»ã‚’è¹‚èº™ï¼';
                            skillData.bonus = 26;
                            break;
                        case 'ä¸Šé‡ã®é»„æ–‘':
                            skillData.description = 'é–¢æ±éšä¸€ã®æ­¦å‹‡ã§æ•µå°†ã‚’è¨ã¡å–ã‚‹ï¼';
                            skillData.bonus = 24;
                            break;
                        case 'ä¸Šæ‰åŸ·æ”¿':
                            skillData.description = 'ä¸Šæ‰å®¶åŸ·æ”¿ã¨ã—ã¦ã®çµ±æ²»æ‰‹è…•ã§è»ã®çµ„ç¹”åŠ›ã‚’å¼·åŒ–ï¼';
                            skillData.bonus = 18;
                            break;
                        case 'ä¸¹æ³¢ã®èµ¤é¬¼':
                            skillData.description = 'ä¸¹æ³¢ã®èµ¤é¬¼ã¨ã—ã¦ææ€–ã‚’ä¸ãˆã‚‹ï¼';
                            skillData.bonus = 25;
                            break;
                        case 'æ¢Ÿé›„':
                            skillData.description = 'æ¢Ÿé›„ã®ç­–ç•¥ã§æ•µè»ã‚’ç¿»å¼„ã™ã‚‹ï¼';
                            skillData.bonus = 27;
                            break;
                        case 'ä¼šæ´¥ã®éº’éºŸå…':
                            skillData.description = 'éº’éºŸå…ã®ç•°åã«æ¥ã˜ã¬å®Œç’§ãªæŒ‡æ®ï¼';
                            skillData.bonus = 26;
                            break;
                        case 'é‰„ç ²å¤§å°†':
                            skillData.description = 'é›‘è³€è¡†ã®é‰„ç ²æˆ¦è¡“ã§æ•µé™£ã‚’åˆ¶åœ§ï¼';
                            skillData.bonus = 29;
                            break;
                        case 'é¬¼å·¦è¿‘':
                            skillData.description = 'é¬¼å·¦è¿‘ã®ç•°åã§æ•µå°†ã‚’ä¸€é¨è¨ã¡ã§æ’ƒç ´ï¼';
                            skillData.bonus = 27;
                            break;
                        case 'ç™½é ­å·¾':
                            skillData.description = 'ç™½é ­å·¾ã«éš ã•ã‚ŒãŸæ™ºè¬€ã§æˆ¦æ³ã‚’ä¸€å¤‰ï¼';
                            skillData.bonus = 25;
                            break;
                        case 'è¡Œæ”¿ã®é¬¼':
                            skillData.description = 'å®Œç’§ãªå…µç«™ã§ç¶™æˆ¦èƒ½åŠ›ã‚’å‘ä¸Šï¼';
                            skillData.bonus = 13;
                            break;
                        default:
                            // æ±ç”¨ç‰¹æŠ€åŠ¹æœï¼ˆæœªå®šç¾©ã®ç‰¹æŠ€ç”¨ï¼‰
                            skillData.description = `ã€Œ${general.skill}ã€ã®æŠ€ãŒå†´ãˆæ¸¡ã‚‹ï¼`;
                            skillData.bonus = Math.floor(Math.random() * 8) + 10; // 10-17ã®ãƒ©ãƒ³ãƒ€ãƒ 
                            break;
                    }
                    
                    return skillData;
                    
                } catch (error) {
                    console.warn(`ç‰¹æŠ€ç™ºå‹•ãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼ (${general?.name || 'ä¸æ˜'}):`, error);
                    return {
                        activated: false,
                        name: general?.name || 'ä¸æ˜',
                        skill: general?.skill || 'ç‰¹æŠ€ãªã—',
                        description: '',
                        bonus: 0
                    };
                }
            }
            
            checkNewGeneralAppearance() {
                try {
                    // æ–°æµªäººç™»å ´ã‚·ã‚¹ãƒ†ãƒ ï¼ˆè»½é‡ç‰ˆï¼‰
                    const roll = Math.random() * 100;
                    
                    let newGeneral = null;
                    let isRare = false;
                    
                    if (roll <= 3) {
                        // 3%ã®ç¢ºç‡ã§ãƒ¬ã‚¢æµªäººç™»å ´
                        const availableRare = this.gameState.rareRonin.filter(ronin => 
                            !this.gameState.availableGenerals.some(g => g.id === ronin.id) &&
                            !this.gameState.generals.some(g => g.id === ronin.id)
                        );
                        
                        if (availableRare.length > 0) {
                            newGeneral = availableRare[Math.floor(Math.random() * availableRare.length)];
                            isRare = true;
                        }
                    } else if (roll <= 50) {
                        // 50%ã®ç¢ºç‡ã§é€šå¸¸æµªäººç™»å ´
                        const availableNormal = this.gameState.normalRonin.filter(ronin => 
                            !this.gameState.availableGenerals.some(g => g.id === ronin.id) &&
                            !this.gameState.generals.some(g => g.id === ronin.id)
                        );
                        
                        if (availableNormal.length > 0) {
                            newGeneral = availableNormal[Math.floor(Math.random() * availableNormal.length)];
                        }
                    }
                    
                    if (newGeneral) {
                        const roninWithTurn = { ...newGeneral, appearanceTurn: this.gameState.turn };
                        this.gameState.availableGenerals.push(roninWithTurn);
                        
                        let appearanceMessage = '';
                        if (isRare) {
                            appearanceMessage = `â­ã€åå°†ç™»å ´ã€‘${newGeneral.name}ãŒä¸–ã«ç¾ã‚ŒãŸï¼`;
                        } else {
                            appearanceMessage = `æ–°ãŸãªæ­¦å°†ã€Œ${newGeneral.name}ã€ãŒä»•å®˜ã‚’å¸Œæœ›ã—ã¦ã„ã‚‹`;
                        }
                        
                        this.gameState.addLog(appearanceMessage, 'diplomacy');
                        this.gameState.addPersonnelLog(appearanceMessage);
                    }
                    
                } catch (error) {
                    console.warn('æ–°æ­¦å°†ç™»å ´å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ:', error);
                }
            }
            
            checkDaimyoExtinction() {
                try {
                    if (!this.gameState.daimyos || !this.gameState.territories || !this.gameState.generals) {
                        return;
                    }
                    
                    // æ»…äº¡ã—ãŸå¤§åã‚’è¨˜éŒ²ã™ã‚‹é…åˆ—
                    const extinctDaimyos = [];
                    
                    // å„å¤§åã®é ˜åœŸæ•°ã‚’ãƒã‚§ãƒƒã‚¯
                    this.gameState.daimyos.forEach(daimyo => {
                        try {
                            if (!daimyo || !daimyo.id || daimyo.id === this.gameState.playerDaimyo) {
                                return; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯é™¤å¤–
                            }
                            
                            const ownedTerritories = this.gameState.territories.filter(t => 
                                t && t.owner === daimyo.id
                            );
                            
                            // é ˜åœŸã‚’å…¨ã¦å¤±ã£ãŸå ´åˆ
                            if (ownedTerritories.length === 0) {
                                this.convertGeneralsToRonin(daimyo.id, daimyo.name);
                                extinctDaimyos.push(daimyo.id);
                            }
                        } catch (error) {
                            console.warn(`å¤§å${daimyo?.name || 'ä¸æ˜'}ã®æ»…äº¡ãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼:`, error);
                        }
                    });
                    
                    // æ»…äº¡ã—ãŸå¤§åã‚’é…åˆ—ã‹ã‚‰å®Œå…¨ã«å‰Šé™¤
                    if (extinctDaimyos.length > 0) {
                        this.gameState.daimyos = this.gameState.daimyos.filter(d => 
                            !extinctDaimyos.includes(d.id)
                        );
                    }
                } catch (error) {
                    console.warn('å¤§åå®¶æ»…äº¡ãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ:', error);
                }
            }
            
            convertGeneralsToRonin(daimyoId, daimyoName) {
                try {
                    // æ»…äº¡ã—ãŸå¤§åã®æ­¦å°†ã‚’å–å¾—
                    const extinctGenerals = this.gameState.generals.filter(g => 
                        g && g.lord === daimyoId
                    );
                    
                    if (extinctGenerals.length === 0) {
                        return;
                    }
                    
                    let roninCount = 0;
                    
                    // å„æ­¦å°†ã‚’æµªäººã«å¤‰æ›
                    extinctGenerals.forEach(general => {
                        try {
                            if (!general || !general.name) return;
                            
                            // æµªäººã¨ã—ã¦è¿½åŠ ï¼ˆæ—¢å­˜ã®æµªäººå½¢å¼ã«åˆã‚ã›ã‚‹ï¼‰
                            const roninGeneral = {
                                id: `ronin_${general.id}_${Date.now()}`, // é‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚æ–°ã—ã„ID
                                name: general.name,
                                stats: { ...general.stats },
                                skill: general.skill || 'ç‰¹æŠ€ãªã—',
                                recruitCost: 100,
                                baseCharm: Math.max(50, (general.stats?.charm || 50) - 10) // å°‘ã—å³ã—ã
                            };
                            
                            roninGeneral.appearanceTurn = this.gameState.turn;
                            this.gameState.availableGenerals.push(roninGeneral);
                            roninCount++;
                            
                        } catch (error) {
                            console.warn(`æ­¦å°†${general?.name || 'ä¸æ˜'}ã®æµªäººå¤‰æ›ä¸­ã«ã‚¨ãƒ©ãƒ¼:`, error);
                        }
                    });
                    
                    // å…ƒã®æ­¦å°†ã‚’å‰Šé™¤
                    this.gameState.generals = this.gameState.generals.filter(g => 
                        !g || g.lord !== daimyoId
                    );
                    
                    // AIå½¹è·è¨­å®šã‚‚å‰Šé™¤
                    if (this.gameState.aiRoles && this.gameState.aiRoles[daimyoId]) {
                        delete this.gameState.aiRoles[daimyoId];
                    }
                    
                    // å±±åŸæ”¯é…ãƒ»å¾å¤·å¤§å°†è»çŠ¶æ³ã‚‚ã‚¯ãƒªã‚¢
                    if (this.gameState.yamashiroControl && this.gameState.yamashiroControl[daimyoId]) {
                        this.gameState.yamashiroControl[daimyoId] = 0;
                    }
                    if (this.gameState.tenkaninStatus && this.gameState.tenkaninStatus[daimyoId]) {
                        this.gameState.tenkaninStatus[daimyoId] = false;
                    }
                    
                    // æ»…äº¡ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨˜éŒ²
                    this.gameState.turnEvents.push({
                        type: 'diplomacy',
                        message: `ğŸ’€${daimyoName}ãŒæ»…äº¡ï¼é…ä¸‹æ­¦å°†${roninCount}åãŒæµªäººã¨ãªã£ãŸ`
                    });
                    
                    if (roninCount > 0) {
                        this.gameState.addLog(`${daimyoName}æ»…äº¡ã«ã‚ˆã‚Š${roninCount}åã®æ­¦å°†ãŒæµªäººã¨ã—ã¦ç™»ç”¨å¯èƒ½ã«`, 'diplomacy');
                        this.gameState.addPersonnelLog(`${daimyoName}å®¶æ»…äº¡ã«ã‚ˆã‚Š${roninCount}åã®æ­¦å°†ãŒæµªäººã«`);
                    }
                    
                } catch (error) {
                    console.warn(`${daimyoName}ã®æ­¦å°†æµªäººåŒ–å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼:`, error);
                }
            }
            
            processAIPersonnel() {
                try {
                    // å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
                    if (!this.gameState.daimyos || !this.gameState.playerDaimyo) {
                        return;
                    }
                    
                    // AIå¤§åã®äººäº‹ç®¡ç†ã‚’å®Ÿè¡Œ
                    const aiDaimyos = this.gameState.daimyos.filter(d => d && d.id !== this.gameState.playerDaimyo);
                    
                    aiDaimyos.forEach(daimyo => {
                        try {
                            // æ­¦å°†ç™»ç”¨ãƒã‚§ãƒƒã‚¯
                            this.checkAIRecruitment(daimyo);
                            
                            // å½¹è·é©æ­£ãƒã‚§ãƒƒã‚¯
                            this.checkAIRoleOptimization(daimyo);
                            
                            // é ˜åœŸæ‹…å½“æ­¦å°†ã®è¦‹ç›´ã—
                            this.checkAITerritoryAssignments(daimyo);
                        } catch (error) {
                            console.warn(`AIå¤§å${daimyo.name}ã®äººäº‹å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼:`, error);
                        }
                    });
                } catch (error) {
                    console.warn('AIäººäº‹ç®¡ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ:', error);
                }
            }
            
            checkAIRecruitment(daimyo) {
                try {
                    // åŸºæœ¬çš„ãªå­˜åœ¨ãƒã‚§ãƒƒã‚¯
                    if (!daimyo || !this.gameState.turn || !this.gameState.generals || !this.gameState.availableGenerals) {
                        return;
                    }
                    
                    // 5ã‚¿ãƒ¼ãƒ³ã«1å›ã€ç™»ç”¨ã‚’æ¤œè¨
                    if (this.gameState.turn % 5 !== 0) return;
                    
                    // ç¾åœ¨ã®æ­¦å°†æ•°ã‚’ãƒã‚§ãƒƒã‚¯
                    const currentGenerals = this.gameState.generals.filter(g => g && g.lord === daimyo.id);
                    if (currentGenerals.length >= 8) return; // ä¸Šé™8äºº
                    
                    // è³‡é‡‘ãƒã‚§ãƒƒã‚¯
                    if (!daimyo.gold || daimyo.gold < 500) return;
                    
                    // ç™»ç”¨å¯èƒ½æ­¦å°†ã‹ã‚‰é¸æŠ
                    const availableGenerals = this.gameState.availableGenerals.filter(g => 
                        g && g.recruitCost && g.baseCharm && g.recruitCost <= daimyo.gold && 
                        g.baseCharm <= (daimyo.stats?.charm || 50) + 20
                    );
                    
                    if (availableGenerals.length > 0 && Math.random() < 0.4) {
                        // ã‚³ã‚¹ãƒˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®è‰¯ã„æ­¦å°†ã‚’é¸æŠ
                        const targetGeneral = availableGenerals.reduce((best, current) => {
                            const bestValue = this.calculateGeneralValue(best) / (best.recruitCost || 1);
                            const currentValue = this.calculateGeneralValue(current) / (current.recruitCost || 1);
                            return currentValue > bestValue ? current : best;
                        });
                        
                        if (!targetGeneral) return;
                        
                        // ç™»ç”¨å®Ÿè¡Œ
                        const daimyoCharm = daimyo.stats?.charm || 50;
                        const successChance = Math.min(80, Math.max(30, daimyoCharm - targetGeneral.baseCharm + 40));
                        
                        if (Math.random() * 100 <= successChance) {
                            const newGeneral = {
                                id: targetGeneral.id,
                                name: targetGeneral.name || 'ç„¡åæ­¦å°†',
                                lord: daimyo.id,
                                stats: { ...targetGeneral.stats } || { battle: 50, command: 50, politics: 50, intelligence: 50, charm: 50 },
                                skill: targetGeneral.skill || 'ç‰¹æŠ€ãªã—',
                                loyalty: Math.floor(Math.random() * 20) + 70 // 70-90ã®å¿ èª åº¦
                            };
                            
                            this.gameState.generals.push(newGeneral);
                            this.gameState.availableGenerals = this.gameState.availableGenerals.filter(g => g.id !== targetGeneral.id);
                            daimyo.gold -= targetGeneral.recruitCost;
                            
                            // äººäº‹ãƒ­ã‚°ã«è¨˜éŒ²
                            if (this.gameState.addPersonnelLog) {
                                this.gameState.addPersonnelLog(`${daimyo.name}ãŒ${targetGeneral.name}ã‚’ç™»ç”¨ï¼ˆå¿ èª åº¦${newGeneral.loyalty}ï¼‰`);
                            }
                            
                            // æ–°æ­¦å°†ã‚’é©åˆ‡ãªå½¹è·ã«é…ç½®
                            this.assignNewGeneralRole(daimyo.id, newGeneral.id);
                        }
                    }
                } catch (error) {
                    console.warn('AIç™»ç”¨å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            calculateGeneralValue(general) {
                try {
                    if (!general || !general.stats) return 0;
                    
                    const stats = general.stats;
                    return (stats.battle || 0) + (stats.command || 0) + 
                           (stats.politics || 0) + (stats.intelligence || 0) + (stats.charm || 0);
                } catch (error) {
                    console.warn('æ­¦å°†è©•ä¾¡å€¤è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                    return 0;
                }
            }
            
            checkAIRoleOptimization(daimyo) {
                try {
                    // åŸºæœ¬çš„ãªå­˜åœ¨ãƒã‚§ãƒƒã‚¯
                    if (!daimyo || !this.gameState.turn || !this.gameState.aiRoles) {
                        return;
                    }
                    
                    // 3ã‚¿ãƒ¼ãƒ³ã«1å›ã€å½¹è·ã‚’è¦‹ç›´ã—
                    if (this.gameState.turn % 3 !== 0) return;
                    
                    const aiRoles = this.gameState.aiRoles[daimyo.id];
                    if (!aiRoles) return;
                    
                    const daimyoGenerals = this.gameState.generals.filter(g => g && g.lord === daimyo.id);
                    if (daimyoGenerals.length === 0) return;
                    
                    // å„å½¹è·ã®é©æ­£åº¦ã‚’ãƒã‚§ãƒƒã‚¯
                    const roleOptimizations = [];
                    
                    Object.keys(aiRoles).forEach(roleKey => {
                        try {
                            const currentGeneralId = aiRoles[roleKey];
                            let currentScore = 0;
                            let bestGeneral = null;
                            let bestScore = 0;
                            
                            // ç¾åœ¨ã®æ­¦å°†ã®ã‚¹ã‚³ã‚¢
                            if (currentGeneralId) {
                                const currentGeneral = this.gameState.generals.find(g => g && g.id === currentGeneralId);
                                if (currentGeneral) {
                                    currentScore = this.gameState.calculateGeneralScore(currentGeneral, roleKey);
                                }
                            }
                            
                            // ã‚ˆã‚Šé©åˆ‡ãªæ­¦å°†ã‚’æ¢ã™
                            daimyoGenerals.forEach(general => {
                                if (!general) return;
                                
                                // ä»–ã®å½¹è·ã«ã¤ã„ã¦ã„ãªã„æ­¦å°†ã®ã¿
                                const isAssigned = Object.values(aiRoles).includes(general.id);
                                if (!isAssigned || general.id === currentGeneralId) {
                                    const score = this.gameState.calculateGeneralScore(general, roleKey);
                                    if (score > bestScore) {
                                        bestScore = score;
                                        bestGeneral = general;
                                    }
                                }
                            });
                            
                            // æ”¹å–„ãŒè¦‹è¾¼ã‚ã‚‹å ´åˆã®ã¿å¤‰æ›´
                            if (bestGeneral && bestScore > currentScore + 20) { // 20ãƒã‚¤ãƒ³ãƒˆä»¥ä¸Šã®æ”¹å–„ãŒã‚ã‚‹å ´åˆ
                                roleOptimizations.push({
                                    roleKey: roleKey,
                                    newGeneralId: bestGeneral.id,
                                    newGeneralName: bestGeneral.name || 'ç„¡åæ­¦å°†',
                                    improvement: bestScore - currentScore
                                });
                            }
                        } catch (error) {
                            console.warn(`å½¹è·${roleKey}ã®æœ€é©åŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼:`, error);
                        }
                    });
                    
                    // æœ€ã‚‚æ”¹å–„åŠ¹æœã®é«˜ã„1ã¤ã ã‘ã‚’å®Ÿè¡Œï¼ˆé »ç¹ãªå¤‰æ›´ã‚’é¿ã‘ã‚‹ï¼‰
                    if (roleOptimizations.length > 0) {
                        const bestOptimization = roleOptimizations.reduce((best, current) => 
                            current.improvement > best.improvement ? current : best
                        );
                        
                        const oldGeneralId = aiRoles[bestOptimization.roleKey];
                        const oldGeneralName = oldGeneralId ? 
                            this.gameState.generals.find(g => g && g.id === oldGeneralId)?.name || 'ä¸æ˜' : 'æœªè¨­å®š';
                        
                        // ä»–ã®å½¹è·ã‹ã‚‰æ–°æ­¦å°†ã‚’è§£é™¤
                        Object.keys(aiRoles).forEach(key => {
                            if (aiRoles[key] === bestOptimization.newGeneralId) {
                                aiRoles[key] = null;
                            }
                        });
                        
                        // æ–°ã—ã„å½¹è·ã«ä»»å‘½
                        aiRoles[bestOptimization.roleKey] = bestOptimization.newGeneralId;
                        
                        // äººäº‹ãƒ­ã‚°ã«è¨˜éŒ²
                        const roleNames = {
                            'strategist': 'è»å¸«', 'diplomat': 'å¤–äº¤æ‹…å½“', 'administrator': 'å†…æ”¿ç·ç›£',
                            'kenchiCommissioner': 'æ¤œåœ°å¥‰è¡Œ', 'riceCommissioner': 'ç±³å¥‰è¡Œ', 
                            'townCommissioner': 'ç”ºå¥‰è¡Œ', 'goldCommissioner': 'é‡‘å¥‰è¡Œ',
                            'constructionCommissioner': 'æ™®è«‹å¥‰è¡Œ', 'militaryCommissioner': 'å…µå¥‰è¡Œ',
                            'armyStrategist': 'å‚è¬€', 'vanguard': 'å‰è¡›', 'rightWing': 'å³ç¿¼',
                            'leftWing': 'å·¦ç¿¼', 'reserve': 'å¾Œè©°'
                        };
                        
                        const roleName = roleNames[bestOptimization.roleKey] || bestOptimization.roleKey;
                        
                        if (this.gameState.addPersonnelLog) {
                            this.gameState.addPersonnelLog(
                                `${daimyo.name}ãŒ${bestOptimization.newGeneralName}ã‚’${roleName}ã«ä»»å‘½ï¼ˆå‰ä»»ï¼š${oldGeneralName}ï¼‰`
                            );
                        }
                    }
                } catch (error) {
                    console.warn('AIå½¹è·æœ€é©åŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            assignNewGeneralRole(daimyoId, generalId) {
                try {
                    if (!this.gameState.aiRoles || !daimyoId || !generalId) return;
                    
                    const aiRoles = this.gameState.aiRoles[daimyoId];
                    if (!aiRoles) return;
                    
                    const general = this.gameState.generals.find(g => g && g.id === generalId);
                    if (!general) return;
                    
                    // ç©ºã„ã¦ã„ã‚‹å½¹è·ã«æœ€é©é…ç½®
                    const availableRoles = Object.keys(aiRoles).filter(key => !aiRoles[key]);
                    
                    if (availableRoles.length > 0) {
                        let bestRole = availableRoles[0];
                        let bestScore = this.gameState.calculateGeneralScore(general, bestRole);
                        
                        availableRoles.forEach(role => {
                            const score = this.gameState.calculateGeneralScore(general, role);
                            if (score > bestScore) {
                                bestScore = score;
                                bestRole = role;
                            }
                        });
                        
                        aiRoles[bestRole] = generalId;
                        
                        const roleNames = {
                            'strategist': 'è»å¸«', 'diplomat': 'å¤–äº¤æ‹…å½“', 'administrator': 'å†…æ”¿ç·ç›£',
                            'kenchiCommissioner': 'æ¤œåœ°å¥‰è¡Œ', 'riceCommissioner': 'ç±³å¥‰è¡Œ', 
                            'townCommissioner': 'ç”ºå¥‰è¡Œ', 'goldCommissioner': 'é‡‘å¥‰è¡Œ',
                            'constructionCommissioner': 'æ™®è«‹å¥‰è¡Œ', 'militaryCommissioner': 'å…µå¥‰è¡Œ',
                            'armyStrategist': 'è»å›£è»å¸«', 'vanguard': 'å‰è¡›', 'rightWing': 'å³ç¿¼',
                            'leftWing': 'å·¦ç¿¼', 'reserve': 'å¾Œè©°'
                        };
                        
                        const roleName = roleNames[bestRole] || bestRole;
                        
                        if (this.gameState.addPersonnelLog) {
                            this.gameState.addPersonnelLog(`${general.name}ã‚’${roleName}ã«é…ç½®`);
                        }
                    }
                } catch (error) {
                    console.warn('æ–°æ­¦å°†å½¹è·é…ç½®ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            checkAITerritoryAssignments(daimyo) {
                try {
                    // åŸºæœ¬çš„ãªå­˜åœ¨ãƒã‚§ãƒƒã‚¯
                    if (!daimyo || !this.gameState.turn || !this.gameState.territories || !this.gameState.generals) {
                        return;
                    }
                    
                    // 4ã‚¿ãƒ¼ãƒ³ã«1å›ã€é ˜åœŸæ‹…å½“ã‚’è¦‹ç›´ã—
                    if (this.gameState.turn % 4 !== 0) return;
                    
                    const daimyoTerritories = this.gameState.territories.filter(t => t && t.owner === daimyo.id);
                    const daimyoGenerals = this.gameState.generals.filter(g => g && g.lord === daimyo.id);
                    
                    if (daimyoTerritories.length === 0 || daimyoGenerals.length === 0) return;
                    
                    // å½¹è·ã«ã¤ã„ã¦ã„ãªã„æ­¦å°†ã‚’å–å¾—
                    const aiRoles = this.gameState.aiRoles[daimyo.id] || {};
                    const assignedToRoles = Object.values(aiRoles).filter(id => id !== null);
                    const availableGenerals = daimyoGenerals.filter(g => !assignedToRoles.includes(g.id));
                    
                    // æ‹…å½“è€…ãŒã„ãªã„ã€ã¾ãŸã¯ä¸é©åˆ‡ãªé ˜åœŸã‚’ç‰¹å®š
                    const needsReassignment = [];
                    
                    daimyoTerritories.forEach(territory => {
                        const currentGeneralId = territory.generalGarrison;
                        let shouldReassign = false;
                        
                        if (!currentGeneralId) {
                            // æ‹…å½“è€…ãŒã„ãªã„
                            shouldReassign = true;
                        } else {
                            const currentGeneral = this.gameState.generals.find(g => g && g.id === currentGeneralId);
                            if (!currentGeneral || currentGeneral.lord !== daimyo.id) {
                                // æ­¦å°†ãŒå­˜åœ¨ã—ãªã„ã‹ã€ä»–ã®å¤§åã®æ­¦å°†
                                shouldReassign = true;
                            } else if (assignedToRoles.includes(currentGeneralId)) {
                                // é‡è¦ãªå½¹è·ã«ã¤ã„ã¦ã„ã‚‹æ­¦å°†ã¯é ˜åœŸæ‹…å½“ã‹ã‚‰å¤–ã™
                                shouldReassign = true;
                            }
                        }
                        
                        if (shouldReassign) {
                            needsReassignment.push(territory);
                        }
                    });
                    
                    // æ”¿æ²»åŠ›ã®é«˜ã„é †ã«é…ç½®
                    if (needsReassignment.length > 0 && availableGenerals.length > 0) {
                        const sortedGenerals = availableGenerals.sort((a, b) => 
                            (b.stats?.politics || 0) - (a.stats?.politics || 0)
                        );
                        
                        needsReassignment.forEach((territory, index) => {
                            if (index < sortedGenerals.length && territory) {
                                const oldGeneralId = territory.generalGarrison;
                                const oldGeneralName = oldGeneralId ? 
                                    this.gameState.generals.find(g => g && g.id === oldGeneralId)?.name || 'ä¸æ˜' : 'æœªè¨­å®š';
                                
                                territory.generalGarrison = sortedGenerals[index].id;
                                
                                // äººäº‹ãƒ­ã‚°ã«è¨˜éŒ²
                                if (this.gameState.addPersonnelLog) {
                                    this.gameState.addPersonnelLog(
                                        `${daimyo.name}ãŒ${sortedGenerals[index].name}ã‚’${territory.name}æ‹…å½“ã«ä»»å‘½ï¼ˆå‰ä»»ï¼š${oldGeneralName}ï¼‰`
                                    );
                                }
                            } else {
                                // æ­¦å°†ãŒè¶³ã‚Šãªã„å ´åˆã¯æ‹…å½“ãªã—ã«
                                if (territory) {
                                    territory.generalGarrison = null;
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.warn('AIé ˜åœŸæ‹…å½“è¦‹ç›´ã—ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            calculateAIBattlePower(daimyo) {
                try {
                    if (!daimyo || !daimyo.stats) return 50; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
                    
                    let attackPower = daimyo.stats.battle || 50;
                    
                    // AIå¤§åã®é ˜åœŸã®å…µç§‘ãƒœãƒ¼ãƒŠã‚¹ã‚’è¨ˆç®—
                    const aiTerritories = this.gameState.territories.filter(t => t.owner === daimyo.id);
                    let totalUnitBonus = 0;
                    
                    aiTerritories.forEach(territory => {
                        if (territory.troops > 0 && territory.unitType === territory.advantageType) {
                            // åœ°åŸŸç‰¹æ€§ã¨ä¸€è‡´ã™ã‚‹å…µç§‘ã¯+20%ãƒœãƒ¼ãƒŠã‚¹
                            const territoryBonus = Math.floor(territory.troops * 0.2);
                            totalUnitBonus += territoryBonus;
                        }
                    });
                    
                    if (totalUnitBonus > 0) {
                        attackPower += Math.floor(totalUnitBonus / 10); // å…µç§‘ãƒœãƒ¼ãƒŠã‚¹ã‚’æˆ¦é—˜åŠ›ã«åæ˜ 
                    }
                    
                    // AIå¤§åã®æ­¦å°†ç·¨æˆã‚’è€ƒæ…®
                    if (this.gameState.aiRoles && this.gameState.aiRoles[daimyo.id] && this.gameState.generals) {
                        const aiRoles = this.gameState.aiRoles[daimyo.id];
                        const positions = {
                            'armyStrategist': { command: 0.5, intelligence: 0.3 },
                            'vanguard': { battle: 1, command: 0.5 },
                            'rightWing': { battle: 0.8 },
                            'leftWing': { battle: 0.8 },
                            'reserve': { command: 0.3 }
                        };
                        
                        Object.entries(positions).forEach(([roleKey, stats]) => {
                            try {
                                const generalId = aiRoles[roleKey];
                                if (generalId && this.gameState.generals) {
                                    const general = this.gameState.generals.find(g => g && g.id === generalId && g.lord === daimyo.id);
                                    if (general && general.stats) {
                                        if (stats.battle && general.stats.battle) {
                                            attackPower += Math.floor((general.stats.battle || 0) * stats.battle);
                                        }
                                        if (stats.command && general.stats.command) {
                                            attackPower += Math.floor((general.stats.command || 0) * stats.command);
                                        }
                                        if (stats.intelligence && general.stats.intelligence) {
                                            attackPower += Math.floor((general.stats.intelligence || 0) * stats.intelligence);
                                        }
                                    }
                                }
                            } catch (error) {
                                console.warn('AIæˆ¦åŠ›è¨ˆç®—ã®å½¹è·å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                            }
                        });
                        
                        // è»å¸«ãƒœãƒ¼ãƒŠã‚¹ï¼ˆå½¹è·è¨­å®šã®è»å¸«ï¼‰
                        try {
                            if (aiRoles.strategist && this.gameState.generals) {
                                const strategist = this.gameState.generals.find(g => g && g.id === aiRoles.strategist && g.lord === daimyo.id);
                                if (strategist && strategist.stats && strategist.stats.intelligence) {
                                    attackPower += Math.floor(strategist.stats.intelligence / 10);
                                }
                            }
                        } catch (error) {
                            console.warn('AIè»å¸«ãƒœãƒ¼ãƒŠã‚¹è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                        }
                    }
                    
                    return Math.max(30, attackPower + Math.random() * 15); // æœ€ä½30ã¯ä¿è¨¼
                    
                } catch (error) {
                    console.warn('AIæˆ¦åŠ›è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                    return 50; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
                }
            }
            
            assignNewTerritoryGeneral(daimyoId, territory) {
                try {
                    if (!daimyoId || !territory || !this.gameState.generals || !this.gameState.territories) {
                        return;
                    }
                    
                    // ã“ã®å¤§åã®æœªé…ç½®æ­¦å°†ã‚’å–å¾—
                    const daimyoGenerals = this.gameState.generals.filter(g => g && g.lord === daimyoId);
                    const assignedGeneralIds = this.gameState.territories
                        .filter(t => t && t.owner === daimyoId && t.generalGarrison)
                        .map(t => t.generalGarrison);
                    
                    const unassignedGenerals = daimyoGenerals.filter(g => g && !assignedGeneralIds.includes(g.id));
                    
                    if (unassignedGenerals.length > 0) {
                        // æ”¿æ²»åŠ›ãŒæœ€ã‚‚é«˜ã„æ­¦å°†ã‚’é…ç½®
                        const bestGeneral = unassignedGenerals.reduce((best, current) => {
                            const bestPolitics = best.stats?.politics || 0;
                            const currentPolitics = current.stats?.politics || 0;
                            return currentPolitics > bestPolitics ? current : best;
                        });
                        
                        if (bestGeneral) {
                            territory.generalGarrison = bestGeneral.id;
                        }
                    }
                } catch (error) {
                    console.warn('æ–°é ˜åœŸã¸ã®æ­¦å°†é…ç½®ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            resetCurrentTab() {
                try {
                    // ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ã‚’åˆ¤å®š
                    const activeTab = document.querySelector('.tab-content.active');
                    if (!activeTab) {
                        this.gameState.addLog('ç¾åœ¨ã®ã‚¿ãƒ–ã‚’ç‰¹å®šã§ãã¾ã›ã‚“ã§ã—ãŸ');
                        return;
                    }

                    const tabId = activeTab.id;
                    let resetCount = 0;
                    let resetMessage = '';

                    // å¿ èª åº¦ã‚’ä¸‹ã’ã‚‹å‡¦ç†
                    const decreaseLoyaltyForGeneral = (generalId, reason) => {
                        if (!generalId) return;
                        const general = this.gameState.generals.find(g => g.id === generalId);
                        if (general) {
                            general.loyalty = Math.max(0, general.loyalty - 10);
                            this.gameState.addLog(`${general.name}ã®å¿ èª åº¦ãŒ-10ï¼ˆ${reason}ï¼‰`, 'battle');
                        }
                    };

                    switch(tabId) {
                        case 'tab-assignment':
                            // åŸä¸»é…ç½®ã‚’ã‚¯ãƒªã‚¢
                            this.gameState.territories.forEach(territory => {
                                if (territory.owner === this.gameState.playerDaimyo && territory.generalGarrison) {
                                    decreaseLoyaltyForGeneral(territory.generalGarrison, 'åŸä¸»å†ç·¨æˆ');
                                    territory.generalGarrison = null;
                                    resetCount++;
                                }
                            });
                            resetMessage = `åŸä¸»é…ç½®ã‚’${resetCount}äººè§£é™¤ã—ã¾ã—ãŸ`;
                            this.updateTerritoryAssignments();
                            if (resetCount > 0) {
                                this.gameState.addPersonnelLog(`åŸä¸»é…ç½®ã‚’${resetCount}äººè§£é™¤`);
                            }
                            break;

                        case 'tab-roles':
                            // å½¹è·è¨­å®šã‚’ã‚¯ãƒªã‚¢
                            const roleKeys = ['strategist', 'diplomat', 'administrator', 'kenchiCommissioner', 'riceCommissioner', 'townCommissioner', 'goldCommissioner', 'constructionCommissioner', 'militaryCommissioner'];
                            roleKeys.forEach(roleKey => {
                                if (this.gameState.playerRoles[roleKey]) {
                                    decreaseLoyaltyForGeneral(this.gameState.playerRoles[roleKey], 'å½¹è·å†ç·¨æˆ');
                                    this.gameState.playerRoles[roleKey] = null;
                                    resetCount++;
                                }
                            });
                            resetMessage = `å½¹è·è¨­å®šã‚’${resetCount}ä»¶è§£é™¤ã—ã¾ã—ãŸ`;
                            this.updateRoleSelections();
                            if (resetCount > 0) {
                                this.gameState.addPersonnelLog(`å½¹è·è¨­å®šã‚’${resetCount}ä»¶è§£é™¤`);
                            }
                            break;

                        case 'tab-army':
                            // è»å›£ç·¨æˆã‚’ã‚¯ãƒªã‚¢
                            const armyKeys = ['armyStrategist', 'vanguard', 'rightWing', 'leftWing', 'reserve'];
                            armyKeys.forEach(roleKey => {
                                if (this.gameState.playerRoles[roleKey]) {
                                    decreaseLoyaltyForGeneral(this.gameState.playerRoles[roleKey], 'è»å›£å†ç·¨æˆ');
                                    this.gameState.playerRoles[roleKey] = null;
                                    resetCount++;
                                }
                            });
                            resetMessage = `è»å›£ç·¨æˆã‚’${resetCount}ä»¶è§£é™¤ã—ã¾ã—ãŸ`;
                            this.updateArmyFormation();
                            if (resetCount > 0) {
                                this.gameState.addPersonnelLog(`è»å›£ç·¨æˆã‚’${resetCount}ä»¶è§£é™¤`);
                            }
                            break;

                        case 'tab-reward':
                            resetMessage = 'ä¸‹è³œã¯å–ã‚Šæ¶ˆã—ã§ãã¾ã›ã‚“';
                            break;

                        case 'tab-list':
                            resetMessage = 'æ­¦å°†ä¸€è¦§ã¯è¡¨ç¤ºå°‚ç”¨ã®ãŸã‚ã€å†ç·¨æˆå¯¾è±¡å¤–ã§ã™';
                            break;

                        default:
                            resetMessage = 'ä¸æ˜ãªã‚¿ãƒ–ã§ã™';
                            break;
                    }

                    this.gameState.addLog(resetMessage);

                    // è»å›£æˆ¦åŠ›ã‚’å†è¨ˆç®—
                    if (tabId === 'tab-army' || tabId === 'tab-roles') {
                        this.calculateArmyStats();
                    }
                    // å…¨ã¦ã®ã‚¿ãƒ–ã‚’æ›´æ–°ã—ã¦å¿ èª åº¦ã®å¤‰æ›´ã‚’å³æ™‚åæ˜ 
                    this.refreshAllTabs();

                } catch (error) {
                    console.error('å†ç·¨æˆå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ:', error);
                    this.gameState.addLog('å†ç·¨æˆå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€ã‚²ãƒ¼ãƒ ã¯ç¶šè¡Œã§ãã¾ã™');
                }
            }
            
            executeStrategy() {
                const strategyType = document.getElementById('strategy-type')?.value;
                const target = this.gameState.selectedTerritory;
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                
                // è™šå ±ä»¥å¤–ã¯å¯¾è±¡ãŒå¿…è¦
                if (strategyType !== 'rumor' && !target) {
                    this.gameState.addLog('è¬€ç•¥å¯¾è±¡ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    return;
                }
                
                // è™šå ±ä»¥å¤–ã§è‡ªé ˜åœŸã¸ã®å®Ÿè¡Œã‚’é˜²ã
                if (strategyType !== 'rumor' && target && target.owner === this.gameState.playerDaimyo) {
                    this.gameState.addLog('è‡ªé ˜åœŸã«ã¯è¬€ç•¥ã‚’ä»•æ›ã‘ã‚‰ã‚Œã¾ã›ã‚“');
                    return;
                }
                
                const intelligencePower = playerDaimyo.stats.intelligence;
                
                // å¤–äº¤ãƒ»è¬€ç•¥ãƒœãƒ¼ãƒŠã‚¹
                let diplomacyBonus = 0;
                
                // å‚è¬€ãƒœãƒ¼ãƒŠã‚¹
                let strategyBonus = 0;
                let kanbeiWaterBonus = 0; // é»’ç”°å®˜å…µè¡›å°‚ç”¨ãƒœãƒ¼ãƒŠã‚¹
                
                if (this.gameState.playerRoles.strategist) {
                    const strategist = this.gameState.generals.find(g => g.id === this.gameState.playerRoles.strategist);
                    if (strategist) {
                        strategyBonus = Math.floor(strategist.stats.intelligence / 10);
                        
                        // é»’ç”°å®˜å…µè¡›ã®ç‰¹æ®ŠåŠ¹æœï¼šæ°´æ”»ã‚+10
                        if (strategist.id === 'kuroda_kanbei_h' && strategist.skill === 'è»å¸«ã®æ‰') {
                            kanbeiWaterBonus = 10;
                            // æ°´æ”»ã‚å®Ÿè¡Œæ™‚ã®ã¿ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤ºï¼ˆstrategyTypeã‚’ãƒã‚§ãƒƒã‚¯ï¼‰
                        }
                    }
                }
                
                const totalIntelligence = intelligencePower + strategyBonus + diplomacyBonus + kanbeiWaterBonus;
                
                const targetDefenseIntelligence = target.owner ? 
                    this.gameState.daimyos.find(d => d.id === target.owner)?.stats.intelligence || 50 : 30;
                
                switch (strategyType) {
                    case 'fire':
                        // ç«æ”»ã‚ã¯åŸå£å°‚ç”¨æ”»æ’ƒï¼ˆæ”»æ’ƒåŠ›å¼·åŒ–ï¼‰
                        if (!target) {
                            this.gameState.addLog('ç«æ”»ã‚ã®å¯¾è±¡ãŒä¸æ­£ã§ã™');
                            return;
                        }
                        
                        if (totalIntelligence > targetDefenseIntelligence) {
                            const wallDamage = Math.floor(totalIntelligence * (Math.random() * 0.6 + 0.5)); // æ”»æ’ƒåŠ›å¼·åŒ–
                            const previousWalls = target.walls;
                            target.walls = Math.max(0, target.walls - wallDamage);
                            
                            let fireMessage = `${target.name}ã«ç«æ”»ã‚ã‚’ä»•æ›ã‘ã€åŸå£${previousWalls}â†’${target.walls}ã«ç ´å£Š`;
                            this.gameState.addLog(fireMessage, 'strategy');
                            
                            // åŸå£ãŒ0ã«ãªã£ãŸã‚‰é ˜åœŸå¥ªå–
                            if (target.walls <= 0) {
                                const previousOwner = target.owner ? 
                                    this.gameState.daimyos.find(d => d.id === target.owner)?.name || 'ä¸æ˜å‹¢åŠ›' : 
                                    'ç©ºç™½åœ°';
                                
                                target.owner = this.gameState.playerDaimyo;
                                target.troops = Math.floor(totalIntelligence / 8); // æ–°ãŸãªå®ˆå‚™å…µé…ç½®
                                target.walls = 100; // å¥ªå–ç›´å¾Œã¯100ã‚¹ã‚¿ãƒ¼ãƒˆ
                                
                                // æ–°é ˜åœŸã«å¤§åã®å¾—æ„å…µç§‘ã‚’è¨­å®š
                                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                                if (playerDaimyo && playerDaimyo.preferredUnit) {
                                    target.unitType = playerDaimyo.preferredUnit;
                                } else {
                                    target.unitType = 'infantry'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ­©å…µ
                                }
                                
                                let conquestMessage = `ç«æ”»ã‚ã«ã‚ˆã‚Š${target.name}ãŒé™¥è½ï¼`;
                                if (previousOwner !== 'ç©ºç™½åœ°') {
                                    conquestMessage += `${previousOwner}ã®æ”¯é…ã‹ã‚‰å¥ªå–ã—ãŸ`;
                                } else {
                                    conquestMessage += 'ç©ºç™½åœ°ã‚’æ–°é ˜åœŸã¨ã—ã¦ç¢ºä¿';
                                }
                                
                                this.gameState.addLog(conquestMessage, 'strategy');
                                this.gameState.addLog(`æ–°ãŸãªå®ˆå‚™å…µ${target.troops}ã‚’é…ç½®ã—ã€åŸå£${target.walls}ã‚’ä¿®ç¯‰`, 'strategy');
                                
                                // æ–°é ˜åœŸã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ­¦å°†ã‚’é…ç½®ï¼ˆå¯èƒ½ã§ã‚ã‚Œã°ï¼‰
                                const playerGenerals = this.gameState.generals.filter(g => g.lord === this.gameState.playerDaimyo);
                                const assignedGeneralIds = this.gameState.territories
                                    .filter(t => t.owner === this.gameState.playerDaimyo && t.generalGarrison)
                                    .map(t => t.generalGarrison);
                                const unassignedGenerals = playerGenerals.filter(g => !assignedGeneralIds.includes(g.id));
                                
                                if (unassignedGenerals.length > 0) {
                                    // æ”¿æ²»åŠ›ãŒæœ€ã‚‚é«˜ã„æ­¦å°†ã‚’é…ç½®
                                    const bestGeneral = unassignedGenerals.reduce((best, current) => {
                                        const bestPolitics = best.stats?.politics || 0;
                                        const currentPolitics = current.stats?.politics || 0;
                                        return currentPolitics > bestPolitics ? current : best;
                                    });
                                    
                                    if (bestGeneral) {
                                        target.generalGarrison = bestGeneral.id;
                                        this.gameState.addLog(`${bestGeneral.name}ã‚’${target.name}æ‹…å½“ã«ä»»å‘½`, 'strategy');
                                    }
                                }
                            }
                        } else {
                            this.gameState.addLog(`${target.name}ã¸ã®ç«æ”»ã‚ã‚’è¦‹ç ´ã‚‰ã‚ŒãŸ`, 'strategy');
                        }
                        break;
                    case 'water':
                        // é»’ç”°å®˜å…µè¡›ã®æ°´æ”»ã‚åŠ¹æœã‚³ãƒ¡ãƒ³ãƒˆ
                        if (kanbeiWaterBonus > 0) {
                            this.gameState.addLog('é»’ç”°å®˜å…µè¡›ã®å‚è¬€åŠ¹æœï¼šæ°´æ”»ã‚å¨åŠ›+10', 'strategy');
                        }
                        
                        // æ°´æ”»ã‚ã¯ç±³ã‚’æ¸›ã‚‰ã™
                        if (totalIntelligence > targetDefenseIntelligence) {
                            if (target.owner) {
                                const targetDaimyo = this.gameState.daimyos.find(d => d.id === target.owner);
                                if (targetDaimyo) {
                                    const riceDamage = Math.floor(totalIntelligence * (Math.random() * 0.6 + 0.4));
                                    const previousRice = targetDaimyo.rice;
                                    targetDaimyo.rice = Math.max(0, targetDaimyo.rice - riceDamage);
                                    
                                    let waterMessage = `${target.name}ã«æ°´æ”»ã‚ã‚’ä»•æ›ã‘ã€${targetDaimyo.name}ã®ç±³${previousRice}â†’${targetDaimyo.rice}ã«æ¸›å°‘`;
                                    this.gameState.addLog(waterMessage, 'strategy');
                                    
                                    // è¾²æ¥­å€¤ã‚‚æ¸›å°‘
                                    const agricultureDamage = Math.floor(riceDamage / 10);
                                    if (agricultureDamage > 0) {
                                        const previousAgriculture = target.agriculture;
                                        target.agriculture = Math.max(10, target.agriculture - agricultureDamage);
                                        this.gameState.addLog(`${target.name}ã®è¾²åœ°ãŒæ°´å®³ã«ã‚ˆã‚Šè¾²æ¥­${previousAgriculture}â†’${target.agriculture}ã«ä½ä¸‹`, 'strategy');
                                    }
                                } else {
                                    this.gameState.addLog(`${target.name}ã¸ã®æ°´æ”»ã‚ã‚’å®Ÿè¡Œã—ãŸãŒã€åŠ¹æœçš„ãªæå®³ã‚’ä¸ãˆã‚‰ã‚Œãªã‹ã£ãŸ`, 'strategy');
                                }
                            } else {
                                this.gameState.addLog(`${target.name}ã¯ç©ºç™½åœ°ã®ãŸã‚æ°´æ”»ã‚ã®åŠ¹æœãªã—`, 'strategy');
                            }
                        } else {
                            this.gameState.addLog(`${target.name}ã¸ã®æ°´æ”»ã‚ã‚’è¦‹ç ´ã‚‰ã‚ŒãŸ`, 'strategy');
                        }
                        break;
                    case 'rumor':
                        // è™šå ±é˜²å¾¡ã®è¨­å®š
                        let rumorIntelligence = intelligencePower;
                        
                        // è»å¸«ã®çŸ¥è¬€ã‚’ã•ã‚‰ã«åŠ ç®—
                        if (this.gameState.playerRoles.strategist) {
                            const strategist = this.gameState.generals.find(g => g.id === this.gameState.playerRoles.strategist);
                            if (strategist && strategist.stats && strategist.stats.intelligence) {
                                rumorIntelligence = Math.max(rumorIntelligence, strategist.stats.intelligence);
                            }
                        }
                        
                        // ç™ºå‹•ç‡è¨ˆç®—: (çŸ¥è¬€-85)*4ã€æœ€ä½5%
                        const activationRate = Math.max(5, (rumorIntelligence - 85) * 4);
                        this.gameState.rumorActivationRate = activationRate;
                        this.gameState.rumorDefenseActive = true;
                        
                        let rumorMessage = `è™šå ±å·¥ä½œã‚’å±•é–‹ï¼æ•µã®æ”»æ’ƒã‚’æ’¹ä¹±ã™ã‚‹æº–å‚™ãŒæ•´ã£ãŸ`;
                        rumorMessage += ` (ç™ºå‹•ç‡: ${activationRate}%)`;
                        
                        this.gameState.addLog(rumorMessage, 'strategy');
                        break;
                    case 'defection':
                        // å‚è¬€ã®çŸ¥è¬€ã‚’å–å¾—
                        let strategistIntelligence = 0;
                        let kanbeiDiplomacyBonus = 0; // é»’ç”°å®˜å…µè¡›å°‚ç”¨ãƒœãƒ¼ãƒŠã‚¹
                        
                        if (this.gameState.playerRoles.strategist) {
                            const strategist = this.gameState.generals.find(g => g.id === this.gameState.playerRoles.strategist);
                            if (strategist && strategist.stats) {
                                strategistIntelligence = strategist.stats.intelligence || 0;
                                
                                // é»’ç”°å®˜å…µè¡›ã®ç‰¹æ®ŠåŠ¹æœï¼šèª¿ç•¥+10
                                if (strategist.id === 'kuroda_kanbei_h' && strategist.skill === 'è»å¸«ã®æ‰') {
                                    kanbeiDiplomacyBonus = 10;
                                    this.gameState.addLog('é»’ç”°å®˜å…µè¡›ã®å‚è¬€åŠ¹æœï¼šèª¿ç•¥æˆåŠŸç‡+10%', 'strategy');
                                }
                            }
                        }
                        
                        // æˆåŠŸç‡è¨ˆç®—ï¼š(å‚è¬€ã®çŸ¥è¬€-80)*4 + é»’ç”°å®˜å…µè¡›ãƒœãƒ¼ãƒŠã‚¹
                        const successRate = Math.max(0, (strategistIntelligence - 80) * 4 + kanbeiDiplomacyBonus);
                        
                        if (target.owner && Math.random() * 100 <= successRate) {
                            const targetGenerals = this.gameState.generals.filter(g => g && g.lord === target.owner);
                            if (targetGenerals.length > 0) {
                                // ä¸€ç•ªå¿ èª åº¦ãŒä½ã„æ­¦å°†ã‚’æ¢ã™
                                let lowestLoyalty = Math.min(...targetGenerals.map(g => g.loyalty || 100));
                                const lowestLoyaltyGenerals = targetGenerals.filter(g => (g.loyalty || 100) === lowestLoyalty);
                                const targetGeneral = lowestLoyaltyGenerals[Math.floor(Math.random() * lowestLoyaltyGenerals.length)];
                                
                                if (targetGeneral && typeof targetGeneral.loyalty === 'number') {
                                    // å¼•ãæŠœãåˆ¤å®š
                                    if (targetGeneral.loyalty <= 20) {
                                        // å¿ èª åº¦20ä»¥ä¸‹ï¼šå¼•ãæŠœãæˆåŠŸ
                                        const oldLord = this.gameState.daimyos.find(d => d && d.id === targetGeneral.lord)?.name || 'ä¸æ˜';
                                        
                                        targetGeneral.lord = this.gameState.playerDaimyo;
                                        targetGeneral.loyalty = Math.floor(Math.random() * 20) + 70; // 70-90ã§å†è¨­å®š
                                        
                                        // æ—§ä¸»å›ã®å½¹è·ãƒ»é ˜åœŸã‹ã‚‰é™¤å¤–
                                        if (this.gameState.aiRoles && this.gameState.aiRoles[target.owner]) {
                                            Object.keys(this.gameState.aiRoles[target.owner]).forEach(roleKey => {
                                                if (this.gameState.aiRoles[target.owner][roleKey] === targetGeneral.id) {
                                                    this.gameState.aiRoles[target.owner][roleKey] = null;
                                                }
                                            });
                                        }
                                        
                                        this.gameState.territories.forEach(territory => {
                                            if (territory && territory.generalGarrison === targetGeneral.id) {
                                                territory.generalGarrison = null;
                                            }
                                        });
                                        
                                        let defectionMessage = `èª¿ç•¥æˆåŠŸï¼${targetGeneral.name}ãŒ${oldLord}ã‚’è£åˆ‡ã‚Šæˆ‘ãŒè»ã«å‚ã˜ãŸï¼`;
                                        this.gameState.addLog(defectionMessage, 'strategy');
                                        this.gameState.addPersonnelLog(`${targetGeneral.name}ã‚’èª¿ç•¥ã«ã‚ˆã‚Š${oldLord}ã‹ã‚‰å¼•ãæŠœãï¼ˆå¿ èª åº¦${targetGeneral.loyalty}ï¼‰`);
                                    } else {
                                        // å¿ èª åº¦æ¸›å°‘ï¼šå‚è¬€ã®çŸ¥è¬€-80
                                        const loyaltyDamage = Math.max(1, strategistIntelligence - 80);
                                        targetGeneral.loyalty = Math.max(0, targetGeneral.loyalty - loyaltyDamage);
                                        let defectionMessage = `${target.name}ã®${targetGeneral.name}ã®å¿ èª åº¦ã‚’${loyaltyDamage}ä½ä¸‹ã•ã›ãŸ`;
                                        if (diplomacyBonus > 0) defectionMessage += `ã€‚ç‹¬çœ¼ç«œã®äººæ ¼çš„é­…åŠ›ãŒèª¿ç•¥ã‚’æˆåŠŸã«å°ã„ãŸ`;
                                        this.gameState.addLog(defectionMessage, 'strategy');
                                        
                                        if (targetGeneral.loyalty <= 20) {
                                            this.gameState.addLog(`${targetGeneral.name}ã®å¿ èª åº¦ãŒå±é™ºæ°´æº–ã«ï¼æ¬¡å›ã®èª¿ç•¥ã§å¼•ãæŠœã‘ã‚‹ã‹ã‚‚ã—ã‚Œãªã„`, 'strategy');
                                        }
                                    }
                                }
                            } else {
                                this.gameState.addLog(`${target.name}ã«ã¯èª¿ç•¥å¯¾è±¡ã¨ãªã‚‹æ­¦å°†ãŒã„ãªã„`, 'strategy');
                            }
                        } else {
                            let strategistName = '';
                            if (this.gameState.playerRoles.strategist) {
                                const strategist = this.gameState.generals.find(g => g.id === this.gameState.playerRoles.strategist);
                                if (strategist) strategistName = strategist.name;
                            }
                            
                            let failMessage = `${target.name}ã¸ã®èª¿ç•¥ãŒå¤±æ•—ã—ãŸ`;
                            if (strategistName) {
                                failMessage += ` (${strategistName}ã®çŸ¥è¬€${strategistIntelligence} æˆåŠŸç‡${successRate}%)`;
                            } else {
                                failMessage += ` (å‚è¬€ä¸åœ¨ã®ãŸã‚æˆåŠŸç‡0%)`;
                            }
                            this.gameState.addLog(failMessage, 'strategy');
                        }
                        break;
                }
                
                this.gameState.strategyUsed = true;
                this.updateActionButtons();
                this.renderMap();
                this.updateStatus();
            }
            
            executeDiplomacy() {
                const target = this.gameState.selectedTerritory;
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                
                if (!target || !target.owner || target.owner === this.gameState.playerDaimyo) {
                    this.gameState.addLog('å¤–äº¤å¯¾è±¡ãŒä¸æ­£ã§ã™');
                    return;
                }
                
                // è²»ç”¨ãƒã‚§ãƒƒã‚¯
                if (playerDaimyo.gold < 10) {
                    this.gameState.addLog('å¤–äº¤äº¤æ¸‰ã«ã¯é‡‘10ãŒå¿…è¦ã§ã™');
                    return;
                }
                
                // è²»ç”¨ã‚’æ”¯æ‰•ã†
                playerDaimyo.gold -= 10;
                
                const targetDaimyo = this.gameState.daimyos.find(d => d.id === target.owner);
                if (!targetDaimyo) {
                    this.gameState.addLog('å¤–äº¤å¯¾è±¡ã®å¤§åãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                // å¤–äº¤åŠ›ã‚’è¨ˆç®—
                let diplomacyPower = playerDaimyo.stats.charm || 50;
                
                // å¤–äº¤æ‹…å½“æ­¦å°†ã®ãƒœãƒ¼ãƒŠã‚¹
                if (this.gameState.playerRoles.diplomat) {
                    const diplomat = this.gameState.generals.find(g => g.id === this.gameState.playerRoles.diplomat);
                    if (diplomat && diplomat.stats) {
                        diplomacyPower += diplomat.stats.politics || 0;
                    }
                }
                
                // ä¼Šé”æ”¿å®—ã®ç‹¬çœ¼ç«œç‰¹æŠ€åŠ¹æœ
                if (playerDaimyo.skill === 'ç‹¬çœ¼ç«œ') {
                    diplomacyPower += 20;
                }
                
                // ç›¸æ‰‹ã®å¤–äº¤æŠµæŠ—åŠ›
                const targetResistance = (targetDaimyo.stats.politics || 50) + (targetDaimyo.stats.intelligence || 50);
                
                // åŸºæœ¬æˆåŠŸç‡ã‚’è¨ˆç®—ï¼ˆ30-80%ã®ç¯„å›²ï¼‰
                const baseSuccessRate = Math.max(30, Math.min(80, 50 + (diplomacyPower - targetResistance) / 2));
                const roll = Math.random() * 100;
                
                let diplomacyMessage = '';
                let diplomatName = '';
                
                // å¤–äº¤æ‹…å½“æ­¦å°†ã®åå‰ã‚’å–å¾—
                if (this.gameState.playerRoles.diplomat) {
                    const diplomat = this.gameState.generals.find(g => g.id === this.gameState.playerRoles.diplomat);
                    if (diplomat) {
                        diplomatName = diplomat.name;
                    }
                }
                
                if (roll <= baseSuccessRate) {
                    // å¤–äº¤æˆåŠŸ
                    diplomacyMessage = `${target.name}ã®${targetDaimyo.name}ã¨ã®å¤–äº¤äº¤æ¸‰ãŒæˆåŠŸï¼`;
                    
                    if (diplomatName) {
                        diplomacyMessage += ` ${diplomatName}ã®äº¤æ¸‰è¡“ãŒåŠŸã‚’å¥ã—ãŸ`;
                    }
                    
                    if (playerDaimyo.skill === 'ç‹¬çœ¼ç«œ') {
                        diplomacyMessage += `ã€‚ç‹¬çœ¼ç«œã®å¨å³ãŒå¤–äº¤ã‚’æœ‰åˆ©ã«å°ã„ãŸ`;
                    }
                    
                    diplomacyMessage += ` (æˆåŠŸç‡:${Math.floor(baseSuccessRate)}%)`;
                    
                    // å¤–äº¤å”å®šã‚’çµã¶
                    if (!this.gameState.diplomacyTreaties[this.gameState.playerDaimyo]) {
                        this.gameState.diplomacyTreaties[this.gameState.playerDaimyo] = [];
                    }
                    if (!this.gameState.diplomacyTreaties[targetDaimyo.id]) {
                        this.gameState.diplomacyTreaties[targetDaimyo.id] = [];
                    }
                    
                    this.gameState.diplomacyTreaties[this.gameState.playerDaimyo].push(targetDaimyo.id);
                    this.gameState.diplomacyTreaties[targetDaimyo.id].push(this.gameState.playerDaimyo);
                    
                    this.gameState.addLog(diplomacyMessage, 'diplomacy');
                    this.gameState.addLog(`${targetDaimyo.name}ã¨ä»Šã‚¿ãƒ¼ãƒ³ã¯ç›¸äº’ä¸å¯ä¾µã¨ãªã£ãŸ`, 'diplomacy');
                    
                } else {
                    // å¤–äº¤å¤±æ•—
                    diplomacyMessage = `${target.name}ã®${targetDaimyo.name}ã¨ã®å¤–äº¤äº¤æ¸‰ãŒæ±ºè£‚...`;
                    
                    if (diplomatName) {
                        diplomacyMessage += ` ${diplomatName}ã®åŠªåŠ›ã‚‚å®Ÿã‚‰ãš`;
                    }
                    
                    if (playerDaimyo.skill === 'ç‹¬çœ¼ç«œ') {
                        diplomacyMessage += `ã€‚ç‹¬çœ¼ç«œã®å¨å³ã‚’ã‚‚ã£ã¦ã—ã¦ã‚‚`;
                    }
                    
                    diplomacyMessage += ` (æˆåŠŸç‡:${Math.floor(baseSuccessRate)}%)`;
                    
                    this.gameState.addLog(diplomacyMessage, 'diplomacy');
                    this.gameState.addLog('äº¤æ¸‰æ±ºè£‚ã«ã‚ˆã‚Šç·Šå¼µçŠ¶æ…‹ãŒç¶šã', 'diplomacy');
                }
                
                this.gameState.diplomacyUsed++;
                this.updateActionButtons();
                this.updateStatus();
            }
            
            executeTrade() {
                const amount = parseInt(document.getElementById('trade-amount')?.value || '0');
                const type = document.getElementById('trade-type')?.value;
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                
                if (type === 'buy' && playerDaimyo.gold >= amount * 2) {
                    playerDaimyo.gold -= amount * 2;
                    playerDaimyo.rice += amount;
                    this.gameState.addLog(`é‡‘${amount * 2}ã§ç±³${amount}ã‚’è³¼å…¥ã—ãŸ`);
                } else if (type === 'sell' && playerDaimyo.rice >= amount) {
                    playerDaimyo.rice -= amount;
                    playerDaimyo.gold += amount * 2;
                    this.gameState.addLog(`ç±³${amount}ã‚’å£²ã£ã¦é‡‘${amount * 2}ã‚’å¾—ãŸ`);
                }
                
                this.updateStatus();
            }
            
            executeRecruit() {
                const amount = parseInt(document.getElementById('recruit-amount')?.value || '0');
                const territoryId = document.getElementById('recruit-territory')?.value;
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                const targetTerritory = this.gameState.territories.find(t => t.id === territoryId);
                
                if (playerDaimyo.gold >= amount && targetTerritory) {
                    playerDaimyo.gold -= amount;
                    targetTerritory.troops += amount;
                    
                    const unitTypeNames = {
                        'infantry': 'æ­©å…µ',
                        'cavalry': 'é¨é¦¬', 
                        'arquebus': 'é‰„ç ²'
                    };
                    
                    const unitName = unitTypeNames[targetTerritory.unitType] || 'å…µå£«';
                    this.gameState.addLog(`${targetTerritory.name}ã«${unitName}${amount}äººã‚’é›‡ç”¨ã—ãŸ`);
                    this.gameState.addPersonnelLog(`${targetTerritory.name}ã§${unitName}${amount}äººã‚’æ–°è¦å‹Ÿé›†`);
                } else if (!targetTerritory) {
                    this.gameState.addLog('é…ç½®å…ˆã®é ˜åœŸãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                } else {
                    this.gameState.addLog('è³‡é‡‘ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
                }
                
                this.updateStatus();
                this.renderMap();
            }
            
            nextTurn() {
                this.processTurn();
                this.showTurnLog();
            }
            
            processTurn() {
                this.gameState.turn++;
                this.gameState.attackUsed = false;
                this.gameState.diplomacyUsed = 0;
                this.gameState.strategyUsed = false;
                this.gameState.turnEvents = [];
                this.gameState.personnelEvents = []; // äººäº‹ãƒ­ã‚°ã‚‚ã‚¯ãƒªã‚¢
                
                // å„é ˜åœŸã®ç™ºå±•
                this.gameState.territories.forEach(territory => {
                    if (territory.owner) {
                        let agricultureBonus = 1;
                        let commerceBonus = 1;
                        let troopsBonus = 1;
                        let wallsBonus = 1;
                        
                        // æ‹…å½“æ­¦å°†ã®ãƒœãƒ¼ãƒŠã‚¹è¨ˆç®—
                        if (territory.generalGarrison) {
                            const general = this.gameState.generals.find(g => g.id === territory.generalGarrison);
                            if (general) {
                                // æ”¿æ²»åŠ›ï¼šè¾²æ¥­ãƒ»å•†æ¥­ãƒœãƒ¼ãƒŠã‚¹
                                agricultureBonus += Math.floor(general.stats.politics / 20);
                                commerceBonus += Math.floor(general.stats.politics / 20);
                                
                                // æˆ¦é—˜åŠ›ï¼šå…µæ•°ãƒœãƒ¼ãƒŠã‚¹
                                troopsBonus += Math.floor(general.stats.battle / 15);
                                
                                // çµ±ç‡åŠ›ï¼šåŸå£ãƒœãƒ¼ãƒŠã‚¹
                                wallsBonus += Math.floor(general.stats.command / 15);
                                
                                // é­…åŠ›ï¼šå£«æ°—å‘ä¸Šã«ã‚ˆã‚‹è¿½åŠ å…µæ•°ãƒœãƒ¼ãƒŠã‚¹
                                troopsBonus += Math.floor(general.stats.charm / 30);
                            }
                        }
                        
                        territory.agriculture += Math.floor(Math.random() * 3) + agricultureBonus;
                        territory.commerce += Math.floor(Math.random() * 3) + commerceBonus;
                        territory.troops += Math.floor(territory.agriculture / 10) + troopsBonus;
                        
                        // åŸå£å›å¾©ï¼ˆåŒ—æ¡æ°åº·ã¯2å€å›å¾©ï¼‰
                        let wallsGrowth = Math.floor(Math.random() * 2) + wallsBonus;
                        if (territory.owner === 'hojo') {
                            wallsGrowth *= 2; // åŒ—æ¡æ°åº·ã®é–¢æ±åˆ¶è¦‡ç‰¹æŠ€åŠ¹æœ
                        }
                        territory.walls += wallsGrowth;
                        
                        territory.agriculture = Math.min(200, territory.agriculture);
                        territory.commerce = Math.min(200, territory.commerce);
                        // ç›¸æ¨¡ã¯åŸå£æœ€å¤§1000ã€ãã®ä»–ã¯500
                        const maxWalls = territory.name === 'ç›¸æ¨¡' ? 1000 : 500;
                        territory.walls = Math.min(maxWalls, territory.walls);
                    }
                });
                
                // å¤§åã®åå…¥
                this.gameState.daimyos.forEach(daimyo => {
                    const territories = this.gameState.territories.filter(t => t.owner === daimyo.id);
                    const income = territories.reduce((sum, t) => sum + t.commerce, 0);
                    const riceIncome = territories.reduce((sum, t) => sum + t.agriculture, 0);
                    daimyo.gold += Math.floor(income / 10);
                    daimyo.rice += Math.floor(riceIncome / 10);
                    
                    // å¥‰è¡Œè·ã«ã‚ˆã‚‹è¿½åŠ åŠ¹æœ
                    let totalAgricultureBonus = 0;
                    let totalCommerceBonus = 0;
                    let totalGoldBonus = 0;
                    let totalRiceBonus = 0;
                    let totalWallsBonus = 0;
                    let totalTroopsBonus = 0;
                    
                    const roles = daimyo.id === this.gameState.playerDaimyo ? 
                        this.gameState.playerRoles : 
                        (this.gameState.aiRoles[daimyo.id] || {});
                    
                    // æ¤œåœ°å¥‰è¡ŒåŠ¹æœï¼ˆæ”¿æ²»-90ã®æ•°å€¤åˆ†ã ã‘è¾²æ¥­å‘ä¸Šï¼‰
                    if (roles.kenchiCommissioner) {
                        const commissioner = this.gameState.generals.find(g => g && g.id === roles.kenchiCommissioner);
                        if (commissioner && commissioner.stats && commissioner.stats.politics >= 90) {
                            totalAgricultureBonus = commissioner.stats.politics - 90;
                        }
                    }
                    
                    // ç±³å¥‰è¡ŒåŠ¹æœï¼ˆæ”¿æ²»-80ã®æ•°å€¤åˆ†ã ã‘ç±³å¢—åŠ ï¼‰
                    if (roles.riceCommissioner) {
                        const commissioner = this.gameState.generals.find(g => g && g.id === roles.riceCommissioner);
                        if (commissioner && commissioner.stats && commissioner.stats.politics >= 80) {
                            totalRiceBonus = commissioner.stats.politics - 80;
                        }
                    }
                    
                    // ç”ºå¥‰è¡ŒåŠ¹æœï¼ˆæ”¿æ²»-90ã®æ•°å€¤åˆ†ã ã‘å•†æ¥­å‘ä¸Šï¼‰
                    if (roles.townCommissioner) {
                        const commissioner = this.gameState.generals.find(g => g && g.id === roles.townCommissioner);
                        if (commissioner && commissioner.stats && commissioner.stats.politics >= 90) {
                            totalCommerceBonus = commissioner.stats.politics - 90;
                        }
                    }
                    
                    // é‡‘å¥‰è¡ŒåŠ¹æœï¼ˆæ”¿æ²»-80ã®æ•°å€¤åˆ†ã ã‘é‡‘å¢—åŠ ï¼‰
                    if (roles.goldCommissioner) {
                        const commissioner = this.gameState.generals.find(g => g && g.id === roles.goldCommissioner);
                        if (commissioner && commissioner.stats && commissioner.stats.politics >= 80) {
                            totalGoldBonus = commissioner.stats.politics - 80;
                        }
                    }
                    
                    // æ™®è«‹å¥‰è¡ŒåŠ¹æœï¼ˆçµ±ç‡-80ã®æ•°å€¤åˆ†ã ã‘åŸå£å‘ä¸Šï¼‰
                    if (roles.constructionCommissioner) {
                        const commissioner = this.gameState.generals.find(g => g && g.id === roles.constructionCommissioner);
                        if (commissioner && commissioner.stats && commissioner.stats.command >= 80) {
                            totalWallsBonus = commissioner.stats.command - 80;
                        }
                    }
                    
                    // å…µå¥‰è¡ŒåŠ¹æœï¼ˆæˆ¦é—˜-80ã®æ•°å€¤åˆ†ã ã‘å…µæ•°å‘ä¸Šï¼‰
                    if (roles.militaryCommissioner) {
                        const commissioner = this.gameState.generals.find(g => g && g.id === roles.militaryCommissioner);
                        if (commissioner && commissioner.stats && commissioner.stats.battle >= 80) {
                            totalTroopsBonus = commissioner.stats.battle - 80;
                        }
                    }
                    
                    // å¥‰è¡Œè·åŠ¹æœã‚’é ˜åœŸã«é©ç”¨
                    if (totalAgricultureBonus > 0 || totalCommerceBonus > 0 || totalWallsBonus > 0 || totalTroopsBonus > 0) {
                        territories.forEach(territory => {
                            territory.agriculture += totalAgricultureBonus;
                            territory.commerce += totalCommerceBonus;
                            territory.walls += totalWallsBonus;
                            territory.troops += totalTroopsBonus;
                            
                            // ä¸Šé™ãƒã‚§ãƒƒã‚¯
                            territory.agriculture = Math.min(200, territory.agriculture);
                            territory.commerce = Math.min(200, territory.commerce);
                            const maxWalls = territory.name === 'ç›¸æ¨¡' ? 1000 : 500;
                            territory.walls = Math.min(maxWalls, territory.walls);
                        });
                    }
                    
                    // é‡‘ãƒ»ç±³ã®ç›´æ¥ãƒœãƒ¼ãƒŠã‚¹
                    daimyo.gold += totalGoldBonus;
                    daimyo.rice += totalRiceBonus;
                    
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸ã®ãƒ­ã‚°è¡¨ç¤º
                    if (daimyo.id === this.gameState.playerDaimyo) {
                        if (totalAgricultureBonus > 0) this.gameState.addLog(`æ¤œåœ°å¥‰è¡ŒåŠ¹æœã§å…¨é ˜åœŸã®è¾²æ¥­+${totalAgricultureBonus}`, 'strategy');
                        if (totalCommerceBonus > 0) this.gameState.addLog(`ç”ºå¥‰è¡ŒåŠ¹æœã§å…¨é ˜åœŸã®å•†æ¥­+${totalCommerceBonus}`, 'strategy');
                        if (totalWallsBonus > 0) this.gameState.addLog(`æ™®è«‹å¥‰è¡ŒåŠ¹æœã§å…¨é ˜åœŸã®åŸå£+${totalWallsBonus}`, 'strategy');
                        if (totalTroopsBonus > 0) this.gameState.addLog(`å…µå¥‰è¡ŒåŠ¹æœã§å…¨é ˜åœŸã®å…µæ•°+${totalTroopsBonus}`, 'strategy');
                        if (totalGoldBonus > 0) this.gameState.addLog(`é‡‘å¥‰è¡ŒåŠ¹æœã§é‡‘+${totalGoldBonus}`, 'strategy');
                        if (totalRiceBonus > 0) this.gameState.addLog(`ç±³å¥‰è¡ŒåŠ¹æœã§ç±³+${totalRiceBonus}`, 'strategy');
                    }
                });
                
                // å…µã®ç¶­æŒè²»ï¼ˆå…¨å›½ç·å…µæ•°ã®50åˆ†ã®1ã®ç±³ã‚’æ¶ˆè²»ï¼‰
                let totalTroops = 0;
                this.gameState.territories.forEach(territory => {
                    if (territory.owner && territory.troops > 0) {
                        totalTroops += territory.troops;
                    }
                });
                
                const maintenanceCost = Math.floor(totalTroops / 50);
                if (maintenanceCost > 0) {
                    this.gameState.daimyos.forEach(daimyo => {
                        const daimyoTerritories = this.gameState.territories.filter(t => t.owner === daimyo.id);
                        const daimyoTroops = daimyoTerritories.reduce((sum, t) => sum + (t.troops || 0), 0);
                        
                        if (daimyoTroops > 0) {
                            const daimyoMaintenanceCost = Math.floor((daimyoTroops / totalTroops) * maintenanceCost);
                            daimyo.rice -= daimyoMaintenanceCost;
                            
                            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã¯ãƒ­ã‚°è¡¨ç¤º
                            if (daimyo.id === this.gameState.playerDaimyo && daimyoMaintenanceCost > 0) {
                                this.gameState.addLog(`å…µã®ç¶­æŒè²»ã¨ã—ã¦ç±³${daimyoMaintenanceCost}ã‚’æ¶ˆè²» (å…¨è»${daimyoTroops}äºº)`, 'strategy');
                            }
                        }
                    });
                }
                
                // AIå¤§åã®ç±³è£œå……ã‚·ã‚¹ãƒ†ãƒ ï¼ˆç±³ä¸è¶³å¯¾ç­–ï¼‰
                this.gameState.daimyos.forEach(daimyo => {
                    if (daimyo.id !== this.gameState.playerDaimyo && daimyo.rice < 100 && daimyo.gold >= 100) {
                        const riceToBuy = Math.min(200, 100 - daimyo.rice + 100); // 100ä¸è¶³åˆ†+ä½™è£•åˆ†
                        const cost = riceToBuy * 2; // é‡‘2 = ç±³1ã®äº¤æ›ãƒ¬ãƒ¼ãƒˆ
                        
                        if (daimyo.gold >= cost) {
                            daimyo.gold -= cost;
                            daimyo.rice += riceToBuy;
                            
                            // äººäº‹ãƒ­ã‚°ã«è¨˜éŒ²
                            this.gameState.addPersonnelLog(`${daimyo.name}ãŒç±³ä¸è¶³ã®ãŸã‚é‡‘${cost}ã§ç±³${riceToBuy}ã‚’èª¿é”`);
                        }
                    }
                });
                
                // ç±³ä¸è¶³ã«ã‚ˆã‚‹å…µåŠ›æ¸›å°‘å‡¦ç†
                this.gameState.daimyos.forEach(daimyo => {
                    if (daimyo.rice <= 0) {
                        const territories = this.gameState.territories.filter(t => t.owner === daimyo.id);
                        let totalTroopsLost = 0;
                        
                        territories.forEach(territory => {
                            const previousTroops = territory.troops;
                            territory.troops = Math.floor(territory.troops / 2);
                            totalTroopsLost += (previousTroops - territory.troops);
                        });
                        
                        if (totalTroopsLost > 0) {
                            if (daimyo.id === this.gameState.playerDaimyo) {
                                this.gameState.addLog(`ç±³ä¸è¶³ã«ã‚ˆã‚Šè»ãŒé›¢æ•£ï¼å…µåŠ›${totalTroopsLost}å¤±ã†`, 'strategy');
                                this.gameState.turnEvents.push({
                                    type: 'strategy',
                                    message: `${daimyo.name}ã®è»ãŒç±³ä¸è¶³ã§å¤§å¹…ã«é›¢æ•£ï¼`
                                });
                            } else {
                                this.gameState.turnEvents.push({
                                    type: 'strategy',
                                    message: `${daimyo.name}ãŒç±³ä¸è¶³ã«ã‚ˆã‚Šè»ãŒé›¢æ•£ï¼å…µåŠ›${totalTroopsLost}æ¸›å°‘`
                                });
                            }
                            
                            // äººäº‹ãƒ­ã‚°ã«ã‚‚è¨˜éŒ²
                            this.gameState.addPersonnelLog(`${daimyo.name}ãŒé£Ÿæ–™ä¸è¶³ã«ã‚ˆã‚Šè»ã®å£«æ°—ä½ä¸‹ã€å…µåŠ›å¤§å¹…æ¸›å°‘`);
                        }
                    }
                });
                
                // å±±åŸæ”¯é…çŠ¶æ³ã¨å¤©ä¸‹äººèªå®šãƒã‚§ãƒƒã‚¯
                try {
                    const yamashiro = this.gameState.territories.find(t => t && t.id === 'yamashiro');
                    if (yamashiro && yamashiro.owner) {
                        const currentOwner = yamashiro.owner;
                        
                        // å±±åŸæ”¯é…ã‚¿ãƒ¼ãƒ³æ•°ã‚’æ›´æ–°
                        if (!this.gameState.yamashiroControl[currentOwner]) {
                            this.gameState.yamashiroControl[currentOwner] = 1;
                        } else {
                            this.gameState.yamashiroControl[currentOwner]++;
                        }
                        
                        // ä»–ã®å¤§åã®å±±åŸæ”¯é…ã‚¿ãƒ¼ãƒ³æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
                        Object.keys(this.gameState.yamashiroControl).forEach(daimyoId => {
                            if (daimyoId !== currentOwner) {
                                this.gameState.yamashiroControl[daimyoId] = 0;
                                this.gameState.tenkaninStatus[daimyoId] = false;
                            }
                        });
                        
                        // 6ã‚¿ãƒ¼ãƒ³é€£ç¶šæ”¯é…ã§å¾å¤·å¤§å°†è»èªå®š
                        if (this.gameState.yamashiroControl[currentOwner] === 6 && !this.gameState.tenkaninStatus[currentOwner]) {
                            this.gameState.tenkaninStatus[currentOwner] = true;
                            
                            const ownerName = this.gameState.daimyos.find(d => d && d.id === currentOwner)?.name || 'ä¸æ˜';
                            
                            if (currentOwner === this.gameState.playerDaimyo) {
                                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå¾å¤·å¤§å°†è»èªå®š
                                const playerGenerals = this.gameState.generals.filter(g => g && g.lord === this.gameState.playerDaimyo);
                                const loyaltyBonus = 25;
                                
                                playerGenerals.forEach(general => {
                                    if (general && typeof general.loyalty === 'number') {
                                        general.loyalty = Math.min(100, general.loyalty + loyaltyBonus);
                                    }
                                });
                                
                                this.gameState.addLog(`ğŸ›ï¸ã€å¾å¤·å¤§å°†è»å°±ä»»ã€‘å±±åŸã‚’6ã‚¿ãƒ¼ãƒ³æ”¯é…ï¼${ownerName}ãŒå¾å¤·å¤§å°†è»ã¨ã—ã¦å¹•åºœã‚’é–‹åºœï¼`, 'diplomacy');
                                this.gameState.addLog(`å…¨æ­¦å°†ã®å¿ èª åº¦ãŒå¤§å¹…ä¸Šæ˜‡ï¼æ­¦å®¶æ”¿æ¨©ã®ç¢ºç«‹ã«ã‚ˆã‚Šå£«æ°—å‘ä¸ŠåŠ¹æœã‚‚ç²å¾—`, 'diplomacy');
                                this.gameState.addPersonnelLog(`å¾å¤·å¤§å°†è»å°±ä»»ã«ã‚ˆã‚Šå…¨æ­¦å°†ã®å¿ èª åº¦+${loyaltyBonus}`);
                                
                                this.gameState.turnEvents.push({
                                    type: 'diplomacy',
                                    message: `ğŸ›ï¸${ownerName}ãŒå¾å¤·å¤§å°†è»ã¨ã—ã¦å¹•åºœã‚’é–‹åºœï¼å¤©ä¸‹ã«æ­¦å®¶æ”¿æ¨©ã‚’ç¢ºç«‹ã—ãŸ`
                                });
                            } else {
                                // AIå¤§åãŒå¾å¤·å¤§å°†è»èªå®š
                                this.gameState.turnEvents.push({
                                    type: 'diplomacy',
                                    message: `ğŸ›ï¸ã€å¾å¤·å¤§å°†è»å°±ä»»ã€‘${ownerName}ãŒå±±åŸã‚’6ã‚¿ãƒ¼ãƒ³æ”¯é…ã—ã€å¾å¤·å¤§å°†è»ã¨ã—ã¦å¹•åºœã‚’é–‹åºœï¼`
                                });
                                
                                this.gameState.turnEvents.push({
                                    type: 'diplomacy',
                                    message: `æ­¦å®¶æ”¿æ¨©ãŒç¢ºç«‹ï¼${ownerName}ã¸ã®å¯¾æŠ—ãŒã¾ã™ã¾ã™å›°é›£ã¨ãªã£ãŸ`
                                });
                                
                                if (this.gameState.playerDaimyo) {
                                    this.gameState.addLog(`ğŸ’€å±æ©Ÿï¼${ownerName}ãŒå¾å¤·å¤§å°†è»ã¨ãªã£ãŸã€‚å¹•åºœã¨ã®æˆ¦ã„ãŒå¾…ã£ã¦ã„ã‚‹`, 'strategy');
                                }
                            }
                        } else if (this.gameState.yamashiroControl[currentOwner] < 6) {
                            // ã¾ã 6ã‚¿ãƒ¼ãƒ³ã«é”ã—ã¦ã„ãªã„å ´åˆ
                            const remainingTurns = 6 - this.gameState.yamashiroControl[currentOwner];
                            const ownerName = this.gameState.daimyos.find(d => d && d.id === currentOwner)?.name || 'ä¸æ˜';
                            
                            if (currentOwner === this.gameState.playerDaimyo) {
                                this.gameState.addLog(`å±±åŸæ”¯é…${this.gameState.yamashiroControl[currentOwner]}ã‚¿ãƒ¼ãƒ³ç›®ã€‚å¾å¤·å¤§å°†è»å°±ä»»ã¾ã§ã‚ã¨${remainingTurns}ã‚¿ãƒ¼ãƒ³`, 'diplomacy');
                            } else if (Math.random() < 0.4) { // 40%ã®ç¢ºç‡ã§è¡¨ç¤º
                                this.gameState.turnEvents.push({
                                    type: 'diplomacy',
                                    message: `${ownerName}ãŒå±±åŸã‚’${this.gameState.yamashiroControl[currentOwner]}ã‚¿ãƒ¼ãƒ³æ”¯é…ä¸­ã€‚å¾å¤·å¤§å°†è»å°±ä»»ã¾ã§ã‚ã¨${remainingTurns}ã‚¿ãƒ¼ãƒ³`
                                });
                            }
                        }
                    } else {
                        // å±±åŸãŒç©ºç™½åœ°ã®å ´åˆã€å…¨ã¦ã®æ”¯é…ã‚¿ãƒ¼ãƒ³æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
                        Object.keys(this.gameState.yamashiroControl).forEach(daimyoId => {
                            this.gameState.yamashiroControl[daimyoId] = 0;
                            this.gameState.tenkaninStatus[daimyoId] = false;
                        });
                    }
                } catch (error) {
                    console.warn('å±±åŸæ”¯é…ãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                }
                
                // æ­¦å°†ã®å¿ èª åº¦å¤‰åŒ–ï¼ˆè‡ªç„¶æ¸›å°‘ã®ã¿ï¼‰
                try {
                    this.gameState.daimyos.forEach(daimyo => {
                        if (!daimyo || !daimyo.id) return;
                        
                        const daimyoGenerals = this.gameState.generals.filter(g => g && g.lord === daimyo.id);
                        
                        if (daimyoGenerals.length === 0) return;
                        
                        // å¿ èª åº¦ã®è‡ªç„¶æ¸›å°‘ï¼ˆ70%ã®ç¢ºç‡ã§-1ï¼‰
                        daimyoGenerals.forEach(general => {
                            if (general && typeof general.loyalty === 'number' && Math.random() < 0.7) {
                                general.loyalty = Math.max(0, general.loyalty - 1);
                            }
                        });
                        
                        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å±é™ºãƒ¬ãƒ™ãƒ«æ­¦å°†ã®è­¦å‘Š
                        if (daimyo.id === this.gameState.playerDaimyo) {
                            daimyoGenerals.forEach(general => {
                                if (general && general.loyalty <= 15 && Math.random() < 0.4) {
                                    this.gameState.addLog(`${general.name}ã®å¿ èª åº¦ãŒæ¥µã‚ã¦å±é™º(${general.loyalty})ï¼`, 'strategy');
                                }
                            });
                        }
                    });
                } catch (error) {
                    console.warn('å¿ èª åº¦å¤‰åŒ–å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                }
                
                // AIè¡Œå‹•
                this.processAIActions();
                
                // è™šå ±é˜²å¾¡ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆAIè¡Œå‹•ã®å¾Œï¼‰
                this.gameState.rumorDefenseActive = false;
                this.gameState.rumorActivationRate = 0;
                
                // AIå¤§åã®äººäº‹ç®¡ç†ï¼ˆå®‰å…¨ã«å®Ÿè¡Œï¼‰
                try {
                    this.processAIPersonnel();
                } catch (error) {
                    console.warn('AIäººäº‹ç®¡ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€ã‚²ãƒ¼ãƒ ã¯ç¶šè¡Œã—ã¾ã™:', error);
                }
                
                // æ–°ã—ã„æ­¦å°†ã®ç™»å ´ãƒã‚§ãƒƒã‚¯
                this.checkNewGeneralAppearance();
                
                // å¤§åå®¶æ»…äº¡ãƒã‚§ãƒƒã‚¯
                this.checkDaimyoExtinction();
                
                // å¤–äº¤å”å®šã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆ1ã‚¿ãƒ¼ãƒ³é™ã‚Šã®åŠ¹æœï¼‰
                this.gameState.diplomacyTreaties = {};
                
                // æµªäººã®è‡ªå‹•å£«å®˜å‡¦ç†
                this.processRoninAutoRecruitment();
                
                this.updateActionButtons();
            }
            
            processAIActions() {
                const aiDaimyos = this.gameState.daimyos.filter(d => d.id !== this.gameState.playerDaimyo);
                
                aiDaimyos.forEach(daimyo => {
                    const ownedTerritories = this.gameState.territories.filter(t => t.owner === daimyo.id);
                    if (ownedTerritories.length === 0) return;
                    
                    // å±±åŸã®çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
                    const yamashiro = this.gameState.territories.find(t => t.id === 'yamashiro');
                    const ownsYamashiro = yamashiro && yamashiro.owner === daimyo.id;
                    
                    // AIè¡Œå‹•ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå±±åŸå„ªå…ˆï¼‰
                    const borderTerritories = [];
                    let yamashiroTarget = null;
                    
                    ownedTerritories.forEach(territory => {
                        territory.adjacentTerritories.forEach(adjId => {
                            const adjTerritory = this.gameState.territories.find(t => t.id === adjId);
                            if (adjTerritory && adjTerritory.owner !== daimyo.id) {
                                // å±±åŸã¸ã®æ”»æ’ƒã¯è¿‘æ±Ÿãƒ»å¤§å’Œã‹ã‚‰ã®ã¿å¯èƒ½
                                if (adjTerritory.id === 'yamashiro') {
                                    if (territory.id === 'omi' || territory.id === 'yamato') {
                                        borderTerritories.push(adjTerritory);
                                        yamashiroTarget = adjTerritory;
                                    }
                                } else {
                                    borderTerritories.push(adjTerritory);
                                }
                            }
                        });
                    });
                    
                    let target = null;
                    let attackReason = '';
                    
                    if (yamashiroTarget && !ownsYamashiro) {
                        // å±±åŸãŒæ”»æ’ƒå¯èƒ½ã§ã€ã¾ã æŒã£ã¦ã„ãªã„å ´åˆã¯æœ€å„ªå…ˆ
                        target = yamashiroTarget;
                        attackReason = 'å¤©ä¸‹ã®ä¸­å¿ƒåœ°ãƒ»å±±åŸã‚’ç‹™ã„';
                    } else if (borderTerritories.length > 0) {
                        if (ownsYamashiro) {
                            // å±±åŸã‚’æ—¢ã«æŒã£ã¦ã„ã‚‹å ´åˆã¯é€šå¸¸ã®æ‹¡å¤§æˆ¦ç•¥
                            target = borderTerritories[Math.floor(Math.random() * borderTerritories.length)];
                            attackReason = 'å±±åŸã‚’æ‹ ç‚¹ã¨ã—ã¦é ˜åœŸæ‹¡å¤§ã‚’å›³ã‚Š';
                        } else {
                            // å±±åŸã‚’æŒã£ã¦ã„ãªã„å ´åˆã¯ã€å±±åŸã«è¿‘ã„é ˜åœŸã‚’å„ªå…ˆ
                            const yamashiroAdjacent = this.gameState.territories.find(t => t.id === 'yamashiro');
                            if (yamashiroAdjacent) {
                                const yamashiroNeighbors = borderTerritories.filter(t => 
                                    yamashiroAdjacent.adjacentTerritories.includes(t.id)
                                );
                                
                                if (yamashiroNeighbors.length > 0) {
                                    target = yamashiroNeighbors[Math.floor(Math.random() * yamashiroNeighbors.length)];
                                    attackReason = 'å±±åŸã¸ã®è¶³ãŒã‹ã‚Šã¨ã—ã¦';
                                } else {
                                    target = borderTerritories[Math.floor(Math.random() * borderTerritories.length)];
                                    attackReason = 'å¤©ä¸‹çµ±ä¸€ã®é‡æœ›ã‚’æŠ±ã';
                                }
                            } else {
                                target = borderTerritories[Math.floor(Math.random() * borderTerritories.length)];
                                attackReason = 'é ˜åœŸæ‹¡å¤§ã‚’å›³ã‚Š';
                            }
                        }
                    }
                    
                    // æ”»æ’ƒåˆ¤å®šï¼šå±±åŸã‚’ç‹™ã†å ´åˆã¯ç©æ¥µæ€§ã‚’ä¸Šã’ã‚‹
                    const baseAttackChance = target && target.id === 'yamashiro' ? 0.6 : 0.3;
                    
                    if (target && Math.random() < baseAttackChance) {
                        
                        // å¤–äº¤å”å®šãƒã‚§ãƒƒã‚¯ï¼šç›¸äº’ä¸å¯ä¾µæ¡ç´„ãŒã‚ã‚‹å ´åˆã¯æ”»æ’ƒã‚’æ§ãˆã‚‹
                        if (target.owner && this.gameState.diplomacyTreaties[daimyo.id] && 
                            this.gameState.diplomacyTreaties[daimyo.id].includes(target.owner)) {
                            this.gameState.turnEvents.push({
                                type: 'diplomacy',
                                message: `${daimyo.name}ã¯${target.name}ã¸ã®æ”»æ’ƒã‚’å¤–äº¤å”å®šã«ã‚ˆã‚Šæ§ãˆãŸ`
                            });
                            return; // æ”»æ’ƒã‚’ä¸­æ­¢
                        }
                        
                        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é ˜åœŸã¸ã®æ”»æ’ƒã®å ´åˆã€è™šå ±é˜²å¾¡ã‚’ãƒã‚§ãƒƒã‚¯
                        if (target.owner === this.gameState.playerDaimyo && this.gameState.rumorDefenseActive) {
                            const rumorRoll = Math.random() * 100;
                            
                            if (rumorRoll <= this.gameState.rumorActivationRate) {
                                // è™šå ±é˜²å¾¡æˆåŠŸ
                                this.gameState.turnEvents.push({
                                    type: 'strategy',
                                    message: `ã€è™šå ±ç™ºå‹•ã€‘${daimyo.name}ã®${target.name}ã¸ã®æ”»æ’ƒã‚’è™šå ±ã§æ’¹ä¹±ã—æ’ƒé€€ï¼`
                                });
                                
                                this.gameState.addLog(`è™šå ±é˜²å¾¡ç™ºå‹•ï¼${daimyo.name}ã®æ”»æ’ƒã‚’æ’¹ä¹±ã—ã¦è¿½ã„è¿”ã—ãŸ`, 'strategy');
                                return; // æ”»æ’ƒã‚’ç„¡åŠ¹åŒ–ã—ã¦å‡¦ç†çµ‚äº†
                            } else {
                                // è™šå ±é˜²å¾¡å¤±æ•—
                                this.gameState.turnEvents.push({
                                    type: 'strategy',
                                    message: `ã€è™šå ±å¤±æ•—ã€‘${daimyo.name}ãŒè™šå ±ã‚’è¦‹ç ´ã‚Š${target.name}ã¸ã®æ”»æ’ƒã‚’ç¶šè¡Œ`
                                });
                                
                                this.gameState.addLog(`è™šå ±é˜²å¾¡å¤±æ•—...${daimyo.name}ã«è™šå ±ã‚’è¦‹ç ´ã‚‰ã‚ŒãŸ`, 'strategy');
                                // æ”»æ’ƒå‡¦ç†ã¯ç¶šè¡Œ
                            }
                        }
                        
                        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç¹”ç”°ä¿¡é•·ã§é‰„ç ²å…µç§‘ã®å ´åˆã®å®ˆå‚™åŠ¹æœã‚’ãƒã‚§ãƒƒã‚¯
                        let nobunagaDefenseBonus = 1.0;
                        if (target.owner === this.gameState.playerDaimyo) {
                            const playerDaimyo = this.gameState.getPlayerDaimyoData();
                            if (playerDaimyo && playerDaimyo.skill === 'é©æ–°è€…' && target.unitType === 'arquebus') {
                                nobunagaDefenseBonus = Math.random() * 0.1 + 1.3; // 1.3-1.4å€
                                this.gameState.turnEvents.push({
                                    type: 'strategy',
                                    message: `ã€é‰„ç ²åæ’ƒç™ºå‹•ã€‘ç¹”ç”°ä¿¡é•·ã®é©æ–°çš„æˆ¦è¡“ã«ã‚ˆã‚Š${target.name}ã®é‰„ç ²éšŠãŒè¿æ’ƒæ…‹å‹¢ï¼åæ’ƒåŠ›${(nobunagaDefenseBonus * 100).toFixed(0)}%å¢—å¼·ï¼`
                                });
                            }
                        }
                        
                        // AIè»å›£æˆ¦åŠ›ã‚’è¨ˆç®—ï¼ˆæ­¦å°†ç·¨æˆã‚’è€ƒæ…®ï¼‰+ æ”»æ’ƒåŠ›å¼·åŒ–
                        let aiAttackPower = this.calculateAIBattlePower(daimyo) + 15; // +15æ”»æ’ƒãƒœãƒ¼ãƒŠã‚¹
                        
                        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é ˜åœŸã¸ã®æ”»æ’ƒæ™‚ã®é‰„å£ãƒã‚§ãƒƒã‚¯
                        let ironwallActivated = false;
                        let ironwallActivator = '';
                        
                        if (target.owner === this.gameState.playerDaimyo) {
                            try {
                                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é˜²å¾¡æ­¦å°†ã‚’åé›†
                                let playerDefenderGenerals = [];
                                
                                // åŸä¸»æ­¦å°†
                                if (target.generalGarrison) {
                                    const castleCommander = this.gameState.generals.find(g => g && g.id === target.generalGarrison);
                                    if (castleCommander) {
                                        playerDefenderGenerals.push(castleCommander);
                                    }
                                }
                                
                                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è»å›£æ­¦å°†
                                const playerMilitaryRoles = ['armyStrategist', 'vanguard', 'rightWing', 'leftWing', 'reserve'];
                                playerMilitaryRoles.forEach(roleKey => {
                                    const generalId = this.gameState.playerRoles[roleKey];
                                    if (generalId) {
                                        const general = this.gameState.generals.find(g => g && g.id === generalId);
                                        if (general) {
                                            playerDefenderGenerals.push(general);
                                        }
                                    }
                                });
                                
                                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å¤§åã‚‚è¿½åŠ 
                                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                                if (playerDaimyo) {
                                    playerDefenderGenerals.push(playerDaimyo);
                                }
                                
                                // é‰„å£ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¿ãƒ¼ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆç”¨ã®battleLogã‚’ä½œæˆï¼‰
                                const tempBattleLog = { events: [] };
                                const ironwallResult = this.checkIronwallDefense(playerDefenderGenerals, tempBattleLog);
                                
                                if (ironwallResult.activated) {
                                    ironwallActivated = true;
                                    ironwallActivator = ironwallResult.activator;
                                    aiAttackPower = Math.floor(aiAttackPower * ironwallResult.multiplier);
                                    
                                    // é‰„å£ç™ºå‹•ã‚’ã‚¿ãƒ¼ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã«è¿½åŠ 
                                    tempBattleLog.events.forEach(event => {
                                        if (event.message.includes('é‰„å£ã®é™£ã‚’æ•·ã“ã†ã¨ã—ã¦ã„ã‚‹')) {
                                            this.gameState.turnEvents.push({
                                                type: 'strategy',
                                                message: event.message
                                            });
                                        } else if (event.message.includes('ã€é‰„å£ç™ºå‹•ã€‘')) {
                                            this.gameState.turnEvents.push({
                                                type: 'defense',
                                                message: event.message
                                            });
                                        }
                                    });
                                }
                            } catch (error) {
                                console.warn('AIæˆ¦é—˜ã§ã®é‰„å£ãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                            }
                        }
                        
                        // æ­¦ç”°ä¿¡ç„ã®é¢¨æ—ç«å±±åŠ¹æœï¼šAIç‰ˆé¨é¦¬çªæ’ƒ
                        if (daimyo.skill === 'é¢¨æ—ç«å±±') {
                            const aiTerritories = this.gameState.territories.filter(t => t.owner === daimyo.id);
                            let aiMainUnit = 'infantry';
                            let maxTroops = 0;
                            
                            aiTerritories.forEach(territory => {
                                if (territory && territory.troops > maxTroops) {
                                    maxTroops = territory.troops;
                                    aiMainUnit = territory.unitType || 'infantry';
                                }
                            });
                            
                            if (aiMainUnit === 'cavalry') {
                                const chargeMultiplier = Math.random() * 0.4 + 1.1; // 1.1-1.5å€
                                aiAttackPower = Math.floor(aiAttackPower * chargeMultiplier);
                                
                                this.gameState.turnEvents.push({
                                    type: 'battle',
                                    message: `ã€é¨é¦¬çªæ’ƒç™ºå‹•ã€‘${daimyo.name}ã®é¢¨æ—ç«å±±ã«ã‚ˆã‚Šé¨é¦¬éšŠãŒç–¾é¢¨è¿…é›·ã®çªæ’ƒï¼æˆ¦åŠ›${(chargeMultiplier * 100).toFixed(0)}%å¢—å¼·ï¼`
                                });
                            }
                        }
                        
                        // AIæ”»æ’ƒå´ã®å£«æ°—è£œæ­£
                        const aiDaimyoCharm = daimyo.stats?.charm || 50;
                        let aiMorale = 1.0;
                        if (aiDaimyoCharm <= 79) {
                            aiMorale = 0.8;
                        } else {
                            aiMorale = 1.0 + (aiDaimyoCharm - 80) * 0.07;
                        }
                        
                        // AIå¾å¤·å¤§å°†è»åŠ¹æœï¼šå£«æ°—1.2å€
                        if (this.gameState.tenkaninStatus[daimyo.id]) {
                            aiMorale *= 1.2;
                            this.gameState.turnEvents.push({
                                type: 'battle',
                                message: `ã€å¾å¤·å¤§å°†è»ã€‘${daimyo.name}ã®è»ãŒå¹•åºœã®å¨å…‰ã«ã‚ˆã‚Šå£«æ°—1.2å€ã§é€²è»ï¼`
                            });
                        }
                        
                        const finalAiAttackPower = Math.floor(aiAttackPower * aiMorale);
                        
                        const troopDefensePower = Math.floor((target.troops || 0) / 10) + Math.random() * 10;
                        
                        // AIæ”»æ’ƒç”¨ã®åŸºæœ¬é˜²å¾¡åŠ›ã‚’å®šç¾©
                        const baseDefensePower = Math.floor((target.troops || 0) / 8) + Math.random() * 15;
                        
                        // AIæ­¦å°†ã®åå‰ã¨æ•°ã‚’å–å¾—
                        let aiGeneralsCount = 0;
                        let aiGeneralNames = [];
                        
                        try {
                            if (this.gameState.aiRoles && this.gameState.aiRoles[daimyo.id] && this.gameState.generals) {
                                const aiRoles = this.gameState.aiRoles[daimyo.id];
                                const assignedGeneralIds = Object.values(aiRoles).filter(id => {
                                    if (!id) return false;
                                    const general = this.gameState.generals.find(g => g && g.id === id && g.lord === daimyo.id);
                                    return general !== undefined;
                                });
                                
                                aiGeneralsCount = assignedGeneralIds.length;
                                
                                // æ­¦å°†åã‚’å–å¾—
                                assignedGeneralIds.forEach(generalId => {
                                    try {
                                        const general = this.gameState.generals.find(g => g && g.id === generalId && g.lord === daimyo.id);
                                        if (general && general.name) {
                                            aiGeneralNames.push(general.name);
                                        }
                                    } catch (error) {
                                        console.warn('AIæ­¦å°†åå–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                                    }
                                });
                            }
                        } catch (error) {
                            console.warn('AIæ­¦å°†æƒ…å ±å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                        }
                        
                        // æ”»æ’ƒé–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆæ­¦å°†åã‚’å«ã‚€ + å±±åŸã¸ã®é‡æœ›ï¼‰
                        let attackMessage = `${daimyo.name}ãŒ${attackReason}${target.name}ã«æ”»æ’ƒã‚’é–‹å§‹ï¼è»å›£æˆ¦åŠ›${Math.floor(finalAiAttackPower)} (å£«æ°—${(aiMorale * 100).toFixed(0)}%)`;
                        
                        try {
                            if (aiGeneralNames.length > 0) {
                                if (aiGeneralNames.length <= 2) {
                                    attackMessage += ` (${aiGeneralNames.join('ã€')}ãŒå‚æˆ¦)`;
                                } else if (aiGeneralNames.length <= 4) {
                                    attackMessage += ` (${aiGeneralNames.slice(0, 3).join('ã€')}ã‚‰ãŒå‚æˆ¦)`;
                                } else {
                                    attackMessage += ` (${aiGeneralNames.slice(0, 2).join('ã€')}ã‚‰${aiGeneralsCount}åãŒå‚æˆ¦)`;
                                }
                            } else if (aiGeneralsCount > 0) {
                                attackMessage += ` (æ­¦å°†${aiGeneralsCount}åå‚æˆ¦)`;
                            }
                        } catch (error) {
                            console.warn('æ”»æ’ƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                            if (aiGeneralsCount > 0) {
                                attackMessage += ` (æ­¦å°†${aiGeneralsCount}åå‚æˆ¦)`;
                            }
                        }
                        
                        this.gameState.turnEvents.push({
                            type: 'battle',
                            message: attackMessage
                        });
                        
                        if ((target.troops || 0) > 0) {
                            // ç¬¬1æ®µéš: å…µæ•°ã¸ã®æ”»æ’ƒ
                            if (finalAiAttackPower > troopDefensePower) {
                                const damage = Math.floor((finalAiAttackPower - troopDefensePower) * (Math.random() * 0.5 + 0.5));
                                const previousTroops = target.troops || 0;
                                target.troops = Math.max(0, (target.troops || 0) - damage);
                                
                                this.gameState.turnEvents.push({
                                    type: 'battle',
                                    message: `${target.name}ã®å®ˆå‚™å…µ${previousTroops}â†’${target.troops}ã«æ¸›å°‘`
                                });
                                
                                if (target.troops === 0) {
                                    this.gameState.turnEvents.push({
                                        type: 'battle',
                                        message: `${target.name}ã®å®ˆå‚™å…µãŒå…¨æ»…ï¼åŸå£ã¸ã®æ”»æ’ƒé–‹å§‹`
                                    });
                                }
                            } else {
                                this.gameState.turnEvents.push({
                                    type: 'battle',
                                    message: `${target.name}ã®å®ˆå‚™å…µãŒ${daimyo.name}ã®æ”»æ’ƒã‚’é˜²ã„ã `
                                });
                            }
                        }
                        
                        if ((target.troops || 0) === 0) {
                            // ç¬¬2æ®µéš: åŸå£ã¸ã®æ”»æ’ƒï¼ˆå…µæ•°ãŒ0ã®å ´åˆã®ã¿ï¼‰
                            let wallDefensePower = (Math.floor((target.walls || 0) / 5) + Math.random() * 10) * 3;
                            
                            // AIå¤§åãŒä¸Šæ‰è¬™ä¿¡ã®å ´åˆã€åŸå£å®ˆå‚™åŠ›ã‚‚åŠæ¸›
                            if (daimyo.skill === 'è»ç¥') {
                                wallDefensePower = Math.floor(wallDefensePower / 2);
                                this.gameState.turnEvents.push({
                                    type: 'battle',
                                    message: `ã€è»ç¥åŠ¹æœã€‘${daimyo.name}ã®ç¥å¨ã«ã‚ˆã‚ŠåŸå£å®ˆå‚™åŠ›ã‚‚åŠæ¸›ï¼`
                                });
                            }
                            
                            if (finalAiAttackPower > wallDefensePower) {
                                const wallDamage = Math.floor((finalAiAttackPower - wallDefensePower) * (Math.random() * 0.4 + 0.3));
                                const previousWalls = target.walls || 0;
                                target.walls = Math.max(0, (target.walls || 0) - wallDamage);
                                
                                this.gameState.turnEvents.push({
                                    type: 'battle',
                                    message: `${target.name}ã®åŸå£${previousWalls}â†’${target.walls}ã«ç ´å£Š`
                                });
                                
                                if (target.walls <= 0) {
                                    // åŸå£ç ´å£Šã§é ˜åœŸé™¥è½
                                    const previousOwner = target.owner ? 
                                        this.gameState.daimyos.find(d => d && d.id === target.owner)?.name || 'ä¸æ˜å‹¢åŠ›' : 
                                        'ç©ºç™½åœ°';
                                    
                                    target.owner = daimyo.id;
                                    target.troops = Math.floor(finalAiAttackPower / 5);
                                    target.walls = 100; // å¥ªå–ç›´å¾Œã¯100ã‚¹ã‚¿ãƒ¼ãƒˆ
                                    
                                    // AIå¤§åã®å¾—æ„å…µç§‘ã‚’è¨­å®š
                                    if (daimyo.preferredUnit) {
                                        target.unitType = daimyo.preferredUnit;
                                    } else {
                                        target.unitType = 'infantry'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ­©å…µ
                                    }
                                    
                                    // æ–°ã—ãç²å¾—ã—ãŸé ˜åœŸã«AIæ­¦å°†ã‚’é…ç½®
                                    this.assignNewTerritoryGeneral(daimyo.id, target);
                                    
                                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒé ˜åœŸã‚’å¤±ã£ãŸå ´åˆã®å¿ èª åº¦æ¸›å°‘
                                    if (previousOwner === this.gameState.playerDaimyo) {
                                        try {
                                            const playerGenerals = this.gameState.generals.filter(g => g && g.lord === this.gameState.playerDaimyo);
                                            if (playerGenerals.length > 0) {
                                                if (target.id === 'yamashiro') {
                                                    // å±±åŸå¤±é™¥æ™‚ï¼šå¤©ä¸‹äººã ã£ãŸå ´åˆã¯å¤§ããªãƒšãƒŠãƒ«ãƒ†ã‚£
                                                    const wasTenkanin = this.gameState.tenkaninStatus[this.gameState.playerDaimyo];
                                                    const loyaltyPenalty = wasTenkanin ? 30 : 15;
                                                    
                                                    playerGenerals.forEach(general => {
                                                        if (general && typeof general.loyalty === 'number') {
                                                            general.loyalty = Math.max(0, general.loyalty - loyaltyPenalty);
                                                        }
                                                    });
                                                    
                                                    if (wasTenkanin) {
                                                        this.gameState.addLog(`ğŸ’”å¤©ä¸‹äººã®åœ°ä½ã‚’å¤±ã£ãŸï¼å±±åŸå¤±é™¥ã«ã‚ˆã‚Šå¨ä¿¡ãŒå¤±å¢œ...`, 'strategy');
                                                        this.gameState.addLog(`å…¨æ­¦å°†ã®å¿ èª åº¦ãŒå¤§å¹…ä½ä¸‹ã€‚å¤©ä¸‹çµ±ä¸€ã¸ã®é“ã®ã‚ŠãŒé ã®ã„ãŸ`, 'strategy');
                                                        this.gameState.addPersonnelLog(`å¤©ä¸‹äººå¤±å¢œã«ã‚ˆã‚Šå…¨æ­¦å°†ã®å¿ èª åº¦-${loyaltyPenalty}`);
                                                    } else {
                                                        this.gameState.addLog(`ğŸ’”å¤©ä¸‹ã®ä¸­å¿ƒåœ°ãƒ»å±±åŸã‚’å¤±é™¥ï¼æ­¦å°†ã®å¿ èª åº¦ãŒå¤§å¹…ä½ä¸‹...`, 'strategy');
                                                        this.gameState.addPersonnelLog(`å±±åŸå¤±é™¥ã«ã‚ˆã‚Šå…¨æ­¦å°†ã®å¿ èª åº¦-${loyaltyPenalty}`);
                                                    }
                                                    
                                                    // å±±åŸå¤±é™¥ã®ç‰¹åˆ¥ãªå½±éŸ¿
                                                    this.gameState.addLog(`å¤©ä¸‹ã¸ã®é‡æœ›ãŒå¤§ããå¾Œé€€ã—ãŸ...`, 'strategy');
                                                } else {
                                                    const loyaltyPenalty = 5;
                                                    playerGenerals.forEach(general => {
                                                        if (general && typeof general.loyalty === 'number') {
                                                            general.loyalty = Math.max(0, general.loyalty - loyaltyPenalty);
                                                        }
                                                    });
                                                    this.gameState.addLog(`é ˜åœŸå¤±é™¥ã«ã‚ˆã‚Šæ­¦å°†ã®å£«æ°—ä½ä¸‹...`, 'strategy');
                                                    this.gameState.addPersonnelLog(`é ˜åœŸå¤±é™¥ã«ã‚ˆã‚Šå…¨æ­¦å°†ã®å¿ èª åº¦-${loyaltyPenalty}`);
                                                }
                                            }
                                        } catch (error) {
                                            console.warn('é ˜åœŸå¤±é™¥æ™‚ã®å¿ èª åº¦æ¸›å°‘å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                                        }
                                    }
                                    
                                    // ä»–ã®AIå¤§åãŒå±±åŸã‚’å¤±ã£ãŸå ´åˆã®ç‰¹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                                    if (target.id === 'yamashiro' && previousOwner !== this.gameState.playerDaimyo && previousOwner !== 'ç©ºç™½åœ°') {
                                        const previousDaimyoName = this.gameState.daimyos.find(d => d && d.id === previousOwner)?.name || 'ä¸æ˜å‹¢åŠ›';
                                        const wasPreviousShogun = this.gameState.tenkaninStatus[previousOwner];
                                        
                                        if (wasPreviousShogun) {
                                            this.gameState.turnEvents.push({
                                                type: 'battle',
                                                message: `ğŸ›ï¸å¾å¤·å¤§å°†è»${previousDaimyoName}ãŒå±±åŸã‚’å¤±ã„ã€å¹•åºœãŒå´©å£Šã—ãŸï¼å¤©ä¸‹ã®è¦‡æ¨©ãŒç§»å‹•ã—ã¦ã„ã‚‹`
                                            });
                                        } else {
                                            this.gameState.turnEvents.push({
                                                type: 'battle',
                                                message: `${previousDaimyoName}ãŒå¤©ä¸‹ã®è¦‡æ¨©ã‚’å¤±ã„ã€å„åœ°ã®æƒ…å‹¢ãŒä¸€å¤‰ã—ãŸï¼`
                                            });
                                        }
                                    }
                                    
                                    let conquestMessage = `${daimyo.name}ãŒ${target.name}ã‚’æ”»ç•¥ï¼`;
                                    if (previousOwner !== 'ç©ºç™½åœ°') {
                                        conquestMessage += `${previousOwner}ã®æ”¯é…ã‹ã‚‰å¥ªå–ã—ãŸã€‚`;
                                    } else {
                                        conquestMessage += 'ç©ºç™½åœ°ã‚’æ–°é ˜åœŸã¨ã—ã¦ç¢ºä¿ã€‚';
                                    }
                                    
                                    // æ­¦å°†ã®æ´»èºã‚’å…·ä½“çš„ã«è¡¨ç¤º
                                    try {
                                        if (aiGeneralNames.length > 0) {
                                            if (aiGeneralNames.length <= 2) {
                                                conquestMessage += ` ${aiGeneralNames.join('ã€')}ãŒå¥®æˆ¦ã—ãŸã€‚`;
                                            } else if (aiGeneralNames.length <= 3) {
                                                conquestMessage += ` ${aiGeneralNames.join('ã€')}ã‚‰ãŒå¥®æˆ¦ã—ãŸã€‚`;
                                            } else {
                                                conquestMessage += ` ${aiGeneralNames.slice(0, 2).join('ã€')}ã‚‰${aiGeneralsCount}åãŒå¥®æˆ¦ã—ãŸã€‚`;
                                            }
                                        } else if (aiGeneralsCount > 0) {
                                            conquestMessage += ` é…ä¸‹æ­¦å°†${aiGeneralsCount}åãŒå¥®æˆ¦ã—ãŸã€‚`;
                                        }
                                    } catch (error) {
                                        console.warn('AIæ”»ç•¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                                        if (aiGeneralsCount > 0) {
                                            conquestMessage += ` é…ä¸‹æ­¦å°†${aiGeneralsCount}åãŒå¥®æˆ¦ã—ãŸã€‚`;
                                        }
                                    }
                                    
                                    this.gameState.turnEvents.push({
                                        type: 'battle',
                                        message: conquestMessage
                                    });
                                } else {
                                    this.gameState.turnEvents.push({
                                        type: 'battle',
                                        message: `${daimyo.name}ãŒ${target.name}ã®åŸå£ã«æå‚·ã‚’ä¸ãˆãŸãŒé™¥è½ã«ã¯è‡³ã‚‰ãš`
                                    });
                                }
                            } else {
                                this.gameState.turnEvents.push({
                                    type: 'battle',
                                    message: `${target.name}ã®åŸå£ãŒå …å›ºã§${daimyo.name}ã®æ”»æ’ƒã‚’é˜²ã„ã `
                                });
                            }
                        }
                    }
                });
            }
            
            showTurnLog() {
                document.getElementById('turn-log-screen').classList.remove('hidden');
                
                // è¡Œå‹•ãƒ­ã‚°ã‚’è¡¨ç¤º
                const actionEventsContainer = document.getElementById('action-events');
                if (actionEventsContainer) {
                    if (this.gameState.turnEvents.length === 0) {
                        actionEventsContainer.innerHTML = '<div class="no-events">å¹³ç©ãªä¸€å¹´ãŒéããŸ...</div>';
                    } else {
                        actionEventsContainer.innerHTML = this.gameState.turnEvents.map(event => 
                            `<div class="event-entry">${event.message}</div>`
                        ).join('');
                    }
                    
                    // è¿½åŠ ã®è¿«åŠ›ã‚ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ
                    const dramaticEvents = [
                        'æ­¦å°†ãŸã¡ãŒæ¿€ã—ãåˆ€ã‚’äº¤ãˆãŸï¼',
                        'æˆ¦å ´ã«é›„å«ã³ãŒéŸ¿ãæ¸¡ã‚‹ï¼',
                        'åŸå£ãŒå´©ã‚Œè½ã¡ã‚‹éŸ³ãŒè½Ÿã„ãŸï¼',
                        'é¨é¦¬éšŠãŒå¤§åœ°ã‚’é§†ã‘æŠœã‘ãŸï¼',
                        'è»å¸«ã®ç­–ç•¥ãŒåŠŸã‚’å¥ã—ãŸï¼'
                    ];
                    
                    if (this.gameState.turnEvents.length > 0 && Math.random() < 0.7) {
                        const dramaticEvent = dramaticEvents[Math.floor(Math.random() * dramaticEvents.length)];
                        actionEventsContainer.innerHTML += `<div class="event-entry">${dramaticEvent}</div>`;
                    }
                }
                
                // äººäº‹ãƒ­ã‚°ã‚’è¡¨ç¤º
                const personnelEventsContainer = document.getElementById('personnel-events');
                if (personnelEventsContainer) {
                    if (!this.gameState.personnelEvents || this.gameState.personnelEvents.length === 0) {
                        personnelEventsContainer.innerHTML = '<div class="no-events">äººäº‹é–¢é€£ã®å‹•ãã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
                    } else {
                        try {
                            // äººäº‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç¨®é¡åˆ¥ã«åˆ†é¡ã—ã¦è¡¨ç¤º
                            const playerDaimyo = this.gameState.getPlayerDaimyoData();
                            const playerName = playerDaimyo ? playerDaimyo.name : '';
                            
                            const playerEvents = this.gameState.personnelEvents.filter(e => 
                                playerName && (e.message.includes(playerName) ||
                                (!e.message.includes('ãŒ') && !e.message.includes('ã‚’')))
                            );
                            const aiEvents = this.gameState.personnelEvents.filter(e => !playerEvents.includes(e));
                            
                            let html = '';
                            
                            if (playerEvents.length > 0) {
                                html += '<div style="color: #66ff66; font-weight: bold; margin-bottom: 8px;">ã€è‡ªå‹¢åŠ›ã€‘</div>';
                                html += playerEvents.map(event => 
                                    `<div class="event-entry" style="margin-left: 10px;">${event.message}</div>`
                                ).join('');
                            }
                            
                            if (aiEvents.length > 0) {
                                html += '<div style="color: #ffaa66; font-weight: bold; margin: 8px 0;">ã€ä»–å‹¢åŠ›ã€‘</div>';
                                html += aiEvents.map(event => 
                                    `<div class="event-entry" style="margin-left: 10px; color: #ccc;">${event.message}</div>`
                                ).join('');
                            }
                            
                            if (html === '') {
                                html = '<div class="no-events">äººäº‹é–¢é€£ã®å‹•ãã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
                            }
                            
                            personnelEventsContainer.innerHTML = html;
                        } catch (error) {
                            console.warn('äººäº‹ãƒ­ã‚°è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                            personnelEventsContainer.innerHTML = '<div class="no-events">äººäº‹ãƒ­ã‚°ã®è¡¨ç¤ºã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
                        }
                    }
                }
            }
            
            hideTurnLog() {
                document.getElementById('turn-log-screen').classList.add('hidden');
                this.renderMap();
                this.updateStatus();
            }
            
            showGeneralsModal() {
                document.getElementById('generals-modal').style.display = 'flex';
                this.initializeGeneralsModal();
            }
            
            hideGeneralsModal() {
                document.getElementById('generals-modal').style.display = 'none';
            }
            
            showRecruitGeneralModal() {
                document.getElementById('recruit-general-modal').style.display = 'flex';
                this.updateAvailableGeneralsList();
            }
            
            hideRecruitGeneralModal() {
                document.getElementById('recruit-general-modal').style.display = 'none';
            }
            
            showScoutModal() {
                try {
                    const target = this.gameState.selectedTerritory;
                    if (!target) {
                        this.gameState.addLog('åµå¯Ÿå¯¾è±¡ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                        return;
                    }
                    
                    if (target.owner === this.gameState.playerDaimyo) {
                        this.gameState.addLog('è‡ªé ˜åœŸã¯åµå¯Ÿã§ãã¾ã›ã‚“');
                        return;
                    }
                    
                    this.displayScoutInfo(target);
                    document.getElementById('scout-modal').style.display = 'flex';
                    
                    // åµå¯Ÿãƒ­ã‚°
                    const targetOwner = target.owner ? 
                        this.gameState.daimyos.find(d => d && d.id === target.owner)?.name || 'ä¸æ˜å‹¢åŠ›' : 
                        'ç©ºç™½åœ°';
                    
                    let scoutMessage = `${target.name}(${targetOwner})ã‚’åµå¯Ÿ`;
                    
                    // è²¡æ”¿æƒ…å ±ã‚’å«ã‚ã‚‹
                    if (target.owner) {
                        const ownerData = this.gameState.daimyos.find(d => d && d.id === target.owner);
                        if (ownerData) {
                            scoutMessage += ` - é‡‘${ownerData.gold || 0} ç±³${ownerData.rice || 0}ã‚’ç¢ºèª`;
                        }
                    }
                    
                    this.gameState.addLog(scoutMessage, 'strategy');
                } catch (error) {
                    console.error('åµå¯Ÿãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                    this.gameState.addLog('åµå¯Ÿä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            }
            
            hideScoutModal() {
                document.getElementById('scout-modal').style.display = 'none';
            }
            
            displayScoutInfo(target) {
                try {
                    const targetInfo = document.getElementById('scout-target-info');
                    const generalsInfo = document.getElementById('scout-generals-info');
                    
                    if (!targetInfo || !generalsInfo) {
                        console.error('åµå¯Ÿãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        return;
                    }
                    
                    // å¯¾è±¡é ˜åœŸã®æƒ…å ±
                    const targetOwner = target.owner ? 
                        this.gameState.daimyos.find(d => d && d.id === target.owner) : 
                        null;
                    
                    let targetInfoHtml = `
                        <div style="background: #333; border: 1px solid #666; border-radius: 8px; padding: 15px;">
                            <h3 style="color: #ff6666; margin-bottom: 10px; text-align: center;">ã€${target.name} åµå¯Ÿå ±å‘Šã€‘</h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 13px;">
                                <div><strong>æ”¯é…è€…:</strong> ${targetOwner ? targetOwner.name : 'ç©ºç™½åœ°'}</div>
                                <div><strong>å®ˆå‚™å…µ:</strong> ${target.troops || 0}</div>
                                <div><strong>åŸå£å¼·åº¦:</strong> ${target.walls || 0}</div>
                                <div><strong>è¾²æ¥­:</strong> ${target.agriculture || 0}</div>
                                <div><strong>å•†æ¥­:</strong> ${target.commerce || 0}</div>
                                <div><strong>æ‹…å½“æ­¦å°†:</strong> ${this.getGeneralName(target.generalGarrison) || 'æœªé…ç½®'}</div>
                            </div>
                    `;
                    
                    // å¤§åã®è³‡é‡‘æƒ…å ±ã‚’è¿½åŠ 
                    if (targetOwner) {
                        targetInfoHtml += `
                            <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #666;">
                                <h4 style="color: #ffff66; margin-bottom: 8px; text-align: center;">ã€è²¡æ”¿çŠ¶æ³ã€‘</h4>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 13px;">
                                    <div><strong>ä¿æœ‰é‡‘:</strong> <span style="color: #ffff66;">${targetOwner.gold || 0}</span></div>
                                    <div><strong>ä¿æœ‰ç±³:</strong> <span style="color: #66ff66;">${targetOwner.rice || 0}</span></div>
                                </div>
                                <div style="text-align: center; margin-top: 8px; font-size: 11px; color: #ccc;">
                                    â€»è«œå ±ç¶²ã«ã‚ˆã‚‹æ¨å®šå€¤
                                </div>
                            </div>
                        `;
                    }
                    
                    targetInfoHtml += `</div>`;
                    
                    targetInfo.innerHTML = targetInfoHtml;
                    
                    // æ­¦å°†æƒ…å ±
                    if (targetOwner && targetOwner.id) {
                        this.displayEnemyGenerals(targetOwner.id, generalsInfo);
                    } else {
                        generalsInfo.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">ç©ºç™½åœ°ã®ãŸã‚æ­¦å°†æƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                    }
                } catch (error) {
                    console.error('åµå¯Ÿæƒ…å ±è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                    const targetInfo = document.getElementById('scout-target-info');
                    const generalsInfo = document.getElementById('scout-generals-info');
                    
                    if (targetInfo) {
                        targetInfo.innerHTML = '<div style="color: #ff6666; text-align: center;">åµå¯Ÿæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
                    }
                    if (generalsInfo) {
                        generalsInfo.innerHTML = '<div style="color: #ff6666; text-align: center;">æ­¦å°†æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
                    }
                }
            }
            
            getGeneralName(generalId) {
                try {
                    if (!generalId || !this.gameState.generals) return null;
                    
                    const general = this.gameState.generals.find(g => g && g.id === generalId);
                    return general ? general.name : null;
                } catch (error) {
                    console.warn('æ­¦å°†åå–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                    return null;
                }
            }
            
            displayEnemyGenerals(daimyoId, container) {
                try {
                    if (!daimyoId || !container || !this.gameState.generals) {
                        if (container) {
                            container.innerHTML = '<div style="color: #888; text-align: center;">æ­¦å°†æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“</div>';
                        }
                        return;
                    }
                    
                    // æ•µã®æ­¦å°†ã‚’å–å¾—
                    const enemyGenerals = this.gameState.generals.filter(g => g && g.lord === daimyoId);
                    
                    if (enemyGenerals.length === 0) {
                        container.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">é…ä¸‹æ­¦å°†ãªã—</div>';
                        return;
                    }
                    
                    // æ•µã®å½¹è·æƒ…å ±ã‚’å–å¾—
                    const enemyRoles = this.gameState.aiRoles && this.gameState.aiRoles[daimyoId] ? 
                        this.gameState.aiRoles[daimyoId] : {};
                    
                    let generalsHtml = `
                        <div style="background: #222; border: 1px solid #666; border-radius: 8px; padding: 15px;">
                            <h4 style="color: #ff6666; margin-bottom: 15px; text-align: center;">é…ä¸‹æ­¦å°†ä¸€è¦§ (${enemyGenerals.length}å)</h4>
                    `;
                    
                    // å½¹è·é…ç½®æƒ…å ±
                    const roleNames = {
                        'strategist': 'å‚è¬€',
                        'diplomat': 'å¤–äº¤æ‹…å½“',
                        'administrator': 'äººäº‹ç·ç›£',
                        'kenchiCommissioner': 'æ¤œåœ°å¥‰è¡Œ',
                        'riceCommissioner': 'ç±³å¥‰è¡Œ',
                        'townCommissioner': 'ç”ºå¥‰è¡Œ',
                        'goldCommissioner': 'é‡‘å¥‰è¡Œ',
                        'constructionCommissioner': 'æ™®è«‹å¥‰è¡Œ',
                        'militaryCommissioner': 'å…µå¥‰è¡Œ',
                        'armyStrategist': 'è»å›£è»å¸«',
                        'vanguard': 'å‰è¡›',
                        'rightWing': 'å³ç¿¼',
                        'leftWing': 'å·¦ç¿¼',
                        'reserve': 'å¾Œè©°'
                    };
                    
                    // å½¹è·æƒ…å ±ã‚’è¡¨ç¤º
                    generalsHtml += '<div style="margin-bottom: 20px; background: #333; padding: 10px; border-radius: 5px;">';
                    generalsHtml += '<h5 style="color: #66ff66; margin-bottom: 10px;">å½¹è·é…ç½®</h5>';
                    generalsHtml += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 12px;">';
                    
                    Object.entries(roleNames).forEach(([roleKey, roleName]) => {
                        try {
                            const assignedGeneralId = enemyRoles[roleKey];
                            let assignedGeneralName = 'æœªè¨­å®š';
                            
                            if (assignedGeneralId) {
                                const assignedGeneral = enemyGenerals.find(g => g && g.id === assignedGeneralId);
                                if (assignedGeneral) {
                                    assignedGeneralName = assignedGeneral.name || 'ç„¡åæ­¦å°†';
                                }
                            }
                            
                            generalsHtml += `<div><strong>${roleName}:</strong> ${assignedGeneralName}</div>`;
                        } catch (error) {
                            console.warn(`å½¹è·${roleKey}ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼:`, error);
                            generalsHtml += `<div><strong>${roleName}:</strong> ä¸æ˜</div>`;
                        }
                    });
                    
                    generalsHtml += '</div></div>';
                    
                    // æ­¦å°†è©³ç´°ãƒªã‚¹ãƒˆ
                    generalsHtml += '<div style="max-height: 400px; overflow-y: auto;">';
                    
                    enemyGenerals.forEach((general, index) => {
                        try {
                            if (!general) return;
                            
                            // ã“ã®æ­¦å°†ã®å½¹è·ã‚’ç‰¹å®š
                            let currentRoles = [];
                            Object.entries(enemyRoles).forEach(([roleKey, assignedId]) => {
                                if (assignedId === general.id && roleNames[roleKey]) {
                                    currentRoles.push(roleNames[roleKey]);
                                }
                            });
                            
                            // é ˜åœŸæ‹…å½“ãƒã‚§ãƒƒã‚¯
                            const assignedTerritories = this.gameState.territories.filter(t => 
                                t && t.generalGarrison === general.id
                            );
                            
                            if (assignedTerritories.length > 0) {
                                const territoryNames = assignedTerritories.map(t => t.name).join('ã€');
                                currentRoles.push(`${territoryNames}æ‹…å½“`);
                            }
                            
                            const roleText = currentRoles.length > 0 ? currentRoles.join('ã€') : 'å¾…æ©Ÿä¸­';
                            const roleColor = currentRoles.length > 0 ? '#66ff66' : '#888';
                            
                            generalsHtml += `
                                <div style="background: #333; border: 1px solid #555; border-radius: 5px; padding: 12px; margin-bottom: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <div style="font-weight: bold; color: #ff6666; font-size: 15px;">${general.name || 'ç„¡åæ­¦å°†'}</div>
                                        <div style="color: ${roleColor}; font-size: 11px;">${roleText}</div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 12px; margin-bottom: 8px;">
                                        <div><span>æˆ¦é—˜:</span> <span style="color: #ffaa66;">${general.stats?.battle || 0}</span></div>
                                        <div><span>çµ±ç‡:</span> <span style="color: #ffaa66;">${general.stats?.command || 0}</span></div>
                                        <div><span>æ”¿æ²»:</span> <span style="color: #ffaa66;">${general.stats?.politics || 0}</span></div>
                                        <div><span>çŸ¥è¬€:</span> <span style="color: #ffaa66;">${general.stats?.intelligence || 0}</span></div>
                                        <div><span>é­…åŠ›:</span> <span style="color: #ffaa66;">${general.stats?.charm || 0}</span></div>
                                        <div><span>å¿ èª :</span> <span style="color: #ffff66;">${general.loyalty || 0}</span></div>
                                    </div>
                                    <div style="color: #66ff66; font-size: 12px;">
                                        <strong>ç‰¹æŠ€:</strong> ${general.skill || 'ç‰¹æŠ€ãªã—'}
                                    </div>
                                </div>
                            `;
                        } catch (error) {
                            console.warn(`æ­¦å°†${general?.name || index}ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼:`, error);
                            generalsHtml += `
                                <div style="background: #333; border: 1px solid #555; border-radius: 5px; padding: 12px; margin-bottom: 8px;">
                                    <div style="color: #ff6666;">æ­¦å°†æƒ…å ±ã®è¡¨ç¤ºã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>
                                </div>
                            `;
                        }
                    });
                    
                    generalsHtml += '</div></div>';
                    
                    container.innerHTML = generalsHtml;
                } catch (error) {
                    console.error('æ•µæ­¦å°†è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                    if (container) {
                        container.innerHTML = '<div style="color: #ff6666; text-align: center; padding: 20px;">æ­¦å°†æƒ…å ±ã®è¡¨ç¤ºã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
                    }
                }
            }
            
            showBattleLogModal() {
                document.getElementById('battle-log-modal').style.display = 'flex';
            }
            
            hideBattleLogModal() {
                document.getElementById('battle-log-modal').style.display = 'none';
            }
            
            displayBattleLog(battleLog) {
                try {
                    // æ”»æ’ƒå´æƒ…å ±ã‚’è¡¨ç¤º
                    const attackerDetails = document.getElementById('attacker-details');
                    if (!attackerDetails) {
                        return;
                    }
                    
                    let attackerHtml = `
                        <div><strong>${battleLog.attacker?.name || 'ä¸æ˜'}</strong></div>
                        <div class="participant-stats">
                            <div><span>åŸºæœ¬æˆ¦åŠ›:</span><span class="power-display">${battleLog.attacker?.basePower || 0}</span></div>
                            <div><span>ç·åˆæˆ¦åŠ›:</span><span class="power-display">${battleLog.attacker?.totalPower || 0}</span></div>
                    `;
                    
                    if (battleLog.attacker?.generals && Array.isArray(battleLog.attacker.generals) && battleLog.attacker.generals.length > 0) {
                        attackerHtml += '<div style="margin-top: 10px; color: #66ff66;"><strong>å‚æˆ¦æ­¦å°†:</strong></div>';
                        battleLog.attacker.generals.forEach(general => {
                            if (general && general.name) {
                                const roleNames = {
                                    'armyStrategist': 'è»å¸«', 'vanguard': 'å‰è¡›', 
                                    'rightWing': 'å³ç¿¼', 'leftWing': 'å·¦ç¿¼', 'reserve': 'å¾Œè©°'
                                };
                                const roleName = roleNames[general.role] || general.role || 'ä¸æ˜';
                                const skillText = general.skill && general.skill !== 'ç‰¹æŠ€ãªã—' ? ` ç‰¹æŠ€:${general.skill}` : '';
                                attackerHtml += `<div style="font-size: 11px; margin-left: 10px;">ãƒ»${general.name}(${roleName}) æˆ¦${general.battle || 0} çµ±${general.command || 0}${skillText}</div>`;
                            }
                        });
                    }
                    
                    attackerHtml += '</div>';
                    attackerDetails.innerHTML = attackerHtml;
                    
                    // é˜²å¾¡å´æƒ…å ±ã‚’è¡¨ç¤º
                    const defenderDetails = document.getElementById('defender-details');
                    if (defenderDetails) {
                        let defenderHtml = `
                            <div><strong>${battleLog.defender?.name || 'ä¸æ˜'}</strong></div>
                            <div class="participant-stats">
                                <div><span>åŸºæœ¬æˆ¦åŠ›:</span><span class="power-display">${battleLog.defender?.basePower || 0}</span></div>
                                <div><span>å®ˆå‚™å…µ:</span><span class="damage-display">${battleLog.defender?.troops || 0}</span></div>
                                <div><span>åŸå£å¼·åº¦:</span><span class="damage-display">${battleLog.defender?.walls || 0}</span></div>
                        `;
                        
                        if (battleLog.defender?.generals && Array.isArray(battleLog.defender.generals) && battleLog.defender.generals.length > 0) {
                            defenderHtml += '<div style="margin-top: 10px; color: #ff6666;"><strong>å‚æˆ¦æ­¦å°†:</strong></div>';
                            battleLog.defender.generals.forEach(general => {
                                if (general && general.name) {
                                    const roleNames = {
                                        'armyStrategist': 'è»å¸«', 'vanguard': 'å‰è¡›', 
                                        'rightWing': 'å³ç¿¼', 'leftWing': 'å·¦ç¿¼', 'reserve': 'å¾Œè©°'
                                    };
                                    const roleName = roleNames[general.role] || general.role || 'ä¸æ˜';
                                    const skillText = general.skill && general.skill !== 'ç‰¹æŠ€ãªã—' ? ` ç‰¹æŠ€:${general.skill}` : '';
                                    defenderHtml += `<div style="font-size: 11px; margin-left: 10px;">ãƒ»${general.name}(${roleName}) æˆ¦${general.battle || 0} çµ±${general.command || 0}${skillText}</div>`;
                                }
                            });
                        }
                        
                        defenderHtml += '</div>';
                        defenderDetails.innerHTML = defenderHtml;
                    }
                } catch (error) {
                    // æˆ¦é—˜å‚åŠ è€…æƒ…å ±è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ç¶™ç¶š
                }
                
                try {
                    // æˆ¦é—˜ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ã‚’è¡¨ç¤º
                    const battleEvents = document.getElementById('battle-events-log');
                    if (!battleEvents) {
                        return;
                    }
                    
                    battleEvents.innerHTML = '';
                    
                    // é€šå¸¸ã®æˆ¦é—˜ã‚¤ãƒ™ãƒ³ãƒˆ
                    if (battleLog.events && Array.isArray(battleLog.events)) {
                        battleLog.events.forEach(event => {
                            if (event && event.message) {
                                const eventDiv = document.createElement('div');
                                eventDiv.className = `battle-event ${event.type || 'normal'}`;
                                eventDiv.textContent = event.message;
                                battleEvents.appendChild(eventDiv);
                            }
                        });
                    }
                    
                    // æ­¦å°†ã®æ´»èºã‚’è¡¨ç¤ºï¼ˆæ”»æ’ƒå´ã¨é˜²å¾¡å´ã‚’åˆ†ã‘ã¦è¡¨ç¤ºï¼‰
                    if (battleLog.generalActivities && Array.isArray(battleLog.generalActivities) && battleLog.generalActivities.length > 0) {
                        const attackerActivities = battleLog.generalActivities.filter(activity => 
                            activity && (!activity.side || activity.side === 'attacker')
                        );
                        const defenderActivities = battleLog.generalActivities.filter(activity => 
                            activity && activity.side === 'defender'
                        );
                        
                        // æ”»æ’ƒå´ã®æ´»èº
                        if (attackerActivities.length > 0) {
                            const activitiesHeader = document.createElement('div');
                            activitiesHeader.className = 'battle-event';
                            activitiesHeader.style.backgroundColor = '#003366';
                            activitiesHeader.style.borderLeftColor = '#66ccff';
                            activitiesHeader.style.fontWeight = 'bold';
                            activitiesHeader.style.marginTop = '15px';
                            activitiesHeader.textContent = 'ã€æ”»æ’ƒè»æ­¦å°†ã®æ´»èºã€‘';
                            battleEvents.appendChild(activitiesHeader);
                            
                            attackerActivities.forEach(activity => {
                                if (activity && activity.name && activity.action) {
                                    const activityDiv = document.createElement('div');
                                    activityDiv.className = 'battle-event';
                                    activityDiv.style.backgroundColor = '#001133';
                                    activityDiv.style.borderLeftColor = '#66ccff';
                                    activityDiv.style.marginLeft = '10px';
                                    activityDiv.textContent = `${activity.name}(${activity.role || 'ä¸æ˜'})ãŒ${activity.action}ã—ã€æˆ¦åŠ›${activity.contribution || 0}ã‚’ç™ºæ®ï¼`;
                                    battleEvents.appendChild(activityDiv);
                                }
                            });
                        }
                        
                        // é˜²å¾¡å´ã®æ´»èº
                        if (defenderActivities.length > 0) {
                            const defenderActivitiesHeader = document.createElement('div');
                            defenderActivitiesHeader.className = 'battle-event';
                            defenderActivitiesHeader.style.backgroundColor = '#330000';
                            defenderActivitiesHeader.style.borderLeftColor = '#ff6666';
                            defenderActivitiesHeader.style.fontWeight = 'bold';
                            defenderActivitiesHeader.style.marginTop = '15px';
                            defenderActivitiesHeader.textContent = 'ã€å®ˆå‚™è»æ­¦å°†ã®æ´»èºã€‘';
                            battleEvents.appendChild(defenderActivitiesHeader);
                            
                            defenderActivities.forEach(activity => {
                                if (activity && activity.name && activity.action) {
                                    const activityDiv = document.createElement('div');
                                    activityDiv.className = 'battle-event';
                                    activityDiv.style.backgroundColor = '#110000';
                                    activityDiv.style.borderLeftColor = '#ff6666';
                                    activityDiv.style.marginLeft = '10px';
                                    activityDiv.textContent = `${activity.name}(${activity.role || 'ä¸æ˜'})ãŒ${activity.action}ã—ã€æˆ¦åŠ›${activity.contribution || 0}ã‚’ç™ºæ®ï¼`;
                                    battleEvents.appendChild(activityDiv);
                                }
                            });
                        }
                    }
                    
                    // ç‰¹æŠ€ç™ºå‹•ã‚’è¡¨ç¤ºï¼ˆæ”»æ’ƒå´ã¨é˜²å¾¡å´ã‚’åˆ†ã‘ã¦è¡¨ç¤ºï¼‰
                    if (battleLog.skillActivations && Array.isArray(battleLog.skillActivations) && battleLog.skillActivations.length > 0) {
                        const attackerSkills = battleLog.skillActivations.filter(s => s && s.activated && (!s.side || s.side === 'attacker'));
                        const defenderSkills = battleLog.skillActivations.filter(s => s && s.activated && s.side === 'defender');
                        
                        // æ”»æ’ƒå´ã®ç‰¹æŠ€ç™ºå‹•
                        if (attackerSkills.length > 0) {
                            const skillsHeader = document.createElement('div');
                            skillsHeader.className = 'battle-event';
                            skillsHeader.style.backgroundColor = '#330033';
                            skillsHeader.style.borderLeftColor = '#ff66ff';
                            skillsHeader.style.fontWeight = 'bold';
                            skillsHeader.style.marginTop = '15px';
                            skillsHeader.textContent = 'ã€æ”»æ’ƒè»ç‰¹æŠ€ç™ºå‹•ã€‘';
                            battleEvents.appendChild(skillsHeader);
                            
                            attackerSkills.forEach(skill => {
                                if (skill && skill.name && skill.skill && skill.description) {
                                    const skillDiv = document.createElement('div');
                                    skillDiv.className = 'battle-event';
                                    skillDiv.style.backgroundColor = '#220022';
                                    skillDiv.style.borderLeftColor = '#ff66ff';
                                    skillDiv.style.marginLeft = '10px';
                                    skillDiv.innerHTML = `<strong>${skill.name}</strong>ã®ã€Œ${skill.skill}ã€ãŒç™ºå‹•ï¼<br>${skill.description} (+${skill.bonus || 0}æˆ¦åŠ›)`;
                                    battleEvents.appendChild(skillDiv);
                                }
                            });
                        }
                        
                        // é˜²å¾¡å´ã®ç‰¹æŠ€ç™ºå‹•
                        if (defenderSkills.length > 0) {
                            const defenderSkillsHeader = document.createElement('div');
                            defenderSkillsHeader.className = 'battle-event';
                            defenderSkillsHeader.style.backgroundColor = '#003300';
                            defenderSkillsHeader.style.borderLeftColor = '#66ff66';
                            defenderSkillsHeader.style.fontWeight = 'bold';
                            defenderSkillsHeader.style.marginTop = '15px';
                            defenderSkillsHeader.textContent = 'ã€å®ˆå‚™è»ç‰¹æŠ€ç™ºå‹•ã€‘';
                            battleEvents.appendChild(defenderSkillsHeader);
                            
                            defenderSkills.forEach(skill => {
                                if (skill && skill.name && skill.skill && skill.description) {
                                    const skillDiv = document.createElement('div');
                                    skillDiv.className = 'battle-event';
                                    skillDiv.style.backgroundColor = '#002200';
                                    skillDiv.style.borderLeftColor = '#66ff66';
                                    skillDiv.style.marginLeft = '10px';
                                    skillDiv.innerHTML = `<strong>${skill.name}</strong>ã®ã€Œ${skill.skill}ã€ãŒç™ºå‹•ï¼<br>${skill.description} (+${skill.bonus || 0}æˆ¦åŠ›)`;
                                    battleEvents.appendChild(skillDiv);
                                }
                            });
                        }
                    }
                    
                    // ç‰¹æŠ€ãƒœãƒ¼ãƒŠã‚¹ã®åˆè¨ˆã‚’è¡¨ç¤ºï¼ˆæ”»æ’ƒå´ã¨é˜²å¾¡å´ã‚’åˆ†ã‘ã¦ï¼‰
                    const attackerSkillBonus = battleLog.result?.skillBonuses || 0;
                    const defenderSkillBonus = battleLog.result?.defenderSkillBonuses || 0;
                    
                    if (attackerSkillBonus > 0 || defenderSkillBonus > 0) {
                        const bonusDiv = document.createElement('div');
                        bonusDiv.className = 'battle-event victory';
                        bonusDiv.style.marginTop = '10px';
                        
                        let bonusText = '';
                        if (attackerSkillBonus > 0 && defenderSkillBonus > 0) {
                            bonusText = `ç‰¹æŠ€åŠ¹æœ - æ”»æ’ƒè»: +${attackerSkillBonus} å®ˆå‚™è»: +${defenderSkillBonus}`;
                        } else if (attackerSkillBonus > 0) {
                            bonusText = `æ”»æ’ƒè»ç‰¹æŠ€åŠ¹æœ: +${attackerSkillBonus}`;
                        } else if (defenderSkillBonus > 0) {
                            bonusText = `å®ˆå‚™è»ç‰¹æŠ€åŠ¹æœ: +${defenderSkillBonus}`;
                        }
                        
                        bonusDiv.textContent = bonusText;
                        battleEvents.appendChild(bonusDiv);
                    }
                } catch (error) {
                    // æˆ¦é—˜ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ç¶™ç¶š
                }
                
                try {
                    // æˆ¦æœã‚’è¡¨ç¤º
                    const battleResult = document.getElementById('battle-final-result');
                    if (!battleResult) {
                        return;
                    }
                    
                    let resultHtml = '';
                    const result = battleLog.result || {};
                    const attackerSkillBonuses = result.skillBonuses || 0;
                    const defenderSkillBonuses = result.defenderSkillBonuses || 0;
                    const attackerGeneralsCount = (battleLog.attacker && battleLog.attacker.generals) ? battleLog.attacker.generals.length : 0;
                    const defenderGeneralsCount = (battleLog.defender && battleLog.defender.generals) ? battleLog.defender.generals.length : 0;
                    const playerCasualties = result.playerCasualties || 0;
                    
                    if (result.conquered) {
                        resultHtml = `
                            <div class="result-summary success-display">å‹åˆ©ï¼é ˜åœŸã‚’ç²å¾—ã—ã¾ã—ãŸï¼</div>
                            <div class="result-details">
                                <div class="result-item"><span>æ•µå…µæå®³:</span><span class="damage-display">${result.troopDamage || 0}</span></div>
                                <div class="result-item"><span>æ•µåŸå£ç ´å£Š:</span><span class="damage-display">${result.wallDamage || 0}</span></div>
                                <div class="result-item"><span>æˆ‘è»æå®³:</span><span class="damage-display">${playerCasualties}</span></div>
                                <div class="result-item"><span>æ”»æ’ƒç‰¹æŠ€:</span><span class="success-display">+${attackerSkillBonuses}</span></div>
                                <div class="result-item"><span>å®ˆå‚™ç‰¹æŠ€:</span><span class="power-display">+${defenderSkillBonuses}</span></div>
                                <div class="result-item"><span>å¥‡è¥²æ”»æ’ƒ:</span><span class="success-display">${result.surpriseAttack ? 'æˆåŠŸ(1.5å€)' : 'æœªç™ºå‹•'}</span></div>
                                <div class="result-item"><span>ä¸­å¤®çªç ´:</span><span class="success-display">${result.centralBreakthrough ? 'ç™ºå‹•(+100)' : 'æœªç™ºå‹•'}</span></div>
                                <div class="result-item"><span>æ”»æ’ƒæ­¦å°†:</span><span class="power-display">${attackerGeneralsCount}å</span></div>
                                <div class="result-item"><span>å®ˆå‚™æ­¦å°†:</span><span class="damage-display">${defenderGeneralsCount}å</span></div>
                            </div>
                        `;
                    } else if ((result.troopDamage || 0) > 0 || (result.wallDamage || 0) > 0) {
                        resultHtml = `
                            <div class="result-summary power-display">æå®³ã‚’ä¸ãˆã¾ã—ãŸ</div>
                            <div class="result-details">
                                <div class="result-item"><span>æ•µå…µæå®³:</span><span class="damage-display">${result.troopDamage || 0}</span></div>
                                <div class="result-item"><span>æ•µåŸå£æå‚·:</span><span class="damage-display">${result.wallDamage || 0}</span></div>
                                <div class="result-item"><span>æˆ‘è»æå®³:</span><span class="damage-display">${playerCasualties}</span></div>
                                <div class="result-item"><span>æ”»æ’ƒç‰¹æŠ€:</span><span class="success-display">+${attackerSkillBonuses}</span></div>
                                <div class="result-item"><span>å®ˆå‚™ç‰¹æŠ€:</span><span class="power-display">+${defenderSkillBonuses}</span></div>
                                <div class="result-item"><span>å¥‡è¥²æ”»æ’ƒ:</span><span class="success-display">${result.surpriseAttack ? 'æˆåŠŸ(1.5å€)' : 'æœªç™ºå‹•'}</span></div>
                                <div class="result-item"><span>æ”»æ’ƒæ­¦å°†:</span><span class="power-display">${attackerGeneralsCount}å</span></div>
                                <div class="result-item"><span>å®ˆå‚™æ­¦å°†:</span><span class="damage-display">${defenderGeneralsCount}å</span></div>
                            </div>
                        `;
                    } else {
                        resultHtml = `
                            <div class="result-summary damage-display">æ”»æ’ƒã¯é˜²ãŒã‚Œã¾ã—ãŸ</div>
                            <div class="result-details">
                                <div class="result-item"><span>æˆ‘è»æå®³:</span><span class="damage-display">${playerCasualties}</span></div>
                                <div class="result-item"><span>æ”»æ’ƒç‰¹æŠ€:</span><span class="success-display">+${attackerSkillBonuses}</span></div>
                                <div class="result-item"><span>å®ˆå‚™ç‰¹æŠ€:</span><span class="power-display">+${defenderSkillBonuses}</span></div>
                                <div class="result-item"><span>å¥‡è¥²æ”»æ’ƒ:</span><span class="success-display">${result.surpriseAttack ? 'æˆåŠŸã‚‚ä¸ç™º' : 'æœªç™ºå‹•'}</span></div>
                                <div class="result-item"><span>ä¸­å¤®çªç ´:</span><span class="success-display">${result.centralBreakthrough ? 'ç™ºå‹•ã‚‚ä¸ç™º' : 'æœªç™ºå‹•'}</span></div>
                                <div class="result-item"><span>æ”»æ’ƒæ­¦å°†:</span><span class="power-display">${attackerGeneralsCount}å</span></div>
                                <div class="result-item"><span>å®ˆå‚™æ­¦å°†:</span><span class="damage-display">${defenderGeneralsCount}å</span></div>
                            </div>
                            <div style="font-size: 12px; color: #ccc; margin-top: 10px;">
                                ${defenderGeneralsCount > 0 ? 'æ•µæ­¦å°†ã®å¥®æˆ¦ã«ã‚ˆã‚Šæ”»æ’ƒãŒé˜»ã¾ã‚Œã¾ã—ãŸ' : 'æ•µã®é˜²å¾¡ãŒå›ºãã€æœ‰åŠ¹ãªæå®³ã‚’ä¸ãˆã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã§ã—ãŸ'}
                                ${playerCasualties > 0 ? `<br>æˆ¦é—˜ã«ã‚ˆã‚Šæˆ‘è»ã«ã‚‚${playerCasualties}ã®æå®³ãŒç™ºç”Ÿã—ã¾ã—ãŸ` : ''}
                            </div>
                        `;
                    }
                    
                    battleResult.innerHTML = resultHtml;
                } catch (error) {
                    console.warn('æˆ¦æœè¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                }
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                this.showBattleLogModal();
            }
            
            switchTab(tabName) {
                // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                const targetTabBtn = document.querySelector(`[data-tab="${tabName}"]`);
                if (targetTabBtn) {
                    targetTabBtn.classList.add('active');
                }
                
                // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                const targetTab = document.getElementById(`tab-${tabName}`);
                if (targetTab) {
                    targetTab.classList.add('active');
                }
                
                // ã‚¿ãƒ–ã«å¿œã˜ãŸå†…å®¹ã‚’æ›´æ–°ï¼ˆã‚¨ãƒ©ãƒ¼é˜²æ­¢ï¼‰
                try {
                    switch(tabName) {
                        case 'assignment':
                            this.updateTerritoryAssignments();
                            break;
                        case 'roles':
                            this.updateRoleSelections();
                            break;
                        case 'army':
                            this.updateArmyFormation();
                            break;
                        case 'reward':
                            this.updateRewardTab();
                            break;
                        case 'list':
                            this.updateGeneralsList();
                            break;
                    }
                } catch (error) {
                    console.warn('ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€ç¶™ç¶šã—ã¾ã™:', error);
                }
            }
            
            initializeGeneralsModal() {
                try {
                    // åˆæœŸåŒ–å‰ã«å…¼ä»»ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
                    this.validateAndFixRoleAssignments();
                    this.switchTab('assignment');
                } catch (error) {
                    console.warn('æ­¦å°†ãƒ¢ãƒ¼ãƒ€ãƒ«åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€ç¶™ç¶šã—ã¾ã™:', error);
                    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã‚¿ãƒ–ã¯åˆ‡ã‚Šæ›¿ãˆã‚‹
                    this.switchTab('assignment');
                }
            }
            
            updateTerritoryAssignments() {
                const container = document.getElementById('territory-assignment-list');
                const playerTerritories = this.gameState.getPlayerTerritories();
                const playerGenerals = this.gameState.generals.filter(g => g.lord === this.gameState.playerDaimyo);
                
                container.innerHTML = '';
                
                playerTerritories.forEach(territory => {
                    const assignmentDiv = document.createElement('div');
                    assignmentDiv.className = 'territory-assignment';
                    
                    // æ—¢ã«ä»–ã®é ˜åœŸã«é…ç½®ã•ã‚Œã¦ã„ã‚‹æ­¦å°†IDã‚’å–å¾—
                    const assignedGeneralIds = playerTerritories
                        .filter(t => t.id !== territory.id && t.generalGarrison)
                        .map(t => t.generalGarrison);
                    
                    // å½¹è·ã«ã¤ã„ã¦ã„ã‚‹æ­¦å°†IDã‚‚å–å¾—
                    const roleAssignedIds = Object.values(this.gameState.playerRoles).filter(id => id !== null);
                    
                    // åˆ©ç”¨å¯èƒ½ãªæ­¦å°†ï¼ˆæœªé…ç½® and å½¹è·ãªã— or ç¾åœ¨ã“ã®é ˜åœŸã«é…ç½®æ¸ˆã¿ï¼‰
                    const availableGenerals = playerGenerals.filter(g => 
                        (!assignedGeneralIds.includes(g.id) && !roleAssignedIds.includes(g.id)) || g.id === territory.generalGarrison
                    );
                    
                    assignmentDiv.innerHTML = `
                        <div class="territory-info">
                            <div class="territory-name-assign">${territory.name}</div>
                            <div class="territory-stats-assign">
                                è¾²æ¥­:${territory.agriculture} å•†æ¥­:${territory.commerce} å…µ:${territory.troops}
                            </div>
                        </div>
                        <div class="assignment-controls">
                            <label>åŸä¸»:</label>
                            <select data-territory="${territory.id}" class="territory-general-select">
                                <option value="">æœªè¨­å®š</option>
                                ${availableGenerals.map(g => 
                                    `<option value="${g.id}" ${territory.generalGarrison === g.id ? 'selected' : ''}>${g.name}</option>`
                                ).join('')}
                            </select>
                            <button class="dismiss-btn territory-dismiss-btn" data-territory="${territory.id}">è§£ä»»</button>
                        </div>
                    `;
                    
                    container.appendChild(assignmentDiv);
                });
                
                // å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                container.querySelectorAll('.territory-general-select').forEach(select => {
                    select.addEventListener('change', (e) => {
                        const territoryId = e.target.dataset.territory;
                        const newGeneralId = e.target.value;
                        const territory = this.gameState.territories.find(t => t.id === territoryId);
                        
                        // æ–°ã—ã„æ­¦å°†ãŒé¸ã°ã‚ŒãŸå ´åˆã€ä»–ã®é ˜åœŸãƒ»å½¹è·ã‹ã‚‰åŒã˜æ­¦å°†ã‚’é™¤å¤–
                        if (newGeneralId) {
                            // ä»–ã®é ˜åœŸã‹ã‚‰é™¤å¤–
                            playerTerritories.forEach(t => {
                                if (t.id !== territoryId && t.generalGarrison === newGeneralId) {
                                    t.generalGarrison = null;
                                }
                            });
                            
                            // å…¨ã¦ã®å½¹è·ã‹ã‚‰é™¤å¤–
                            Object.keys(this.gameState.playerRoles).forEach(roleKey => {
                                if (this.gameState.playerRoles[roleKey] === newGeneralId) {
                                    this.gameState.playerRoles[roleKey] = null;
                                }
                            });
                            
                            // äººäº‹ãƒ­ã‚°ã«è¨˜éŒ²
                            const general = this.gameState.generals.find(g => g.id === newGeneralId);
                            if (general) {
                                this.gameState.addPersonnelLog(`${general.name}ã‚’${territory.name}åŸä¸»ã«ä»»å‘½`);
                            }
                        }
                        
                        territory.generalGarrison = newGeneralId || null;
                        
                        // å…¨ã¦ã®æ­¦å°†é…ç½®ã‚’æ›´æ–°ï¼ˆé‡è¤‡é™¤å»ã®ãŸã‚ï¼‰
                        this.updateAllGeneralAssignments();
                    });
                });
                
                // åŸä¸»è§£ä»»ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                container.querySelectorAll('.territory-dismiss-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const territoryId = e.target.dataset.territory;
                        const territory = this.gameState.territories.find(t => t.id === territoryId);
                        
                        if (!territory || !territory.generalGarrison) {
                            this.gameState.addLog('ç¾åœ¨ã“ã®é ˜åœŸã«åŸä¸»ã¯é…ç½®ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                            return;
                        }
                        
                        // æ­¦å°†æƒ…å ±ã‚’å–å¾—
                        const general = this.gameState.generals.find(g => g.id === territory.generalGarrison);
                        
                        // å¿ èª åº¦ã‚’æ¸›å°‘
                        if (general) {
                            general.loyalty = Math.max(0, general.loyalty - 10);
                            this.gameState.addLog(`${general.name}ã®å¿ èª åº¦ãŒ-10ï¼ˆåŸä¸»è§£ä»»ï¼‰`, 'battle');
                        }

                        // åŸä¸»ã‹ã‚‰è§£ä»»
                        territory.generalGarrison = null;
                        
                        // ãƒ­ã‚°è¨˜éŒ²
                        if (general) {
                            this.gameState.addPersonnelLog(`${general.name}ã‚’${territory.name}åŸä¸»ã‹ã‚‰è§£ä»»`);
                            this.gameState.addLog(`${general.name}ã‚’${territory.name}åŸä¸»ã‹ã‚‰è§£ä»»ã—ã¾ã—ãŸ`, 'strategy');
                        }
                        
                        // è¡¨ç¤ºæ›´æ–°
                        this.refreshAllTabs();
                        this.updateStatus();
                    });
                });
            }
            
            updateRoleSelections() {
                const playerGenerals = this.gameState.generals.filter(g => g.lord === this.gameState.playerDaimyo);
                
                // ç¾åœ¨ã®å½¹è·è¨­å®šã‚’è¡¨ç¤º
                this.displayCurrentRoles();
                
                // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
                const roleSelects = [
                    { id: 'strategist-select', roleKey: 'strategist' },
                    { id: 'diplomat-select', roleKey: 'diplomat' },
                    { id: 'administrator-select', roleKey: 'administrator' },
                    { id: 'kenchi-commissioner-select', roleKey: 'kenchiCommissioner' },
                    { id: 'rice-commissioner-select', roleKey: 'riceCommissioner' },
                    { id: 'town-commissioner-select', roleKey: 'townCommissioner' },
                    { id: 'gold-commissioner-select', roleKey: 'goldCommissioner' },
                    { id: 'construction-commissioner-select', roleKey: 'constructionCommissioner' },
                    { id: 'military-commissioner-select', roleKey: 'militaryCommissioner' }
                ];
                
                roleSelects.forEach(({ id, roleKey }) => {
                    const select = document.getElementById(id);
                    if (!select) return; // ã‚¨ãƒ©ãƒ¼é˜²æ­¢
                    
                    // ç¾åœ¨è¨­å®šã•ã‚Œã¦ã„ã‚‹æ­¦å°†ID
                    const currentGeneralId = this.gameState.playerRoles[roleKey];
                    
                    // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢
                    select.innerHTML = '<option value="">æœªè¨­å®š</option>';
                    
                    // åˆ©ç”¨å¯èƒ½ãªæ­¦å°†ã®ã¿ã‚’è¿½åŠ 
                    playerGenerals.forEach(general => {
                        // ã“ã®æ­¦å°†ãŒä»–ã®å½¹è·ã«ã¤ã„ã¦ã„ãªã„ã‹ã€ã¾ãŸã¯ç¾åœ¨ã®ã“ã®å½¹è·ã«ã¤ã„ã¦ã„ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯
                        const isAvailable = this.isGeneralAvailable(general.id, roleKey);
                        
                        if (isAvailable || general.id === currentGeneralId) {
                            const option = document.createElement('option');
                            option.value = general.id;
                            option.textContent = general.name;
                            if (general.id === currentGeneralId) {
                                option.selected = true;
                            }
                            select.appendChild(option);
                        }
                    });
                    
                    // å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’æ–°ãŸã«è¿½åŠ ï¼ˆé‡è¤‡é˜²æ­¢ã®ãŸã‚å‰Šé™¤ã—ã¦ã‹ã‚‰è¿½åŠ ï¼‰
                    const newSelect = select.cloneNode(true);
                    select.parentNode.replaceChild(newSelect, select);
                    
                    newSelect.addEventListener('change', (e) => {
                        const newGeneralId = e.target.value || null;
                        const oldGeneralId = this.gameState.playerRoles[roleKey];
                        
                        // é‡è¦å½¹è·ã®å¤‰æ›´ã«ã¯é‡‘100ãŒå¿…è¦
                        const importantRoles = ['strategist', 'diplomat', 'administrator'];
                        if (importantRoles.includes(roleKey) && newGeneralId && newGeneralId !== oldGeneralId) {
                            const playerDaimyo = this.gameState.getPlayerDaimyoData();
                            if (playerDaimyo.gold < 100) {
                                this.gameState.addLog('é‡è¦å½¹è·ã®å¤‰æ›´ã«ã¯é‡‘100ãŒå¿…è¦ã§ã™');
                                e.target.value = oldGeneralId || '';
                                return;
                            }
                            playerDaimyo.gold -= 100;
                            this.gameState.addLog('é‡è¦å½¹è·å¤‰æ›´ã«ã‚ˆã‚Šé‡‘100ã‚’æ¶ˆè²»', 'strategy');
                        }
                        
                        // æ–°ã—ã„æ­¦å°†ãŒé¸ã°ã‚ŒãŸå ´åˆã€ä»–ã®å½¹è·ã‹ã‚‰é™¤å¤–
                        if (newGeneralId && newGeneralId !== oldGeneralId) {
                            this.removeGeneralFromOtherRoles(newGeneralId, roleKey);
                            
                            // äººäº‹ãƒ­ã‚°ã«è¨˜éŒ²
                            const general = this.gameState.generals.find(g => g.id === newGeneralId);
                            const roleNames = { 
                                'strategist': 'å‚è¬€', 
                                'diplomat': 'å¤–äº¤æ‹…å½“', 
                                'administrator': 'äººäº‹ç·ç›£',
                                'kenchiCommissioner': 'æ¤œåœ°å¥‰è¡Œ',
                                'riceCommissioner': 'ç±³å¥‰è¡Œ',
                                'townCommissioner': 'ç”ºå¥‰è¡Œ',
                                'goldCommissioner': 'é‡‘å¥‰è¡Œ',
                                'constructionCommissioner': 'æ™®è«‹å¥‰è¡Œ',
                                'militaryCommissioner': 'å…µå¥‰è¡Œ'
                            };
                            const roleName = roleNames[roleKey];
                            if (general && roleName) {
                                const costText = importantRoles.includes(roleKey) ? 'ï¼ˆè²»ç”¨ï¼šé‡‘100ï¼‰' : '';
                                this.gameState.addPersonnelLog(`${general.name}ã‚’${roleName}ã«ä»»å‘½${costText}`);
                            }
                        } else if (!newGeneralId && oldGeneralId) {
                            // ã€Œæœªè¨­å®šã€ãŒé¸æŠã•ã‚ŒãŸå ´åˆï¼ˆæ­¦å°†ã‚’å½¹è·ã‹ã‚‰å¤–ã™ï¼‰
                            const oldGeneral = this.gameState.generals.find(g => g.id === oldGeneralId);
                            const roleNames = { 
                                'strategist': 'å‚è¬€', 
                                'diplomat': 'å¤–äº¤æ‹…å½“', 
                                'administrator': 'äººäº‹ç·ç›£',
                                'kenchiCommissioner': 'æ¤œåœ°å¥‰è¡Œ',
                                'riceCommissioner': 'ç±³å¥‰è¡Œ',
                                'townCommissioner': 'ç”ºå¥‰è¡Œ',
                                'goldCommissioner': 'é‡‘å¥‰è¡Œ',
                                'constructionCommissioner': 'æ™®è«‹å¥‰è¡Œ',
                                'militaryCommissioner': 'å…µå¥‰è¡Œ'
                            };
                            const roleName = roleNames[roleKey];
                            if (oldGeneral && roleName) {
                                // å¿ èª åº¦ã‚’æ¸›å°‘
                                oldGeneral.loyalty = Math.max(0, oldGeneral.loyalty - 10);
                                this.gameState.addLog(`${oldGeneral.name}ã®å¿ èª åº¦ãŒ-10ï¼ˆå½¹è·è§£é™¤ï¼‰`, 'battle');
                                this.gameState.addPersonnelLog(`${oldGeneral.name}ã‚’${roleName}ã‹ã‚‰è§£ä»»`);
                            }
                        }
                        
                        this.gameState.playerRoles[roleKey] = newGeneralId;
                        this.refreshAllTabs(); // å…¨ã¦ã®ã‚¿ãƒ–ã‚’æ›´æ–°ã—ã¦å¿ èª åº¦ã®å¤‰æ›´ã‚’å³æ™‚åæ˜ 
                        this.updateStatus(); // é‡‘ã®è¡¨ç¤ºã‚’æ›´æ–°
                    });
                });
                
                // è§£ä»»ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                document.querySelectorAll('.dismiss-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const roleKey = e.target.dataset.role;
                        const currentGeneralId = this.gameState.playerRoles[roleKey];
                        
                        if (!currentGeneralId) {
                            this.gameState.addLog('ç¾åœ¨ã“ã®å½¹è·ã«æ­¦å°†ã¯é…ç½®ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                            return;
                        }
                        
                        // æ­¦å°†æƒ…å ±ã‚’å–å¾—
                        const general = this.gameState.generals.find(g => g.id === currentGeneralId);
                        const roleNames = {
                            'strategist': 'å‚è¬€',
                            'diplomat': 'å¤–äº¤æ‹…å½“', 
                            'administrator': 'äººäº‹ç·ç›£',
                            'kenchiCommissioner': 'æ¤œåœ°å¥‰è¡Œ',
                            'riceCommissioner': 'ç±³å¥‰è¡Œ',
                            'townCommissioner': 'ç”ºå¥‰è¡Œ',
                            'goldCommissioner': 'é‡‘å¥‰è¡Œ',
                            'constructionCommissioner': 'æ™®è«‹å¥‰è¡Œ',
                            'militaryCommissioner': 'å…µå¥‰è¡Œ',
                            'armyStrategist': 'è»å¸«',
                            'vanguard': 'å‰è¡›',
                            'rightWing': 'å³ç¿¼',
                            'leftWing': 'å·¦ç¿¼',
                            'reserve': 'å¾Œè©°'
                        };
                        
                        // å¿ èª åº¦ã‚’æ¸›å°‘
                        if (general) {
                            general.loyalty = Math.max(0, general.loyalty - 10);
                            this.gameState.addLog(`${general.name}ã®å¿ èª åº¦ãŒ-10ï¼ˆå½¹è·è§£ä»»ï¼‰`, 'battle');
                        }

                        // å½¹è·ã‹ã‚‰è§£ä»»
                        this.gameState.playerRoles[roleKey] = null;
                        
                        // ãƒ­ã‚°è¨˜éŒ²
                        const roleName = roleNames[roleKey];
                        if (general && roleName) {
                            this.gameState.addPersonnelLog(`${general.name}ã‚’${roleName}ã‹ã‚‰è§£ä»»`);
                            this.gameState.addLog(`${general.name}ã‚’${roleName}ã‹ã‚‰è§£ä»»ã—ã¾ã—ãŸ`, 'strategy');
                        }
                        
                        // è¡¨ç¤ºæ›´æ–°
                        this.refreshAllTabs();
                        this.updateStatus();
                    });
                });
            }
            
            updateArmyFormation() {
                const playerGenerals = this.gameState.generals.filter(g => g.lord === this.gameState.playerDaimyo);
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                
                // ç¾åœ¨ã®è»å›£ç·¨æˆã‚’è¡¨ç¤º
                this.displayCurrentArmyFormation();
                
                // å¤§å°†åã‚’è¡¨ç¤º
                const generalNameElement = document.getElementById('general-name');
                if (generalNameElement) {
                    generalNameElement.textContent = playerDaimyo.name;
                }
                
                // å„ãƒã‚¸ã‚·ãƒ§ãƒ³ã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
                const positions = [
                    { id: 'army-strategist', roleKey: 'armyStrategist' },
                    { id: 'vanguard', roleKey: 'vanguard' },
                    { id: 'right-wing', roleKey: 'rightWing' },
                    { id: 'left-wing', roleKey: 'leftWing' },
                    { id: 'reserve', roleKey: 'reserve' }
                ];
                
                positions.forEach(({ id, roleKey }) => {
                    const select = document.getElementById(id);
                    if (!select) return; // ã‚¨ãƒ©ãƒ¼é˜²æ­¢
                    
                    // ç¾åœ¨è¨­å®šã•ã‚Œã¦ã„ã‚‹æ­¦å°†ID
                    const currentGeneralId = this.gameState.playerRoles[roleKey];
                    
                    // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢
                    select.innerHTML = '<option value="">æœªè¨­å®š</option>';
                    
                    // åˆ©ç”¨å¯èƒ½ãªæ­¦å°†ã®ã¿ã‚’è¿½åŠ 
                    playerGenerals.forEach(general => {
                        const isAvailable = this.isGeneralAvailable(general.id, roleKey);
                        
                        if (isAvailable || general.id === currentGeneralId) {
                            const option = document.createElement('option');
                            option.value = general.id;
                            option.textContent = general.name;
                            if (general.id === currentGeneralId) {
                                option.selected = true;
                            }
                            select.appendChild(option);
                        }
                    });
                    
                    // å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’æ–°ãŸã«è¿½åŠ 
                    const newSelect = select.cloneNode(true);
                    select.parentNode.replaceChild(newSelect, select);
                    
                    newSelect.addEventListener('change', (e) => {
                        const newGeneralId = e.target.value || null;
                        const oldGeneralId = this.gameState.playerRoles[roleKey];
                        
                        // æ–°ã—ã„æ­¦å°†ãŒé¸ã°ã‚ŒãŸå ´åˆã€ä»–ã®å½¹è·ã‹ã‚‰é™¤å¤–
                        if (newGeneralId && newGeneralId !== oldGeneralId) {
                            this.removeGeneralFromOtherRoles(newGeneralId, roleKey);
                            
                            // äººäº‹ãƒ­ã‚°ã«è¨˜éŒ²
                            const general = this.gameState.generals.find(g => g.id === newGeneralId);
                            const positionNames = { 
                                'armyStrategist': 'è»å¸«', 'vanguard': 'å‰è¡›', 
                                'rightWing': 'å³ç¿¼', 'leftWing': 'å·¦ç¿¼', 'reserve': 'å¾Œè©°' 
                            };
                            const positionName = positionNames[roleKey];
                            if (general && positionName) {
                                this.gameState.addPersonnelLog(`${general.name}ã‚’${positionName}ã«é…ç½®`);
                            }
                        } else if (!newGeneralId && oldGeneralId) {
                            // ã€Œæœªè¨­å®šã€ãŒé¸æŠã•ã‚ŒãŸå ´åˆï¼ˆæ­¦å°†ã‚’è»å›£ã‹ã‚‰å¤–ã™ï¼‰
                            const oldGeneral = this.gameState.generals.find(g => g.id === oldGeneralId);
                            const positionNames = { 
                                'armyStrategist': 'è»å¸«', 'vanguard': 'å‰è¡›', 
                                'rightWing': 'å³ç¿¼', 'leftWing': 'å·¦ç¿¼', 'reserve': 'å¾Œè©°' 
                            };
                            const positionName = positionNames[roleKey];
                            if (oldGeneral && positionName) {
                                // å¿ èª åº¦ã‚’æ¸›å°‘
                                oldGeneral.loyalty = Math.max(0, oldGeneral.loyalty - 10);
                                this.gameState.addLog(`${oldGeneral.name}ã®å¿ èª åº¦ãŒ-10ï¼ˆè»å›£è§£é™¤ï¼‰`, 'battle');
                                this.gameState.addPersonnelLog(`${oldGeneral.name}ã‚’${positionName}ã‹ã‚‰è§£é™¤`);
                            }
                        }
                        
                        this.gameState.playerRoles[roleKey] = newGeneralId;
                        this.refreshAllTabs(); // å…¨ã¦ã®ã‚¿ãƒ–ã‚’æ›´æ–°ã—ã¦å¿ èª åº¦ã®å¤‰æ›´ã‚’å³æ™‚åæ˜ 
                        this.updateStatus();
                    });
                });
                
                // è»å›£ç·¨æˆã®è§£ä»»ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                document.querySelectorAll('.dismiss-btn[data-role^="army"], .dismiss-btn[data-role="vanguard"], .dismiss-btn[data-role="rightWing"], .dismiss-btn[data-role="leftWing"], .dismiss-btn[data-role="reserve"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const roleKey = e.target.dataset.role;
                        const currentGeneralId = this.gameState.playerRoles[roleKey];
                        
                        if (!currentGeneralId) {
                            this.gameState.addLog('ç¾åœ¨ã“ã®å½¹è·ã«æ­¦å°†ã¯é…ç½®ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                            return;
                        }
                        
                        // æ­¦å°†æƒ…å ±ã‚’å–å¾—
                        const general = this.gameState.generals.find(g => g.id === currentGeneralId);
                        const positionNames = {
                            'armyStrategist': 'è»å¸«',
                            'vanguard': 'å‰è¡›',
                            'rightWing': 'å³ç¿¼',
                            'leftWing': 'å·¦ç¿¼',
                            'reserve': 'å¾Œè©°'
                        };
                        
                        // å¿ èª åº¦ã‚’æ¸›å°‘
                        if (general) {
                            general.loyalty = Math.max(0, general.loyalty - 10);
                            this.gameState.addLog(`${general.name}ã®å¿ èª åº¦ãŒ-10ï¼ˆè»å›£è§£ä»»ï¼‰`, 'battle');
                        }

                        // å½¹è·ã‹ã‚‰è§£ä»»
                        this.gameState.playerRoles[roleKey] = null;
                        
                        // ãƒ­ã‚°è¨˜éŒ²
                        const positionName = positionNames[roleKey];
                        if (general && positionName) {
                            this.gameState.addPersonnelLog(`${general.name}ã‚’${positionName}ã‹ã‚‰è§£é™¤`);
                            this.gameState.addLog(`${general.name}ã‚’${positionName}ã‹ã‚‰è§£é™¤ã—ã¾ã—ãŸ`, 'strategy');
                        }
                        
                        // è¡¨ç¤ºæ›´æ–°
                        this.refreshAllTabs();
                        this.updateStatus();
                    });
                });
                
                this.calculateArmyStats();
            }
            
            // æ­¦å°†ãŒä»–ã®å½¹è·ã«ã¤ã„ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆé ˜åœŸæ‹…å½“ã‚‚å«ã‚€ï¼‰
            isGeneralAvailable(generalId, currentRoleKey) {
                // å½¹è·ãƒã‚§ãƒƒã‚¯
                const allRoles = Object.keys(this.gameState.playerRoles);
                for (let roleKey of allRoles) {
                    if (roleKey !== currentRoleKey && this.gameState.playerRoles[roleKey] === generalId) {
                        return false; // ä»–ã®å½¹è·ã«ã¤ã„ã¦ã„ã‚‹
                    }
                }
                
                // é ˜åœŸæ‹…å½“ãƒã‚§ãƒƒã‚¯
                const assignedToTerritory = this.gameState.territories.some(t => 
                    t.owner === this.gameState.playerDaimyo && t.generalGarrison === generalId
                );
                
                if (assignedToTerritory) {
                    return false; // é ˜åœŸæ‹…å½“ã«ã¤ã„ã¦ã„ã‚‹
                }
                
                return true; // åˆ©ç”¨å¯èƒ½
            }
            
            // æ­¦å°†ã‚’ä»–ã®å½¹è·ã‹ã‚‰é™¤å¤–ï¼ˆé ˜åœŸæ‹…å½“ã‚‚å«ã‚€ï¼‰
            removeGeneralFromOtherRoles(generalId, keepRoleKey) {
                // å½¹è·ã‹ã‚‰é™¤å¤–
                const allRoles = Object.keys(this.gameState.playerRoles);
                allRoles.forEach(roleKey => {
                    if (roleKey !== keepRoleKey && this.gameState.playerRoles[roleKey] === generalId) {
                        this.gameState.playerRoles[roleKey] = null;
                    }
                });
                
                // é ˜åœŸæ‹…å½“ã‹ã‚‰é™¤å¤–
                this.gameState.territories.forEach(territory => {
                    if (territory.owner === this.gameState.playerDaimyo && territory.generalGarrison === generalId) {
                        territory.generalGarrison = null;
                    }
                });
            }
            
            // å…¨ã¦ã®æ­¦å°†é…ç½®ã‚’æ›´æ–°
            updateAllGeneralAssignments() {
                setTimeout(() => {
                    try {
                        this.updateTerritoryAssignments();
                        this.updateRoleSelections();
                        this.updateArmyFormation();
                        this.calculateArmyStats();
                    } catch (error) {
                        console.warn('æ­¦å°†é…ç½®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€ç¶™ç¶šã—ã¾ã™:', error);
                    }
                }, 50);
            }
            
            // å…¨ã¦ã®å½¹è·ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
            updateAllRoleSelects() {
                // é…å»¶å®Ÿè¡Œã§ã‚¨ãƒ©ãƒ¼ã‚’é˜²ã
                setTimeout(() => {
                    try {
                        this.updateRoleSelections();
                        this.updateArmyFormation();
                    } catch (error) {
                        console.warn('å½¹è·æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€ç¶™ç¶šã—ã¾ã™:', error);
                    }
                }, 50);
            }
            
            displayCurrentRoles() {
                const container = document.getElementById('current-roles-list');
                if (!container) return; // ã‚¨ãƒ©ãƒ¼é˜²æ­¢
                
                const importantRoles = {
                    'strategist': 'å‚è¬€',
                    'diplomat': 'å¤–äº¤æ‹…å½“',
                    'administrator': 'äººäº‹ç·ç›£'
                };
                
                const commissionerRoles = {
                    'kenchiCommissioner': 'æ¤œåœ°å¥‰è¡Œ',
                    'riceCommissioner': 'ç±³å¥‰è¡Œ',
                    'townCommissioner': 'ç”ºå¥‰è¡Œ',
                    'goldCommissioner': 'é‡‘å¥‰è¡Œ',
                    'constructionCommissioner': 'æ™®è«‹å¥‰è¡Œ',
                    'militaryCommissioner': 'å…µå¥‰è¡Œ'
                };
                
                container.innerHTML = '';
                
                // é‡è¦å½¹è·ã‚»ã‚¯ã‚·ãƒ§ãƒ³
                const importantHeader = document.createElement('div');
                importantHeader.style.cssText = 'color: #ff6666; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px;';
                importantHeader.textContent = 'é‡è¦å½¹è·';
                container.appendChild(importantHeader);
                
                Object.entries(importantRoles).forEach(([key, label]) => {
                    const roleDiv = document.createElement('div');
                    roleDiv.className = 'role-item';
                    
                    const generalId = this.gameState.playerRoles[key];
                    let generalName = 'æœªè¨­å®š';
                    let valueClass = 'role-value empty';
                    
                    if (generalId) {
                        const general = this.gameState.generals.find(g => g.id === generalId);
                        if (general) {
                            generalName = general.name;
                            valueClass = 'role-value';
                        }
                    }
                    
                    roleDiv.innerHTML = `
                        <span class="role-label">${label}:</span>
                        <span class="${valueClass}">${generalName}</span>
                    `;
                    
                    container.appendChild(roleDiv);
                });
                
                // å¥‰è¡Œè·ã‚»ã‚¯ã‚·ãƒ§ãƒ³
                const commissionerHeader = document.createElement('div');
                commissionerHeader.style.cssText = 'color: #66ff66; font-weight: bold; margin: 15px 0 10px 0; border-bottom: 1px solid #444; padding-bottom: 5px;';
                commissionerHeader.textContent = 'å¥‰è¡Œè·';
                container.appendChild(commissionerHeader);
                
                Object.entries(commissionerRoles).forEach(([key, label]) => {
                    const roleDiv = document.createElement('div');
                    roleDiv.className = 'role-item';
                    
                    const generalId = this.gameState.playerRoles[key];
                    let generalName = 'æœªè¨­å®š';
                    let valueClass = 'role-value empty';
                    
                    if (generalId) {
                        const general = this.gameState.generals.find(g => g.id === generalId);
                        if (general) {
                            generalName = general.name;
                            valueClass = 'role-value';
                        }
                    }
                    
                    roleDiv.innerHTML = `
                        <span class="role-label">${label}:</span>
                        <span class="${valueClass}">${generalName}</span>
                    `;
                    
                    container.appendChild(roleDiv);
                });
            }
            
            displayCurrentArmyFormation() {
                const container = document.getElementById('current-army-formation');
                const positions = {
                    'armyStrategist': 'è»å¸«',
                    'vanguard': 'å‰è¡›',
                    'rightWing': 'å³ç¿¼',
                    'leftWing': 'å·¦ç¿¼',
                    'reserve': 'å¾Œè©°'
                };
                
                container.innerHTML = '';
                
                // å¤§å°†ã‚’è¿½åŠ 
                const generalDiv = document.createElement('div');
                generalDiv.className = 'formation-item';
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                generalDiv.innerHTML = `
                    <span class="formation-label">å¤§å°†:</span>
                    <span class="formation-value">${playerDaimyo.name}</span>
                `;
                container.appendChild(generalDiv);
                
                // ãã®ä»–ã®ãƒã‚¸ã‚·ãƒ§ãƒ³
                Object.entries(positions).forEach(([key, label]) => {
                    const formationDiv = document.createElement('div');
                    formationDiv.className = 'formation-item';
                    
                    const generalId = this.gameState.playerRoles[key];
                    let generalName = 'æœªè¨­å®š';
                    let valueClass = 'formation-value empty';
                    
                    if (generalId) {
                        const general = this.gameState.generals.find(g => g.id === generalId);
                        if (general) {
                            generalName = general.name;
                            valueClass = 'formation-value';
                        }
                    }
                    
                    formationDiv.innerHTML = `
                        <span class="formation-label">${label}:</span>
                        <span class="${valueClass}">${generalName}</span>
                    `;
                    
                    container.appendChild(formationDiv);
                });
            }
            
            calculateArmyStats() {
                try {
                    const playerDaimyo = this.gameState.getPlayerDaimyoData();
                    if (!playerDaimyo || !playerDaimyo.stats) {
                        return; // å¤§åãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯å‡¦ç†ã‚’ä¸­æ–­
                    }
                    
                    let attackPower = playerDaimyo.stats.battle || 0;
                    let defensePower = Math.floor((playerDaimyo.stats.command || 0) / 3);
                    let intelligencePower = playerDaimyo.stats.intelligence || 0;
                    
                    // å„ãƒã‚¸ã‚·ãƒ§ãƒ³ã®æ­¦å°†ã‚’å–å¾—ã—ã¦èƒ½åŠ›ã‚’åˆè¨ˆ
                    const positions = {
                        'armyStrategist': { command: 1, intelligence: 1 },
                        'vanguard': { battle: 1, command: 1 },
                        'rightWing': { battle: 1 },
                        'leftWing': { battle: 1 },
                        'reserve': { command: 1 }
                    };
                    
                    let assignedGeneralsCount = 0;
                    
                    Object.entries(positions).forEach(([roleKey, stats]) => {
                        try {
                            const generalId = this.gameState.playerRoles[roleKey];
                            if (generalId) {
                                const general = this.gameState.generals.find(g => g && g.id === generalId);
                                if (general && general.stats) {
                                    assignedGeneralsCount++;
                                    if (stats.battle) attackPower += general.stats.battle || 0;
                                    if (stats.command) defensePower += Math.floor((general.stats.command || 0) / 3);
                                    if (stats.intelligence) intelligencePower += general.stats.intelligence || 0;
                                }
                            }
                        } catch (error) {
                            // è»å›£æˆ¦åŠ›è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ç¶™ç¶š
                        }
                    });
                    
                    // è»å¸«ãƒœãƒ¼ãƒŠã‚¹ï¼ˆå½¹è·è¨­å®šã®è»å¸«ï¼‰
                    try {
                        if (this.gameState.playerRoles.strategist) {
                            const strategist = this.gameState.generals.find(g => g && g.id === this.gameState.playerRoles.strategist);
                            if (strategist && strategist.stats) {
                                defensePower += Math.floor(((strategist.stats.command || 0) + (strategist.stats.intelligence || 0)) / 10);
                                intelligencePower += Math.floor((strategist.stats.intelligence || 0) / 5);
                            }
                        }
                    } catch (error) {
                        // è»å¸«ãƒœãƒ¼ãƒŠã‚¹è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ç¶™ç¶š
                    }
                    
                    const totalPower = attackPower + defensePower + intelligencePower;
                    
                    // UIè¦ç´ ã®å­˜åœ¨ç¢ºèªå¾Œã«æ›´æ–°
                    const attackElement = document.getElementById('army-attack');
                    const defenseElement = document.getElementById('army-defense');
                    const intelligenceElement = document.getElementById('army-intelligence');
                    const totalElement = document.getElementById('total-army-power');
                    
                    if (attackElement) attackElement.textContent = attackPower;
                    if (defenseElement) defenseElement.textContent = defensePower;
                    if (intelligenceElement) intelligenceElement.textContent = intelligencePower;
                    if (totalElement) totalElement.textContent = totalPower;
                } catch (error) {
                    // è»å›£æˆ¦åŠ›è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ç¶™ç¶š
                }
            }
            
            updateMainStatusWithArmyPower(attack, defense, intelligence, total, assignedCount = 0) {
                try {
                    // ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚¨ãƒªã‚¢ã«è»å›£æˆ¦åŠ›ã‚’è¡¨ç¤º
                    const statusDisplay = document.querySelector('.status-display');
                    if (!statusDisplay) return;
                    
                    let armyPowerDiv = statusDisplay.querySelector('.army-power-status');
                    
                    if (!armyPowerDiv) {
                        armyPowerDiv = document.createElement('div');
                        armyPowerDiv.className = 'army-power-status';
                        armyPowerDiv.style.marginTop = '10px';
                        armyPowerDiv.style.borderTop = '1px solid #666';
                        armyPowerDiv.style.paddingTop = '10px';
                        statusDisplay.appendChild(armyPowerDiv);
                    }
                    
                    const assignedText = assignedCount > 0 ? ` (æ­¦å°†${assignedCount}å)` : '';
                    
                    armyPowerDiv.innerHTML = `
                        <div><strong>è»å›£æˆ¦åŠ›:</strong> ${total}${assignedText}</div>
                        <div style="font-size: 10px; color: #ccc;">
                            æ”»:${attack} é˜²:${defense} è¬€:${intelligence}
                        </div>
                    `;
                } catch (error) {
                    // è»å›£æˆ¦åŠ›è¡¨ç¤ºæ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ç¶™ç¶š
                }
            }
            
            updateGeneralsList() {
                const container = document.getElementById('generals-list');
                if (!container) return;
                
                const playerGenerals = this.gameState.generals.filter(g => g.lord === this.gameState.playerDaimyo);
                
                if (playerGenerals.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">é…ä¸‹æ­¦å°†ãªã—</div>';
                    return;
                }
                
                let html = `
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="background: #444; border-bottom: 2px solid #666;">
                                <th style="padding: 8px; border: 1px solid #666; color: #ff6666;">æ­¦å°†å</th>
                                <th style="padding: 8px; border: 1px solid #666;">æˆ¦</th>
                                <th style="padding: 8px; border: 1px solid #666;">çµ±</th>
                                <th style="padding: 8px; border: 1px solid #666;">æ”¿</th>
                                <th style="padding: 8px; border: 1px solid #666;">çŸ¥</th>
                                <th style="padding: 8px; border: 1px solid #666;">é­…</th>
                                <th style="padding: 8px; border: 1px solid #666;">å¿ èª </th>
                                <th style="padding: 8px; border: 1px solid #666;">é…ç½®</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                playerGenerals.forEach(general => {
                    // é…ç½®çŠ¶æ³ã‚’å–å¾—
                    let assignmentStatus = [];
                    
                    const assignedTerritory = this.gameState.territories.find(t => t.generalGarrison === general.id);
                    if (assignedTerritory) {
                        assignmentStatus.push(`${assignedTerritory.name}åŸä¸»`);
                    }
                    
                    const roleNames = {
                        'strategist': 'å‚è¬€', 'diplomat': 'å¤–äº¤', 'administrator': 'äººäº‹',
                        'kenchiCommissioner': 'æ¤œåœ°', 'riceCommissioner': 'ç±³å¥‰è¡Œ',
                        'townCommissioner': 'ç”ºå¥‰è¡Œ', 'goldCommissioner': 'é‡‘å¥‰è¡Œ',
                        'constructionCommissioner': 'æ™®è«‹', 'militaryCommissioner': 'å…µå¥‰è¡Œ',
                        'armyStrategist': 'è»å¸«', 'vanguard': 'å‰è¡›',
                        'rightWing': 'å³ç¿¼', 'leftWing': 'å·¦ç¿¼', 'reserve': 'å¾Œè©°'
                    };
                    
                    Object.entries(this.gameState.playerRoles).forEach(([roleKey, assignedGeneralId]) => {
                        if (assignedGeneralId === general.id && roleNames[roleKey]) {
                            assignmentStatus.push(roleNames[roleKey]);
                        }
                    });
                    
                    const statusText = assignmentStatus.length > 0 ? assignmentStatus.join(',') : 'å¾…æ©Ÿ';
                    const loyaltyColor = general.loyalty > 70 ? '#66ff66' : general.loyalty > 40 ? '#ffff66' : '#ff6666';
                    
                    html += `
                        <tr style="border-bottom: 1px solid #555;">
                            <td style="padding: 6px; border: 1px solid #555; color: #ff6666; font-weight: bold;">${general.name}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: center;">${general.stats.battle}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: center;">${general.stats.command}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: center;">${general.stats.politics}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: center;">${general.stats.intelligence}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: center;">${general.stats.charm}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: center; color: ${loyaltyColor};">${general.loyalty}</td>
                            <td style="padding: 6px; border: 1px solid #555; font-size: 10px;">${statusText}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
            }
            
            updateRewardTab() {
                const container = document.getElementById('reward-generals-list');
                if (!container) return;
                
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                const playerGenerals = this.gameState.generals.filter(g => g.lord === this.gameState.playerDaimyo);
                
                if (playerGenerals.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">é…ä¸‹æ­¦å°†ãªã—</div>';
                    return;
                }
                
                container.innerHTML = '';
                
                playerGenerals.forEach(general => {
                    const generalCard = document.createElement('div');
                    generalCard.className = 'general-card';
                    generalCard.style.marginBottom = '10px';
                    
                    const loyaltyColor = general.loyalty > 70 ? '#66ff66' : general.loyalty > 40 ? '#ffff66' : '#ff6666';
                    const canAfford = playerDaimyo.gold >= 100;
                    const canIncrease = general.loyalty < 100;
                    const canReward = canAfford && canIncrease;
                    
                    generalCard.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div class="general-name">${general.name}</div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 12px; margin: 8px 0;">
                                    <div>æˆ¦é—˜: ${general.stats.battle}</div>
                                    <div>çµ±ç‡: ${general.stats.command}</div>
                                    <div>æ”¿æ²»: ${general.stats.politics}</div>
                                    <div>çŸ¥è¬€: ${general.stats.intelligence}</div>
                                    <div>é­…åŠ›: ${general.stats.charm}</div>
                                    <div style="color: ${loyaltyColor};">å¿ èª : ${general.loyalty}</div>
                                </div>
                                <div style="color: #66ff66; font-size: 12px;">ç‰¹æŠ€: ${general.skill}</div>
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                                <button class="btn" onclick="uiManager.giveReward('${general.id}')" 
                                        ${!canReward ? 'disabled' : ''} 
                                        style="padding: 8px 16px; font-size: 11px; ${canReward ? 'background: linear-gradient(145deg, #006600, #008800); border-color: #00aa00;' : ''}">
                                    ${!canAfford ? 'é‡‘ä¸è¶³' : !canIncrease ? 'ä¸Šé™' : 'ä¸‹è³œã™ã‚‹'}
                                </button>
                                <div style="font-size: 10px; color: #ccc; text-align: center;">
                                    é‡‘100 â†’ å¿ èª +25
                                </div>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(generalCard);
                });
            }
            
            giveReward(generalId) {
                const general = this.gameState.generals.find(g => g.id === generalId);
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                
                if (!general || !playerDaimyo || playerDaimyo.gold < 100 || general.loyalty >= 100) {
                    this.gameState.addLog('ä¸‹è³œã‚’å®Ÿè¡Œã§ãã¾ã›ã‚“');
                    return;
                }
                
                // è²»ç”¨ã‚’æ”¯æ‰•ã„ã€å¿ èª åº¦ã‚’ä¸Šæ˜‡
                playerDaimyo.gold -= 100;
                const oldLoyalty = general.loyalty;
                general.loyalty = Math.min(100, general.loyalty + 25);
                
                this.gameState.addLog(`${general.name}ã«ä¸‹è³œã‚’è¡Œã„ã€å¿ èª åº¦ãŒ${oldLoyalty}â†’${general.loyalty}ã«ä¸Šæ˜‡`, 'diplomacy');
                this.gameState.addPersonnelLog(`${general.name}ã«é‡‘100ã‚’ä¸‹è³œã—å¿ èª åº¦+25`);
                
                // è¡¨ç¤ºã‚’æ›´æ–°
                this.updateRewardTab();
                this.updateStatus();
            }
            
            refreshAllTabs() {
                try {
                    this.updateTerritoryAssignments();
                    this.updateRoleSelections();
                    this.updateArmyFormation();
                    this.updateRewardTab();
                    this.updateGeneralsList();
                } catch (error) {
                    console.warn('å…¨ã‚¿ãƒ–æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€ç¶™ç¶šã—ã¾ã™:', error);
                }
            }
            
            saveGeneralsSettings() {
                // å¿ èª åº¦ã‚’æ“ä½œã™ã‚‹é–¢æ•°
                const handleLoyaltyChange = (oldGeneralId, newGeneralId, reason) => {
                    if (oldGeneralId && oldGeneralId !== newGeneralId) {
                        const general = this.gameState.generals.find(g => g.id === oldGeneralId);
                        if (general) {
                            general.loyalty = Math.max(0, general.loyalty - 10);
                            this.gameState.addLog(`${general.name}ã®å¿ èª åº¦ãŒ-10 (${reason}ã«ã‚ˆã‚Šè§£ä»»)`, 'battle');
                        }
                    }
                };

                // åŸä¸»é…ç½®ã®å¤‰æ›´ã‚’æ¤œçŸ¥
                const territorySelects = document.querySelectorAll('#territory-assignment-list select');
                territorySelects.forEach(select => {
                    const territoryId = select.dataset.territoryId;
                    const newGeneralId = select.value || null;
                    const territory = this.gameState.territories.find(t => t.id === territoryId);
                    if (territory) {
                        const oldGeneralId = territory.generalGarrison;
                        handleLoyaltyChange(oldGeneralId, newGeneralId, 'åŸä¸»äº¤ä»£');
                        territory.generalGarrison = newGeneralId;
                    }
                });

                // å½¹è·è¨­å®šã®å¤‰æ›´ã‚’æ¤œçŸ¥
                const roleSelects = document.querySelectorAll('#tab-roles select');
                roleSelects.forEach(select => {
                    const role = select.id.replace('-select', '');
                    const newGeneralId = select.value || null;
                    const oldGeneralId = this.gameState.playerRoles[role];
                    handleLoyaltyChange(oldGeneralId, newGeneralId, 'å½¹è·äº¤ä»£');
                    this.gameState.playerRoles[role] = newGeneralId;
                });

                // è»å›£ç·¨æˆã®å¤‰æ›´ã‚’æ¤œçŸ¥
                const armySelects = document.querySelectorAll('#tab-army select');
                armySelects.forEach(select => {
                    const role = select.id;
                    const newGeneralId = select.value || null;
                    const oldGeneralId = this.gameState.playerRoles[role];
                    handleLoyaltyChange(oldGeneralId, newGeneralId, 'è»å›£äº¤ä»£');
                    this.gameState.playerRoles[role] = newGeneralId;
                });

                this.gameState.addLog('æ­¦å°†è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'strategy');
                this.hideGeneralsModal();
                this.calculateArmyStats();
                this.refreshAllTabs(); // å¤‰æ›´ã‚’å…¨ã‚¿ãƒ–ã«åæ˜ 
            }
            
            // å½¹è·ã®é‡è¤‡ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ä¿®æ­£
            validateAndFixRoleAssignments() {
                const usedGenerals = new Set();
                const conflictingRoles = [];
                
                // é‡è¤‡ã‚’ãƒã‚§ãƒƒã‚¯
                Object.entries(this.gameState.playerRoles).forEach(([roleKey, generalId]) => {
                    if (generalId) {
                        if (usedGenerals.has(generalId)) {
                            conflictingRoles.push(roleKey);
                        } else {
                            usedGenerals.add(generalId);
                        }
                    }
                });
                
                // é‡è¤‡ãŒã‚ã‚‹å ´åˆã¯æœ€å¾Œã«è¨­å®šã•ã‚ŒãŸã‚‚ã®ä»¥å¤–ã‚’ã‚¯ãƒªã‚¢
                conflictingRoles.forEach(roleKey => {
                    this.gameState.playerRoles[roleKey] = null;
                });
                
                if (conflictingRoles.length > 0) {
                    this.gameState.addLog(`é‡è¤‡ã—ãŸå½¹è·è¨­å®šã‚’ä¿®æ­£ã—ã¾ã—ãŸ: ${conflictingRoles.length}ä»¶`);
                }
            }
            
            updateAvailableGeneralsList() {
                const container = document.getElementById('available-generals-list');
                if (!container) return;
                
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                if (!playerDaimyo) return;
                
                if (this.gameState.availableGenerals.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">ç¾åœ¨ç™»ç”¨å¯èƒ½ãªæ­¦å°†ã¯ã„ã¾ã›ã‚“</div>';
                    return;
                }
                
                // å¤©ä¸‹äººãƒœãƒ¼ãƒŠã‚¹è¡¨ç¤º
                const bonusDisplay = playerDaimyo.skill === 'å¤©ä¸‹äºº' ? ' <span style="color: #ffcc33;">(+20%)</span>' : '';
                
                let html = `
                    <div style="color: #ccc; font-size: 11px; margin-bottom: 10px;">â€»æˆåŠŸç‡ã¯äººäº‹ç·ç›£ã®é­…åŠ›ã«ä¾å­˜${bonusDisplay}</div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                        <thead>
                            <tr style="background: #444; border-bottom: 2px solid #666;">
                                <th style="padding: 6px; border: 1px solid #666; color: #ff6666;">æ­¦å°†å</th>
                                <th style="padding: 6px; border: 1px solid #666;">æˆ¦</th>
                                <th style="padding: 6px; border: 1px solid #666;">çµ±</th>
                                <th style="padding: 6px; border: 1px solid #666;">æ”¿</th>
                                <th style="padding: 6px; border: 1px solid #666;">çŸ¥</th>
                                <th style="padding: 6px; border: 1px solid #666;">é­…</th>
                                <th style="padding: 6px; border: 1px solid #666;">ç‰¹æŠ€</th>
                                <th style="padding: 6px; border: 1px solid #666;">æˆåŠŸç‡</th>
                                <th style="padding: 6px; border: 1px solid #666;">ç™»ç”¨</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                this.gameState.availableGenerals.forEach(general => {
                    const recruitChance = this.calculateRecruitChance(general, playerDaimyo);
                    let chanceColor = '#ff6666';
                    if (recruitChance >= 70) chanceColor = '#66ff66';
                    else if (recruitChance >= 40) chanceColor = '#ffff66';
                    
                    const canAfford = playerDaimyo.gold >= 100;
                    
                    html += `
                        <tr style="border-bottom: 1px solid #555;">
                            <td style="padding: 6px; border: 1px solid #555; color: #ff6666; font-weight: bold;">${general.name}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: center;">${general.stats.battle}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: center;">${general.stats.command}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: center;">${general.stats.politics}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: center;">${general.stats.intelligence}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: center;">${general.stats.charm}</td>
                            <td style="padding: 6px; border: 1px solid #555; font-size: 10px;">${general.skill}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: center; color: ${chanceColor};">${recruitChance}%</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: center;">
                                <button class="btn" onclick="uiManager.attemptGeneralRecruitment('${general.id}')" 
                                        ${!canAfford ? 'disabled' : ''} 
                                        style="padding: 4px 8px; font-size: 10px; ${canAfford ? 'background: linear-gradient(145deg, #006600, #008800); border-color: #00aa00;' : ''}">
                                    ${canAfford ? 'ç™»ç”¨' : 'é‡‘ä¸è¶³'}
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
            }
            
            calculateRecruitChance(general, playerDaimyo) {
                try {
                    // äººäº‹ç·ç›£ã®é­…åŠ›ã‚’å–å¾—
                    let administratorCharm = 0;
                    if (this.gameState.playerRoles.administrator) {
                        const administrator = this.gameState.generals.find(g => g.id === this.gameState.playerRoles.administrator);
                        if (administrator && administrator.stats) {
                            administratorCharm = administrator.stats.charm || 0;
                        }
                    }
                    
                    // æ–°ã—ã„æˆåŠŸç‡è¨ˆç®—: (äººäº‹ç·ç›£ã®é­…åŠ› - 80) * 4
                    let successChance = (administratorCharm - 80) * 4;
                    
                    // ç¾½æŸ´ç§€å‰ã®å¤©ä¸‹äººåŠ¹æœ: ç™»ç”¨æˆåŠŸç‡+20%
                    if (playerDaimyo.skill === 'å¤©ä¸‹äºº') {
                        successChance += 20;
                    }
                    
                    // æœ€ä½10%ä¿è¨¼
                    return Math.max(10, successChance);
                } catch (error) {
                    console.warn('ç™»ç”¨æˆåŠŸç‡è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ:', error);
                    return 10; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
                }
            }
            
            attemptGeneralRecruitment(generalId) {
                const general = this.gameState.availableGenerals.find(g => g.id === generalId);
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                
                if (!general || !playerDaimyo || playerDaimyo.gold < 100) {
                    this.gameState.addLog('ç™»ç”¨ã«ã¯é‡‘100ãŒå¿…è¦ã§ã™');
                    return;
                }
                
                // è²»ç”¨ã‚’æ”¯æ‰•ã†ï¼ˆæˆåŠŸå¤±æ•—é–¢ä¿‚ãªã100ï¼‰
                playerDaimyo.gold -= 100;
                
                // æˆåŠŸç‡ã‚’è¨ˆç®—
                const successChance = this.calculateRecruitChance(general, playerDaimyo);
                const roll = Math.random() * 100;
                
                if (roll <= successChance) {
                    // ç™»ç”¨æˆåŠŸ
                    const newGeneral = {
                        id: general.id,
                        name: general.name,
                        lord: this.gameState.playerDaimyo,
                        stats: { ...general.stats },
                        skill: general.skill,
                        loyalty: Math.floor(Math.random() * 30) + 60
                    };
                    
                    this.gameState.generals.push(newGeneral);
                    this.gameState.availableGenerals = this.gameState.availableGenerals.filter(g => g.id !== generalId);
                    
                    this.gameState.addLog(`${general.name}ã®ç™»ç”¨ã«æˆåŠŸï¼`, 'diplomacy');
                } else {
                    // ç™»ç”¨å¤±æ•—
                    this.gameState.addLog(`${general.name}ã®ç™»ç”¨ã«å¤±æ•—...`, 'diplomacy');
                }
                
                this.updateAvailableGeneralsList();
                this.updateStatus();
            }
        }
        
        // è‡ªå‹•å†ç”Ÿã‚’å¼·åˆ¶çš„ã«é–‹å§‹
        window.addEventListener('load', function() {
            const bgm = document.getElementById('bgm');
            
            // å³åº§ã«ãƒŸãƒ¥ãƒ¼ãƒˆã‚’è§£é™¤ã—ã¦å†ç”Ÿ
            setTimeout(() => {
                bgm.muted = false;
                bgm.play().catch(e => {
                    // è‡ªå‹•å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã€ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§é–‹å§‹
                    document.addEventListener('click', function() {
                        bgm.muted = false;
                        bgm.play();
                    }, { once: true });
                    
                    document.addEventListener('keydown', function() {
                        bgm.muted = false;
                        bgm.play();
                    }, { once: true });
                });
            }, 100);
        });
        
        // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
        const gameState = new GameState();
        const uiManager = new UIManager(gameState);
    </script>
</body>
</html>